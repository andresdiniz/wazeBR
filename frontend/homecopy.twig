<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<link rel="stylesheet" href="https://cdn.datatables.net/1.10.25/css/dataTables.bootstrap5.min.css">
<script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>

<style>
    :root {
        --card-shadow: 0 2px 8px rgba(0,0,0,0.08);
        --card-hover-shadow: 0 4px 16px rgba(0,0,0,0.12);
        --border-radius: 12px;
        --transition: all 0.3s ease;
    }

    /* Cards melhorados */
    .card {
        border: none;
        border-radius: var(--border-radius);
        box-shadow: var(--card-shadow);
        transition: var(--transition);
        overflow: hidden;
    }

    .card:hover {
        box-shadow: var(--card-hover-shadow);
        transform: translateY(-2px);
    }

    .card-header {
        border: none;
        padding: 1rem 1.25rem;
        font-weight: 600;
        font-size: 1.1rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .card-header i {
        margin-right: 0.5rem;
        font-size: 1.2rem;
    }

    .card-body {
        padding: 1.25rem;
    }

    /* Badge modernizado */
    .badge {
        padding: 0.4rem 0.7rem;
        border-radius: 20px;
        font-weight: 600;
        font-size: 0.85rem;
    }

    /* Mapa de congestionamento */
    #congestionMap {
        height: 550px;
        width: 100%;
        border-radius: var(--border-radius);
        overflow: hidden;
    }

    /* Tabelas otimizadas */
    .table {
        margin-bottom: 0;
        font-size: 0.9rem;
    }

    .table thead th {
        background-color: #f8f9fa;
        border-bottom: 2px solid #dee2e6;
        font-weight: 600;
        font-size: 0.85rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        padding: 0.75rem 0.5rem;
        white-space: nowrap;
    }

    .table tbody td {
        padding: 0.75rem 0.5rem;
        vertical-align: middle;
    }

    .table-hover tbody tr:hover {
        background-color: #f8f9fa;
        cursor: pointer;
    }

    /* Botões melhorados */
    .btn-sm {
        padding: 0.35rem 0.7rem;
        font-size: 0.85rem;
        border-radius: 6px;
        transition: var(--transition);
    }

    .btn-group .btn {
        margin: 0 2px;
    }

    .btn-outline-primary:hover {
        transform: scale(1.05);
    }

    /* Card de estatísticas (motoristas) */
    .stat-card {
        text-align: center;
        padding: 2rem;
    }

    .stat-card h2 {
        font-size: 3.5rem;
        font-weight: 700;
        color: #0dcaf0;
        margin: 0;
        line-height: 1;
    }

    .stat-card p {
        font-size: 1rem;
        color: #6c757d;
        margin-top: 0.5rem;
    }

    /* Estados vazios melhorados */
    .empty-state {
        text-align: center;
        padding: 3rem 1rem;
    }

    .empty-state i {
        opacity: 0.3;
        margin-bottom: 1rem;
    }

    .empty-state p {
        color: #6c757d;
        font-size: 1rem;
    }

    /* Responsividade aprimorada */
    @media (max-width: 768px) {
        .card-header {
            font-size: 1rem;
            padding: 0.875rem 1rem;
        }

        .table {
            font-size: 0.85rem;
        }

        .table thead th,
        .table tbody td {
            padding: 0.5rem 0.35rem;
        }

        .col-mobile-hide {
            display: none;
        }

        .btn-sm {
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
        }

        .stat-card h2 {
            font-size: 2.5rem;
        }

        #congestionMap {
            height: 400px;
        }

        .badge {
            font-size: 0.75rem;
            padding: 0.3rem 0.5rem;
        }
    }

    @media (min-width: 769px) {
        .col-mobile-hide {
            display: table-cell;
        }
    }

    @media (min-width: 1400px) {
        .container-fluid {
            max-width: 1600px;
            margin: 0 auto;
        }
    }

    /* DataTables customização */
    .dataTables_wrapper .dataTables_length select,
    .dataTables_wrapper .dataTables_filter input {
        border-radius: 6px;
        border: 1px solid #dee2e6;
        padding: 0.375rem 0.75rem;
    }

    .dataTables_wrapper .dataTables_paginate .paginate_button {
        border-radius: 6px;
        margin: 0 2px;
    }

    /* Badges de confiança */
    .confidence-badge {
        min-width: 50px;
        font-weight: 600;
    }

    /* Animações sutis */
    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .card {
        animation: fadeIn 0.5s ease;
    }

    /* Melhorias de acessibilidade */
    .btn:focus,
    .form-control:focus {
        box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
    }

    /* Tooltip customizado */
    [title] {
        cursor: help;
    }
</style>

<div class="container-fluid py-4">
    <div class="row g-4">
        <!-- Card de Acidentes -->
        <div class="col-xl-6 col-lg-12">
            <div class="card h-100">
                <div class="card-header bg-danger text-white">
                    <span>
                        <i class="fas fa-car-crash"></i>
                        Acidentes
                    </span>
                    <span class="badge bg-light text-dark">15</span>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0" id="accidentsTable">
                            <thead>
                                <tr>
                                    <th>Local</th>
                                    <th class="col-mobile-hide">Rua</th>
                                    <th class="col-mobile-hide">Localização</th>
                                    <th>Data/Hora</th>
                                    <th class="text-center">Conf.</th>
                                    <th class="text-center">Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>
                                        <strong class="text-dark">São Paulo</strong>
                                        <div class="d-md-none">
                                            <small class="text-muted">Av. Paulista</small>
                                        </div>
                                    </td>
                                    <td class="col-mobile-hide">Av. Paulista</td>
                                    <td class="col-mobile-hide text-center">
                                        <a href="#" target="_blank" class="btn btn-outline-primary btn-sm">
                                            <i class="fab fa-waze"></i>
                                        </a>
                                    </td>
                                    <td>
                                        <div class="fw-semibold">05/11/2025</div>
                                        <small class="text-muted">14:30</small>
                                    </td>
                                    <td class="text-center">
                                        <span class="badge bg-success confidence-badge">85</span>
                                    </td>
                                    <td class="text-center">
                                        <div class="btn-group" role="group">
                                            <button class="btn btn-info btn-sm" title="Detalhes">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            <a href="#" class="btn btn-primary btn-sm d-md-none" title="Waze">
                                                <i class="fab fa-waze"></i>
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <strong class="text-dark">Rio de Janeiro</strong>
                                        <div class="d-md-none">
                                            <small class="text-muted">Av. Atlântica</small>
                                        </div>
                                    </td>
                                    <td class="col-mobile-hide">Av. Atlântica</td>
                                    <td class="col-mobile-hide text-center">
                                        <a href="#" target="_blank" class="btn btn-outline-primary btn-sm">
                                            <i class="fab fa-waze"></i>
                                        </a>
                                    </td>
                                    <td>
                                        <div class="fw-semibold">05/11/2025</div>
                                        <small class="text-muted">13:15</small>
                                    </td>
                                    <td class="text-center">
                                        <span class="badge bg-warning confidence-badge">65</span>
                                    </td>
                                    <td class="text-center">
                                        <div class="btn-group" role="group">
                                            <button class="btn btn-info btn-sm" title="Detalhes">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            <a href="#" class="btn btn-primary btn-sm d-md-none" title="Waze">
                                                <i class="fab fa-waze"></i>
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Card de Congestionamentos -->
        <div class="col-xl-6 col-lg-12">
            <div class="card h-100">
                <div class="card-header bg-warning text-dark">
                    <span>
                        <i class="fas fa-traffic-light"></i>
                        Congestionamentos
                    </span>
                    <span class="badge bg-dark">23</span>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0" id="trafficTable">
                            <thead>
                                <tr>
                                    <th>Local</th>
                                    <th class="col-mobile-hide">Rua</th>
                                    <th class="col-mobile-hide">Localização</th>
                                    <th>Data/Hora</th>
                                    <th class="text-center">Conf.</th>
                                    <th class="text-center">Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>
                                        <strong class="text-dark">Belo Horizonte</strong>
                                        <div class="d-md-none">
                                            <small class="text-muted">Av. Afonso Pena</small>
                                        </div>
                                    </td>
                                    <td class="col-mobile-hide">Av. Afonso Pena</td>
                                    <td class="col-mobile-hide text-center">
                                        <a href="#" target="_blank" class="btn btn-outline-primary btn-sm">
                                            <i class="fab fa-waze"></i>
                                        </a>
                                    </td>
                                    <td>
                                        <div class="fw-semibold">05/11/2025</div>
                                        <small class="text-muted">15:45</small>
                                    </td>
                                    <td class="text-center">
                                        <span class="badge bg-success confidence-badge">92</span>
                                    </td>
                                    <td class="text-center">
                                        <div class="btn-group" role="group">
                                            <button class="btn btn-info btn-sm" title="Detalhes">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            <a href="#" class="btn btn-primary btn-sm d-md-none" title="Waze">
                                                <i class="fab fa-waze"></i>
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Card de Motoristas Impactados -->
        <div class="col-xl-6 col-lg-12">
            <div class="card h-100">
                <div class="card-header bg-info text-white">
                    <span>
                        <i class="fas fa-users"></i>
                        Motoristas em Congestionamentos
                    </span>
                    <span class="badge bg-light text-dark">1,247</span>
                </div>
                <div class="card-body stat-card">
                    <h2>1,247</h2>
                    <p class="mb-0">motoristas impactados no momento</p>
                </div>
            </div>
        </div>

        <!-- Mapa de Congestionamento -->
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-dark text-white">
                    <span>
                        <i class="fas fa-map-marked-alt"></i>
                        Mapa de Congestionamentos em Tempo Real
                    </span>
                </div>
                <div class="card-body p-3">
                    <div id="congestionMap"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
    // Configuração do DataTable
    const dataTableConfig = {
        language: {
            url: '//cdn.datatables.net/plug-ins/1.10.25/i18n/Portuguese-Brasil.json'
        },
        responsive: true,
        pageLength: 10,
        lengthMenu: [[10, 25, 50, -1], [10, 25, 50, "Todos"]],
        order: [[3, 'desc']],
        columnDefs: [
            { orderable: false, targets: [-1] },
            { className: "text-center", targets: [4, 5] }
        ],
        dom: '<"row mb-3"<"col-sm-12 col-md-6"l><"col-sm-12 col-md-6"f>>' +
             '<"row"<"col-sm-12"tr>>' +
             '<"row mt-3"<"col-sm-12 col-md-5"i><"col-sm-12 col-md-7"p>>'
    };

    if ($('#accidentsTable').length) {
        $('#accidentsTable').DataTable(dataTableConfig);
    }

    if ($('#trafficTable').length) {
        $('#trafficTable').DataTable(dataTableConfig);
    }

    // Inicialização do mapa
    const congestionMap = L.map('congestionMap').setView([-20.66, -43.79], 13);
    
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors',
        maxZoom: 19
    }).addTo(congestionMap);

    // Função para cores baseadas no nível
    function getColorForLevel(level) {
        const colors = {
            5: '#dc3545',  // Vermelho - Parado
            4: '#fd7e14',  // Laranja - Muito lento
            3: '#ffc107',  // Amarelo - Lento
            2: '#28a745',  // Verde - Moderado
            1: '#17a2b8',  // Azul - Leve
        };
        return colors[level] || '#6c757d';
    }

    // Dados de exemplo para o mapa
    const sampleJams = [
        {
            lines: [
                {latitude: -20.66, longitude: -43.79},
                {latitude: -20.67, longitude: -43.80}
            ],
            level: 5,
            street: "Av. Principal"
        },
        {
            lines: [
                {latitude: -20.65, longitude: -43.78},
                {latitude: -20.64, longitude: -43.77}
            ],
            level: 3,
            street: "Rua Secundária"
        }
    ];

    sampleJams.forEach(jam => {
        if (jam.lines && jam.lines.length > 0) {
            const latlngs = jam.lines.map(line => [line.latitude, line.longitude]);
            const color = getColorForLevel(jam.level);
            
            L.polyline(latlngs, {
                color: color,
                weight: 6,
                opacity: 0.8,
                lineJoin: 'round'
            }).addTo(congestionMap)
              .bindPopup(`
                <strong>${jam.street}</strong><br>
                Nível: ${jam.level}/5<br>
                Status: ${jam.level >= 4 ? 'Crítico' : jam.level >= 3 ? 'Moderado' : 'Leve'}
              `);
        }
    });

    // Ajustar mapa após carregamento
    setTimeout(() => {
        congestionMap.invalidateSize();
    }, 300);

    // Tooltip Bootstrap 5
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl)
    });
});
</script>

<script src="https://cdn.datatables.net/1.10.25/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.10.25/js/dataTables.bootstrap5.min.js"></script