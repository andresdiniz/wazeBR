    
    <!-- Carregamento adiado de CSS não críticos -->
    <link rel="preload" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <link rel="preload" href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.dataTables.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript>
        <link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css">
        <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.dataTables.min.css">
    </noscript>

    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --success-gradient: linear-gradient(135deg, #1cc88a 0%, #13855c 100%);
            --warning-gradient: linear-gradient(135deg, #f6c23e 0%, #dda20a 100%);
            --danger-gradient: linear-gradient(135deg, #e74a3b 0%, #be2617 100%);
            --info-gradient: linear-gradient(135deg, #36b9cc 0%, #258391 100%);
            --card-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            --card-shadow-hover: 0 8px 30px rgba(0, 0, 0, 0.12);
            
            --bg-color: #f8f9fc;
            --card-bg: #ffffff;
            --text-primary: #2c3e50;
            --text-secondary: #858796;
            --text-muted: #858796;
            --border-color: #e3e6f0;
            --table-hover: #f8f9fc;
            --header-border: #e3e6f0;
            --legend-bg: #ffffff;
            --empty-icon-color: #d1d3e2;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-primary);
        }

        .page-header {
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--header-border);
        }

        .page-header h2 {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .page-header .subtitle {
            color: var(--text-secondary);
            font-size: 0.95rem;
        }

        /* Cards modernos */
        .modern-card {
            border: none;
            border-radius: 1rem;
            overflow: hidden;
            transition: all 0.3s ease;
            box-shadow: var(--card-shadow);
            background: var(--card-bg);
            margin-bottom: 1.5rem;
        }

        .modern-card:hover {
            box-shadow: var(--card-shadow-hover);
        }

        .modern-card-header {
            background: var(--primary-gradient);
            color: white;
            padding: 1.25rem 1.5rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 1.05rem;
        }

        .modern-card-header i {
            font-size: 1.2rem;
        }

        .modern-card-header.bg-warning-gradient {
            background: var(--warning-gradient);
        }

        .modern-card-header.bg-danger-gradient {
            background: var(--danger-gradient);
        }

        .modern-card-header.bg-info-gradient {
            background: var(--info-gradient);
        }

        .modern-card-header.bg-success-gradient {
            background: var(--success-gradient);
        }

        /* Badge contador */
        .badge-counter {
            background: rgba(255, 255, 255, 0.25);
            padding: 0.4rem 0.75rem;
            border-radius: 50px;
            font-weight: 700;
            font-size: 0.95rem;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        /* Stats cards otimizados */
        .stats-card {
            background: var(--card-bg);
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: var(--card-shadow);
            transition: all 0.3s ease;
            border-left: 4px solid transparent;
            height: 100%;
        }

        .stats-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--card-shadow-hover);
        }

        .stats-card.route1 {
            border-left-color: #3c8dbc;
        }

        .stats-card.route2 {
            border-left-color: #d33724;
        }

        .stats-card-icon {
            width: 60px;
            height: 60px;
            border-radius: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            margin-bottom: 1rem;
        }

        .stats-card.route1 .stats-card-icon {
            background: linear-gradient(135deg, rgba(60, 141, 188, 0.1), rgba(45, 106, 141, 0.1));
            color: #3c8dbc;
        }

        .stats-card.route2 .stats-card-icon {
            background: linear-gradient(135deg, rgba(211, 55, 36, 0.1), rgba(158, 41, 27, 0.1));
            color: #d33724;
        }

        .stats-card-value {
            font-size: 2.5rem;
            font-weight: 800;
            line-height: 1;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }

        .stats-card-label {
            font-size: 0.9rem;
            color: var(--text-secondary);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Gráficos */
        .chart-container {
            position: relative;
            height: 400px;
            margin: 20px 0;
        }

        @media (max-width: 767px) {
            .chart-container {
                height: 300px;
            }
        }

        /* Comparação de métricas */
        .metric-card {
            transition: all 0.3s ease;
            padding: 1rem;
            border-radius: 0.75rem;
            background: rgba(248, 249, 252, 0.5);
        }

        .metric-card:hover {
            transform: translateY(-3px);
            background: rgba(248, 249, 252, 0.8);
        }

        .comparison-diff {
            font-size: 0.85rem;
            padding: 0.3rem 0.75rem;
            border-radius: 50px;
            margin-top: 0.5rem;
            display: inline-block;
            font-weight: 600;
        }

        .positive-diff { 
            background: rgba(28, 200, 138, 0.15);
            color: #1cc88a;
            border: 1px solid rgba(28, 200, 138, 0.3);
        }
        
        .negative-diff { 
            background: rgba(231, 74, 59, 0.15);
            color: #e74a3b;
            border: 1px solid rgba(231, 74, 59, 0.3);
        }

        /* Tabelas melhoradas */
        .modern-table {
            margin-bottom: 0;
        }

        .modern-table thead th {
            background: var(--table-hover);
            border: none;
            font-weight: 700;
            text-transform: uppercase;
            font-size: 0.75rem;
            color: var(--text-secondary);
            padding: 1rem 0.75rem;
            letter-spacing: 0.5px;
        }

        .modern-table tbody tr {
            transition: all 0.2s ease;
            border-bottom: 1px solid var(--border-color);
        }

        .modern-table tbody tr:hover {
            background-color: var(--table-hover);
            transform: translateX(3px);
        }

        .modern-table tbody tr:last-child {
            border-bottom: none;
        }

        .modern-table tbody td {
            padding: 1rem 0.75rem;
            vertical-align: middle;
            color: var(--text-primary);
        }

        /* Filtros e ações */
        .filter-section {
            background: var(--card-bg);
            padding: 1.5rem;
            border-radius: 1rem;
            box-shadow: var(--card-shadow);
            margin-bottom: 1.5rem;
        }

        .filter-section .form-control,
        .filter-section .form-select {
            border-radius: 0.5rem;
            border: 1px solid var(--border-color);
            padding: 0.625rem 1rem;
            background-color: var(--card-bg);
            color: var(--text-primary);
        }

        .filter-section .btn {
            border-radius: 0.5rem;
            padding: 0.625rem 1.5rem;
            font-weight: 600;
        }

        /* Botões de ação */
        .action-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            border: none;
            margin: 0 3px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .action-btn:hover {
            transform: translateY(-3px) scale(1.1);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        /* Loading spinner */
        .spinner-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255,255,255,0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid var(--border-color);
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .loading-text {
            margin-top: 1rem;
            color: var(--text-secondary);
            font-weight: 600;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Animações de entrada */
        .fade-in {
            animation: fadeIn 0.6s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Responsividade */
        @media (max-width: 767px) {
            .btn-export {
                width: 100%;
                margin-bottom: 0.5rem;
            }
            
            .stats-card-value {
                font-size: 2rem;
            }
            
            .stats-card-icon {
                width: 50px;
                height: 50px;
                font-size: 1.5rem;
            }
        }
    </style>
</head>
<body>

<!-- Loading Spinner -->
<div class="spinner-overlay" id="loadingSpinner">
    <div class="loading-spinner"></div>
    <div class="loading-text">Carregando comparação...</div>
</div>

<div class="container mt-4">
    
    <!-- Header da Página -->
    <div class="page-header fade-in">
        <h2 class="text-center"><i class="fas fa-route me-2"></i>Comparação de Rotas</h2>
        <p class="subtitle text-center mb-0">
            Compare o desempenho de duas rotas em um período de tempo
        </p>
    </div>

    <!-- Filtros -->
    <div class="filter-section fade-in" style="animation-delay: 0.1s;">
        <form method="GET" class="row g-3" id="routeComparisonForm">
            <div class="col-md-4">
                <label class="form-label fw-bold">Rota 1:</label>
                <select name="route1_id" class="form-select" required>
                    <option value="">Selecione a primeira rota</option>
                    {% for route in routes %}
                        <option value="{{ route.id }}"
                                {% if route.id == route1 %}selected{% endif %}>
                                {{ route.name }}
                        </option>
                    {% endfor %}
                </select>
            </div>

            <div class="col-md-4">
                <label class="form-label fw-bold">Rota 2:</label>
                <select name="route2_id" class="form-select" required>
                    <option value="">Selecione a segunda rota</option>
                    {% for route in routes %}
                        <option value="{{ route.id }}"
                                {% if route.id == route2 %}selected{% endif %}>
                                {{ route.name }}
                        </option>
                    {% endfor %}
                </select>
            </div>

            <div class="col-md-2">
                <label class="form-label fw-bold">Data Inicial:</label>
                <input type="date" name="start_date"
                       class="form-control"
                       value="{{ start_date }}"
                       max="{{ "now"|date("Y-m-d") }}"
                       required>
            </div>

            <div class="col-md-2">
                <label class="form-label fw-bold">Data Final:</label>
                <input type="date" name="end_date"
                       class="form-control"
                       value="{{ end_date }}"
                       required>
            </div>

            <div class="col-md-12 text-center mt-3">
                <button type="submit" class="btn btn-primary px-4" id="compareButton">
                    <i class="fas fa-sync-alt me-2"></i>Comparar Rotas
                </button>
            </div>
        </form>
    </div>

    {% if dados %}
        <!-- Dashboard Cards -->
        <div class="row mt-4">
            <!-- Rota 1 Card -->
            <div class="col-md-6 mb-4 fade-in" style="animation-delay: 0.2s;">
                <div class="stats-card route1">
                    <div class="d-flex align-items-center mb-3">
                        <div class="stats-card-icon">
                            <i class="fas fa-route"></i>
                        </div>
                        <div class="ms-3">
                            <h5 class="mb-0 fw-bold">{{ route1_name }}</h5>
                            <span class="badge bg-secondary">
                                {{ dados.estatisticas.rota1.total_registros }} registros
                            </span>
                        </div>
                    </div>
                    
                    <div class="row mt-3">
                        <!-- Velocidade -->
                        <div class="col-6">
                            <div class="metric-card text-center">
                                <div class="stats-card-value text-primary">
                                    {{ dados.media1.velocidade|round(1) }}<small class="text-muted fs-6">km/h</small>
                                </div>
                                <div class="stats-card-label">Velocidade Média</div>
                                
                                {% if dados.estatisticas.rota1.diferenca_percentual.velocidade != 0 %}
                                    <div class="comparison-diff 
                                        {% if dados.estatisticas.rota1.diferenca_percentual.velocidade > 0 %}positive-diff{% else %}negative-diff{% endif %}">
                                        <i class="fas fa-arrow-{% if dados.estatisticas.rota1.diferenca_percentual.velocidade > 0 %}up{% else %}down{% endif %} me-1"></i>
                                        {{ dados.estatisticas.rota1.diferenca_percentual.velocidade|abs|round(1) }}% vs Rota 2
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- Tempo -->
                        <div class="col-6">
                            <div class="metric-card text-center">
                                <div class="stats-card-value text-secondary">
                                    {{ dados.media1.tempo|round(1) }}<small class="text-muted fs-6">s</small>
                                </div>
                                <div class="stats-card-label">Tempo Médio</div>
                                
                                {% if dados.estatisticas.rota1.diferenca_percentual.tempo != 0 %}
                                    <div class="comparison-diff 
                                        {% if dados.estatisticas.rota1.diferenca_percentual.tempo < 0 %}positive-diff{% else %}negative-diff{% endif %}">
                                        <i class="fas fa-arrow-{% if dados.estatisticas.rota1.diferenca_percentual.tempo < 0 %}down{% else %}up{% endif %} me-1"></i>
                                        {{ dados.estatisticas.rota1.diferenca_percentual.tempo|abs|round(1) }}% vs Rota 2
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Rota 2 Card -->
            <div class="col-md-6 mb-4 fade-in" style="animation-delay: 0.3s;">
                <div class="stats-card route2">
                    <div class="d-flex align-items-center mb-3">
                        <div class="stats-card-icon">
                            <i class="fas fa-route"></i>
                        </div>
                        <div class="ms-3">
                            <h5 class="mb-0 fw-bold">{{ route2_name }}</h5>
                            <span class="badge bg-secondary">
                                {{ dados.estatisticas.rota2.total_registros }} registros
                            </span>
                        </div>
                    </div>
                    
                    <div class="row mt-3">
                        <!-- Velocidade -->
                        <div class="col-6">
                            <div class="metric-card text-center">
                                <div class="stats-card-value text-primary">
                                    {{ dados.media2.velocidade|round(1) }}<small class="text-muted fs-6">km/h</small>
                                </div>
                                <div class="stats-card-label">Velocidade Média</div>
                            </div>
                        </div>
                        
                        <!-- Tempo -->
                        <div class="col-6">
                            <div class="metric-card text-center">
                                <div class="stats-card-value text-secondary">
                                    {{ dados.media2.tempo|round(1) }}<small class="text-muted fs-6">s</small>
                                </div>
                                <div class="stats-card-label">Tempo Médio</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Gráficos Responsivos -->
        <div class="row fade-in" style="animation-delay: 0.4s;">
            <div class="col-12">
                <div class="modern-card">
                    <div class="modern-card-header bg-success-gradient">
                        <span>
                            <i class="fas fa-chart-line me-2"></i>
                            Gráficos Comparativos
                        </span>
                    </div>
                    <div class="card-body">
                        <ul class="nav nav-tabs" id="chartTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="velocidade-tab" data-bs-toggle="tab" 
                                        data-bs-target="#tab-velocidade" type="button" role="tab">
                                    <i class="fas fa-tachometer-alt me-2"></i>Velocidade
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="tempo-tab" data-bs-toggle="tab" 
                                        data-bs-target="#tab-tempo" type="button" role="tab">
                                    <i class="fas fa-clock me-2"></i>Tempo
                                </button>
                            </li>
                        </ul>
                        
                        <div class="tab-content mt-3" id="chartTabsContent">
                            <!-- Tab Velocidade -->
                            <div class="tab-pane fade show active" id="tab-velocidade" role="tabpanel">
                                <div class="chart-container">
                                    <canvas id="comparisonChartVelocidade"></canvas>
                                </div>
                            </div>
                            
                            <!-- Tab Tempo -->
                            <div class="tab-pane fade" id="tab-tempo" role="tabpanel">
                                <div class="chart-container">
                                    <canvas id="comparisonChartTempo"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabelas -->
        <div class="row mt-4">
            <div class="col-md-6 mb-4 fade-in" style="animation-delay: 0.5s;">
                <div class="modern-card h-100">
                    <div class="modern-card-header bg-info-gradient">
                        <h5 class="mb-0"><i class="fas fa-route me-2"></i>{{ route1_name }}</h5>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table modern-table" id="tabelaRota1">
                                <thead>
                                    <tr>
                                        <th>Data/Hora</th>
                                        <th>Velocidade (km/h)</th>
                                        <th>Tempo (s)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for item in dados.rota1 %}
                                        <tr>
                                            <td>{{ item.data|date('d/m/Y H:i') }}</td>
                                            <td class="fw-bold">{{ item.velocidade|number_format(1) }}</td>
                                            <td class="fw-bold">{{ item.tempo|number_format(1) }}</td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-6 mb-4 fade-in" style="animation-delay: 0.6s;">
                <div class="modern-card h-100">
                    <div class="modern-card-header bg-warning-gradient">
                        <h5 class="mb-0"><i class="fas fa-route me-2"></i>{{ route2_name }}</h5>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table modern-table" id="tabelaRota2">
                                <thead>
                                    <tr>
                                        <th>Data/Hora</th>
                                        <th>Velocidade (km/h)</th>
                                        <th>Tempo (s)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for item in dados.rota2 %}
                                        <tr>
                                            <td>{{ item.data|date('d/m/Y H:i') }}</td>
                                            <td class="fw-bold">{{ item.velocidade|number_format(1) }}</td>
                                            <td class="fw-bold">{{ item.tempo|number_format(1) }}</td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Botões de Exportação -->
        <div class="row mt-4 fade-in" style="animation-delay: 0.7s;">
            <div class="col-12">
                <div class="modern-card">
                    <div class="card-body text-center">
                        <div class="d-flex flex-wrap justify-content-center gap-3">
                            <button class="btn btn-info px-4 btn-export" onclick="exportChart('comparisonChartVelocidade')">
                                <i class="fas fa-download me-2"></i>Exportar Gráfico Velocidade
                            </button>
                            <button class="btn btn-info px-4 btn-export" onclick="exportChart('comparisonChartTempo')">
                                <i class="fas fa-download me-2"></i>Exportar Gráfico Tempo
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    {% endif %}
</div>

<!-- Scripts com carregamento otimizado -->
<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<!-- Scripts do Chart.js (carregados agora, não mais dinamicamente) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>

<!-- Scripts adicionais (carregados dinamicamente) -->
<script>
    // Estado global da aplicação
    let comparisonChartVelocidade = null;
    let comparisonChartTempo = null;
    let dataTablesLoaded = false;
    
    // Carregador de scripts dinâmico
    function loadScript(url, callback) {
        const script = document.createElement('script');
        script.src = url;
        script.onload = callback;
        document.head.appendChild(script);
    }
    
    // Esconder spinner após carregamento
    document.addEventListener("DOMContentLoaded", function() {
        document.getElementById('loadingSpinner').style.display = 'none';
        
        // Mostrar spinner durante o envio do formulário
        document.getElementById('routeComparisonForm')?.addEventListener('submit', function() {
            document.getElementById('loadingSpinner').style.display = 'flex';
        });
        
        {% if dados %}
            initializeApp();
        {% endif %}
    });
    
    // Função para inicializar o aplicativo após os dados estarem disponíveis
    function initializeApp() {
        try {
            initCharts();
            loadDataTables();
        } catch (error) {
            console.error('Erro na inicialização:', error);
            alert(`Erro: ${error.message}\n\nO aplicativo pode não funcionar corretamente.`);
        }
    }
    
    // Inicialização de gráficos
    function initCharts() {
        {% if dados %}
            try {
                // Converter strings de data para objetos Date
                const labels = {{ dados.labels|json_encode|raw }}.map(date => {
                    // Se já for uma string ISO, usar new Date
                    if (typeof date === 'string' && date.includes('T')) {
                        return new Date(date);
                    }
                    // Se for timestamp
                    return new Date(date * 1000);
                });
                
                // Inicializar gráficos
                comparisonChartVelocidade = initComparativeChart('comparisonChartVelocidade', 'Velocidade (km/h)', labels,
                    {{ dados.rota1_values.velocidade|json_encode|raw }},
                    {{ dados.rota2_values.velocidade|json_encode|raw }},
                    ['#3c8dbc', '#d33724'],
                    '{{ route1_name }}',
                    '{{ route2_name }}'
                );

                comparisonChartTempo = initComparativeChart('comparisonChartTempo', 'Tempo (segundos)', labels,
                    {{ dados.rota1_values.tempo|json_encode|raw }},
                    {{ dados.rota2_values.tempo|json_encode|raw }},
                    ['#3c8dbc', '#d33724'],
                    '{{ route1_name }}',
                    '{{ route2_name }}'
                );
                
                // Ajustar tamanho dos gráficos quando as tabs são alteradas
                const chartTabs = document.getElementById('chartTabs');
                if (chartTabs) {
                    chartTabs.addEventListener('shown.bs.tab', function (event) {
                        setTimeout(() => {
                            if (event.target.id === 'velocidade-tab' && comparisonChartVelocidade) {
                                comparisonChartVelocidade.resize();
                            } else if (event.target.id === 'tempo-tab' && comparisonChartTempo) {
                                comparisonChartTempo.resize();
                            }
                        }, 100);
                    });
                }
            } catch (error) {
                console.error('Erro na inicialização dos gráficos:', error);
                // Tentar inicializar novamente após 1 segundo
                setTimeout(initCharts, 1000);
            }
        {% endif %}
    }
    
    // Função otimizada para criar gráficos comparativos
    function initComparativeChart(canvasId, title, labels, data1, data2, colors, label1, label2) {
        const ctx = document.getElementById(canvasId);
        if (!ctx) {
            console.error('Canvas não encontrado:', canvasId);
            return null;
        }
    
        // Destruir gráfico existente se houver
        if (canvasId === 'comparisonChartVelocidade' && comparisonChartVelocidade) {
            comparisonChartVelocidade.destroy();
            comparisonChartVelocidade = null;
        } else if (canvasId === 'comparisonChartTempo' && comparisonChartTempo) {
            comparisonChartTempo.destroy();
            comparisonChartTempo = null;
        }
        
        // Configuração de gráfico otimizada
        const chartConfig = {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: `${label1}`,
                        data: data1,
                        borderColor: colors[0],
                        backgroundColor: `${colors[0]}20`,
                        borderWidth: 3,
                        tension: 0.3,
                        spanGaps: true,
                        pointRadius: labels.length > 100 ? 0 : 4,
                        pointHoverRadius: 6,
                        pointBackgroundColor: colors[0],
                        pointBorderColor: '#ffffff',
                        pointBorderWidth: 2
                    },
                    {
                        label: `${label2}`,
                        data: data2,
                        borderColor: colors[1],
                        backgroundColor: `${colors[1]}20`,
                        borderWidth: 3,
                        tension: 0.3,
                        spanGaps: true,
                        pointRadius: labels.length > 100 ? 0 : 4,
                        pointHoverRadius: 6,
                        pointBackgroundColor: colors[1],
                        pointBorderColor: '#ffffff',
                        pointBorderWidth: 2
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                animation: {
                    duration: labels.length > 100 ? 0 : 1000
                },
                plugins: {
                    legend: {
                        position: 'top',
                        labels: {
                            padding: 20,
                            font: { size: 14 },
                            usePointStyle: true,
                            pointStyle: 'circle'
                        }
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        backgroundColor: 'rgba(0,0,0,0.85)',
                        titleFont: { size: 14 },
                        bodyFont: { size: 13 },
                        padding: 12,
                        cornerRadius: 8,
                        callbacks: {
                            label: function(context) {
                                let value = context.raw;
                                return `${context.dataset.label}: ${value !== null ? value.toFixed(1) : 'N/A'}`;
                            }
                        }
                    },
                    title: {
                        display: true,
                        text: title,
                        font: { size: 18 },
                        color: '#2c3e50'
                    }
                },
                scales: {
                    x: {
                        type: 'time',
                        time: {
                            tooltipFormat: 'dd/MM HH:mm',
                            displayFormats: {
                                hour: 'dd/MM HH:mm',
                                day: 'dd/MM',
                            }
                        },
                        grid: {
                            color: 'rgba(0,0,0,0.05)'
                        },
                        ticks: {
                            maxTicksLimit: 10,
                            autoSkip: true
                        }
                    },
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: 'rgba(0,0,0,0.05)'
                        },
                        title: {
                            display: true,
                            text: title,
                            font: { size: 14 },
                            color: '#5a5c69'
                        }
                    }
                },
                elements: {
                    line: {
                        tension: 0.3
                    }
                },
                interaction: {
                    mode: 'nearest',
                    axis: 'x',
                    intersect: false
                }
            }
        };
    
        // Criar novo gráfico
        try {
            const chart = new Chart(ctx, chartConfig);
            return chart;
        } catch (error) {
            console.error('Erro ao criar gráfico:', error);
            return null;
        }
    }

    // Carregamento sob demanda do DataTables
    function loadDataTables() {
        if (dataTablesLoaded) return;
        
        const scripts = [
            'https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js',
            'https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js'
        ];
        
        let loaded = 0;
        scripts.forEach(url => {
            loadScript(url, function() {
                loaded++;
                if (loaded === scripts.length) {
                    initDataTables();
                    dataTablesLoaded = true;
                }
            });
        });
    }

    function initDataTables() {
        if (typeof $.fn.DataTable !== 'function') return;
    
        const tableConfig = {
            pageLength: 10,
            lengthMenu: [[10, 25, 50, -1], [10, 25, 50, "Todos"]],
            searching: true,
            info: true,
            ordering: true,
            autoWidth: false,
            responsive: true,
            order: [[0, 'desc']],
            language: { 
                url: '//cdn.datatables.net/plug-ins/1.13.7/i18n/pt-BR.json' 
            },
            deferRender: true,
            dom: '<"row mb-3"<"col-sm-12 col-md-6"l><"col-sm-12 col-md-6"f>>' +
                 '<"row"<"col-sm-12"tr>>' +
                 '<"row mt-3"<"col-sm-12 col-md-5"i><"col-sm-12 col-md-7"p>>'
        };
    
        $('#tabelaRota1').DataTable(tableConfig);
        $('#tabelaRota2').DataTable(tableConfig);
    }

    // Exportação de gráficos para PNG
    function exportChart(chartId) {
        const canvas = document.getElementById(chartId);
        if (!canvas) {
            alert('Elemento do gráfico não encontrado!');
            return;
        }

        try {
            const chartType = chartId.includes('Velocidade') ? 'Velocidade' : 'Tempo';
            const fileName = `Comparacao_${chartType}_${new Date().toISOString().slice(0,10)}.png`;
            
            // Criar link temporário para download
            const tempLink = document.createElement('a');
            tempLink.download = fileName;
            tempLink.href = canvas.toDataURL('image/png', 1.0);
            document.body.appendChild(tempLink);
            tempLink.click();
            document.body.removeChild(tempLink);
            
            // Notificação visual
            if (typeof $.notify !== 'undefined') {
                $.notify(`Gráfico ${chartType.toLowerCase()} exportado com sucesso!`, {
                    position: "top right",
                    className: "success",
                    autoHideDelay: 3000
                });
            }
        } catch (error) {
            console.error('Erro na exportação do gráfico:', error);
            alert('Falha ao exportar gráfico: ' + error.message);
        }
    }
</script>
