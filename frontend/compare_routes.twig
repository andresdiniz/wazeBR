<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comparação de Rotas</title>
    
    <!-- CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.dataTables.min.css">
    
    <style>
        .comparison-card {
            border-left: 4px solid;
            transition: transform 0.3s;
        }
        .comparison-card:hover {
            transform: translateY(-5px);
        }
        .route1-color { border-color: #3c8dbc; }
        .route2-color { border-color: #d33724; }
        @media (max-width: 767px) {
            .chart-container { padding: 0 5px; }
            canvas { max-height: 300px; }
            .dataTables_wrapper { overflow-x: auto; }
        }
    </style>
</head>
<body>

<div class="container mt-4">
    <h2 class="text-center mb-4">Comparação de Rotas</h2>
        <!-- Formulário Completo -->
        <form method="GET" class="row g-3 mb-4">
            <div class="col-md-4">
                <label class="form-label">Rota 1:</label>
                <select name="route1_id" class="form-select" required>
                    <option value="">Selecione a primeira rota</option>
                    {% for route in routes %}
                        <option value="{{ route.id }}" 
                            {% if route.id == route1 %}selected{% endif %}>
                            {{ route.name }}
                        </option>
                    {% endfor %}
                </select>
            </div>
    
            <div class="col-md-4">
                <label class="form-label">Rota 2:</label>
                <select name="route2_id" class="form-select" required>
                    <option value="">Selecione a segunda rota</option>
                    {% for route in routes %}
                        <option value="{{ route.id }}" 
                            {% if route.id == route2 %}selected{% endif %}>
                            {{ route.name }}
                        </option>
                    {% endfor %}
                </select>
            </div>
    
            <div class="col-md-2">
                <label class="form-label">Data Inicial:</label>
                <input type="date" name="start_date" 
                    class="form-control" 
                    value="{{ start_date }}" 
                    max="{{ "now"|date("Y-m-d") }}" 
                    required>
            </div>
    
            <div class="col-md-2">
                <label class="form-label">Data Final:</label>
                <input type="date" name="end_date" 
                    class="form-control" 
                    value="{{ end_date }}" 
                    max="{{ "now"|date("Y-m-d") }}" 
                    required>
            </div>
    
            <div class="col-md-12 text-center mt-3">
                <button type="submit" class="btn btn-primary btn-lg">
                    <i class="bi bi-arrow-repeat"></i> Comparar Rotas
                </button>
            </div>
        </form>

    {% if dados %}
        <!-- Seção de Cards -->
        <div class="row mt-4">
            <div class="col-md-6 mb-4">
                <div class="card comparison-card route1-color shadow">
                    <div class="card-body">
                        <h5 class="card-title mb-3">
                            <i class="bi bi-signpost"></i> {{ route1_name }}
                        </h5>
                        <div class="row">
                            <div class="col-6 text-center">
                                <div class="display-5 text-primary mb-2">
                                    {{ dados.media1.velocidade|round(1) }}<small class="text-muted fs-6">km/h</small>
                                </div>
                                <span class="badge bg-primary">Velocidade Média</span>
                            </div>
                            <div class="col-6 text-center">
                                <div class="display-5 text-secondary mb-2">
                                    {{ dados.media1.tempo|round(1) }}<small class="text-muted fs-6">s</small>
                                </div>
                                <span class="badge bg-secondary">Tempo Médio</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-6 mb-4">
                <div class="card comparison-card route2-color shadow">
                    <div class="card-body">
                        <h5 class="card-title mb-3">
                            <i class="bi bi-signpost"></i> {{ route2_name }}
                        </h5>
                        <div class="row">
                            <div class="col-6 text-center">
                                <div class="display-5 text-primary mb-2">
                                    {{ dados.media2.velocidade|round(1) }}<small class="text-muted fs-6">km/h</small>
                                </div>
                                <span class="badge bg-primary">Velocidade Média</span>
                            </div>
                            <div class="col-6 text-center">
                                <div class="display-5 text-secondary mb-2">
                                    {{ dados.media2.tempo|round(1) }}<small class="text-muted fs-6">s</small>
                                </div>
                                <span class="badge bg-secondary">Tempo Médio</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Gráficos -->
        <div class="chart-container">
            <canvas id="comparisonChartVelocidade" class="mt-4"></canvas>
            <canvas id="comparisonChartTempo" class="mt-4"></canvas>
        </div>

        <!-- Tabelas -->
        <div class="row mt-4">
            <div class="col-md-6">
                <h4 class="text-center">{{ route1_name }}</h4>
                <table class="table table-striped" id="tabelaRota1">
                    <!-- ... -->
                </table>
            </div>
            <div class="col-md-6">
                <h4 class="text-center">{{ route2_name }}</h4>
                <table class="table table-striped" id="tabelaRota2">
                    <!-- ... -->
                </table>
            </div>
        </div>

        <!-- Botões de Exportação -->
        <div class="mt-4 d-flex justify-content-center gap-3 flex-wrap">
            <!-- ... -->
        </div>
    {% endif %}
</div>

<!-- Scripts na ordem CORRETA -->
<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"></script>

<script>
    // Resolver conflitos de jQuery
    var jq = jQuery.noConflict(true);
    
    document.addEventListener("DOMContentLoaded", function() {
        {% if dados %}
            // Verificação de segurança
            const hasValidData = {{ dados.rota1 is defined and dados.rota2 is defined ? 'true' : 'false' }};
            
            if(hasValidData) {
                try {
                    // Configuração dos gráficos
                    const chartConfig = {
                        responsive: true,
                        plugins: {
                            legend: { position: 'top' },
                            tooltip: { mode: 'index' }
                        }
                    };

                    // Dados dinâmicos
                    const labels = {{ dados.labels|json_encode|raw }};
                    const dataRota1 = {{ dados.rota1_values|json_encode|raw }};
                    const dataRota2 = {{ dados.rota2_values|json_encode|raw }};

                    // Inicializar gráficos
                    initChart('comparisonChartVelocidade', 'Velocidade', labels, dataRota1.velocidade, dataRota2.velocidade);
                    initChart('comparisonChartTempo', 'Tempo', labels, dataRota1.tempo, dataRota2.tempo);

                    // Inicializar DataTables
                    initDataTables();
                } catch(error) {
                    console.error('Erro na inicialização:', error);
                    alert('Erro ao processar dados. Verifique o console.');
                }
            }
        {% endif %}
    });

    function initChart(canvasId, metric, labels, data1, data2) {
        new Chart(document.getElementById(canvasId), {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    createDataset('Rota 1', data1, '#3c8dbc'),
                    createDataset('Rota 2', data2, '#d33724')
                ]
            },
            options: {
                responsive: true,
                scales: { y: { beginAtZero: true } },
                plugins: {
                    title: { 
                        display: true,
                        text: `Comparação de ${metric}`
                    }
                }
            }
        });
    }

    function createDataset(label, data, color) {
        return {
            label: label,
            data: data,
            borderColor: color,
            backgroundColor: color + '20',
            borderWidth: 2,
            tension: 0.3
        };
    }

    function initDataTables() {
        if(typeof jq.fn.DataTable === 'function') {
            jq('#tabelaRota1, #tabelaRota2').DataTable({
                paging: false,
                searching: false,
                info: false,
                ordering: true,
                order: [[0, 'desc']],
                language: {
                    url: '//cdn.datatables.net/plug-ins/1.13.7/i18n/pt-BR.json'
                },
                dom: 'Bfrtip',
                buttons: [
                    { extend: 'copy', text: 'Copiar' },
                    { extend: 'csv', text: 'CSV' },
                    { extend: 'excel', text: 'Excel' }
                ]
            });
        }
    }

    function exportData() {
        {% if dados and dados.merged_data %}
            try {
                const wsData = [
                    ['Data', 'Rota 1 Velocidade', 'Rota 1 Tempo', 'Rota 2 Velocidade', 'Rota 2 Tempo'],
                    ...{{ dados.merged_data|json_encode|raw }}.map(row => [
                        row.data,
                        row.velocidade1 ?? 'N/A',
                        row.tempo1 ?? 'N/A',
                        row.velocidade2 ?? 'N/A',
                        row.tempo2 ?? 'N/A'
                    ])
                ];
                
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.aoa_to_sheet(wsData);
                XLSX.utils.book_append_sheet(wb, ws, "Comparação");
                XLSX.writeFile(wb, `comparacao_rotas_${Date.now()}.xlsx`);
            } catch(error) {
                alert('Erro na exportação: ' + error.message);
            }
        {% else %}
            alert('Selecione ambas as rotas e período antes de exportar.');
        {% endif %}
    }

    function exportChart(chartId) {
        const canvas = document.getElementById(chartId);
        if(canvas) {
            const tempLink = document.createElement('a');
            tempLink.download = `${chartId}_${new Date().toISOString().slice(0,10)}.png`;
            tempLink.href = canvas.toDataURL('image/png');
            tempLink.click();
        }
    }
</script>

</body>
</html>