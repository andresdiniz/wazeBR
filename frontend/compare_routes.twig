<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comparação de Rotas</title>
    
    <!-- CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.dataTables.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

    <style>
        .comparison-card {
            border-left: 4px solid;
            transition: transform 0.3s;
            min-height: 180px;
        }
        .comparison-card:hover {
            transform: translateY(-5px);
        }
        .route1-color { border-color: #3c8dbc; }
        .route2-color { border-color: #d33724; }
        @media (max-width: 767px) {
            .chart-container { padding: 0 5px; }
            canvas { max-height: 300px; }
            .dataTables_wrapper { overflow-x: auto; }
            .comparison-card { margin-bottom: 1rem; }
        }
        .chart-title {
            font-size: 1.25rem;
            color: #333;
            margin-bottom: 1rem;
            text-align: center;
        }
    </style>
</head>
<body>

<div class="container mt-4">
    <h2 class="text-center mb-4">Comparação de Rotas</h2>
    
    <!-- Formulário Completo -->
    <form method="GET" class="row g-3 mb-4">
        <div class="col-md-4">
            <label class="form-label">Rota 1:</label>
            <select name="route1_id" class="form-select" required>
                <option value="">Selecione a primeira rota</option>
                {% for route in routes %}
                    <option value="{{ route.id }}" 
                        {% if route.id == route1 %}selected{% endif %}>
                        {{ route.name }}
                    </option>
                {% endfor %}
            </select>
        </div>

        <div class="col-md-4">
            <label class="form-label">Rota 2:</label>
            <select name="route2_id" class="form-select" required>
                <option value="">Selecione a segunda rota</option>
                {% for route in routes %}
                    <option value="{{ route.id }}" 
                        {% if route.id == route2 %}selected{% endif %}>
                        {{ route.name }}
                    </option>
                {% endfor %}
            </select>
        </div>

        <div class="col-md-2">
            <label class="form-label">Data Inicial:</label>
            <input type="date" name="start_date" 
                class="form-control" 
                value="{{ start_date }}" 
                max="{{ "now"|date("Y-m-d") }}" 
                required>
        </div>

        <div class="col-md-2">
            <label class="form-label">Data Final:</label>
            <input type="date" name="end_date" 
                class="form-control" 
                value="{{ end_date }}" 
                required>
        </div>

        <div class="col-md-12 text-center mt-3">
            <button type="submit" class="btn btn-primary btn-lg">
                <i class="bi bi-arrow-repeat"></i> Comparar Rotas
            </button>
        </div>
    </form>

    {% if dados %}
        <!-- Seção de Cards -->
        <div class="row mt-4">
            <div class="col-md-6 mb-4">
                <div class="card comparison-card route1-color shadow">
                    <div class="card-body">
                        <h5 class="card-title mb-3">
                            <i class="bi bi-signpost"></i> {{ route1_name }}
                        </h5>
                        <div class="row">
                            <div class="col-6 text-center">
                                <div class="display-5 text-primary mb-2">
                                    {{ dados.media1.velocidade|round(1) }}<small class="text-muted fs-6">km/h</small>
                                </div>
                                <span class="badge bg-primary">Velocidade Média</span>
                            </div>
                            <div class="col-6 text-center">
                                <div class="display-5 text-secondary mb-2">
                                    {{ dados.media1.tempo|round(1) }}<small class="text-muted fs-6">s</small>
                                </div>
                                <span class="badge bg-secondary">Tempo Médio</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-6 mb-4">
                <div class="card comparison-card route2-color shadow">
                    <div class="card-body">
                        <h5 class="card-title mb-3">
                            <i class="bi bi-signpost"></i> {{ route2_name }}
                        </h5>
                        <div class="row">
                            <div class="col-6 text-center">
                                <div class="display-5 text-primary mb-2">
                                    {{ dados.media2.velocidade|round(1) }}<small class="text-muted fs-6">km/h</small>
                                </div>
                                <span class="badge bg-primary">Velocidade Média</span>
                            </div>
                            <div class="col-6 text-center">
                                <div class="display-5 text-secondary mb-2">
                                    {{ dados.media2.tempo|round(1) }}<small class="text-muted fs-6">s</small>
                                </div>
                                <span class="badge bg-secondary">Tempo Médio</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Gráficos -->
        <div class="chart-container">
            <h4 class="chart-title">Comparação de Velocidades</h4>
            <canvas id="comparisonChartVelocidade" class="mt-4"></canvas>
            
            <h4 class="chart-title mt-5">Comparação de Tempos</h4>
            <canvas id="comparisonChartTempo" class="mt-4"></canvas>
        </div>

        <!-- Tabelas -->
        <div class="row mt-4">
            <div class="col-md-6">
                <h4 class="text-center mb-3">{{ route1_name }}</h4>
                <table class="table table-striped table-hover" id="tabelaRota1">
                    <thead class="table-light">
                        <tr>
                            <th>Data</th>
                            <th>Velocidade (km/h)</th>
                            <th>Tempo (s)</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in dados.rota1 %}
                            <tr>
                                <td>{{ item.data|date('d/m/Y H:i') }}</td>
                                <td>{{ item.velocidade|number_format(1) }}</td>
                                <td>{{ item.tempo|number_format(1) }}</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <div class="col-md-6">
                <h4 class="text-center mb-3">{{ route2_name }}</h4>
                <table class="table table-striped table-hover" id="tabelaRota2">
                    <thead class="table-light">
                        <tr>
                            <th>Data</th>
                            <th>Velocidade (km/h)</th>
                            <th>Tempo (s)</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in dados.rota2 %}
                            <tr>
                                <td>{{ item.data|date('d/m/Y H:i') }}</td>
                                <td>{{ item.velocidade|number_format(1) }}</td>
                                <td>{{ item.tempo|number_format(1) }}</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Botões de Exportação -->
        <div class="mt-4 d-flex justify-content-center gap-3 flex-wrap">
            <button class="btn btn-success px-4" onclick="exportData()">
                <i class="bi bi-file-earmark-spreadsheet"></i> Exportar Dados
            </button>
            <button class="btn btn-info px-4" onclick="exportChart('comparisonChartVelocidade')">
                <i class="bi bi-image"></i> Exportar Gráfico Velocidade
            </button>
            <button class="btn btn-info px-4" onclick="exportChart('comparisonChartTempo')">
                <i class="bi bi-image"></i> Exportar Gráfico Tempo
            </button>
        </div>
    {% endif %}
</div>

<!-- Scripts na ordem CORRETA -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
<script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>
<script>
    var jq = jQuery.noConflict(true);

    const chartCommonConfig = {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'top',
                labels: {
                    padding: 20,
                    font: { size: 14 }
                }
            },
            tooltip: {
                mode: 'index',
                intersect: false,
                backgroundColor: 'rgba(0,0,0,0.85)',
                titleFont: { size: 16 },
                bodyFont: { size: 14 },
                padding: 12
            }
        },
        scales: {
            x: {
                type: 'time',
                time: {
                    tooltipFormat: 'dd/MM HH:mm',
                    displayFormats: {
                        hour: 'dd/MM HH:mm',
                        day: 'dd/MM',
                    }
                }
            }
        },
            y: {
                beginAtZero: true,
                title: {
                    display: true,
                    text: 'Valores',
                    font: { size: 14 }
                },
                grid: {
                    color: 'rgba(0,0,0,0.1)'
                }
            }
        },
        elements: {
            line: {
                tension: 0.3,
                borderWidth: 2
            },
            point: {
                radius: 4,
                hoverRadius: 6,
                backgroundColor: '#ffffff'
            }
        }
    };

    document.addEventListener("DOMContentLoaded", function() {
        {% if dados %}
            try {
                console.log('Dados para gráficos:', { dados: {{ dados|json_encode|raw }} });

                const processData = (data) => data ? data.map(v => v ?? null) : [];
                const labels = {{ dados.labels|json_encode|raw }}.map(date => new Date(date));
                
                initComparativeChart('comparisonChartVelocidade', 'Velocidade (km/h)', labels,
                    processData({{ dados.rota1_values.velocidade|json_encode|raw }}),
                    processData({{ dados.rota2_values.velocidade|json_encode|raw }}),
                    ['#3c8dbc', '#d33724']
                );

                initComparativeChart('comparisonChartTempo', 'Tempo (segundos)', labels,
                    processData({{ dados.rota1_values.tempo|json_encode|raw }}),
                    processData({{ dados.rota2_values.tempo|json_encode|raw }}),
                    ['#3c8dbc', '#d33724']
                );

                initDataTables();
            } catch (error) {
                console.error('Erro na inicialização:', error);
                alert(`Erro: ${error.message}\n\nOs gráficos não serão renderizados.`);
            }
        {% endif %}
    });

    function initComparativeChart(canvasId, title, labels, data1, data2, colors) {
        const ctx = document.getElementById(canvasId);
        if (!ctx) return;

        requestAnimationFrame(() => {
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels,
                    datasets: [
                        {
                            label: `Rota 1 - ${title}`,
                            data: data1,
                            borderColor: colors[0],
                            backgroundColor: `${colors[0]}20`,
                            borderWidth: 2,
                            tension: 0.3,
                            spanGaps: true
                        },
                        {
                            label: `Rota 2 - ${title}`,
                            data: data2,
                            borderColor: colors[1],
                            backgroundColor: `${colors[1]}20`,
                            borderWidth: 2,
                            tension: 0.3,
                            spanGaps: true
                        }
                    ]
                },
                options: {
                    ...chartCommonConfig,
                    plugins: {
                        ...chartCommonConfig.plugins,
                        title: {
                            display: true,
                            text: title,
                            font: { size: 18 }
                        }
                    }
                }
            });
        });
    }

    function initDataTables() {
        if (typeof jq.fn.DataTable !== 'function') return;

        const tableConfig = {
            paging: true,
            pageLength: 10,
            searching: false,
            info: true,
            order: [[0, 'desc']],
            language: { url: '//cdn.datatables.net/plug-ins/1.13.7/i18n/pt-BR.json' },
            columnDefs: [
                {
                    targets: 0,
                    type: 'date',
                    render: function(dados) {
                        return dados.merged_data.data ? new Date(dados.merged_data.data).toLocaleString('pt-BR') : '';
                    }
                },
                { targets: [1, 2], className: 'dt-body-right' }
            ],
            dom: 'Bfrtip',
            buttons: [
                {
                    extend: 'excel',
                    text: 'Exportar para Excel',
                    exportOptions: { modifier: { page: 'all' } }
                }
            ]
        };
        
        jq('#tabelaRota1, #tabelaRota2').DataTable(tableConfig);
    }

    function exportData() {
        {% if dados and dados.merged_data %}
            try {
                const headers = ['Data', 'Rota 1 Velocidade (km/h)', 'Rota 1 Tempo (s)', 'Rota 2 Velocidade (km/h)', 'Rota 2 Tempo (s)'];
                const rows = {{ dados.merged_data|json_encode|raw }}.map(row => [
                    row.data ? new Date(row.data).toLocaleString('pt-BR') : 'N/A',
                    row.velocidade1?.toFixed(1) ?? 'N/A',
                    row.tempo1?.toFixed(1) ?? 'N/A',
                    row.velocidade2?.toFixed(1) ?? 'N/A',
                    row.tempo2?.toFixed(1) ?? 'N/A'
                ]);

                const ws = XLSX.utils.aoa_to_sheet([headers, ...rows]);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Comparação");
                XLSX.writeFile(wb, `Comparação_Rotas_${new Date().toISOString().slice(0,10)}.xlsx`);
            } catch (error) {
                console.error('Erro na exportação:', error);
                alert('Falha na exportação: ' + error.message);
            }
        {% else %}
            alert('Selecione ambas as rotas e um período válido antes de exportar.');
        {% endif %}
    }

    function exportChart(chartId) {
        const canvas = document.getElementById(chartId);
        if (!canvas) {
            alert('Elemento do gráfico não encontrado!');
            return;
        }

        try {
            const tempLink = document.createElement('a');
            tempLink.download = `${chartId}_${new Date().toISOString().slice(0,10)}.png`;
            tempLink.href = canvas.toDataURL('image/png', 1.0);
            tempLink.click();
        } catch (error) {
            console.error('Erro na exportação do gráfico:', error);
            alert('Falha ao exportar gráfico: ' + error.message);
        }
    }
</script>