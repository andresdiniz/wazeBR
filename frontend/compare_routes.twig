<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comparação de Rotas</title>

    <!-- CSS com carregamento otimizado -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    
    <!-- Carregamento adiado de CSS não críticos -->
    <link rel="preload" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <link rel="preload" href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.dataTables.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript>
        <link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css">
        <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.dataTables.min.css">
    </noscript>

    <style>
        /* Estilos críticos de page load */
        .comparison-card {
            border-left: 4px solid;
            transition: transform 0.3s;
            min-height: 150px;
        }
        .comparison-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
        }
        .route1-color { border-color: #3c8dbc; }
        .route2-color { border-color: #d33724; }
        
        .chart-title {
            font-size: 1.25rem;
            color: #333;
            margin-bottom: 1rem;
            text-align: center;
        }
        
        .chart-container {
            position: relative;
            height: 400px;
            margin: 20px 0;
        }
        
        .stats-badge {
            font-size: 0.9rem;
            padding: 0.35rem 0.65rem;
        }
        
        .metric-card {
            transition: all 0.3s ease;
        }
        
        .metric-card:hover {
            transform: translateY(-3px);
        }
        
        .comparison-diff {
            font-size: 0.9rem;
            padding: 0.2rem 0.5rem;
            border-radius: 0.25rem;
            margin-top: 0.3rem;
        }
        
        .positive-diff { 
            background-color: #d4edda; 
            color: #155724;
        }
        
        .negative-diff { 
            background-color: #f8d7da; 
            color: #721c24;
        }
        
        /* Lazy loading spinner */
        .spinner-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255,255,255,0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .spinner-border {
            width: 3rem;
            height: 3rem;
        }
        
        /* Otimizações para mobile */
        @media (max-width: 767px) {
            .chart-container { 
                height: 300px;
                padding: 0 5px;
            }
            .comparison-card { margin-bottom: 1rem; }
            .dataTables_wrapper { 
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            .btn-export {
                width: 100%;
                margin-bottom: 0.5rem;
            }
        }
    </style>
</head>
<body>

<!-- Loading Spinner -->
<div class="spinner-overlay" id="loadingSpinner">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Carregando...</span>
    </div>
</div>

<div class="container mt-4">
    <h2 class="text-center mb-4">Comparação de Rotas</h2>

    <!-- Formulário Otimizado -->
    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <form method="GET" class="row g-3" id="routeComparisonForm">
                <div class="col-md-4">
                    <label class="form-label">Rota 1:</label>
                    <select name="route1_id" class="form-select" required>
                        <option value="">Selecione a primeira rota</option>
                        {% for route in routes %}
                            <option value="{{ route.id }}"
                                    {% if route.id == route1 %}selected{% endif %}>
                                    {{ route.name }}
                            </option>
                        {% endfor %}
                    </select>
                </div>

                <div class="col-md-4">
                    <label class="form-label">Rota 2:</label>
                    <select name="route2_id" class="form-select" required>
                        <option value="">Selecione a segunda rota</option>
                        {% for route in routes %}
                            <option value="{{ route.id }}"
                                    {% if route.id == route2 %}selected{% endif %}>
                                    {{ route.name }}
                            </option>
                        {% endfor %}
                    </select>
                </div>

                <div class="col-md-2">
                    <label class="form-label">Data Inicial:</label>
                    <input type="date" name="start_date"
                           class="form-control"
                           value="{{ start_date }}"
                           max="{{ "now"|date("Y-m-d") }}"
                           required>
                </div>

                <div class="col-md-2">
                    <label class="form-label">Data Final:</label>
                    <input type="date" name="end_date"
                           class="form-control"
                           value="{{ end_date }}"
                           required>
                </div>

                <div class="col-md-12 text-center mt-3">
                    <button type="submit" class="btn btn-primary px-4" id="compareButton">
                        <i class="bi bi-arrow-repeat"></i> Comparar Rotas
                    </button>
                </div>
            </form>
        </div>
    </div>

    {% if dados %}
        <!-- Dashboard Cards -->
        <div class="row mt-4">
            <!-- Rota 1 Card -->
            <div class="col-md-6 mb-4">
                <div class="card comparison-card route1-color shadow h-100">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="card-title m-0">
                                <i class="bi bi-signpost"></i> {{ route1_name }}
                            </h5>
                            <span class="badge bg-secondary stats-badge">
                                {{ dados.estatisticas.rota1.total_registros }} registros
                            </span>
                        </div>
                        
                        <div class="row">
                            <!-- Velocidade -->
                            <div class="col-6">
                                <div class="metric-card p-2 text-center">
                                    <div class="display-5 text-primary mb-1">
                                        {{ dados.media1.velocidade|round(1) }}<small class="text-muted fs-6">km/h</small>
                                    </div>
                                    <span class="badge bg-primary">Velocidade Média</span>
                                    
                                    {% if dados.estatisticas.rota1.diferenca_percentual.velocidade != 0 %}
                                        <div class="comparison-diff 
                                            {% if dados.estatisticas.rota1.diferenca_percentual.velocidade > 0 %}positive-diff{% else %}negative-diff{% endif %}">
                                            {{ dados.estatisticas.rota1.diferenca_percentual.velocidade|round(1) }}% vs Rota 2
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <!-- Tempo -->
                            <div class="col-6">
                                <div class="metric-card p-2 text-center">
                                    <div class="display-5 text-secondary mb-1">
                                        {{ dados.media1.tempo|round(1) }}<small class="text-muted fs-6">s</small>
                                    </div>
                                    <span class="badge bg-secondary">Tempo Médio</span>
                                    
                                    {% if dados.estatisticas.rota1.diferenca_percentual.tempo != 0 %}
                                        <div class="comparison-diff 
                                            {% if dados.estatisticas.rota1.diferenca_percentual.tempo < 0 %}positive-diff{% else %}negative-diff{% endif %}">
                                            {{ dados.estatisticas.rota1.diferenca_percentual.tempo|round(1) }}% vs Rota 2
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Rota 2 Card -->
            <div class="col-md-6 mb-4">
                <div class="card comparison-card route2-color shadow h-100">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="card-title m-0">
                                <i class="bi bi-signpost"></i> {{ route2_name }}
                            </h5>
                            <span class="badge bg-secondary stats-badge">
                                {{ dados.estatisticas.rota2.total_registros }} registros
                            </span>
                        </div>
                        
                        <div class="row">
                            <!-- Velocidade -->
                            <div class="col-6">
                                <div class="metric-card p-2 text-center">
                                    <div class="display-5 text-primary mb-1">
                                        {{ dados.media2.velocidade|round(1) }}<small class="text-muted fs-6">km/h</small>
                                    </div>
                                    <span class="badge bg-primary">Velocidade Média</span>
                                </div>
                            </div>
                            
                            <!-- Tempo -->
                            <div class="col-6">
                                <div class="metric-card p-2 text-center">
                                    <div class="display-5 text-secondary mb-1">
                                        {{ dados.media2.tempo|round(1) }}<small class="text-muted fs-6">s</small>
                                    </div>
                                    <span class="badge bg-secondary">Tempo Médio</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Gráficos Responsivos -->
        <div class="row">
            <div class="col-12">
                <div class="card shadow-sm mb-4">
                    <div class="card-body">
                        <ul class="nav nav-tabs" id="chartTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="velocidade-tab" data-bs-toggle="tab" 
                                        data-bs-target="#tab-velocidade" type="button" role="tab">
                                    Velocidade
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="tempo-tab" data-bs-toggle="tab" 
                                        data-bs-target="#tab-tempo" type="button" role="tab">
                                    Tempo
                                </button>
                            </li>
                        </ul>
                        
                        <div class="tab-content mt-3" id="chartTabsContent">
                            <!-- Tab Velocidade -->
                            <div class="tab-pane fade show active" id="tab-velocidade" role="tabpanel">
                                <div class="chart-container">
                                    <canvas id="comparisonChartVelocidade"></canvas>
                                </div>
                            </div>
                            
                            <!-- Tab Tempo -->
                            <div class="tab-pane fade" id="tab-tempo" role="tabpanel">
                                <div class="chart-container">
                                    <canvas id="comparisonChartTempo"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabelas -->
        <div class="row mt-4">
            <div class="col-md-6 mb-4">
                <div class="card shadow-sm h-100">
                    <div class="card-header bg-white">
                        <h5 class="mb-0">{{ route1_name }}</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-sm table-striped table-hover" id="tabelaRota1">
                                <thead class="table-light">
                                    <tr>
                                        <th>Data</th>
                                        <th>Velocidade (km/h)</th>
                                        <th>Tempo (s)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for item in dados.rota1 %}
                                        <tr>
                                            <td>{{ item.data|date('d/m/Y H:i') }}</td>
                                            <td>{{ item.velocidade|number_format(1) }}</td>
                                            <td>{{ item.tempo|number_format(1) }}</td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-6 mb-4">
                <div class="card shadow-sm h-100">
                    <div class="card-header bg-white">
                        <h5 class="mb-0">{{ route2_name }}</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-sm table-striped table-hover" id="tabelaRota2">
                                <thead class="table-light">
                                    <tr>
                                        <th>Data</th>
                                        <th>Velocidade (km/h)</th>
                                        <th>Tempo (s)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for item in dados.rota2 %}
                                        <tr>
                                            <td>{{ item.data|date('d/m/Y H:i') }}</td>
                                            <td>{{ item.velocidade|number_format(1) }}</td>
                                            <td>{{ item.tempo|number_format(1) }}</td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Botões de Exportação -->
        <div class="card shadow-sm mb-4">
            <div class="card-body">
                <div class="d-flex flex-wrap justify-content-center gap-3">
                    <button class="btn btn-info px-4 btn-export" onclick="exportChart('comparisonChartVelocidade')">
                        <i class="bi bi-image"></i> Exportar Gráfico Velocidade
                    </button>
                    <button class="btn btn-info px-4 btn-export" onclick="exportChart('comparisonChartTempo')">
                        <i class="bi bi-image"></i> Exportar Gráfico Tempo
                    </button>
                </div>
            </div>
        </div>
    {% endif %}
</div>

<!-- Scripts com carregamento otimizado -->
<!-- jQuery carregado primeiro -->
<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<!-- Scripts adicionais -->
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>

<!-- Scripts opcionais, carregados dinamicamente -->
<script>
    // Carregador de scripts dinâmico
    function loadScript(url, callback) {
        const script = document.createElement('script');
        script.src = url;
        script.onload = callback;
        document.head.appendChild(script);
    }
    
    // Estado global da aplicação
    let comparisonChartVelocidade = null;
    let comparisonChartTempo = null;
    let dataTablesLoaded = false;
    
    // Esconder spinner após carregamento
    document.addEventListener("DOMContentLoaded", function() {
        document.getElementById('loadingSpinner').style.display = 'none';
        
        // Mostrar spinner durante o envio do formulário
        document.getElementById('routeComparisonForm')?.addEventListener('submit', function() {
            document.getElementById('loadingSpinner').style.display = 'flex';
        });
        
        {% if dados %}
            initializeApp();
        {% endif %}
    });
    
    // Função para inicializar o aplicativo após os dados estarem disponíveis
    function initializeApp() {
        try {
            console.log('Inicializando aplicativo com dados disponíveis');
            
            // Carregar Chart.js e inicializar gráficos
            initCharts();
            
            // Carregar DataTables sob demanda
            loadDataTables();
        } catch (error) {
            console.error('Erro na inicialização:', error);
            alert(`Erro: ${error.message}\n\nO aplicativo pode não funcionar corretamente.`);
        }
    }
    
    // Inicialização de gráficos
    function initCharts() {
        {% if dados %}
            try {
                const labels = {{ dados.labels|json_encode|raw }}.map(date => new Date(date));
                
                initComparativeChart('comparisonChartVelocidade', 'Velocidade (km/h)', labels,
                    {{ dados.rota1_values.velocidade|json_encode|raw }},
                    {{ dados.rota2_values.velocidade|json_encode|raw }},
                    ['#3c8dbc', '#d33724'],
                    '{{ route1_name }}',
                    '{{ route2_name }}'
                );

                initComparativeChart('comparisonChartTempo', 'Tempo (segundos)', labels,
                    {{ dados.rota1_values.tempo|json_encode|raw }},
                    {{ dados.rota2_values.tempo|json_encode|raw }},
                    ['#3c8dbc', '#d33724'],
                    '{{ route1_name }}',
                    '{{ route2_name }}'
                );
                
                // Ajustar tamanho dos gráficos quando as tabs são alteradas
                const chartTabs = document.getElementById('chartTabs');
                if (chartTabs) {
                    chartTabs.addEventListener('shown.bs.tab', function (event) {
                        if (event.target.id === 'velocidade-tab') {
                            if (comparisonChartVelocidade) comparisonChartVelocidade.resize();
                        } else if (event.target.id === 'tempo-tab') {
                            if (comparisonChartTempo) comparisonChartTempo.resize();
                        }
                    });
                }
            } catch (error) {
                console.error('Erro na inicialização dos gráficos:', error);
            }
        {% endif %}
    }
    
    // Função otimizada para criar gráficos comparativos
    function initComparativeChart(canvasId, title, labels, data1, data2, colors, label1, label2) {
        const ctx = document.getElementById(canvasId);
        if (!ctx) return;
    
        // Destruir gráfico existente se houver
        if (window[canvasId]) {
            window[canvasId].destroy();
        }
        
        // Reduzir pontos de dados para melhor desempenho se exceder limite
        const MAX_DATA_POINTS = 300;  // Limite máximo de pontos para desempenho
        
        let processedLabels = labels;
        let processedData1 = data1;
        let processedData2 = data2;
        
        if (labels.length > MAX_DATA_POINTS) {
            const step = Math.ceil(labels.length / MAX_DATA_POINTS);
            processedLabels = labels.filter((_, i) => i % step === 0);
            
            processedData1 = [];
            processedData2 = [];
            
            for (let i = 0; i < data1.length; i++) {
                if (i % step === 0) {
                    processedData1.push(data1[i]);
                    processedData2.push(data2[i]);
                }
            }
            
            console.log(`Reduzindo pontos de dados de ${labels.length} para ${processedLabels.length}`);
        }
        
        // Configuração de gráfico otimizada
        const chartConfig = {
            type: 'line',
            data: {
                labels: processedLabels,
                datasets: [
                    {
                        label: `${label1} - ${title}`,
                        data: processedData1,
                        borderColor: colors[0],
                        backgroundColor: `${colors[0]}20`,
                        borderWidth: 2,
                        tension: 0.3,
                        spanGaps: true,
                        pointRadius: processedLabels.length > 100 ? 0 : 3,  // Remover pontos para melhor desempenho
                        pointHoverRadius: 5
                    },
                    {
                        label: `${label2} - ${title}`,
                        data: processedData2,
                        borderColor: colors[1],
                        backgroundColor: `${colors[1]}20`,
                        borderWidth: 2,
                        tension: 0.3,
                        spanGaps: true,
                        pointRadius: processedLabels.length > 100 ? 0 : 3,
                        pointHoverRadius: 5
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                animation: {
                    duration: processedLabels.length > 100 ? 0 : 1000  // Desativar animação para datasets grandes
                },
                plugins: {
                    legend: {
                        position: 'top',
                        labels: { padding: 20, font: { size: 14 } }
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        backgroundColor: 'rgba(0,0,0,0.85)',
                        titleFont: { size: 16 },
                        bodyFont: { size: 14 },
                        padding: 12,
                        callbacks: {
                            label: function(context) {
                                let value = context.raw;
                                return `${context.dataset.label}: ${value !== null ? value.toFixed(1) : 'N/A'}`;
                            }
                        }
                    },
                    title: {
                        display: true,
                        text: title,
                        font: { size: 18 }
                    }
                },
                scales: {
                    x: {
                        type: 'time',
                        time: {
                            tooltipFormat: 'dd/MM HH:mm',
                            displayFormats: {
                                hour: 'dd/MM HH:mm',
                                day: 'dd/MM',
                            }
                        },
                        ticks: {
                            maxTicksLimit: 10,
                            autoSkip: true
                        }
                    },
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: title,
                            font: { size: 14 }
                        },
                        grid: {
                            color: 'rgba(0,0,0,0.1)'
                        }
                    }
                },
                elements: {
                    line: {
                        tension: 0.3,
                        borderWidth: 2
                    },
                    point: {
                        radius: processedLabels.length > 100 ? 0 : 3,
                        hoverRadius: 6,
                        backgroundColor: '#ffffff'
                    }
                },
                interaction: {
                    mode: 'nearest',
                    axis: 'x',
                    intersect: false
                }
            }
        };
    
        // Criar novo gráfico
        window[canvasId] = new Chart(ctx, chartConfig);
        
        return window[canvasId];
    }

    // Carregamento sob demanda do DataTables
    function loadDataTables() {
        if (dataTablesLoaded) return;
        
        const scripts = [
            'https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js',
            'https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js',
            'https://cdn.datatables.net/plug-ins/1.13.7/sorting/datetime-moment.js'
        ];
        
        let loaded = 0;
        scripts.forEach(url => {
            loadScript(url, function() {
                loaded++;
                if (loaded === scripts.length) {
                    initDataTables();
                    
                    // Carregar scripts de exportação
                    loadScript('https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js');
                    loadScript('https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js');
                    loadScript('https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js');
                    
                    dataTablesLoaded = true;
                }
            });
        });
    }

    function initDataTables() {
        if (typeof $.fn.DataTable !== 'function') return;
    
        // Configurar plugin moment para ordenação de datas
        if ($.fn.dataTable.moment) {
            $.fn.dataTable.moment('DD/MM/YYYY HH:mm');
        }
    
        const tableConfig = {
            pageLength: 10,
            lengthMenu: [[10, 25, 50, -1], [10, 25, 50, "Todos"]],
            searching: true,
            info: true,
            ordering: true,
            autoWidth: false,
            responsive: true,
            order: [[0, 'desc']],
            language: { 
                url: '//cdn.datatables.net/plug-ins/1.13.7/i18n/pt-BR.json' 
            },
            deferRender: true,  // Melhora desempenho para tabelas grandes
            columnDefs: [
                { type: 'datetime-moment', targets: 0 },
                { type: 'num', targets: [1, 2] }
            ]
        };
    
        $('#tabelaRota1').DataTable(tableConfig);
        $('#tabelaRota2').DataTable(tableConfig);
    }

    // Exportação de gráficos para PNG
    function exportChart(chartId) {
        const canvas = document.getElementById(chartId);
        if (!canvas) {
            alert('Elemento do gráfico não encontrado!');
            return;
        }

        try {
            // Mais qualidade na exportação
            const originalDevicePixelRatio = window.devicePixelRatio;
            window.devicePixelRatio = 3; // Maior qualidade
            
            const chart = window[chartId];
            if (chart) {
                chart.resize();
                chart.render();
            }
            
            const chartType = chartId.includes('Velocidade') ? 'Velocidade' : 'Tempo';
            const fileName = `Comparacao_${chartType}_${new Date().toISOString().slice(0,10)}.png`;
            
            // Criar link temporário para download
            const tempLink = document.createElement('a');
            tempLink.download = fileName;
            tempLink.href = canvas.toDataURL('image/png', 1.0);
            document.body.appendChild(tempLink);
            tempLink.click();
            document.body.removeChild(tempLink);
            
            // Restaurar resolução
            window.devicePixelRatio = originalDevicePixelRatio;
            if (chart) {
                chart.resize();
                chart.render();
            }
        } catch (error) {
            console.error('Erro na exportação do gráfico:', error);
            alert('Falha ao exportar gráfico: ' + error.message);
        }
    }
</script>