<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>

<style>
    :root {
        --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        --success-gradient: linear-gradient(135deg, #1cc88a 0%, #13855c 100%);
        --warning-gradient: linear-gradient(135deg, #f6c23e 0%, #dda20a 100%);
        --danger-gradient: linear-gradient(135deg, #e74a3b 0%, #be2617 100%);
        --info-gradient: linear-gradient(135deg, #36b9cc 0%, #258391 100%);
        --card-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        --card-shadow-hover: 0 8px 30px rgba(0, 0, 0, 0.12);
        
        /* Variáveis para modo claro */
        --color-bg: #f8f9fc;
        --color-card-bg: #ffffff;
        --color-text-primary: #2c3e50;
        --color-text-secondary: #858796;
        --color-border: #e3e6f0;
    }

    /* Modo Escuro */
    body.dark-mode {
        --color-bg: #1e212b;
        --color-card-bg: #272c38;
        --color-text-primary: #e4e6eb;
        --color-text-secondary: #a9aabc;
        --color-border: #3a4154;
    }

    /* Estilos Base */
    body {
        background-color: var(--color-bg);
    }
    
    /* Novo: Ajuste de Layout */
    .container-fluid {
        /* Garante um espaçamento inferior generoso para evitar sobreposição com o rodapé/footer */
        padding-bottom: 5rem !important; 
    }
    
    /* ... [Restante do seu CSS] ... */

</style>

<div class="container-fluid px-3 px-lg-4 mt-4">
    
    <div class="page-header mb-4 fade-in">
        <h1 class="fw-bold"><i class="fas fa-tachometer-alt me-2 text-primary"></i>Dashboard Principal</h1>
        <p class="text-secondary subtitle">Visão geral e status em tempo real do sistema.</p>
    </div>

    <div class="row mb-4">
        {# Cartão 1 #}
        <div class="col-xl-3 col-md-6 mb-4 fade-in">
            <div class="modern-card border-start-primary">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col me-2">
                            <div class="text-xs fw-bold text-primary text-uppercase mb-1">Entregas Pendentes</div>
                            <div class="h5 mb-0 fw-bold text-primary-dark" id="pendingDeliveries">{{ data.pending_deliveries|default(0) }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-box-open fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        {# Cartão 2 #}
        <div class="col-xl-3 col-md-6 mb-4 fade-in" style="animation-delay: 0.1s;">
            <div class="modern-card border-start-success">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col me-2">
                            <div class="text-xs fw-bold text-success text-uppercase mb-1">Total de Clientes</div>
                            <div class="h5 mb-0 fw-bold text-success-dark" id="totalClients">{{ data.total_clients|default(0) }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-users fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        {# Cartão 3 #}
        <div class="col-xl-3 col-md-6 mb-4 fade-in" style="animation-delay: 0.2s;">
            <div class="modern-card border-start-warning">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col me-2">
                            <div class="text-xs fw-bold text-warning text-uppercase mb-1">Avisos e Pendências</div>
                            <div class="h5 mb-0 fw-bold text-warning-dark" id="systemAlerts">{{ data.system_alerts|default(0) }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-exclamation-triangle fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        {# Cartão 4 (Novo - Temperatura Média/Indicador Geral) #}
        <div class="col-xl-3 col-md-6 mb-4 fade-in" style="animation-delay: 0.3s;">
            <div class="modern-card border-start-info">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col me-2">
                            <div class="text-xs fw-bold text-info text-uppercase mb-1">Temperatura Média do Sistema</div>
                            <div class="h5 mb-0 fw-bold text-info-dark" id="avgSystemTemp">{{ data.avg_system_temp|default('28.5°C') }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-thermometer-half fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row mb-4">
        {# Gráfico Principal (Vendas/Atividades) #}
        <div class="col-xl-8 col-lg-7 mb-4 fade-in" style="animation-delay: 0.4s;">
            <div class="modern-card shadow-lg h-100">
                <div class="modern-card-header py-3 d-flex flex-row align-items-center justify-content-between border-start-info">
                    <h6 class="m-0 fw-bold text-primary"><i class="fas fa-chart-bar me-2"></i>Atividade Mensal do Sistema</h6>
                </div>
                <div class="card-body">
                    <canvas id="monthlyActivityChart" style="height: 350px;"></canvas>
                </div>
            </div>
        </div>

        {# Mapa de Congestionamento (Leaflet) #}
        <div class="col-xl-4 col-lg-5 mb-4 fade-in" style="animation-delay: 0.5s;">
            <div class="modern-card shadow-lg h-100">
                <div class="modern-card-header py-3 d-flex flex-row align-items-center justify-content-between border-start-warning">
                    <h6 class="m-0 fw-bold text-warning"><i class="fas fa-map-marked-alt me-2"></i>Mapa de Congestionamento</h6>
                </div>
                <div class="card-body p-2">
                    <div id="congestionMap" style="height: 350px; border-radius: 0.5rem;"></div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row">
        
        {# Tabela de Tarefas Pendentes #}
        <div class="col-xl-7 col-lg-6 mb-4 fade-in" style="animation-delay: 0.6s;">
            <div class="modern-card shadow-lg h-100">
                <div class="modern-card-header py-3 d-flex flex-row align-items-center justify-content-between border-start-success">
                    <h6 class="m-0 fw-bold text-success"><i class="fas fa-tasks me-2"></i>Tarefas Pendentes</h6>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="bg-light-gray">
                                <tr>
                                    <th>Tarefa</th>
                                    <th>Prioridade</th>
                                    <th>Status</th>
                                    <th>Prazo</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% if data.pending_tasks is not empty %}
                                    {% for task in data.pending_tasks|slice(0, 5) %}
                                        <tr>
                                            <td>{{ task.description }}</td>
                                            <td>
                                                <span class="badge 
                                                    {% if task.priority == 'Alta' %}bg-danger
                                                    {% elseif task.priority == 'Média' %}bg-warning
                                                    {% else %}bg-success
                                                    {% endif %}">
                                                    {{ task.priority }}
                                                </span>
                                            </td>
                                            <td><i class="fas fa-clock me-1 text-info"></i>{{ task.status }}</td>
                                            <td class="text-secondary">{{ task.due_date }}</td>
                                        </tr>
                                    {% endfor %}
                                {% else %}
                                    <tr><td colspan="4" class="text-center text-secondary py-4">Nenhuma tarefa pendente.</td></tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        {# Progresso de Projetos #}
        <div class="col-xl-5 col-lg-6 mb-4 fade-in" style="animation-delay: 0.7s;">
            <div class="modern-card shadow-lg h-100">
                <div class="modern-card-header py-3 d-flex flex-row align-items-center justify-content-between border-start-primary">
                    <h6 class="m-0 fw-bold text-primary"><i class="fas fa-project-diagram me-2"></i>Progresso dos Projetos</h6>
                </div>
                <div class="card-body">
                    {% if data.project_progress is not empty %}
                        {% for project in data.project_progress %}
                            <h4 class="small fw-bold mt-2">{{ project.name }} <span class="float-end text-{{ project.color }}">{{ project.progress }}%</span></h4>
                            <div class="progress mb-4">
                                <div class="progress-bar bg-{{ project.color }}" role="progressbar" style="width: {{ project.progress }}%" aria-valuenow="{{ project.progress }}" aria-valuemin="0" aria-valuemax="100"></div>
                            </div>
                        {% endfor %}
                    {% else %}
                        <p class="text-center text-secondary py-4">Nenhum projeto em andamento.</p>
                    {% endif %}
                </div>
            </div>
        </div>

    </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
<script>
document.addEventListener("DOMContentLoaded", function () {
    // Dados simulados para o gráfico
    const chartData = {
        labels: ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'],
        datasets: [{
            label: 'Atividades Concluídas',
            backgroundColor: 'rgba(102, 126, 234, 0.7)', // Cor principal
            borderColor: '#667eea',
            data: [45, 59, 80, 81, 56, 55, 40, 60, 75, 90, 85, 95], // Dados de exemplo
            tension: 0.4,
            fill: true,
        }]
    };

    // Configuração do Gráfico de Barras/Linha
    const ctx = document.getElementById('monthlyActivityChart');
    if (ctx) {
        new Chart(ctx, {
            type: 'line', // Mudado para Line para visual mais suave
            data: chartData,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                    }
                },
                scales: {
                    x: {
                        grid: {
                            display: false
                        }
                    },
                    y: {
                        beginAtZero: true,
                        ticks: {
                            maxTicksLimit: 5,
                            padding: 10
                        },
                        grid: {
                            color: 'rgba(0, 0, 0, 0.05)'
                        }
                    }
                }
            }
        });
    }

    // Inicialização do Mapa Leaflet
    const mapElement = document.getElementById('congestionMap');
    let congestionMap;
    let heatLayer;

    if (mapElement) {
        // Coordenadas centrais (Exemplo: São Paulo)
        const centerCoords = [-23.5505, -46.6333]; 

        congestionMap = L.map('congestionMap', {
            zoomControl: false // Oculta o controle de zoom padrão
        }).setView(centerCoords, 12); // Nível de zoom

        // Adiciona um mapa base (OpenStreetMap)
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(congestionMap);

        // Dados simulados para o Heatmap (Latitude, Longitude, Intensidade)
        // Valores mais altos = mais congestionamento (heatmap mais quente)
        const heatData = [
            [-23.5489, -46.6388, 0.5], // Ponto 1 - Tráfego leve
            [-23.555, -46.645, 0.8],   // Ponto 2 - Tráfego médio
            [-23.56, -46.65, 1.2],     // Ponto 3 - Tráfego alto (mais intenso)
            [-23.552, -46.63, 0.3],   // Ponto 4 - Tráfego muito leve
            [-23.57, -46.64, 1.5]      // Ponto 5 - Pico de Congestionamento
        ];

        // Adiciona a camada de calor
        heatLayer = L.heatLayer(heatData, {
            radius: 25,
            blur: 15,
            maxZoom: 17,
            gradient: {0.4: 'blue', 0.65: 'lime', 1: 'red'} // Cores (do mais frio/azul ao mais quente/vermelho)
        }).addTo(congestionMap);

    }


    // Lógica para atualizar contadores dinamicamente (simulação)
    function updateCounter() {
        const pendingEl = document.getElementById('pendingDeliveries');
        const clientEl = document.getElementById('totalClients');
        const alertEl = document.getElementById('systemAlerts');

        // Simulação de atualização de dados
        pendingEl.textContent = Math.floor(Math.random() * 50) + 10; 
        clientEl.textContent = Math.floor(Math.random() * 1000) + 500;
        alertEl.textContent = Math.floor(Math.random() * 5); 

        // Adiciona a lógica real de fetch aqui se for necessário

        updateCounter();
    }

    // Atualizar hora atual no rodapé
    function updateCurrentTime() {
        const now = new Date();
        const timeString = now.toLocaleTimeString('pt-BR');
        const dateString = now.toLocaleDateString('pt-BR');
        
        // Se houver um elemento para exibir a hora
        const timeElement = document.getElementById('currentTime');
        if (timeElement) {
            timeElement.textContent = `${dateString} ${timeString}`;
        }
    }

    updateCurrentTime();
    setInterval(updateCurrentTime, 1000);

    // Auto-refresh da página (opcional - descomente se necessário)
    // setTimeout(() => {
    //     location.reload();
    // }, 300000); // 5 minutos

    // Notificação de boas-vindas
    setTimeout(() => {
        if (typeof $.notify !== 'undefined') {
            $.notify("Dashboard carregado com sucesso!", {
                position: "top right",
                className: "success",
                autoHideDelay: 3000
            });
        }
    }, 1000);

    // Listener para mudanças de tamanho da janela
    let resizeTimer;
    window.addEventListener('resize', function() {
        clearTimeout(resizeTimer);
        resizeTimer = setTimeout(function() {
            // Necessário para garantir que o mapa Leaflet se ajuste corretamente
            if (congestionMap) {
                congestionMap.invalidateSize();
            }
        }, 250);
    });
    
    // Aplica a animação fade-in em todos os elementos relevantes
    const fadeElements = document.querySelectorAll('.fade-in');
    fadeElements.forEach(element => {
        // Força o re-flow para garantir que a animação seja executada
        void element.offsetWidth; 
    });
});
</script>