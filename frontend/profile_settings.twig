<style>
    /* Inclusão de variáveis e estilos base do home.twig para consistência */
    :root {
        --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        --success-gradient: linear-gradient(135deg, #1cc88a 0%, #13855c 100%);
        --warning-gradient: linear-gradient(135deg, #f6c23e 0%, #dda20a 100%);
        --danger-gradient: linear-gradient(135deg, #e74a3b 0%, #be2617 100%);
        --info-gradient: linear-gradient(135deg, #36b9cc 0%, #258391 100%);
        --card-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        --card-shadow-hover: 0 8px 30px rgba(0, 0, 0, 0.12);
        
        /* Variáveis para modo claro */
        --bg-color: #f8f9fc;
        --card-bg: #ffffff;
        --text-primary: #2c3e50;
        --text-secondary: #858796;
        --border-color: #e3e6f0;
        --header-border: #e3e6f0;
    }

    /* Modo Escuro (Apenas o essencial para o card) */
    body.dark-mode {
        --bg-color: #1a1d29;
        --card-bg: #252836;
        --text-primary: #e4e6eb;
        --text-secondary: #b0b3b8;
        --border-color: #3a3d4a;
        --header-border: #3a3d4a;
        --card-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        --card-shadow-hover: 0 8px 30px rgba(0, 0, 0, 0.4);
    }

    /* Reutilização de estilos */
    .page-header {
        margin-bottom: 2rem;
        padding-bottom: 1rem;
        border-bottom: 2px solid var(--header-border);
    }
    .page-header h1 {
        font-size: 2rem;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 0.5rem;
    }
    .page-header .subtitle {
        color: var(--text-secondary);
        font-size: 0.95rem;
    }
    .modern-card {
        border: none;
        border-radius: 1rem;
        overflow: hidden;
        transition: all 0.3s ease;
        box-shadow: var(--card-shadow);
        background: var(--card-bg);
    }
    .modern-card:hover {
        box-shadow: var(--card-shadow-hover);
    }
    .modern-card-header {
        color: white;
        padding: 1.25rem 1.5rem;
        font-weight: 700;
        display: flex;
        align-items: center;
        justify-content: space-between;
        font-size: 1.05rem;
    }
    .modern-card-header i {
        font-size: 1.2rem;
    }
    .fade-in {
        animation: fadeIn 0.6s ease-out;
    }
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(30px); }
        to { opacity: 1; transform: translateY(0); }
    }

    /* Estilos específicos do Perfil */
    .profile-photo-container {
        width: 120px;
        height: 120px;
        border-radius: 50%;
        overflow: hidden;
        margin: 0 auto 1.5rem;
        border: 4px solid var(--primary-gradient);
        box-shadow: var(--card-shadow);
        background: #f0f0f0;
    }

    .profile-photo-container img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .profile-info-label {
        font-size: 0.85rem;
        color: var(--text-secondary);
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .profile-info-value {
        font-size: 1.05rem;
        color: var(--text-primary);
        font-weight: 500;
        margin-bottom: 1.5rem;
        border-bottom: 1px dashed var(--border-color);
        padding-bottom: 0.5rem;
    }

    .form-control, .form-select {
        border-radius: 0.5rem;
        border: 1px solid var(--border-color);
        padding: 0.625rem 1rem;
        background-color: var(--card-bg);
        color: var(--text-primary);
    }
    .form-control:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 0.25rem rgba(102, 126, 234, 0.25);
    }

    .btn-primary {
        background: var(--primary-gradient);
        border: none;
        font-weight: 600;
        border-radius: 0.5rem;
    }
    .btn-primary:hover {
        opacity: 0.9;
    }
    
    .btn-info {
        background: var(--info-gradient);
        border: none;
        font-weight: 600;
        border-radius: 0.5rem;
    }
    .btn-info:hover {
        opacity: 0.9;
    }

    .btn-success {
        background: var(--success-gradient);
        border: none;
        font-weight: 600;
        border-radius: 0.5rem;
    }
    .btn-success:hover {
        opacity: 0.9;
    }

    /* Estilos para Notificações (Melhoria Visual) */
    .notification-group {
        border: 1px solid var(--border-color);
        border-radius: 0.75rem;
        padding: 1.25rem;
        margin-bottom: 1rem;
        background-color: var(--card-bg);
        transition: all 0.3s ease;
    }

    .notification-group:hover {
        border-color: #667eea; /* Destaca no hover */
    }

    .notification-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
        padding-bottom: 0.5rem;
        border-bottom: 1px solid var(--border-color);
    }
    .notification-header h5 {
        color: var(--text-primary);
        font-weight: 700;
        margin-bottom: 0;
    }
    .channel-check-group {
        display: flex;
        flex-wrap: wrap;
        gap: 1.5rem;
    }
    .channel-check-group .form-check-label {
        font-size: 0.9rem;
        color: var(--text-primary);
    }

</style>

<div class="container-fluid px-3 px-lg-4 mt-4">
    
    <div class="page-header fade-in">
        <h1><i class="fas fa-user-circle me-2 subtitle"></i>Meu Perfil e Configurações</h1>
        <p class="subtitle mb-0">Gerencie suas informações pessoais, segurança e preferências de sistema.</p>
    </div>

    {# ---------------------------------------------------- #}
    {# EXIBIÇÃO DE MENSAGENS (ERROS E SUCESSO) #}
    {# ---------------------------------------------------- #}
    
    {% if messages is not empty %}
        {% for message in messages %}
            <div class="alert alert-success fade-in" role="alert">
                <i class="fas fa-check-circle me-2"></i>{{ message }}
            </div>
        {% endfor %}
    {% endif %}

    {% if errors is not empty %}
        <div class="alert alert-danger fade-in" role="alert">
            <i class="fas fa-exclamation-triangle me-2"></i>
            {% if errors|length == 1 %}
                {{ errors[0] }}
            {% else %}
                <ul class="mb-0 ps-3">
                    {% for error in errors %}
                        <li>{{ error }}</li>
                    {% endfor %}
                </ul>
            {% endif %}
        </div>
    {% endif %}

    <div class="row">
        
        <div class="col-xl-4 col-lg-5 mb-4 fade-in">
            <div class="card modern-card h-100">
                <div class="modern-card-header bg-info-gradient">
                    <span>
                        <i class="fas fa-id-badge me-2"></i>
                        Dados Pessoais
                    </span>
                </div>
                <div class="card-body p-4 text-center">
                    
                    <div class="profile-photo-container">
                        <img src="{{ user.photo_url|default('path/to/default-avatar.png') }}" alt="{{ user.nome }}">
                    </div>

                    <h4 class="text-primary fw-bold mb-1">{{ user.nome|default('Nome do Usuário') }}</h4>
                    <p class="text-secondary mb-3">@{{ user.username|default('username') }}</p>

                    <div class="text-start mt-4">
                        <div class="profile-info-label">E-mail</div>
                        <div class="profile-info-value">{{ user.email|default('N/A') }}</div>

                        <div class="profile-info-label">Telefone</div>
                        <div class="profile-info-value">{{ user.phone_number|default('N/A') }}</div>

                        <div class="profile-info-label">Tipo de Usuário</div>
                        <div class="profile-info-value">
                            {{ user.type == '1' ? 'Administrador' : (user.type == '2' ? 'Gerente' : (user.type == '3' ? 'Colaborador' : 'Visitante')) }}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-8 col-lg-7 mb-4">
            
            {# =================== FORMULÁRIO 1: ATUALIZAR DADOS =================== #}
            <div class="card modern-card mb-4 fade-in" style="animation-delay: 0.1s;">
                <div class="modern-card-header bg-primary-gradient">
                    <span>
                        <i class="fas fa-edit me-2"></i>
                        Atualizar Dados
                    </span>
                </div>
                <div class="card-body p-4">
                    <form id="updateProfileForm" method="POST" action="">
                        <input type="hidden" name="action" value="update_profile">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="nome" class="profile-info-label mb-1">Nome Completo</label>
                                <input type="text" class="form-control" id="nome" name="nome" value="{{ user.nome }}" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="username" class="profile-info-label mb-1">Nome de Usuário (Username)</label>
                                <input type="text" class="form-control" id="username" name="username" value="{{ user.username }}" required>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="email" class="profile-info-label mb-1">E-mail</label>
                                <input type="email" class="form-control" id="email" name="email" value="{{ user.email }}" disabled>
                                <small class="text-secondary">O e-mail não pode ser alterado.</small>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="phone_number" class="profile-info-label mb-1">Telefone</label>
                                <input type="text" class="form-control" id="phone_number" name="phone_number" value="{{ user.phone_number }}">
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary mt-3"><i class="fas fa-save me-2"></i>Salvar Alterações</button>
                    </form>
                </div>
            </div>

            {# =================== FORMULÁRIO 2: PREFERÊNCIAS DE APP (NOVAS COLUNAS NA TABELA USER) =================== #}
            <div class="card modern-card mb-4 fade-in" style="animation-delay: 0.2s;">
                <div class="modern-card-header bg-info-gradient">
                    <span>
                        <i class="fas fa-sliders-h me-2"></i>
                        Preferências de Aplicativo
                    </span>
                </div>
                <div class="card-body p-4">
                    <form id="updateAppPreferencesForm" method="POST" action="">
                        <input type="hidden" name="action" value="update_app_preferences">

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="ui_locale" class="profile-info-label mb-1">Idioma da Interface</label>
                                <select class="form-select" id="ui_locale" name="ui_locale" required>
                                    <option value="pt-BR" {% if user.ui_locale == 'pt-BR' %}selected{% endif %}>Português (Brasil)</option>
                                    <option value="en-US" {% if user.ui_locale == 'en-US' %}selected{% endif %}>Inglês (EUA)</option>
                                    <option value="es-ES" {% if user.ui_locale == 'es-ES' %}selected{% endif %}>Espanhol (Espanha)</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="ui_timezone" class="profile-info-label mb-1">Fuso Horário</label>
                                <select class="form-select" id="ui_timezone" name="ui_timezone" required>
                                    <option value="America/Sao_Paulo" {% if user.ui_timezone == 'America/Sao_Paulo' %}selected{% endif %}>América/São Paulo (GMT-3)</option>
                                    <option value="America/New_York" {% if user.ui_timezone == 'America/New_York' %}selected{% endif %}>América/Nova York (GMT-5)</option>
                                    <option value="Europe/London" {% if user.ui_timezone == 'Europe/London' %}selected{% endif %}>Europa/Londres (GMT+0)</option>
                                </select>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="ui_theme" class="profile-info-label mb-1">Tema da Interface</label>
                                <select class="form-select" id="ui_theme" name="ui_theme" required>
                                    <option value="light" {% if user.ui_theme == 'light' %}selected{% endif %}>Modo Claro</option>
                                    <option value="dark" {% if user.ui_theme == 'dark' %}selected{% endif %}>Modo Escuro</option>
                                    <option value="system" {% if user.ui_theme == 'system' %}selected{% endif %}>Seguir Sistema</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="home_page" class="profile-info-label mb-1">Página Inicial Padrão</label>
                                <select class="form-select" id="home_page" name="home_page" required>
                                    <option value="dashboard" {% if user.home_page == 'dashboard' %}selected{% endif %}>Dashboard Principal</option>
                                    <option value="tasks" {% if user.home_page == 'tasks' %}selected{% endif %}>Minhas Tarefas</option>
                                    <option value="reports" {% if user.home_page == 'reports' %}selected{% endif %}>Relatórios</option>
                                </select>
                            </div>
                        </div>

                        <button type="submit" class="btn btn-info mt-3"><i class="fas fa-save me-2"></i>Salvar Preferências</button>
                    </form>
                </div>
            </div>

            {# =================== FORMULÁRIO 3: CONTROLE DE NOTIFICAÇÕES (TABELA user_notification_preferences) =================== #}
            <div class="card modern-card mb-4 fade-in" style="animation-delay: 0.3s;">
                <div class="modern-card-header bg-success-gradient">
                    <span>
                        <i class="fas fa-bell me-2"></i>
                        Controle de Notificações
                    </span>
                </div>
                <div class="card-body p-4">
                    <form id="updateNotificationForm" method="POST" action="">
                        <input type="hidden" name="action" value="update_notifications">

                        <p class="text-secondary mb-4">Defina como e quando você quer ser alertado sobre os eventos do sistema.</p>

                        {# Loop sobre os tipos de notificação: user_preferences deve ser um array associativo (ex: ['activity' => {...}, 'security' => {...}]) #}
                        {% for type, prefs in user_preferences %}
                            <div class="notification-group">
                                <div class="notification-header">
                                    {# Converte a chave (ex: 'activity') para um título amigável #}
                                    <h5>
                                        {% if type == 'activity' %}<i class="fas fa-clipboard-list me-2 text-primary"></i> Atividades e Tarefas
                                        {% elseif type == 'security' %}<i class="fas fa-shield-alt me-2 text-danger"></i> Segurança e Conta
                                        {% elseif type == 'marketing' %}<i class="fas fa-bullhorn me-2 text-success"></i> Novidades e Promoções
                                        {% else %}{{ type|capitalize }}
                                        {% endif %}
                                    </h5>
                                </div>

                                <input type="hidden" name="prefs[{{ type }}][notification_type]" value="{{ type }}">
                                
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="profile-info-label mb-2">Canais de Alerta:</label>
                                        <div class="channel-check-group">
                                            {# Checkboxes para os Canais #}
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" name="prefs[{{ type }}][channel_email]" id="{{ type }}_email" value="1" {% if prefs.channel_email == 1 %}checked{% endif %}>
                                                <label class="form-check-label" for="{{ type }}_email"><i class="fas fa-envelope me-1"></i> E-mail</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" name="prefs[{{ type }}][channel_push]" id="{{ type }}_push" value="1" {% if prefs.channel_push == 1 %}checked{% endif %}>
                                                <label class="form-check-label" for="{{ type }}_push"><i class="fas fa-bell me-1"></i> Push/App</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" name="prefs[{{ type }}][channel_whatsapp]" id="{{ type }}_whatsapp" value="1" {% if prefs.channel_whatsapp == 1 %}checked{% endif %}>
                                                <label class="form-check-label" for="{{ type }}_whatsapp"><i class="fab fa-whatsapp me-1"></i> WhatsApp</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" name="prefs[{{ type }}][channel_sms]" id="{{ type }}_sms" value="1" {% if prefs.channel_sms == 1 %}checked{% endif %}>
                                                <label class="form-check-label" for="{{ type }}_sms"><i class="fas fa-sms me-1"></i> SMS</label>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-6 mb-3">
                                        <label for="{{ type }}_frequency" class="profile-info-label mb-2">Frequência (apenas para E-mail):</label>
                                        <select class="form-select form-select-sm" id="{{ type }}_frequency" name="prefs[{{ type }}][frequency]">
                                            <option value="instant" {% if prefs.frequency == 'instant' %}selected{% endif %}>Instantâneo (Assim que ocorrer)</option>
                                            <option value="daily" {% if prefs.frequency == 'daily' %}selected{% endif %}>Resumo Diário</option>
                                            <option value="weekly" {% if prefs.frequency == 'weekly' %}selected{% endif %}>Resumo Semanal</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                        
                        <button type="submit" class="btn btn-success mt-3"><i class="fas fa-check-double me-2"></i>Salvar Notificações</button>
                    </form>
                </div>
            </div>

            {# =================== FORMULÁRIO 4: SEGURANÇA (EXISTENTE) =================== #}
            <div class="card modern-card fade-in" style="animation-delay: 0.4s;">
                <div class="modern-card-header bg-danger-gradient">
                    <span>
                        <i class="fas fa-lock me-2"></i>
                        Segurança da Conta
                    </span>
                </div>
                <div class="card-body p-4">
                    <form id="updatePasswordForm" method="POST" action="">
                        <input type="hidden" name="action" value="update_password">

                        <div class="mb-3">
                            <label for="current_password" class="profile-info-label mb-1">Senha Atual</label>
                            <input type="password" class="form-control" id="current_password" name="current_password" required>
                        </div>
                        <div class="mb-3">
                            <label for="new_password" class="profile-info-label mb-1">Nova Senha</label>
                            <input type="password" class="form-control" id="new_password" name="new_password" required>
                        </div>
                        <div class="mb-3">
                            <label for="confirm_password" class="profile-info-label mb-1">Confirmar Nova Senha</label>
                            <input type="password" class="form-control" id="confirm_password" name="confirm_password" required>
                        </div>
                        
                        <hr>
                        
                        <div class="mb-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="is_2fa_enabled" name="is_2fa_enabled" value="1" role="switch" {% if user.is_2fa_enabled == 1 %}checked{% endif %}>
                                <label class="form-check-label fw-bold" for="is_2fa_enabled">Autenticação de Dois Fatores (2FA)</label>
                                <small class="d-block text-secondary">Aumente a segurança da sua conta exigindo um código adicional no login.</small>
                            </div>
                        </div>

                        <button type="submit" class="btn btn-danger mt-3"><i class="fas fa-shield-alt me-2"></i>Salvar Configurações de Segurança</button>
                    </form>
                </div>
            </div>

        </div>
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
    // Validação Client-Side para Nova Senha
    const updatePasswordForm = document.getElementById('updatePasswordForm');

    if (updatePasswordForm) {
        updatePasswordForm.addEventListener('submit', function(e) {
            const newPassword = document.getElementById('new_password').value;
            const confirmPassword = document.getElementById('confirm_password').value;

            if (newPassword !== confirmPassword) {
                e.preventDefault();
                alert("Erro: A nova senha e a confirmação não coincidem. Por favor, verifique.");
            }
        });
    }

    console.log('Página de Perfil inicializada com submissão nativa via POST.');
});
</script>