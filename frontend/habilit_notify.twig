<!-- Configura√ß√µes de Notifica√ß√£o - Layout Melhorado -->
<div class="container-fluid px-4 py-3">
    <!-- Header da P√°gina -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h4 class="mb-1 fw-bold text-dark">
                <i class="fas fa-bell me-2 text-warning"></i>Configura√ß√µes de Notifica√ß√£o
            </h4>
            <p class="text-muted mb-0 small">Gerencie seus canais de notifica√ß√£o e alertas personalizados</p>
        </div>
        <button class="btn btn-warning btn-lg shadow-sm" data-bs-toggle="modal" data-bs-target="#notificationModal" id="addNotificationBtn">
            <i class="fas fa-plus me-2"></i>Nova Notifica√ß√£o
        </button>
    </div>

    <!-- Card Principal -->
    <div class="card border-0 shadow-sm">
        <div class="card-body p-0">
            <!-- Stats Cards -->
            <div class="row g-3 p-4 pb-3 bg-light bg-opacity-50">
                <div class="col-md-3">
                    <div class="d-flex align-items-center p-3 bg-white rounded shadow-sm">
                        <div class="flex-shrink-0">
                            <i class="fas fa-bell-slash text-secondary fs-4"></i>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <div class="fw-bold text-dark">{{ notification_settings|length }}</div>
                            <small class="text-muted">Total de Configura√ß√µes</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="d-flex align-items-center p-3 bg-white rounded shadow-sm">
                        <div class="flex-shrink-0">
                            <i class="fas fa-toggle-on text-success fs-4"></i>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <div class="fw-bold text-success">{{ notification_settings|selectattr('enabled')|list|length }}</div>
                            <small class="text-muted">Ativas</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="d-flex align-items-center p-3 bg-white rounded shadow-sm">
                        <div class="flex-shrink-0">
                            <i class="fab fa-whatsapp text-success fs-4"></i>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <div class="fw-bold text-dark">{{ notification_settings|selectattr('type', 'equalto', 'whatsapp')|list|length }}</div>
                            <small class="text-muted">WhatsApp</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="d-flex align-items-center p-3 bg-white rounded shadow-sm">
                        <div class="flex-shrink-0">
                            <i class="fas fa-envelope text-primary fs-4"></i>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <div class="fw-bold text-dark">{{ notification_settings|selectattr('type', 'equalto', 'email')|list|length }}</div>
                            <small class="text-muted">E-mail</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tabela de Notifica√ß√µes -->
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="table-light">
                        <tr>
                            <th class="text-center fw-semibold" style="width: 60px;">
                                <i class="fas fa-hashtag text-muted"></i>
                            </th>
                            <th class="fw-semibold">
                                <i class="fas fa-broadcast-tower me-2 text-muted"></i>Canal
                            </th>
                            <th class="fw-semibold">
                                <i class="fas fa-info-circle me-2 text-muted"></i>Descri√ß√£o
                            </th>
                            <th class="fw-semibold">
                                <i class="fas fa-map-marker-alt me-2 text-muted"></i>Destino
                            </th>
                            <th class="text-center fw-semibold">
                                <i class="fas fa-power-off me-2 text-muted"></i>Status
                            </th>
                            <th class="text-center fw-semibold" style="width: 140px;">
                                <i class="fas fa-cogs me-2 text-muted"></i>A√ß√µes
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for notif in notification_settings %}
                        <tr class="border-bottom">
                            <td class="text-center">
                                <span class="badge bg-light text-dark border">{{ notif.id }}</span>
                            </td>
                            <td>
                                <div class="d-flex align-items-center">
                                    {% if notif.type == 'whatsapp' %}
                                        <div class="bg-success bg-opacity-10 rounded-circle p-2 me-3">
                                            <i class="fab fa-whatsapp text-success"></i>
                                        </div>
                                    {% else %}
                                        <div class="bg-primary bg-opacity-10 rounded-circle p-2 me-3">
                                            <i class="fas fa-envelope text-primary"></i>
                                        </div>
                                    {% endif %}
                                    <span class="fw-medium">{{ notif.type|capitalize }}</span>
                                </div>
                            </td>
                            <td>
                                <span class="text-dark">{{ notif.description }}</span>
                            </td>
                            <td>
                                <code class="bg-light text-dark p-1 rounded small">{{ notif.destination }}</code>
                            </td>
                            <td class="text-center">
                                {% if notif.enabled %}
                                    <span class="badge bg-success-subtle text-success border border-success-subtle px-3 py-2">
                                        <i class="fas fa-check-circle me-1"></i>Ativo
                                    </span>
                                {% else %}
                                    <span class="badge bg-secondary-subtle text-secondary border border-secondary-subtle px-3 py-2">
                                        <i class="fas fa-pause-circle me-1"></i>Inativo
                                    </span>
                                {% endif %}
                            </td>
                            <td class="text-center">
                                <div class="btn-group" role="group">
                                    <button class="btn btn-outline-primary btn-sm btn-edit-notification"
                                        data-bs-toggle="modal"
                                        data-bs-target="#notificationModal"
                                        data-all='{{ notif|json_encode }}'
                                        data-action="edit"
                                        data-bs-toggle="tooltip"
                                        title="Editar notifica√ß√£o">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-outline-secondary btn-sm"
                                        data-bs-toggle="tooltip"
                                        title="Testar notifica√ß√£o">
                                        <i class="fas fa-paper-plane"></i>
                                    </button>
                                    <button class="btn btn-outline-danger btn-sm"
                                        data-bs-toggle="tooltip"
                                        title="Excluir notifica√ß√£o">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="6" class="text-center py-5">
                                <div class="text-muted">
                                    <i class="fas fa-bell-slash fs-1 mb-3 opacity-25"></i>
                                    <h5 class="mb-2">Nenhuma configura√ß√£o encontrada</h5>
                                    <p class="mb-3">Comece criando sua primeira notifica√ß√£o personalizada</p>
                                    <button class="btn btn-warning btn-sm" data-bs-toggle="modal" data-bs-target="#notificationModal">
                                        <i class="fas fa-plus me-2"></i>Criar primeira notifica√ß√£o
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Modal Melhorado -->
<div class="modal fade" id="notificationModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <!-- Header do Modal -->
            <div class="modal-header bg-gradient text-white" style="background: linear-gradient(135deg, #ffc107 0%, #ff8f00 100%);">
                <div>
                    <h5 class="modal-title mb-1">
                        <i class="fas fa-cog me-2"></i>Configurar Notifica√ß√£o
                    </h5>
                    <small class="opacity-75">Configure os alertas e canais de comunica√ß√£o</small>
                </div>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>

            <form method="POST" id="notificationForm">
                <input type="hidden" name="form_type" value="configure_notification">
                <input type="hidden" name="id" id="notif_id">
                
                <div class="modal-body p-0">
                    <!-- Configura√ß√µes B√°sicas -->
                    <div class="bg-light bg-opacity-50 p-4 border-bottom">
                        <h6 class="fw-bold mb-3">
                            <i class="fas fa-sliders-h me-2 text-warning"></i>Configura√ß√µes B√°sicas
                        </h6>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="notif_type" class="form-label fw-medium">
                                    <i class="fas fa-broadcast-tower me-1"></i>Canal de Notifica√ß√£o
                                </label>
                                <select class="form-select form-select-lg" name="type" id="notif_type" required>
                                    <option value="">Selecione um canal...</option>
                                    <option value="email">
                                        üìß E-mail
                                    </option>
                                    <option value="whatsapp">
                                        üì± WhatsApp
                                    </option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="notif_destination" class="form-label fw-medium">
                                    <i class="fas fa-map-marker-alt me-1"></i>Destino
                                </label>
                                <input type="text" class="form-control form-control-lg" name="destination" id="notif_destination" 
                                    placeholder="Ex: email@exemplo.com ou +5511999999999" required>
                                <div class="form-text">
                                    <small><i class="fas fa-info-circle me-1"></i>Para WhatsApp, inclua o c√≥digo do pa√≠s</small>
                                </div>
                            </div>
                            <div class="col-md-8">
                                <label for="notif_description" class="form-label fw-medium">
                                    <i class="fas fa-tag me-1"></i>Descri√ß√£o
                                </label>
                                <input type="text" class="form-control form-control-lg" name="description" id="notif_description" 
                                    placeholder="Ex: Alertas de Tr√¢nsito - Centro" maxlength="100" required>
                            </div>
                            <div class="col-md-4 d-flex align-items-end">
                                <div class="form-check form-switch form-check-lg">
                                    <input class="form-check-input" type="checkbox" id="notif_enabled" name="enabled">
                                    <label class="form-check-label fw-medium" for="notif_enabled">
                                        <i class="fas fa-power-off me-1"></i>Ativar
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Sele√ß√£o de Alertas -->
                    <div class="p-4">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="fw-bold mb-0">
                                <i class="fas fa-bell me-2 text-warning"></i>Tipos de Alertas
                            </h6>
                            <div class="btn-group btn-group-sm" role="group">
                                <button type="button" class="btn btn-outline-secondary" id="selectAllAlerts">
                                    <i class="fas fa-check-square me-1"></i>Marcar Todos
                                </button>
                                <button type="button" class="btn btn-outline-secondary" id="unselectAllAlerts">
                                    <i class="fas fa-square me-1"></i>Desmarcar Todos
                                </button>
                            </div>
                        </div>
                        
                        <div class="accordion accordion-flush" id="alertsAccordion">
                            {% set alert_map = {
                                'ACCIDENT': 'Acidentes',
                                'ACCIDENT_MINOR': 'Acidente Menor',
                                'ACCIDENT_MAJOR': 'Acidente Grave',
                                'JAM': 'Congestionamentos',
                                'JAM_MODERATE_TRAFFIC': 'Tr√°fego Moderado',
                                'JAM_HEAVY_TRAFFIC': 'Tr√°fego Pesado',
                                'JAM_STAND_STILL_TRAFFIC': 'Tr√°fego Parado',
                                'JAM_LIGHT_TRAFFIC': 'Tr√°fego Leve',
                                'WEATHERHAZARD': 'Perigos Clim√°ticos',
                                'HAZARD_ON_ROAD': 'Perigo na Via',
                                'HAZARD_ON_SHOULDER': 'Perigo no Acostamento',
                                'HAZARD_WEATHER': 'Perigo do Tempo',
                                'HAZARD_ON_ROAD_OBJECT': 'Objeto na Via',
                                'HAZARD_ON_ROAD_POT_HOLE': 'Buraco na Via',
                                'HAZARD_ON_ROAD_ROAD_KILL': 'Animal Atropelado',
                                'HAZARD_ON_SHOULDER_CAR_STOPPED': 'Carro Parado no Acostamento',
                                'HAZARD_ON_SHOULDER_ANIMALS': 'Animais no Acostamento',
                                'HAZARD_ON_SHOULDER_MISSING_SIGN': 'Placa Ausente no Acostamento',
                                'HAZARD_WEATHER_FOG': 'N√©voa',
                                'HAZARD_WEATHER_HAIL': 'Granizo',
                                'HAZARD_WEATHER_HEAVY_RAIN': 'Chuva Forte',
                                'HAZARD_WEATHER_HEAVY_SNOW': 'Neve Forte',
                                'HAZARD_WEATHER_FLOOD': 'Inunda√ß√£o',
                                'HAZARD_WEATHER_MONSOON': 'Mon√ß√£o',
                                'HAZARD_WEATHER_TORNADO': 'Tornado',
                                'HAZARD_WEATHER_HEAT_WAVE': 'Onda de Calor',
                                'HAZARD_WEATHER_HURRICANE': 'Furac√£o',
                                'HAZARD_WEATHER_FREEZING_RAIN': 'Chuva Congelante',
                                'HAZARD_ON_ROAD_LANE_CLOSED': 'Faixa Fechada',
                                'HAZARD_ON_ROAD_OIL': '√ìleo na Via',
                                'HAZARD_ON_ROAD_ICE': 'Gelo na Via',
                                'HAZARD_ON_ROAD_CONSTRUCTION': 'Constru√ß√£o na Via',
                                'HAZARD_ON_ROAD_CAR_STOPPED': 'Carro Parado na Via',
                                'HAZARD_ON_ROAD_TRAFFIC_LIGHT_FAULT': 'Sem√°foro com Problema',
                                'MISC': 'Diversos',
                                'CONSTRUCTION': 'Constru√ß√£o',
                                'ROAD_CLOSED': 'Vias Fechadas',
                                'ROAD_CLOSED_HAZARD': 'Via Fechada por Perigo',
                                'ROAD_CLOSED_CONSTRUCTION': 'Via Fechada por Constru√ß√£o',
                                'ROAD_CLOSED_EVENT': 'Via Fechada por Evento',
                                'NO_SUBTYPE': 'Geral'
                            } %}
                            
                            {% set alert_groups = {
                                'ACCIDENT': {
                                    'icon': 'fas fa-car-crash text-danger',
                                    'color': 'danger',
                                    'subtypes': ['ACCIDENT_MINOR', 'ACCIDENT_MAJOR', 'NO_SUBTYPE']
                                },
                                'JAM': {
                                    'icon': 'fas fa-traffic-light text-warning',
                                    'color': 'warning',
                                    'subtypes': ['JAM_MODERATE_TRAFFIC', 'JAM_HEAVY_TRAFFIC', 'JAM_STAND_STILL_TRAFFIC', 'JAM_LIGHT_TRAFFIC', 'NO_SUBTYPE']
                                },
                                'WEATHERHAZARD': {
                                    'icon': 'fas fa-cloud-rain text-info',
                                    'color': 'info',
                                    'subtypes': ['HAZARD_ON_ROAD', 'HAZARD_ON_SHOULDER', 'HAZARD_WEATHER', 'HAZARD_ON_ROAD_OBJECT', 'HAZARD_ON_ROAD_POT_HOLE', 'HAZARD_ON_ROAD_ROAD_KILL', 'HAZARD_ON_SHOULDER_CAR_STOPPED', 'HAZARD_ON_SHOULDER_ANIMALS', 'HAZARD_ON_SHOULDER_MISSING_SIGN', 'HAZARD_WEATHER_FOG', 'HAZARD_WEATHER_HAIL', 'HAZARD_WEATHER_HEAVY_RAIN', 'HAZARD_WEATHER_HEAVY_SNOW', 'HAZARD_WEATHER_FLOOD', 'HAZARD_WEATHER_MONSOON', 'HAZARD_WEATHER_TORNADO', 'HAZARD_WEATHER_HEAT_WAVE', 'HAZARD_WEATHER_HURRICANE', 'HAZARD_WEATHER_FREEZING_RAIN', 'HAZARD_ON_ROAD_LANE_CLOSED', 'HAZARD_ON_ROAD_OIL', 'HAZARD_ON_ROAD_ICE', 'HAZARD_ON_ROAD_CONSTRUCTION', 'HAZARD_ON_ROAD_CAR_STOPPED', 'HAZARD_ON_ROAD_TRAFFIC_LIGHT_FAULT', 'NO_SUBTYPE']
                                },
                                'ROAD_CLOSED': {
                                    'icon': 'fas fa-road text-secondary',
                                    'color': 'secondary',
                                    'subtypes': ['ROAD_CLOSED_HAZARD', 'ROAD_CLOSED_CONSTRUCTION', 'ROAD_CLOSED_EVENT', 'NO_SUBTYPE']
                                },
                                'CONSTRUCTION': {
                                    'icon': 'fas fa-hard-hat text-success',
                                    'color': 'success',
                                    'subtypes': ['NO_SUBTYPE']
                                },
                                'MISC': {
                                    'icon': 'fas fa-ellipsis-h text-dark',
                                    'color': 'dark',
                                    'subtypes': ['NO_SUBTYPE']
                                }
                            } %}
                            
                            {% for main_type, config in alert_groups.items() %}
                            <div class="accordion-item border rounded mb-2">
                                <h2 class="accordion-header" id="heading{{ main_type }}">
                                    <button class="accordion-button collapsed py-3" type="button" data-bs-toggle="collapse" 
                                        data-bs-target="#collapse{{ main_type }}" aria-expanded="false" 
                                        aria-controls="collapse{{ main_type }}">
                                        <div class="d-flex align-items-center w-100">
                                            <i class="{{ config.icon }} me-3 fs-5"></i>
                                            <div class="flex-grow-1">
                                                <div class="fw-bold">{{ alert_map[main_type] }}</div>
                                                <small class="text-muted">{{ config.subtypes|length }} tipos dispon√≠veis</small>
                                            </div>
                                            <span class="badge bg-{{ config.color }}-subtle text-{{ config.color }} me-2">
                                                {{ config.subtypes|length }}
                                            </span>
                                        </div>
                                    </button>
                                </h2>
                                <div id="collapse{{ main_type }}" class="accordion-collapse collapse" 
                                    aria-labelledby="heading{{ main_type }}" data-bs-parent="#alertsAccordion">
                                    <div class="accordion-body bg-light bg-opacity-25">
                                        <div class="row g-2">
                                            {% for subtype in config.subtypes %}
                                            <div class="col-md-6">
                                                <div class="form-check p-2 border rounded bg-white">
                                                    <input class="form-check-input alert-checkbox" type="checkbox" 
                                                        name="alerts[]" value="{{ main_type }}_{{ subtype }}" 
                                                        id="alert_cb_{{ main_type }}_{{ subtype }}">
                                                    <label class="form-check-label fw-medium" for="alert_cb_{{ main_type }}_{{ subtype }}">
                                                        {{ alert_map[subtype] }}
                                                    </label>
                                                </div>
                                            </div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>

                <!-- Footer do Modal -->
                <div class="modal-footer bg-light">
                    <button type="button" class="btn btn-outline-secondary btn-lg" data-bs-dismiss="modal">
                        <i class="fas fa-times me-2"></i>Cancelar
                    </button>
                    <button type="submit" class="btn btn-warning btn-lg text-white" id="saveBtn">
                        <i class="fas fa-save me-2"></i>Salvar Configura√ß√£o
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
$(document).ready(function () {
    const notificationModal = $('#notificationModal');
    const notificationForm = $('#notificationForm');
    const notifId = $('#notif_id');
    const notifType = $('#notif_type');
    const notifDescription = $('#notif_description');
    const notifDestination = $('#notif_destination');
    const notifEnabled = $('#notif_enabled');
    const modalTitle = notificationModal.find('.modal-title');
    const saveBtn = $('#saveBtn');
    const alertCheckboxes = $('.alert-checkbox');

    // Inicializar tooltips
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });

    // Fun√ß√£o para resetar o formul√°rio
    function resetForm() {
        notificationForm[0].reset();
        notifId.val('');
        notifType.prop('disabled', false);
        modalTitle.html('<i class="fas fa-plus me-2"></i>Nova Notifica√ß√£o');
        saveBtn.html('<i class="fas fa-plus me-2"></i>Criar Notifica√ß√£o');
        alertCheckboxes.prop('checked', false);
        
        // Fechar todos os acorde√µes
        $('.accordion-collapse').removeClass('show');
    }

    // Marcar/Desmarcar todos os alertas
    $('#selectAllAlerts').on('click', function() {
        alertCheckboxes.prop('checked', true);
        $(this).addClass('btn-success').removeClass('btn-outline-secondary');
        setTimeout(() => {
            $(this).removeClass('btn-success').addClass('btn-outline-secondary');
        }, 1000);
    });

    $('#unselectAllAlerts').on('click', function() {
        alertCheckboxes.prop('checked', false);
        $(this).addClass('btn-danger').removeClass('btn-outline-secondary');
        setTimeout(() => {
            $(this).removeClass('btn-danger').addClass('btn-outline-secondary');
        }, 1000);
    });

    // Configura o modal para edi√ß√£o
    $('.btn-edit-notification').on('click', function () {
        const data = $(this).data('all');
        notifId.val(data.id);
        notifType.val(data.type).prop('disabled', true);
        notifDescription.val(data.description);
        notifDestination.val(data.destination);
        notifEnabled.prop('checked', data.enabled == 1);
        modalTitle.html('<i class="fas fa-edit me-2"></i>Editar Notifica√ß√£o');
        saveBtn.html('<i class="fas fa-save me-2"></i>Salvar Altera√ß√µes');

        // Preenche os checkboxes com base nos alertas salvos
        alertCheckboxes.prop('checked', false);
        if (data.alerts && data.alerts.length > 0) {
            data.alerts.forEach(alertValue => {
                $(`input[name="alerts[]"][value="${alertValue}"]`).prop('checked', true);
            });
        }
    });

    // Configura o modal para adicionar nova notifica√ß√£o
    $('#addNotificationBtn, .btn:contains("Criar primeira notifica√ß√£o")').on('click', function () {
        resetForm();
    });

    // Resetar o formul√°rio ao fechar o modal
    notificationModal.on('hidden.bs.modal', function () {
        resetForm();
    });

    // Feedback visual no formul√°rio
    notificationForm.on('submit', function(e) {
        saveBtn.html('<i class="fas fa-spinner fa-spin me-2"></i>Salvando...');
        saveBtn.prop('disabled', true);
    });

    // Valida√ß√£o din√¢mica do destino baseado no tipo
    notifType.on('change', function() {
        const type = $(this).val();
        const destinationInput = $('#notif_destination');
        
        if (type === 'email') {
            destinationInput.attr('type', 'email');
            destinationInput.attr('placeholder', 'Ex: usuario@exemplo.com');
        } else if (type === 'whatsapp') {
            destinationInput.attr('type', 'tel');
            destinationInput.attr('placeholder', 'Ex: +5511999999999');
        }
    });
});
</script>