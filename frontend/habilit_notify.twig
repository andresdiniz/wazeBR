<div class="container-fluid mx-md-5 mx-lg-5">
    <div class="card shadow-sm border-0">
        <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
            <h5 class="m-0 text-dark">
                <i class="fas fa-bell me-2 text-warning"></i>Configurações de Notificação
            </h5>
            <button class="btn btn-warning text-white" data-bs-toggle="modal" data-bs-target="#notificationModal" id="addNotificationBtn">
                <i class="fas fa-plus me-2"></i>Adicionar Notificação
            </button>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th class="text-center" style="width: 80px;">ID</th>
                            <th>Canal</th>
                            <th>Descrição</th>
                            <th>Destino</th>
                            <th class="text-center">Status</th>
                            <th class="text-center" style="width: 120px;">Ações</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for notif in notification_settings %}
                        <tr class="align-middle">
                            <td class="text-center text-muted">{{ notif.id }}</td>
                            <td>
                                <i class="fab fa-{{ notif.type == 'whatsapp' ? 'whatsapp text-success' : 'envelope-open-text text-primary' }} me-2"></i>
                                {{ notif.type|capitalize }}
                            </td>
                            <td>{{ notif.description }}</td>
                            <td>{{ notif.destination }}</td>
                            <td class="text-center">
                                <span class="badge bg-{{ notif.enabled ? 'success' : 'secondary' }} text-white p-2">
                                    {{ notif.enabled ? 'Ativo' : 'Inativo' }}
                                </span>
                            </td>
                            <td class="text-center">
                                <div class="btn-group" role="group">
                                    <button class="btn btn-sm btn-outline-secondary me-1 btn-edit-notification"
                                        data-bs-toggle="modal"
                                        data-bs-target="#notificationModal"
                                        data-all='{{ notif|json_encode }}'
                                        data-action="edit">
                                        <i class="fas fa-pencil-alt"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="6" class="text-center py-4 text-muted">
                                <i class="fas fa-exclamation-circle me-2"></i>Nenhuma configuração de notificação encontrada.
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>


<div class="modal fade" id="notificationModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title">
                    <i class="fas fa-cog me-2"></i>Configurar Notificação
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>

            <form method="POST" id="notificationForm">
                <input type="hidden" name="form_type" value="configure_notification">
                <input type="hidden" name="id" id="notif_id">
                <div class="modal-body p-4">
                    <div class="row g-3 mb-4">
                        <div class="col-md-6">
                            <label for="notif_type" class="form-label">Canal</label>
                            <select class="form-select" name="type" id="notif_type" required>
                                <option value="email">E-mail</option>
                                <option value="whatsapp">WhatsApp</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="notif_destination" class="form-label">Destino</label>
                            <input type="text" class="form-control" name="destination" id="notif_destination" placeholder="Ex: email@email.com ou +5511999999999" required>
                        </div>
                        <div class="col-12">
                            <label for="notif_description" class="form-label">Descrição</label>
                            <input type="text" class="form-control" name="description" id="notif_description" placeholder="Ex: Notificações de Vendas" maxlength="100" required>
                        </div>
                        <div class="col-12">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="notif_enabled" name="enabled">
                                <label class="form-check-label" for="notif_enabled">Ativar Notificações</label>
                            </div>
                        </div>
                    </div>
                    
                    <h6 class="mb-3">Selecione os Alertas para Notificação:</h6>
                    <div class="accordion" id="alertsAccordion">
                        {% set alert_map = {
                            'ACCIDENT': 'Acidente',
                            'ACCIDENT_MINOR': 'Acidente Menor',
                            'ACCIDENT_MAJOR': 'Acidente Grave',
                            'JAM': 'Congestionamento',
                            'JAM_MODERATE_TRAFFIC': 'Tráfego Moderado',
                            'JAM_HEAVY_TRAFFIC': 'Tráfego Pesado',
                            'JAM_STAND_STILL_TRAFFIC': 'Tráfego Parado',
                            'JAM_LIGHT_TRAFFIC': 'Tráfego Leve',
                            'WEATHERHAZARD': 'Perigo Climático / Perigo',
                            'HAZARD_ON_ROAD': 'Perigo na Via',
                            'HAZARD_ON_SHOULDER': 'Perigo no Acostamento',
                            'HAZARD_WEATHER': 'Perigo do Tempo',
                            'HAZARD_ON_ROAD_OBJECT': 'Objeto na Via',
                            'HAZARD_ON_ROAD_POT_HOLE': 'Buraco na Via',
                            'HAZARD_ON_ROAD_ROAD_KILL': 'Animal Atropelado',
                            'HAZARD_ON_SHOULDER_CAR_STOPPED': 'Carro Parado no Acostamento',
                            'HAZARD_ON_SHOULDER_ANIMALS': 'Animais no Acostamento',
                            'HAZARD_ON_SHOULDER_MISSING_SIGN': 'Placa Ausente no Acostamento',
                            'HAZARD_WEATHER_FOG': 'Névoa',
                            'HAZARD_WEATHER_HAIL': 'Granizo',
                            'HAZARD_WEATHER_HEAVY_RAIN': 'Chuva Forte',
                            'HAZARD_WEATHER_HEAVY_SNOW': 'Neve Forte',
                            'HAZARD_WEATHER_FLOOD': 'Inundação',
                            'HAZARD_WEATHER_MONSOON': 'Monção',
                            'HAZARD_WEATHER_TORNADO': 'Tornado',
                            'HAZARD_WEATHER_HEAT_WAVE': 'Onda de Calor',
                            'HAZARD_WEATHER_HURRICANE': 'Furacão',
                            'HAZARD_WEATHER_FREEZING_RAIN': 'Chuva Congelante',
                            'HAZARD_ON_ROAD_LANE_CLOSED': 'Faixa Fechada',
                            'HAZARD_ON_ROAD_OIL': 'Óleo na Via',
                            'HAZARD_ON_ROAD_ICE': 'Gelo na Via',
                            'HAZARD_ON_ROAD_CONSTRUCTION': 'Construção na Via',
                            'HAZARD_ON_ROAD_CAR_STOPPED': 'Carro Parado na Via',
                            'HAZARD_ON_ROAD_TRAFFIC_LIGHT_FAULT': 'Semáforo com Problema',
                            'MISC': 'Diversos',
                            'CONSTRUCTION': 'Construção',
                            'ROAD_CLOSED': 'Via Fechada',
                            'ROAD_CLOSED_HAZARD': 'Via Fechada por Perigo',
                            'ROAD_CLOSED_CONSTRUCTION': 'Via Fechada por Construção',
                            'ROAD_CLOSED_EVENT': 'Via Fechada por Evento',
                            'NO_SUBTYPE': 'Sem Subtipo'
                        } %}
                        {% set alert_groups = {
                            'ACCIDENT': ['ACCIDENT_MINOR', 'ACCIDENT_MAJOR', 'NO_SUBTYPE'],
                            'JAM': ['JAM_MODERATE_TRAFFIC', 'JAM_HEAVY_TRAFFIC', 'JAM_STAND_STILL_TRAFFIC', 'JAM_LIGHT_TRAFFIC', 'NO_SUBTYPE'],
                            'WEATHERHAZARD': ['HAZARD_ON_ROAD', 'HAZARD_ON_SHOULDER', 'HAZARD_WEATHER', 'HAZARD_ON_ROAD_OBJECT', 'HAZARD_ON_ROAD_POT_HOLE', 'HAZARD_ON_ROAD_ROAD_KILL', 'HAZARD_ON_SHOULDER_CAR_STOPPED', 'HAZARD_ON_SHOULDER_ANIMALS', 'HAZARD_ON_SHOULDER_MISSING_SIGN', 'HAZARD_WEATHER_FOG', 'HAZARD_WEATHER_HAIL', 'HAZARD_WEATHER_HEAVY_RAIN', 'HAZARD_WEATHER_HEAVY_SNOW', 'HAZARD_WEATHER_FLOOD', 'HAZARD_WEATHER_MONSOON', 'HAZARD_WEATHER_TORNADO', 'HAZARD_WEATHER_HEAT_WAVE', 'HAZARD_WEATHER_HURRICANE', 'HAZARD_WEATHER_FREEZING_RAIN', 'HAZARD_ON_ROAD_LANE_CLOSED', 'HAZARD_ON_ROAD_OIL', 'HAZARD_ON_ROAD_ICE', 'HAZARD_ON_ROAD_CONSTRUCTION', 'HAZARD_ON_ROAD_CAR_STOPPED', 'HAZARD_ON_ROAD_TRAFFIC_LIGHT_FAULT', 'NO_SUBTYPE'],
                            'MISC': ['NO_SUBTYPE'],
                            'CONSTRUCTION': ['NO_SUBTYPE'],
                            'ROAD_CLOSED': ['ROAD_CLOSED_HAZARD', 'ROAD_CLOSED_CONSTRUCTION', 'ROAD_CLOSED_EVENT', 'NO_SUBTYPE']
                        } %}
                        {% for main_type, subtypes in alert_groups %}
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="heading{{ main_type }}">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{ main_type }}" aria-expanded="false" aria-controls="collapse{{ main_type }}">
                                    {{ alert_map[main_type] }}
                                </button>
                            </h2>
                            <div id="collapse{{ main_type }}" class="accordion-collapse collapse" aria-labelledby="heading{{ main_type }}" data-bs-parent="#alertsAccordion">
                                <div class="accordion-body">
                                    {% for subtype in subtypes %}
                                    <div class="form-check">
                                        <input class="form-check-input alert-checkbox" type="checkbox" name="alerts[]" value="{{ main_type }}_{{ subtype }}" id="alert_cb_{{ main_type }}_{{ subtype }}">
                                        <label class="form-check-label" for="alert_cb_{{ main_type }}_{{ subtype }}">
                                            {{ alert_map[subtype] }}
                                        </label>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <div class="modal-footer bg-light justify-content-between">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-2"></i>Cancelar
                    </button>
                    <button type="submit" class="btn btn-warning text-white" id="saveBtn">
                        <i class="fas fa-save me-2"></i>Salvar
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
<script>
$(document).ready(function () {
    const notificationModal = $('#notificationModal');
    const notificationForm = $('#notificationForm');
    const notifId = $('#notif_id');
    const notifType = $('#notif_type');
    const notifDescription = $('#notif_description');
    const notifDestination = $('#notif_destination');
    const notifEnabled = $('#notif_enabled');
    const modalTitle = notificationModal.find('.modal-title');
    const saveBtn = $('#saveBtn');
    
    // Adicione a nova variável para a lista de alertas
    const alertCheckboxes = $('.alert-checkbox');

    // Função para resetar o formulário
    function resetForm() {
        notificationForm[0].reset();
        notifId.val('');
        notifType.prop('disabled', false);
        modalTitle.html('<i class="fas fa-plus me-2"></i> Adicionar Notificação');
        saveBtn.html('<i class="fas fa-plus me-2"></i> Adicionar');
        
        // Limpa os checkboxes
        alertCheckboxes.prop('checked', false);
    }

    // Configura o modal para edição
    $('.btn-edit-notification').on('click', function () {
        const data = $(this).data('all');
        notifId.val(data.id);
        notifType.val(data.type).prop('disabled', true);
        notifDescription.val(data.description);
        notifDestination.val(data.destination);
        notifEnabled.prop('checked', data.enabled == 1);
        modalTitle.html('<i class="fas fa-cog me-2"></i> Editar Notificação');
        saveBtn.html('<i class="fas fa-save me-2"></i> Salvar');

        // Preenche os checkboxes com base nos alertas salvos
        // Assumindo que `data.alerts` é um array de strings como ['ACCIDENT_ACCIDENT_MINOR', 'JAM_JAM_HEAVY_TRAFFIC']
        alertCheckboxes.prop('checked', false); // Limpa todos antes de marcar
        if (data.alerts && data.alerts.length > 0) {
            data.alerts.forEach(alertValue => {
                $(`input[name="alerts[]"][value="${alertValue}"]`).prop('checked', true);
            });
        }
    });

    // Configura o modal para adicionar nova notificação
    $('#addNotificationBtn').on('click', function () {
        resetForm();
    });

    // Resetar o formulário ao fechar o modal
    notificationModal.on('hidden.bs.modal', function () {
        resetForm();
    });
});
</script>