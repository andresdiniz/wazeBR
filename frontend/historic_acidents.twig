<link href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.datatables.net/1.12.1/css/jquery.dataTables.min.css" rel="stylesheet">
<link href="https://cdn.datatables.net/buttons/2.2.3/css/buttons.dataTables.min.css" rel="stylesheet">

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script src="https://cdn.datatables.net/1.12.1/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.2.3/js/dataTables.buttons.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"></script>
<script src="https://cdn.datatables.net/buttons/2.2.3/js/buttons.html5.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>


<div class="container my-5">
    <h1 class="text-center mb-4">Histórico de Acidentes</h1>

    <form id="filterForm" class="my-4">
        <div class="row g-3">
            <div class="col-md-4">
                <label for="start_date" class="form-label">Data Inicial:</label>
                <input type="date" class="form-control" id="start_date" name="start_date">
            </div>
            <div class="col-md-4">
                <label for="end_date" class="form-label">Data Final:</label>
                <input type="date" class="form-control" id="end_date" name="end_date">
            </div>
            <div class="col-md-4">
                <label for="group_by" class="form-label">Agrupar por:</label>
                <select class="form-control" id="group_by" name="group_by">
                    <option value="date">Data</option>
                    <option value="hour">Hora</option>
                    <option value="street">Rua</option>
                </select>
            </div>
        </div>
        <button type="submit" class="btn btn-primary w-100 mt-3">Filtrar</button>
    </form>

    <div id="alertsTableContainer" class="my-5">
        <table id="alertsTable" class="display table table-bordered table-striped">
            <thead>
                <tr>
                    <th>Categoria</th>
                    <th>Quantidade</th>
                </tr>
            </thead>
            <tbody>
                <tr><td colspan="2">Nenhum alerta carregado.</td></tr>
            </tbody>
        </table>
    </div>
        <div id="alertsChartContainer" style="display: none;">
        <canvas id="alertsChart" height="400"></canvas>
    </div>
</div>

<script>
    // Use a IIFE para encapsular o código e evitar conflitos
    (function($) {  // Passa o jQuery para o escopo local

        // Função para buscar e exibir dados
        async function fetchAccidentAlerts(startDate, endDate, groupBy) {
            try {
                const response = await fetch(`../wazeportal/api.php?action=get_alerts&start_date=${startDate}&end_date=${endDate}&group_by=${groupBy}`);
                const data = await response.json();

                if (data.error) {
                    console.error(data.error);
                    $('#alertsTable').html(`<p>${data.error}</p>`); // Use jQuery aqui
                    return;
                }

                // Atualiza tabela e gráfico
                updateTable(data.alerts, groupBy);
                if (data.alerts.length > 0) {
                    $('#alertsChartContainer').show(); // Use jQuery aqui
                    updateChart(data.labels, data.data_counts, groupBy);
                } else {
                    $('#alertsChartContainer').hide(); // Use jQuery aqui
                }
            } catch (error) {
                console.error('Erro ao buscar dados:', error);
                $('#alertsTable').html(`<p>Erro ao carregar os dados.</p>`); // Use jQuery aqui
            }
        }

        // ... (resto das funções updateChart e updateTable como antes)

        // Inicializa eventos
        $('#filterForm').on('submit', function(event) { // Use jQuery para o evento submit
            event.preventDefault();
            const startDate = $('#start_date').val(); // Use jQuery para obter os valores
            const endDate = $('#end_date').val();
            const groupBy = $('#group_by').val();
            fetchAccidentAlerts(startDate, endDate, groupBy);
        });

        // Preenche automaticamente as datas no filtro
        $(document).ready(function() { // Use jQuery para o evento DOMContentLoaded
            const now = new Date();
            const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
            const endOfDay = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1);

            const startDate = startOfMonth.toISOString().split('T')[0];
            const endDate = endOfDay.toISOString().split('T')[0];

            $('#start_date').val(startDate); // Use jQuery para definir os valores
            $('#end_date').val(endDate);

            const groupBy = 'date';    // Padrão
            fetchAccidentAlerts(startDate, endDate, groupBy);

        });

    })(jQuery); // Fim da IIFE e passa o jQuery como argumento
</script>