<link href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.datatables.net/1.12.1/css/jquery.dataTables.min.css" rel="stylesheet">
<link href="https://cdn.datatables.net/buttons/2.2.3/css/buttons.dataTables.min.css" rel="stylesheet">

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script src="https://cdn.datatables.net/1.12.1/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.2.3/js/dataTables.buttons.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"></script>
<script src="https://cdn.datatables.net/buttons/2.2.3/js/buttons.html5.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.datatables.net/1.12.1/css/dataTables.bootstrap5.min.css" rel="stylesheet">
<link href="https://cdn.datatables.net/buttons/2.2.3/css/buttons.bootstrap5.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

<style>
    .accident-card {
        background: white;
        border-radius: 10px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        transition: transform 0.2s;
        margin-bottom: 1rem;
        padding: 1.25rem;
    }

    .accident-card:hover {
        transform: translateY(-3px);
    }

    .severity-indicator {
        width: 10px;
        height: 100%;
        border-radius: 5px;
        position: absolute;
        left: 0;
        top: 0;
    }

    .accident-details {
        margin-left: 1.5rem;
    }

    .map-preview {
        height: 120px;
        background: #f8f9fa;
        border-radius: 8px;
        overflow: hidden;
    }

    .badge-custom {
        font-size: 0.85em;
        padding: 0.5em 0.75em;
    }
</style>

<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <div class="dashboard-card p-4 mb-4">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2 class="h4 mb-0"><i class="fas fa-car-crash me-2"></i>Registro de Acidentes</h2>
                    <div class="d-flex gap-2">
                        <button class="btn btn-sm btn-outline-primary" onclick="exportToPDF()">
                            <i class="fas fa-file-pdf me-2"></i>Exportar PDF
                        </button>
                    </div>
                </div>

                <table id="accidentsTable" class="table table-borderless table-hover w-100">
                    <thead>
                        <tr>
                            <th>Data/Hora</th>
                            <th>Localização</th>
                            <th>Tipo</th>
                            <th>Severidade</th>
                            <th>Detalhes</th>
                            <th>Mapa</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Dados serão preenchidos via JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
(function($) {
    const severityColors = {
        LOW: '#4CAF50',
        MEDIUM: '#FFC107',
        HIGH: '#F44336'
    };

    async function fetchAccidents(startDate, endDate) {
        try {
            const response = await fetch(`../api.php?action=get_alerts&start_date=${startDate}&end_date=${endDate}`);
            const { accidentAlerts } = await response.json();
            
            if (accidentAlerts.error) {
                console.error(accidentAlerts.error);
                return;
            }

            updateAccidentsTable(accidentAlerts);
        } catch (error) {
            console.error('Erro ao buscar dados:', error);
        }
    }

    function updateAccidentsTable(accidents) {
        const table = $('#accidentsTable').DataTable({
            dom: 'Bfrtip',
            buttons: ['excel', 'pdf'],
            data: accidents,
            columns: [
                { 
                    data: 'pubMillis',
                    render: (data) => new Date(data).toLocaleString()
                },
                {
                    data: null,
                    render: ({ street, city }) => `
                        <div class="d-flex align-items-center">
                            <i class="fas fa-map-marker-alt text-danger me-2"></i>
                            <div>
                                <div class="fw-medium">${street || 'Rua não informada'}</div>
                                <small class="text-muted">${city || 'Cidade não informada'}</small>
                            </div>
                        </div>
                    `
                },
                {
                    data: 'subtype',
                    render: (data) => `
                        <span class="badge badge-custom bg-info">
                            ${data || 'Tipo não especificado'}
                        </span>
                    `
                },
                {
                    data: 'severity',
                    render: (data) => `
                        <div class="d-flex align-items-center">
                            <div class="severity-indicator" style="background: ${severityColors[data] || '#666'}"></div>
                            <span class="ms-2 text-uppercase fw-medium" style="color: ${severityColors[data] || '#666'}">
                                ${data || 'N/A'}
                            </span>
                        </div>
                    `
                },
                {
                    data: 'reliability',
                    render: (reliability, type, row) => `
                        <div class="small">
                            <div>Confiança: ${reliability}%</div>
                            <div>Raio: ${row.radius}m</div>
                        </div>
                    `
                },
                {
                    data: 'location',
                    render: ({ x, y }) => `
                        <div class="map-preview" 
                             data-bs-toggle="tooltip" 
                             title="Coordenadas: ${x}, ${y}">
                            <img src="https://maps.googleapis.com/maps/api/staticmap?
                                center=${x},${y}&zoom=15&size=200x120&maptype=roadmap
                                &markers=color:red%7C${x},${y}
                                &key=SUA_CHAVE_API" 
                                class="img-fluid rounded">
                        </div>
                    `
                }
            ],
            order: [[0, 'desc']],
            responsive: true,
            language: {
                url: '//cdn.datatables.net/plug-ins/1.12.1/i18n/pt-BR.json'
            },
            createdRow: (row, data) => {
                $(row).addClass('accident-card');
                $(row).css('cursor', 'pointer');
                $(row).on('click', () => showAccidentDetails(data));
            }
        });
    }

    function showAccidentDetails(accident) {
        // Implementar modal com detalhes completos
        console.log('Detalhes do acidente:', accident);
    }

    $(document).ready(function() {
        const startDate = new Date().toISOString().split('T')[0];
        const endDate = new Date().toISOString().split('T')[0];
        fetchAccidents(startDate, endDate);
        
        $('[data-bs-toggle="tooltip"]').tooltip();
    });

})(jQuery);
</script>