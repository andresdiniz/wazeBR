<link href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.datatables.net/1.12.1/css/jquery.dataTables.min.css" rel="stylesheet">
<link href="https://cdn.datatables.net/buttons/2.2.3/css/buttons.dataTables.min.css" rel="stylesheet">
<link href="https://cdn.datatables.net/responsive/2.3.0/css/responsive.dataTables.min.css" rel="stylesheet">

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script src="https://cdn.datatables.net/1.12.1/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.2.3/js/dataTables.buttons.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"></script>
<script src="https://cdn.datatables.net/buttons/2.2.3/js/buttons.html5.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.datatables.net/1.12.1/css/jquery.dataTables.min.css" rel="stylesheet">
<link href="https://cdn.datatables.net/buttons/2.2.3/css/buttons.dataTables.min.css" rel="stylesheet">

<style>
    .card-custom {
        border: none;
        border-radius: 15px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        transition: transform 0.3s ease;
    }

    .card-custom:hover {
        transform: translateY(-2px);
    }

    .chart-container {
        position: relative;
        height: 400px;
        margin: 20px 0;
    }

    .dataTables_wrapper {
        padding: 15px 0;
    }

    .filter-section {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 30px;
    }

    dt-button-collection {
        min-width: 120px;
    }
</style>

<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="display-5 text-center font-weight-bold text-primary">Histórico de Acidentes</h1>
        </div>
    </div>

    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="filter-section">
                <form id="filterForm">
                    <div class="form-row align-items-end">
                        <div class="col-md-3 mb-3">
                            <label for="start_date" class="form-label">Data Inicial</label>
                            <input type="date" class="form-control border-primary" id="start_date" name="start_date">
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="end_date" class="form-label">Data Final</label>
                            <input type="date" class="form-control border-primary" id="end_date" name="end_date">
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="group_by" class="form-label">Agrupar por</label>
                            <select class="form-control border-primary" id="group_by" name="group_by">
                                <option value="date">Data</option>
                                <option value="hour">Hora</option>
                                <option value="street">Rua</option>
                            </select>
                        </div>
                        <div class="col-md-3 mb-3">
                            <input type="hidden" id="id_parceiro" value="{{id_parceiro}}">
                            <button type="submit" class="btn btn-primary btn-block">
                                <i class="fas fa-filter mr-2"></i>Filtrar
                            </button>
                        </div>
                    </div>
                </form>
            </div>

            <div class="card card-custom mb-4">
                <div class="card-body">
                    <div class="table-responsive">
                        <table id="alertsTable" class="table table-hover table-striped" style="width:100%">
                            <thead class="thead-dark">
                                <tr>
                                    <th>Categoria</th>
                                    <th>Quantidade</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td colspan="2" class="text-muted">Nenhum dado disponível</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="card card-custom">
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="alertsChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="detailedView" style="display: none;">
        <div class="card card-custom">
            <div class="card-body">
                <div class="table-responsive">
                    <table id="detailedTable" class="table table-hover" style="width:100%">
                        <thead class="thead-dark">
                            <tr>
                                <th>Data</th>
                                <th>Hora</th>
                                <th>Rua</th>
                                <th>Cidade</th>
                                <th>Estado</th>
                                <th>Coordenadas</th>
                                <th>Tipo</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

</div>

<script>
(function($) {
    let detailedDataTable = null;

    async function fetchDetailedAlerts(startDate, endDate) {
        try {
            const id_parceiro = $('#id_parceiro').val();
            const response = await fetch(
                `../api.php?action=get_alerts&list_all=1&start_date=${startDate}&end_date=${endDate}&id_parceiro=${id_parceiro}`
            );
            const data = await response.json();

            if (detailedDataTable) {
                detailedDataTable.destroy();
            }

            $('#detailedTable tbody').empty();

            detailedDataTable = $('#detailedTable').DataTable({
                dom: 'Bfrtip',
                buttons: ['copy', 'csv', 'excel', 'pdf'],
                data: data.alerts,
                columns: [
                    { 
                        data: 'alert_datetime',
                        render: function(data) {
                            return data ? data.split('T')[0] : 'N/A';
                        }
                    },
                    { 
                        data: 'alert_datetime',
                        render: function(data) {
                            return data ? data.split('T')[1].substring(0,8) : 'N/A';
                        }
                    },
                    { 
                        data: 'street',
                        defaultContent: 'N/A'
                    },
                    { 
                        data: 'city',
                        defaultContent: 'N/A'
                    },
                    { 
                        data: 'state',
                        defaultContent: 'N/A'
                    },
                    { 
                        data: 'coordinates',
                        render: function(data) {
                            if(data && data.lat && data.lon) {
                                return `${data.lat.toFixed(6)}, ${data.lon.toFixed(6)}`;
                            }
                            return 'N/A';
                        }
                    },
                    { 
                        data: 'alert_type',
                        render: function(data) {
                            return data || 'N/A';
                        }
                    }
                ],
                order: [[0, 'desc']],
                responsive: true,
                language: {
                    url: '//cdn.datatables.net/plug-ins/1.12.1/i18n/pt-BR.json'
                },
                autoWidth: false,
                pageLength: 25
            });
        } catch (error) {
            console.error('Erro ao buscar detalhes:', error);
        }
    }

    $('#toggleView').change(function() {
        const showDetailed = $(this).prop('checked');
        $('#aggregatedView').toggle(!showDetailed);
        $('#detailedView').toggle(showDetailed);
        
        if(showDetailed) {
            const startDate = $('#start_date').val();
            const endDate = $('#end_date').val();
            fetchDetailedAlerts(startDate, endDate);
        }
    });

    // Atualizar o filtro para recarregar ambas as visualizações
    $('#filterForm').on('submit', function(event) {
        event.preventDefault();
        const startDate = $('#start_date').val();
        const endDate = $('#end_date').val();
        const groupBy = $('#group_by').val();
        
        fetchAccidentAlerts(startDate, endDate, groupBy);
        
        if($('#toggleView').prop('checked')) {
            fetchDetailedAlerts(startDate, endDate);
        }
    });

    // Inicialização
    $(document).ready(function() {
        // ... (código de inicialização anterior)
        
        // Inicializar a tabela detalhada
        $('#detailedTable').DataTable({
            // Configuração inicial vazia
        });
    });

})(jQuery);
</script>