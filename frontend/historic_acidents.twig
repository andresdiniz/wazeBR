<!-- Carregar jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<!-- Carregar DataTables e seus plugins -->
<script src="https://cdn.datatables.net/1.12.1/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.2.3/js/dataTables.buttons.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"></script>
<script src="https://cdn.datatables.net/buttons/2.2.3/js/buttons.html5.min.js"></script>

<script>
    // Liberar o '$' para outras bibliotecas e atribuir o jQuery a 'jq'
    var jq = jQuery.noConflict();

    // Função para buscar e exibir dados
    async function fetchAccidentAlerts(startDate, endDate, groupBy) {
        try {
            const response = await fetch(`../wazeportal/api.php?action=get_alerts&start_date=${startDate}&end_date=${endDate}&group_by=${groupBy}`);
            const data = await response.json();

            if (data.error) {
                console.error(data.error);
                document.getElementById('alertsTable').innerHTML = `<p>${data.error}</p>`;
                return;
            }

            // Atualiza tabela e gráfico
            updateTable(data.alerts, groupBy);
            if (data.alerts.length > 0) {
                document.getElementById('alertsChartContainer').style.display = 'block';
                updateChart(data.labels, data.data_counts, groupBy);
            } else {
                document.getElementById('alertsChartContainer').style.display = 'none';
            }
        } catch (error) {
            console.error('Erro ao buscar dados:', error);
            document.getElementById('alertsTable').innerHTML = `<p>Erro ao carregar os dados.</p>`;
        }
    }

    // Atualiza gráfico
    function updateChart(labels, dataCounts, groupBy) {
        const dataValues = dataCounts.map(count => parseInt(count, 10));

        const ctx = document.getElementById('alertsChart').getContext('2d');
        if (window.alertsChartInstance) window.alertsChartInstance.destroy();

        const chartType = groupBy === 'date' ? 'line' : groupBy === 'street' ? 'pie' : 'bar';
        const chartData = {
            labels,
            datasets: [{
                label: 'Número de Alertas',
                backgroundColor: chartType === 'pie'
                    ? labels.map(() => `rgba(${Math.random() * 255}, ${Math.random() * 255}, ${Math.random() * 255}, 0.6)`)
                    : 'rgba(75, 192, 192, 0.2)',
                borderColor: 'rgba(75, 192, 192, 1)',
                data: dataValues
            }]
        };

        const config = {
            type: chartType,
            data: chartData,
            plugins: [ChartDataLabels],
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'top' },
                    title: { display: true, text: `Histórico de Acidentes (${groupBy})` },
                    datalabels: {
                        color: 'black',
                        formatter: value => value > 0 ? value : ''
                    }
                },
                scales: chartType !== 'pie' ? {
                    x: { title: { display: true, text: 'Categorias' } },
                    y: { title: { display: true, text: 'Quantidade' }, beginAtZero: true }
                } : {}
            }
        };

        window.alertsChartInstance = new Chart(ctx, config);
    }

    // Atualiza tabela
    function updateTable(alerts, groupBy) {
        let tableContent = `
            <table id="alertsTable" class="table table-bordered table-striped">
                <thead>
                    <tr>
                        <th>${groupBy === 'date' ? 'Data' : groupBy === 'hour' ? 'Hora' : 'Rua'}</th>
                        <th>Quantidade</th>
                    </tr>
                </thead>
                <tbody>
        `;
        alerts.forEach(alert => {
            let label = groupBy === 'date' ? alert.alert_date :
                        groupBy === 'hour' ? `${String(alert.alert_hour).padStart(2, '0')}:00` :
                        alert.street || 'Rua não disponível';
            tableContent += `<tr><td>${label}</td><td>${alert.count}</td></tr>`;
        });
        tableContent += `</tbody></table>`;

        // Preenche a tabela
        document.getElementById('alertsTable').innerHTML = tableContent;

        // Inicializa o DataTable se ainda não foi feito
        if (!jq.fn.dataTable.isDataTable('#alertsTable')) {
            jq('#alertsTable').DataTable({
                dom: 'Bfrtip',
                buttons: [
                    'copy', 'csv', 'excel', 'pdf'
                ]
            });
        } else {
            // Caso já tenha sido inicializado, recarrega os dados
            jq('#alertsTable').DataTable().clear();
            jq('#alertsTable').DataTable().rows.add(alerts); 
            jq('#alertsTable').DataTable().draw();
        }
    }

    // Inicializa eventos
    document.getElementById('filterForm').addEventListener('submit', event => {
        event.preventDefault();
        const startDate = document.getElementById('start_date').value;
        const endDate = document.getElementById('end_date').value;
        const groupBy = document.getElementById('group_by').value;
        fetchAccidentAlerts(startDate, endDate, groupBy);
    });

    // Preenche automaticamente as datas no filtro (início do mês até hoje +1)
    document.addEventListener('DOMContentLoaded', () => {
        const now = new Date();
        const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
        const endOfDay = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1);

        const startDate = startOfMonth.toISOString().split('T')[0];
        const endDate = endOfDay.toISOString().split('T')[0];

        document.getElementById('start_date').value = startDate;
        document.getElementById('end_date').value = endDate;

        const groupBy = 'date';  // Padrão
        fetchAccidentAlerts(startDate, endDate, groupBy);
    });
</script>
