<link href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>

<div class="container my-5">
    <h1 class="text-center mb-4">Histórico de Acidentes</h1>

    <!-- Filtro de Datas e Agrupamento -->
    <form id="filterForm" class="my-4">
        <div class="row g-3">
            <div class="col-md-4">
                <label for="start_date" class="form-label">Data Inicial:</label>
                <input type="date" class="form-control" id="start_date" name="start_date">
            </div>
            <div class="col-md-4">
                <label for="end_date" class="form-label">Data Final:</label>
                <input type="date" class="form-control" id="end_date" name="end_date">
            </div>
            <div class="col-md-4">
                <label for="group_by" class="form-label">Agrupar por:</label>
                <select class="form-control" id="group_by" name="group_by">
                    <option value="date">Data</option>
                    <option value="hour">Hora</option>
                    <option value="street">Rua</option>
                </select>
            </div>
        </div>
        <button type="submit" class="btn btn-primary w-100 mt-3">Filtrar</button>
    </form>

    <!-- Gráfico de Alertas -->
    <div id="alertsChartContainer" class="my-5" style="display: none; width: 100%; height: 50vh; max-height: 400px;">
        <canvas id="alertsChart"></canvas>
    </div>

    <!-- Lista de Alertas -->
    <div id="alertsTable" class="my-5">
        <p>Nenhum alerta carregado.</p>
    </div>
</div>

<script>
    // Função para buscar e exibir dados
    // Função para buscar e exibir dados
async function fetchAccidentAlerts(startDate, endDate, groupBy) {
    try {
        const response = await fetch(`../wazeportal/api.php?action=get_alerts&start_date=${startDate}&end_date=${endDate}&group_by=${groupBy}`);
        const data = await response.json();

        if (data.error) {
            console.error(data.error);
            document.getElementById('alertsTable').innerHTML = `<p>${data.error}</p>`;
            return;
        }

        // Atualiza tabela e gráfico
        updateTable(data.alerts, groupBy);
        if (data.alerts.length > 0) {
            document.getElementById('alertsChartContainer').style.display = 'block';
            updateChart(data.labels, data.data_counts, groupBy);
        } else {
            document.getElementById('alertsChartContainer').style.display = 'none';
        }
    } catch (error) {
        console.error('Erro ao buscar dados:', error);
        document.getElementById('alertsTable').innerHTML = `<p>Erro ao carregar os dados.</p>`;
    }
}

// Atualiza gráfico
function updateChart(labels, dataCounts, groupBy) {
    // Converte os valores de data_counts para números
    const dataValues = dataCounts.map(count => parseInt(count, 10));

    const ctx = document.getElementById('alertsChart').getContext('2d');
    if (window.alertsChartInstance) window.alertsChartInstance.destroy();

    const chartType = groupBy === 'date' ? 'line' : groupBy === 'street' ? 'pie' : 'bar';
    const chartData = {
        labels,
        datasets: [{
            label: 'Número de Alertas',
            backgroundColor: chartType === 'pie'
                ? labels.map(() => `rgba(${Math.random() * 255}, ${Math.random() * 255}, ${Math.random() * 255}, 0.6)`)
                : 'rgba(75, 192, 192, 0.2)',
            borderColor: 'rgba(75, 192, 192, 1)',
            data: dataValues // Usando os valores numéricos
        }]
    };

    const config = {
        type: chartType,
        data: chartData,
        plugins: [ChartDataLabels],
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'top' },
                title: { display: true, text: `Histórico de Acidentes (${groupBy})` },
                datalabels: {
                    color: 'black',
                    formatter: value => value > 0 ? value : ''
                }
            },
            scales: chartType !== 'pie' ? {
                x: { title: { display: true, text: 'Categorias' } },
                y: { title: { display: true, text: 'Quantidade' }, beginAtZero: true }
            } : {}
        }
    };

    window.alertsChartInstance = new Chart(ctx, config);
}


    // Atualiza tabela
function updateTable(alerts, groupBy) {
    let tableContent = `
        <table class="table table-bordered table-striped">
            <thead>
                <tr>
                    <th>${groupBy === 'date' ? 'Data' : groupBy === 'hour' ? 'Hora' : 'Rua'}</th>
                    <th>Quantidade</th>
                    <th>Eventos</th>
                </tr>
            </thead>
            <tbody>
    `;
    alerts.forEach(alert => {
        let label = groupBy === 'date' ? alert.alert_date :
                    groupBy === 'hour' ? `${String(alert.alert_hour).padStart(2, '0')}:00` :
                    alert.street || 'Rua não disponível';
        // Verifica se 'events' existe e é um array antes de tentar fazer join
        let events = Array.isArray(alert.events) ? alert.events.join(', ') : 'Nenhum evento';
        tableContent += `<tr><td>${label}</td><td>${alert.count}</td><td>${events}</td></tr>`;
    });
    tableContent += `</tbody></table>`;
    document.getElementById('alertsTable').innerHTML = tableContent;
}


    // Inicializa eventos
    document.getElementById('filterForm').addEventListener('submit', event => {
        event.preventDefault();
        const startDate = document.getElementById('start_date').value;
        const endDate = document.getElementById('end_date').value;
        const groupBy = document.getElementById('group_by').value;
        const idParceiro = "{{ session.usuario.id_parceiro }}";  // Pegando o valor do id_parceiro diretamente do Twig
        fetchAccidentAlerts(startDate, endDate, groupBy, idParceiro);
    });

    // Carrega gráfico inicial
    document.addEventListener('DOMContentLoaded', () => {
        const startDate = document.getElementById('start_date').value;
        const endDate = document.getElementById('end_date').value;
        const groupBy = 'date';  // Padrão
        const idParceiro = "{{ session.usuario.id_parceiro }}";  // Pegando o valor do id_parceiro diretamente do Twig
        fetchAccidentAlerts(startDate, endDate, groupBy, idParceiro);
    });
</script>
