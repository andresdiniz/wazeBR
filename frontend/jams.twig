<!-- Leaflet CSS + JS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>     

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<!-- Highcharts -->
<script src="https://code.highcharts.com/highcharts.js"></script>
<script src="https://code.highcharts.com/modules/heatmap.js"></script>

<!-- Highcharts Heatmap CSS -->
<link rel="stylesheet" href="https://code.highcharts.com/css/highcharts.css" />

<!-- DataTables CSS e JS -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.bootstrap5.min.css">
<script src="https://code.jquery.com/jquery-3.7.0.js"></script>
<script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>
<script src="https://cdn.datatables.net/responsive/2.5.0/js/responsive.bootstrap5.min.js"></script>

<script src="https://omnipotent.net/jquery.sparkline/2.1.2/jquery.sparkline.js"></script>

<!-- Font Awesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
    .insight-card {
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        transition: transform 0.3s ease;
    }
    
    .insight-card:hover {
        transform: translateY(-5px);
    }
    
    .progress {
        border-radius: 10px;
        overflow: hidden;
    }
    
    .fa-2x {
        width: 40px;
        text-align: center;
    }
    
    #mapContainer {
        height: 500px;
        width: 100%;
    }
    
    .border-primary {
        border-left: 4px solid #0d6efd;
    }
    
    .border-info {
        border-left: 4px solid #0dcaf0;
    }
    
    .border-warning {
        border-left: 4px solid #ffc107;
    }
    
    .border-danger {
        border-left: 4px solid #dc3545;
    }
    
    .border-success {
        border-left: 4px solid #198754;
    }

    /* Estilos específicos para tabela responsiva */
    .dataTables_filter, .dataTables_length {
        margin-bottom: 15px;
    }
    
    .severity-high {
        background-color: rgba(220, 53, 69, 0.1);
        border-left: 4px solid #dc3545;
    }
    
    .severity-medium {
        background-color: rgba(255, 193, 7, 0.1);
        border-left: 4px solid #ffc107;
    }
    
    .severity-low {
        background-color: rgba(25, 135, 84, 0.1);
        border-left: 4px solid #198754;
    }
    
    .badge {
        font-size: 85%;
        padding: 5px 8px;
        border-radius: 4px;
    }
    
    .badge-success {
        background-color: #198754;
        color: white;
    }
    
    .badge-secondary {
        background-color: #6c757d;
        color: white;
    }
    
    .btn-map {
        white-space: nowrap;
    }
    
    /* Melhoria para exibição em telas pequenas */
    @media (max-width: 767px) {
        .card-body {
            padding: 0.5rem;
        }
        
        .table-responsive {
            border: none;
        }
        
        .dtr-details {
            width: 100%;
        }
        
        .dtr-title {
            font-weight: bold;
            margin-right: 8px;
        }
    }
</style>

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            {% if jams is not empty %}
                <div class="card shadow mb-4">
                    <div class="card-header py-3 d-flex justify-content-between align-items-center">
                        <h6 class="m-0 font-weight-bold text-primary">Detalhes dos Congestionamentos</h6>
                        <div class="d-none d-sm-block">
                            <span class="badge severity-high me-2">Crítico (>5 min)</span>
                            <span class="badge severity-medium me-2">Moderado (1-5 min)</span>
                            <span class="badge severity-low">Leve (<1 min)</span>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover" id="routesTable" width="100%" cellspacing="0">
                                <thead class="thead-dark">
                                    <tr>
                                        <th>Cidade</th>
                                        <th>Início</th>
                                        <th>Fim</th>
                                        <th class="text-center">Vel. Normal</th>
                                        <th class="text-center">Vel. Atual</th>
                                        <th class="text-center">Atraso</th>
                                        <th class="text-center">Comprimento</th>
                                        <th class="text-center">Publicado</th>
                                        <th class="text-center">Status</th>
                                        <th class="text-center no-sort">Ações</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for jam in jams %}
                                        {% set speedKMH = jam.speedKMH|default(0) %}
                                        {% set speed = jam.speed|default(0) %}
                                        {% set delay_minutes = jam.delay / 60 %}
                                        {% set pub_date = jam.pubMillis / 1000 %}
                                        {% set length = jam.length|default(0) %}
                                        {% set severity = '' %}
                                        {% if delay_minutes > 5 %}
                                            {% set severity = 'severity-high' %}
                                        {% elseif delay_minutes > 1 %}
                                            {% set severity = 'severity-medium' %}
                                        {% else %}
                                            {% set severity = 'severity-low' %}
                                        {% endif %}
                                        
                                        <tr data-uuid="{{ jam.uuid }}" class="{{ severity }}">
                                            <td data-label="Cidade">{{ jam.city }}</td>
                                            <td data-label="Início">{{ jam.street }}</td>
                                            <td data-label="Fim">{{ jam.endNode }}</td>
                                            <td data-label="Vel. Normal" class="text-center">{{ speedKMH|number_format(2) }} km/h</td>
                                            <td data-label="Vel. Atual" class="text-center">{{ (speed)|number_format(1) }} km/h</td>
                                            <td data-label="Atraso" class="text-center">{{ delay_minutes|number_format(1) }} min</td>
                                            <td data-label="Comprimento" class="text-center">{{ length|number_format(0) }} m</td>
                                            <td data-label="Publicado" class="text-center">{{ pub_date|round(0, 'floor')|date("d/m/Y H:i") }}</td>
                                            <td data-label="Status" class="text-center">
                                                {% if jam.status == 1 %}
                                                    <span class="badge badge-success">Ativo</span>
                                                {% else %}
                                                    <span class="badge badge-secondary">Inativo</span>
                                                {% endif %}
                                            </td>
                                            <td data-label="Ações" class="text-center">
                                                <button class="btn btn-primary btn-sm view-route btn-map"
                                                    data-bs-toggle="modal"
                                                    data-bs-target="#mapModal"
                                                    data-route-id="{{ jam.uuid }}"
                                                    title="Ver detalhes da rota">
                                                    <i class="fas fa-map-marker-alt"></i> <span class="d-none d-md-inline">VER MAPA</span>
                                                </button>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>                                
                            </table>
                        </div>
                    </div>
                </div>
            {% else %}
                <div class="alert alert-info text-center" role="alert">
                    <h4 class="alert-heading">Sem Rotas Monitoradas!</h4>
                    <p>Não há rotas configuradas ou dados disponíveis no momento.</p>
                </div>
            {% endif %}
        </div>
    </div>

    <div id="loadingIndicator" style="display: none; text-align: center; padding: 20px;">
        <div class="spinner-border text-primary" role="status">
            <span class="sr-only">Carregando...</span>
        </div>
        <p class="mt-2 text-muted">Carregando detalhes da rota...</p>
    </div>
</div>

<!-- Modal para exibir detalhes da rota -->
<div class="modal fade" id="mapModal" tabindex="-1" aria-labelledby="modalRouteName" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 id="modalRouteName" class="modal-title">Detalhes da Rota</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body">
                <div id="mapContainer"></div>
                <div id="insightsContainer" class="mt-3"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>

<!-- Importar o script original -->
<script src="../js/scripts-jams.js