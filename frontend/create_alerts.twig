<div class="container mt-3">
    <div class="row">
        <div class="col-lg-6">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h3>Criar Evento</h3>
                </div>
                <div class="card-body">
                    <form action="criar_evento.php" method="post" id="eventoForm">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="nome" class="form-label">Nome do Evento</label>
                                <input type="text" class="form-control" id="nome" name="nome" required>
                            </div>
                            <div class="col-md-6">
                                <label for="descricao" class="form-label">Descrição</label>
                                <textarea class="form-control" id="descricao" name="descricao" required></textarea>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="tipo" class="form-label">Tipo</label>
                                <select class="form-select" id="tipo" name="tipo" required>
                                    <option value="">Selecione um Tipo</option>
                                    {% for tipo in tipos %}
                                        <option value="{{ tipo.id }}">{{ tipo.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="subtipo" class="form-label">Subtipo</label>
                                <select class="form-select" id="subtipo" name="subtipo" required>
                                    <option value="">Selecione um Subtipo</option>
                                </select>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="starttime" class="form-label">Início do Evento</label>
                                <input type="datetime-local" class="form-control" id="starttime" name="starttime" required>
                            </div>
                            <div class="col-md-6">
                                <label for="endtime" class="form-label">Fim do Evento</label>
                                <input type="datetime-local" class="form-control" id="endtime" name="endtime" required>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <label for="coordenadas" class="form-label">Coordenadas do Evento (lat, lon)</label>
                            <input type="text" class="form-control" id="coordenadas" name="coordenadas" required placeholder="Clique no mapa para definir as coordenadas" readonly>
                        </div>
                        <div class="row mb-3">
                            <label for="rua" class="form-label">Selecione a Rua</label>
                            <select class="form-select" id="rua" name="rua" required>
                                <option value="">Selecione uma rua</option>
                                <!-- As opções de rua serão preenchidas dinamicamente aqui -->
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary mt-3">Criar Evento</button>
                    </form>
                </div>
            </div>
        </div>
        <div class="col-lg-6">
            <div id="map" class="mb-3" style="height: 400px;"></div>
        </div>
    </div>
</div>

<script>
    // Carrega os subtipos de acordo com o tipo selecionado
    document.addEventListener('DOMContentLoaded', function () {
        const tipoSelect = document.getElementById('tipo');
        const subtipoSelect = document.getElementById('subtipo');

        const subtiposPorTipo = {{ subtiposPorTipo|json_encode|raw }};

        tipoSelect.addEventListener('change', function () {
            const selectedTipoId = tipoSelect.value;
            subtipoSelect.innerHTML = '<option value="">Selecione um Subtipo</option>';

            if (subtiposPorTipo[selectedTipoId]) {
                subtiposPorTipo[selectedTipoId].forEach(function (subtipo) {
                    const option = document.createElement('option');
                    option.value = subtipo.id;
                    option.textContent = subtipo.name;
                    subtipoSelect.appendChild(option);
                });
            }
        });
    });

    // Manipulador do envio do formulário
    document.getElementById('eventoForm').addEventListener('submit', function (event) {
        event.preventDefault();

        var nome = document.getElementById('nome').value.trim();
        var descricao = document.getElementById('descricao').value.trim();
        var tipo = document.getElementById('tipo').value;
        var subtipo = document.getElementById('subtipo').value;
        var coordenadas = document.getElementById('coordenadas').value.trim();
        var rua = document.getElementById('rua').value;
        var starttime = document.getElementById('starttime').value;
        var endtime = document.getElementById('endtime').value;

        // Validação dos campos obrigatórios
        if (!nome || !descricao || !tipo || !subtipo || !coordenadas || !rua || !starttime || !endtime) {
            alert('Todos os campos são obrigatórios.');
            return;
        }

        // Envia os dados via fetch para o servidor
        var queryParams = new URLSearchParams({
            action: 'criar_evento',
            nome: nome,
            descricao: descricao,
            tipo: tipo,
            subtipo: subtipo,
            coordenadas: coordenadas,
            rua: rua,
            starttime: starttime,
            endtime: endtime
        });

        fetch('api.php?' + queryParams.toString(), {
            method: 'GET',
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Evento criado com sucesso!');
                // Redirecionar ou limpar o formulário
                document.getElementById('eventoForm').reset();
            } else {
                alert('Erro ao criar evento: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Erro ao criar evento:', error);
            alert('Ocorreu um erro ao criar o evento. Tente novamente.');
        });
    });
</script>
