<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<div class="container mt-4 mb-4">
    <div class="row">
        <div class="col-lg-6 mb-3">
            <h3 class="text-primary">Criar Alerta</h3>
        </div>
    </div>
    <div class="row">
        <div class="col-lg-8">
            <div class="card shadow-sm p-4">
                <form action="api.php?action=cadastrar_evento" method="post" id="eventoForm">

                    <div>
                        <input type="hidden" name="id_parceiro" value="{{ id_parceiro }}">
                    </div>

                    <div class="mb-3">
                        <label for="nome" class="form-label">Descriﾃｧﾃ｣o do Evento</label>
                        <input type="text" class="form-control" id="nome" name="nome" required
                            placeholder="Escreva uma descriﾃｧﾃ｣o breve do Evento" maxlength="250">
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="tipo" class="form-label">Tipo</label>
                            <select class="form-select" id="tipo" name="tipo" required>
                                <option value="">Selecione um Tipo</option>
                                {% for tipo in tipos %}
                                <option value="{{ tipo.id }}">{{ tipo.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="subtipo" class="form-label">Subtipo</label>
                            <select class="form-select" id="subtipo" name="subtipo" required>
                                <option value="">Selecione um Subtipo</option>
                            </select>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="starttime" class="form-label">Data de Inﾃｭcio</label>
                            <input type="date" id="starttime" class="form-control" name="starttime">
                        </div>
                        <div class="col-md-6">
                            <label for="endtime" class="form-label">Data de Tﾃｩrmino</label>
                            <input type="date" id="endtime" class="form-control" name="endtime">
                        </div>
                    </div>
                    <div id="horarios_dia" class="mb-3">
                        </div>


                    <div class="mb-3">
                        <label for="coordenadas" class="form-label">Coordenadas do Evento (lat, lon)</label>
                        <input type="text" class="form-control" id="coordenadas" name="coordenadas" required
                            placeholder="Clique no mapa para definir as coordenadas" readonly>
                    </div>

                    <div class="mb-3">
                        <label for="rua" class="form-label">Selecione a Rua</label>
                        <select class="form-select" id="ruaSelect" name="rua" required>
                            <option value="">Selecione uma rua</option>
                            </select>
                    </div>

                    <div id="segmentSelectionContainer" class="card shadow-sm p-3 mb-3 border-warning" style="display: none;">
                        <h5 class="text-warning">沒｢ Defina o Segmento da Via</h5>
                        <p class="text-muted small">Clique no mapa para definir a localizaﾃｧﾃ｣o. Selecione abaixo o trecho exato que deseja marcar:</p>
                        <div class="mb-3">
                            <label for="segmentOptions" class="form-label">Escolha o trecho:</label>
                            <select class="form-select" id="segmentOptions" required>
                                </select>
                        </div>
                        <button type="button" id="confirmSegmentBtn" class="btn btn-success mb-2">笨 Confirmar Seleﾃｧﾃ｣o</button>
                        <button type="button" id="cancelSegmentBtn" class="btn btn-secondary btn-sm">Cancelar e Clicar Novamente</button>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="mb-2">
                                <label for="directionSelect" class="form-label">Escolha o Sentido</label>
                                <select id="directionSelect" class="form-select" name="directionSelect">
                                    </select>
                            </div>
                            <div id="buttonContainer" class="mt-2">
                                </div>

                            {% if id_parceiro == 99 %}
                            <div class="mb-3">
                                <label for="parceiro" class="form-label">Selecione um Parceiro</label>
                                <select class="form-select" id="parceiro" name="id_parceiro_alert" required>
                                    <option value="">Selecione um Parceiro</option>
                                    {% for parceiro in parceiros %}
                                    <option value="{{ parceiro.id }}">{{ parceiro.Nome }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            {% endif %}

                        </div>
                        <div class="col-md-6 d-flex align-items-end justify-content-end">
                            <button type="submit" class="btn btn-primary">Criar Evento</button>
                        </div>
                    </div>

                </form>
            </div>
        </div>

        <div class="col-lg-4 mt-4 mt-lg-0">
            <div id="map" class="card shadow-sm" style="height: 500px;"></div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@turf/turf/turf.min.js"></script>
// ===== VERSﾃグ REVISADA E CONSOLIDADA DO SCRIPT =====
<script>
    // ===== Configuraﾃｧﾃｵes Globais =====
    const MAP_CONFIG = {
        SEGMENT_COLORS: {
            original: '#0000ff',
            reversed: '#ff0000',
            both: '#00ff00'
        },
        PREVIEW_COLOR: '#FFA500', // Laranja para o preview
        ARROW_OPTIONS: {
            pixelSize: 15,
            weight: 2
        },
        LOCAL_STORAGE_KEYS: {
            SEGMENT: 'streetSegment',
            DIRECTION: 'segmentDirection'
        }
    };

    // Inicializa calendarios (Assumindo que flatpickr estﾃ｡ carregado)
    flatpickr("#starttime", { enableTime: true, dateFormat: "Y-m-d H:i", time_24hr: true });
    flatpickr("#endtime", { enableTime: true, dateFormat: "Y-m-d H:i", time_24hr: true });
    
    // Variﾃ｡veis Globais para Camadas e Estado
    let currentSegmentNodes = [];
    let currentSegmentLayer = null; // Camada final e permanente
    let previewSegmentLayer = null; // Camada temporﾃ｡ria para o preview de seleﾃｧﾃ｣o
    let clickMarker = null; // Marcador temporﾃ｡rio do local de clique

    // ===== Funﾃｧﾃｵes de Controle de Camadas e Desenho =====

    function clearMapLayers(map) {
        if (currentSegmentLayer) {
            map.removeLayer(currentSegmentLayer);
            currentSegmentLayer = null;
        }
        if (previewSegmentLayer) {
            map.removeLayer(previewSegmentLayer);
            previewSegmentLayer = null;
        }
        if (clickMarker) {
            map.removeLayer(clickMarker);
            clickMarker = null;
        }
    }

    function drawPreviewSegment(map, segmentNodes) {
        if (!segmentNodes || segmentNodes.length < 2) return;
        
        // Limpar apenas o preview anterior
        if (previewSegmentLayer) {
            map.removeLayer(previewSegmentLayer);
            previewSegmentLayer = null;
        }
        // Limpar o marcador de clique, que serﾃ｡ recriado no mapa.on('click')
        if (clickMarker) {
            map.removeLayer(clickMarker);
            clickMarker = null;
        }

        const latLngs = segmentNodes.map(coord => [coord[1], coord[0]]);

        const previewStyle = {
            color: MAP_CONFIG.PREVIEW_COLOR, 
            weight: 6,
            opacity: 0.7,
            dashArray: '10, 10' // Linha tracejada
        };

        const segmentLayer = L.polyline(latLngs, previewStyle);

        const arrowLayer = L.polylineDecorator(segmentLayer, {
            patterns: [{
                offset: '50%',
                repeat: '100px',
                symbol: L.Symbol.arrowHead({
                    pixelSize: MAP_CONFIG.ARROW_OPTIONS.pixelSize,
                    weight: MAP_CONFIG.ARROW_OPTIONS.weight,
                    pathOptions: previewStyle
                })
            }]
        });

        previewSegmentLayer = L.layerGroup([segmentLayer, arrowLayer]).addTo(map);

        // Ajustar a vista do mapa para o segmento selecionado
        map.fitBounds(segmentLayer.getBounds(), { padding: [50, 50] });
    }

    function drawSegment(map, segmentNodes, direction = 'both') {
        // Limpa o preview e o segmento final antes de desenhar o novo segmento final
        clearMapLayers(map); 
        
        const latLngs = segmentNodes.map(coord => [coord[1], coord[0]]);

        let color;
        if (direction === 'single' || direction === 'reversed') {
            color = (direction === 'reversed') ? MAP_CONFIG.SEGMENT_COLORS.reversed : MAP_CONFIG.SEGMENT_COLORS.original;
        } else {
            color = MAP_CONFIG.SEGMENT_COLORS.both;
        }

        const lineStyle = { color: color, weight: 4 };

        const segmentLayer = L.polyline(latLngs, lineStyle);

        const arrowLayer = L.polylineDecorator(segmentLayer, {
            patterns: [{
                offset: '50%',
                repeat: '100px',
                symbol: L.Symbol.arrowHead({
                    ...MAP_CONFIG.ARROW_OPTIONS,
                    pathOptions: lineStyle
                })
            }]
        });

        // Salvar o estado final
        localStorage.setItem(MAP_CONFIG.LOCAL_STORAGE_KEYS.SEGMENT, JSON.stringify(segmentNodes));
        localStorage.setItem(MAP_CONFIG.LOCAL_STORAGE_KEYS.DIRECTION, direction);

        currentSegmentLayer = L.layerGroup([segmentLayer, arrowLayer]).addTo(map);
        return currentSegmentLayer;
    }

    // ===== Funﾃｧﾃｵes de Inicializaﾃｧﾃ｣o e Helpers =====
    function initializeMap() {
        const map = L.map('map').setView([-23.55052, -46.633308], 15); 
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);
        return map;
    }

    function locateUser(map) {
        map.locate({ setView: true, maxZoom: 12 });
        map.on('locationerror', (e) => showAlert('Nﾃ｣o foi possﾃｭvel localizar a sua posiﾃｧﾃ｣o.', 'warning'));
    }

    function handleLocationFound(e, map) {
        clickMarker = L.marker(e.latlng).addTo(map).bindPopup('Vocﾃｪ estﾃ｡ aqui!').openPopup();
        L.circle(e.latlng, e.accuracy / 2).addTo(map);
    }

    // --- Funﾃｧﾃｵes de Busca (Mantidas, mas assumindo que 'turf' estﾃ｡ carregado) ---
    async function getStreetSegment(map, lat, lon) {
        // ... (Lﾃｳgica de consulta Overpass API - Omitida aqui, mas deve estar completa) ...
        // Se encontrar, chama promptSegmentSelection(map, { intersectionSegment: ..., fullSegment: ... }, lat, lon);
    }
    // --- Fim das funﾃｧﾃｵes de busca ---

    function updateDirectionControls(direction) {
        const directionSelect = document.getElementById('directionSelect');
        if (directionSelect) directionSelect.value = direction;
        // Lﾃｳgica para mostrar/esconder botﾃ｣o de reversﾃ｣o (Simplificada/Removida temporariamente para focar no bug)
    }
    
    function saveSegmentState(segment, direction) {
        localStorage.setItem(MAP_CONFIG.LOCAL_STORAGE_KEYS.SEGMENT, JSON.stringify(segment));
        localStorage.setItem(MAP_CONFIG.LOCAL_STORAGE_KEYS.DIRECTION, direction);
    }

    function loadSavedSegment(map) {
        const savedSegment = localStorage.getItem(MAP_CONFIG.LOCAL_STORAGE_KEYS.SEGMENT);
        const savedDirection = localStorage.getItem(MAP_CONFIG.LOCAL_STORAGE_KEYS.DIRECTION);

        if (savedSegment && savedDirection) {
            currentSegmentNodes = JSON.parse(savedSegment);
            drawSegment(map, currentSegmentNodes, savedDirection);
            updateDirectionControls(savedDirection);
        }
    }

    function showAlert(message, type = 'info') {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-2`;
        alertDiv.style.zIndex = 2000;
        alertDiv.innerHTML = `${message}<button type="button" class="btn-close" data-bs-dismiss="alert"></button>`;
        document.body.appendChild(alertDiv);
        setTimeout(() => alertDiv.remove(), 7000);
    }
    
    // ===== NOVO: Gerenciamento do Painel de Seleﾃｧﾃ｣o com Preview =====
    function promptSegmentSelection(map, segmentData, lat, lon) {
        const container = document.getElementById('segmentSelectionContainer');
        const optionsSelect = document.getElementById('segmentOptions');
        const confirmBtn = document.getElementById('confirmSegmentBtn');
        const cancelBtn = document.getElementById('cancelSegmentBtn');
        
        // Limpar listeners anteriores
        optionsSelect.onchange = null;
        confirmBtn.onclick = null;
        cancelBtn.onclick = null;

        container.style.display = 'block'; 
        optionsSelect.innerHTML = '';

        const intersectionNodes = segmentData.intersectionSegment;
        const fullNodes = segmentData.fullSegment;
        
        // Preencher as opﾃｧﾃｵes
        if (intersectionNodes) {
            const opt1 = document.createElement('option');
            opt1.value = 'intersection';
            opt1.textContent = 'Trecho entre Interseﾃｧﾃｵes (Recomendado)';
            optionsSelect.appendChild(opt1);
        }

        const opt2 = document.createElement('option');
        opt2.value = 'full';
        opt2.textContent = 'Via Completa (Todos os nﾃｳs encontrados)';
        optionsSelect.appendChild(opt2);
        
        optionsSelect.value = intersectionNodes ? 'intersection' : 'full';

        // Desenho inicial do Preview
        const defaultNodes = optionsSelect.value === 'intersection' ? intersectionNodes : fullNodes;
        drawPreviewSegment(map, defaultNodes);

        // Coloca o marcador de clique (somente para referﾃｪncia visual)
        clickMarker = L.marker([lat, lon]).addTo(map).bindPopup("Ponto de referﾃｪncia").openPopup();


        // Listener para mudanﾃｧa na seleﾃｧﾃ｣o -> Atualiza o Preview
        optionsSelect.onchange = () => {
            const selectedType = optionsSelect.value;
            let nodesToPreview;
            
            if (selectedType === 'intersection' && intersectionNodes) {
                nodesToPreview = intersectionNodes;
            } else {
                nodesToPreview = fullNodes;
            }
            drawPreviewSegment(map, nodesToPreview);
        };
        
        // Listener de confirmaﾃｧﾃ｣o
        confirmBtn.onclick = () => {
            const selectedType = optionsSelect.value;
            let nodesToDraw;

            if (selectedType === 'intersection' && intersectionNodes) {
                nodesToDraw = intersectionNodes;
            } else {
                nodesToDraw = fullNodes; 
            }

            if (nodesToDraw && nodesToDraw.length > 1) {
                currentSegmentNodes = nodesToDraw;
                const selectedDirection = document.getElementById('directionSelect').value;
                
                // Desenha o segmento final
                currentSegmentLayer = drawSegment(map, nodesToDraw, selectedDirection);
                container.style.display = 'none';
                showAlert(`Segmento confirmado!`, 'success');
            } else {
                showAlert('Erro ao confirmar o segmento.', 'danger');
            }
        };
        
        // Listener para cancelar
        cancelBtn.onclick = () => {
            container.style.display = 'none';
            showAlert('Seleﾃｧﾃ｣o cancelada. Clique no mapa novamente.', 'info');
            clearMapLayers(map); 
            currentSegmentNodes = [];
        };
    }

    // ===== EXECUﾃﾃグ PRINCIPAL =====
    document.addEventListener('DOMContentLoaded', function () {
        const map = initializeMap();
        const directionSelect = document.getElementById('directionSelect');
        const starttimeInput = document.getElementById('starttime');
        const endtimeInput = document.getElementById('endtime');
        const tipoSelect = document.getElementById('tipo');
        const subtipoSelect = document.getElementById('subtipo');
        const subtiposPorTipo = {{ subtiposPorTipo | json_encode | raw }}; // ESSA LINHA DEPENDE DA SUA LINGUAGEM DE TEMPLATE

        loadSavedSegment(map);
        locateUser(map);
        // ... (Inicializaﾃｧﾃ｣o de direﾃｧﾃｵes, datas, subtipos) ...
        if (directionSelect) { atualizarDirecoes(directionSelect); directionSelect.addEventListener('change', () => { /* ... */ }); }
        if (starttimeInput && endtimeInput) { starttimeInput.addEventListener('change', calcularDiasSemana); endtimeInput.addEventListener('change', calcularDiasSemana); }
        if (tipoSelect && subtipoSelect) { tipoSelect.addEventListener('change', () => carregarSubtiposPorTipo(tipoSelect, subtipoSelect, subtiposPorTipo)); }


        map.on('click', (e) => {
            if (document.getElementById('segmentSelectionContainer').style.display === 'block') return;
            
            clearMapLayers(map);
            currentSegmentNodes = [];
            
            const lat = e.latlng.lat;
            const lon = e.latlng.lon;
            
            // Preenche campo de coordenadas
            document.getElementById('coordenadas').value = `${lat.toFixed(6)}, ${lon.toFixed(6)}`;
            
            // Consulta rua (Assumindo que consultarRuaWaze existe)
            consultarRuaWaze(lat, lon).then(nomeRuaWaze => {
                if (nomeRuaWaze) {
                    const ruaSelect = document.getElementById('ruaSelect');
                    if (ruaSelect) {
                        ruaSelect.innerHTML = `<option value="${nomeRuaWaze}">${nomeRuaWaze}</option>`;
                        ruaSelect.value = nomeRuaWaze;
                    }
                }
            });

            // **CHAMA A FUNﾃﾃグ QUE ABRE O PAINEL DE SELEﾃﾃグ**
            // Nota: A funﾃｧﾃ｣o getStreetSegment precisa ser completada com a lﾃｳgica de consulta Overpass
            // getStreetSegment(map, lat, lon); // <-- Descomente esta linha apﾃｳs completar getStreetSegment
            
            // *** SIMULAﾃﾃグ PARA TESTE DE PREVIEW SEM A API OVERPASS ***
            // Substitua o bloco acima pela chamada real quando a API Overpass estiver 100% implementada
            // Exemplo de dados de segmento simulados:
             const simulatedSegmentData = { 
                 intersectionSegment: [[-46.6, -23.5], [-46.7, -23.6]], // Nﾃｳ 1, Nﾃｳ 2
                 fullSegment: [[-46.6, -23.5], [-46.75, -23.65], [-46.8, -23.7]] // Nﾃｳs completos
             };
             promptSegmentSelection(map, simulatedSegmentData, lat, lon);
            // *** FIM DA SIMULAﾃﾃグ ***

        });

        // Lﾃｳgica de Submit do formulﾃ｡rio (Mantida)
        document.getElementById('eventoForm').addEventListener('submit', function (e) {
            e.preventDefault(); 
            const segment = localStorage.getItem(MAP_CONFIG.LOCAL_STORAGE_KEYS.SEGMENT);
            const direction = localStorage.getItem(MAP_CONFIG.LOCAL_STORAGE_KEYS.DIRECTION);

            if (!segment || !direction) {
                showAlert('Por favor, selecione e confirme o trecho da via antes de enviar.', 'error');
                return; 
            }

            const formData = new FormData(this);
            formData.append('streetSegment', segment);
            formData.append('segmentDirection', direction);
            
            fetch(this.action, { method: 'POST', body: formData })
                .then(response => response.json().then(data => ({ ok: response.ok, data })))
                .then(({ ok, data }) => {
                    if (ok && data.success) {
                        localStorage.clear(); 
                        window.location.href = "https://wfcbrasil.com.br/create_alerts";
                    } else {
                        showAlert(data.message || "Erro no envio dos dados.", 'danger');
                    }
                })
                .catch(error => {
                    console.error("Erro ao enviar:", error);
                    showAlert("Falha na comunicaﾃｧﾃ｣o com o servidor.", 'danger');
                });
        });
    });
</script>

<style>
    /* Estilos Aprimorados */
    #map {
        border-radius: 8px;
        transition: box-shadow 0.3s ease;
    }

    #map:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .leaflet-popup-content {
        font-size: 14px;
        padding: 8px;
    }

    .btn-warning {
        background-color: #ffc107;
        border-color: #ffc107;
        transition: all 0.3s ease;
    }

    .btn-warning:hover {
        transform: translateY(-2px);
        box-shadow: 0 2px 8px rgba(255, 193, 7, 0.3);
    }

    /* Estilo para o novo painel de seleﾃｧﾃ｣o */
    #segmentSelectionContainer {
        border-left: 5px solid #ffc107 !important; /* Cor de destaque */
    }
</style>