<div class="container mt-3">
    <div class="row">
        <div class="col-lg-6">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h3>Criar Evento</h3>
                </div>
                <div class="card-body">
                    <form action="api.php?action=cadastrar_evento" method="post" id="eventoForm">
                        <!-- Seção de Nome e Descrição -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <label for="nome" class="form-label">Nome do Evento</label>
                                <input type="text" class="form-control" id="nome" name="nome" required>
                            </div>
                            <div class="col-md-6">
                                <label for="descricao" class="form-label">Descrição</label>
                                <textarea class="form-control" id="descricao" name="descricao" required></textarea>
                            </div>
                        </div>

                        <!-- Seção de Tipo e Subtipo -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <label for="tipo" class="form-label">Tipo</label>
                                <select class="form-select" id="tipo" name="tipo" required>
                                    <option value="">Selecione um Tipo</option>
                                    {% for tipo in tipos %}
                                        <option value="{{ tipo.id }}">{{ tipo.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="subtipo" class="form-label">Subtipo</label>
                                <select class="form-select" id="subtipo" name="subtipo" required>
                                    <option value="">Selecione um Subtipo</option>
                                </select>
                            </div>
                        </div>

                        <!-- Seção de Início e Fim do Evento -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <label for="starttime" class="form-label">Início do Evento</label>
                                <input type="datetime-local" class="form-control" id="starttime" name="starttime" required>
                            </div>
                            <div class="col-md-6">
                                <label for="endtime" class="form-label">Fim do Evento</label>
                                <input type="datetime-local" class="form-control" id="endtime" name="endtime" required>
                            </div>
                        </div>

                        <!-- Seção de Dias da Semana -->
                        <div class="row mb-4">
                            <div class="col-md-12">
                                <label for="dias_semana" class="form-label">Dias da Semana</label>
                                <select multiple class="form-select" id="dias_semana" name="dias_semana[]">
                                    <option value="domingo">Domingo</option>
                                    <option value="segunda">Segunda-feira</option>
                                    <option value="terca">Terça-feira</option>
                                    <option value="quarta">Quarta-feira</option>
                                    <option value="quinta">Quinta-feira</option>
                                    <option value="sexta">Sexta-feira</option>
                                    <option value="sabado">Sábado</option>
                                </select>
                            </div>
                        </div>

                        <!-- Seção de Horários -->
                        <div id="horarios_dia" class="mb-4">
                            <!-- Espaço para adicionar campos de horário para cada dia da semana -->
                        </div>

                        <!-- Seção de Coordenadas -->
                        <div class="row mb-4">
                            <div class="col-md-12">
                                <label for="coordenadas" class="form-label">Coordenadas do Evento (lat, lon)</label>
                                <input type="text" class="form-control" id="coordenadas" name="coordenadas" required placeholder="Clique no mapa para definir as coordenadas" readonly>
                            </div>
                        </div>

                        <!-- Seção de Rua -->
                        <div class="row mb-4">
                            <div class="col-md-12">
                                <label for="rua" class="form-label">Selecione a Rua</label>
                                <select class="form-select" id="ruaSelect" name="rua" required>
                                    <option value="">Selecione uma rua</option>
                                    <!-- As opções de rua serão preenchidas dinamicamente aqui -->
                                </select>
                            </div>
                        </div>

                        <!-- Botão de envio -->
                        <div class="d-flex justify-content-end">
                            <button type="submit" class="btn btn-primary mt-3">Criar Evento</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        <div class="col-lg-6">
            <div id="map" class="mb-3" style="height: 400px;"></div>
            <!-- Exibição das vias próximas -->
            <div id="vias-proximas" class="alert alert-info">
                <!-- As vias próximas serão inseridas aqui -->
            </div>

            <!-- Controles de Sentido -->
            <div id="controles" class="mt-3"></div> 
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@turf/turf/turf.min.js"></script>

<script>
// Inicializar um mapa com Leaflet e usar a API Overpass para identificar segmentos

// Adicionar mapa ao elemento HTML
const map = L.map('map').setView([-23.55052, -46.633308], 15); // São Paulo como exemplo

// Adicionar camada do mapa base
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
}).addTo(map);

// Variável global para armazenar o segmento anterior (se houver)
let previousSegmentLayer = null;

// Localizar o usuário
function locateUser() {
    map.locate({ setView: true, maxZoom: 16 });
}

// Evento para quando a localização for encontrada
map.on('locationfound', (e) => {
    const radius = e.accuracy / 2;
    L.marker(e.latlng).addTo(map).bindPopup('Você está aqui!').openPopup();
    L.circle(e.latlng, radius).addTo(map);
    console.log('Localização do usuário:', e.latlng);
    
    // Chama a função para consultar a rua após localizar o usuário
    consultarRuaWaze(e.latlng.lat, e.latlng.lng).then(nomeRuaWaze => {
        if (nomeRuaWaze) {
            console.log("Rua encontrada (Waze):", nomeRuaWaze);
            // Adiciona o nome da rua do Waze ao select
            const optionWaze = document.createElement('option');
            optionWaze.value = nomeRuaWaze;
            optionWaze.textContent = nomeRuaWaze;
            ruaSelect.appendChild(optionWaze);
            ruaSelect.value = nomeRuaWaze; // Marca automaticamente a opção
        }
    }).catch(() => {
        console.log("Erro ao consultar a API do Waze");
    });
});

// Evento para quando a localização não for encontrada
map.on('locationerror', (e) => {
    console.error('Erro ao localizar o usuário:', e.message);
});

// Função para consultar a rua via API personalizada api.php usando fetch
function consultarRuaWaze(lat, lon) {
    const url = `api.php?action=get_street&lat_inicio=${lat}&lon_inicio=${lon}`;

    return fetch(url)
        .then(response => response.json())
        .then(data => {
            if (data && data.result && data.result.length > 0) {
                // Ordena as ruas pela menor distância
                data.result.sort((a, b) => a.distance - b.distance);
                
                // Pega o nome da rua mais próxima
                const nomeRua = data.result[0].names[0];  // Assumindo que sempre há pelo menos um nome de rua
                return nomeRua;
            } else {
                return null; // Caso a resposta não tenha dados válidos
            }
        })
        .catch(() => {
            console.log("Erro ao consultar a API do Waze");
            return null; // Caso ocorra um erro na consulta
        });
}

// Função para buscar o segmento da rua entre interseções
async function getStreetSegment(lat, lon) {
    const query = `
        [out:json];
        (
            node(around:50, ${lat}, ${lon});
            way(bn)["highway"];
            >;
        );
        out geom;
    `;

    const url = `https://overpass-api.de/api/interpreter?data=${encodeURIComponent(query)}`;

    try {
        const response = await fetch(url);
        const data = await response.json();

        if (data.elements.length > 0) {
            const nodes = {};
            const ways = [];

            // Separar nós e vias
            data.elements.forEach(el => {
                if (el.type === 'node') {
                    nodes[el.id] = [el.lon, el.lat];
                } else if (el.type === 'way') {
                    ways.push(el);
                }
            });

            // Encontrar a via mais próxima e dividir entre interseções
            let closestWay = null;
            let minDistance = Infinity;

            ways.forEach(way => {
                const wayNodes = way.nodes.map(id => nodes[id]);
                const distance = turf.pointToLineDistance(turf.point([lon, lat]), turf.lineString(wayNodes), { units: 'meters' });

                if (distance < minDistance) {
                    minDistance = distance;
                    closestWay = way;
                }
            });

            if (closestWay) {
                const wayNodes = closestWay.nodes.map(id => nodes[id]);

                // Identificar interseções (nós compartilhados por múltiplas vias)
                const intersections = closestWay.nodes.filter(nodeId =>
                    data.elements.some(el => el.type === 'way' && el.id !== closestWay.id && el.nodes.includes(nodeId))
                );

                if (intersections.length >= 2) {
                    // Obter trecho entre as duas primeiras interseções
                    const startNodeIndex = closestWay.nodes.indexOf(intersections[0]);
                    const endNodeIndex = closestWay.nodes.indexOf(intersections[1]);
                    const segmentNodes = wayNodes.slice(startNodeIndex, endNodeIndex + 1);

                    // Criar segmento como GeoJSON
                    const segment = {
                        type: 'Feature',
                        properties: {},
                        geometry: {
                            type: 'LineString',
                            coordinates: segmentNodes
                        }
                    };

                    // Remover o segmento anterior, se existir
                    if (previousSegmentLayer) {
                        map.removeLayer(previousSegmentLayer);
                    }

                    // Adicionar o novo segmento ao mapa
                    previousSegmentLayer = L.geoJSON(segment).addTo(map);
                    console.log('Trecho identificado entre interseções:', segment);

                    // Logar as coordenadas do segmento
                    console.log('Coordenadas do segmento:', segmentNodes);
                    
                    // Chamar a função para inverter as coordenadas
                    invertCoordinates(segmentNodes);
                } else {
                    console.log('Não foi possível encontrar duas interseções na via.');
                }
            } else {
                console.log('Nenhuma via encontrada próxima.');
            }
        } else {
            console.log('Nenhum elemento encontrado na consulta.');
        }
    } catch (error) {
        console.error('Erro ao buscar segmento:', error);
    }
}

// Função para inverter as coordenadas
function invertCoordinates(segmentNodes) {
    // Verificar se há pelo menos 2 pontos no segmento
    if (segmentNodes.length >= 2) {
        // Inverter as coordenadas dos dois primeiros pontos (se existirem)
        const temp = segmentNodes[0];
        segmentNodes[0] = segmentNodes[1];
        segmentNodes[1] = temp;

        console.log('Segmento invertido:', segmentNodes);

    } else {
        console.log('Não há pontos suficientes para inverter as coordenadas');
    }
}


// Função para exibir ruas próximas
async function displayNearbyStreets(lat, lon) {
    const query = `
        [out:json];
        (
            node(around:20, ${lat}, ${lon});
            way(bn)["highway"];
            >;
        );
        out geom;
    `;
    
    const url = `https://overpass-api.de/api/interpreter?data=${encodeURIComponent(query)}`;
    
    try {
        const response = await fetch(url);
        const data = await response.json();
        
        let streets = [];
        
        if (data.elements) {
            data.elements.forEach(element => {
                if (element.type === 'way') {
                    let streetName = element.tags.name || 'Rua sem nome';
                    streets.push(streetName);
                }
            });
            
            // Mostrar as ruas próximas no div "vias-proximas"
            document.getElementById('vias-proximas').innerHTML = `
                <strong>Ruas Próximas:</strong><br>
                ${streets.join('<br>')}
            `;
        }
    } catch (error) {
        console.error('Erro ao buscar ruas próximas:', error);
    }
}

// Atualizar ruas e subtipos quando o mapa for clicado
map.on('click', (e) => {
    const lat = e.latlng.lat;
    const lon = e.latlng.lng;
    console.log('Coordenadas do clique:', lat, lon);

    // Exibir ruas próximas
    displayNearbyStreets(lat, lon);
    
    // Chama a função para buscar o segmento
    getStreetSegment(lat, lon);

    // Atualizar o campo de coordenadas com o novo valor
    document.getElementById('coordenadas').value = `${lat}, ${lon}`;

    // Consultar a rua do Waze ao clicar no mapa
    consultarRuaWaze(lat, lon).then(nomeRuaWaze => {
        if (nomeRuaWaze) {
            console.log("Rua encontrada (Waze):", nomeRuaWaze);
            // Adiciona o nome da rua do Waze ao select
            const optionWaze = document.createElement('option');
            optionWaze.value = nomeRuaWaze;
            optionWaze.textContent = nomeRuaWaze;
            ruaSelect.appendChild(optionWaze);
            ruaSelect.value = nomeRuaWaze; // Marca automaticamente a opção
        }
    }).catch(() => {
        console.log("Erro ao consultar a API do Waze");
    });
});

// Função para localizar o usuário assim que a página é carregada
function locateUserOnPageLoad() {
    map.locate({ setView: true, maxZoom: 16 }); // Localizar o usuário e centralizar no mapa
}

locateUserOnPageLoad();
</script>

<script>
// Função para calcular os dias da semana entre as duas datas
function calcularDiasSemana() {
    const startDate = document.getElementById('starttime').value;
    const endDate = document.getElementById('endtime').value;
    
    if (!startDate || !endDate) return;

    const start = new Date(startDate);
    const end = new Date(endDate);
    const diasSemana = [];
    const dias = ['domingo', 'segunda', 'terca', 'quarta', 'quinta', 'sexta', 'sabado'];

    // Verifica cada dia entre as datas
    while (start <= end) {
        const dayOfWeek = start.getDay(); // 0=domingo, 1=segunda-feira, etc.
        if (!diasSemana.includes(dias[dayOfWeek])) {
            diasSemana.push(dias[dayOfWeek]);
        }
        start.setDate(start.getDate() + 1); // Move para o próximo dia
    }

    // Preenche o select de dias da semana
    const diasSelect = document.getElementById('dias_semana');
    Array.from(diasSelect.options).forEach(option => {
        if (diasSemana.includes(option.value)) {
            option.disabled = false;
        } else {
            option.disabled = true;
        }
    });

    // Limpa horários anteriores e adiciona novos campos de horário
    atualizarHorarios(diasSemana);
}

// Função para adicionar os campos de horário para cada dia da semana selecionado
function atualizarHorarios(diasSelecionados) {
    const horariosDiv = document.getElementById('horarios_dia');
    horariosDiv.innerHTML = ''; // Limpa horários anteriores

    diasSelecionados.forEach(dia => {
        const dayDiv = document.createElement('div');
        dayDiv.classList.add('mb-3');
        dayDiv.setAttribute('data-dia', dia); // Adiciona o atributo data-dia

        const label = document.createElement('label');
        label.classList.add('form-label');
        label.innerText = `Horários para ${dia.charAt(0).toUpperCase() + dia.slice(1)}`;

        // Campos de horário de início e fim
        const inputHora = document.createElement('input');
        inputHora.type = 'time';
        inputHora.name = `${dia}_inicio`;
        inputHora.classList.add('form-control');
        inputHora.placeholder = 'Início do horário';

        const inputHoraFim = document.createElement('input');
        inputHoraFim.type = 'time';
        inputHoraFim.name = `${dia}_fim`;
        inputHoraFim.classList.add('form-control');
        inputHoraFim.placeholder = 'Fim do horário';

        // Botão para adicionar intervalos
        const addButton = document.createElement('button');
        addButton.classList.add('btn', 'btn-secondary', 'mt-2');
        addButton.innerText = 'Adicionar intervalo';
        addButton.onclick = function (event) {
            event.preventDefault();  // Evita o comportamento padrão do botão
            addHorarioIntervalo(dia);
        };

        // Adiciona os campos de horário para cada dia selecionado
        dayDiv.appendChild(label);
        dayDiv.appendChild(inputHora);
        dayDiv.appendChild(inputHoraFim);
        dayDiv.appendChild(addButton);

        horariosDiv.appendChild(dayDiv);
    });
}

// Função para adicionar intervalos de horário dentro do mesmo dia
function addHorarioIntervalo(dia) {
    // Encontra o div com os horários do dia específico
    const dayDiv = document.querySelector(`div[data-dia="${dia}"]`);

    // Cria um novo formulário de intervalo
    const intervaloDiv = document.createElement('div');
    intervaloDiv.classList.add('mt-3');
    intervaloDiv.classList.add('alert', 'alert-warning');

    // Cria novos campos para "Início" e "Fim" do intervalo
    const inputIntervaloHoraInicio = document.createElement('input');
    inputIntervaloHoraInicio.type = 'time';
    inputIntervaloHoraInicio.name = `${dia}_intervalo_inicio[]`;
    inputIntervaloHoraInicio.classList.add('form-control');
    inputIntervaloHoraInicio.placeholder = 'Início do intervalo';

    const inputIntervaloHoraFim = document.createElement('input');
    inputIntervaloHoraFim.type = 'time';
    inputIntervaloHoraFim.name = `${dia}_intervalo_fim[]`;
    inputIntervaloHoraFim.classList.add('form-control');
    inputIntervaloHoraFim.placeholder = 'Fim do intervalo';

    // Botão para remover o intervalo
    const removeButton = document.createElement('button');
    removeButton.classList.add('btn', 'btn-danger', 'mt-2');
    removeButton.innerText = 'Remover intervalo';
    removeButton.onclick = function () {
        intervaloDiv.remove();
    };

    // Adiciona os novos campos de horário e o botão de remover
    intervaloDiv.appendChild(inputIntervaloHoraInicio);
    intervaloDiv.appendChild(inputIntervaloHoraFim);
    intervaloDiv.appendChild(removeButton);

    // Adiciona o novo intervalo ao div do dia
    dayDiv.appendChild(intervaloDiv);
}

// Evento para atualizar os dias da semana e horários sempre que as datas de início ou fim mudarem
document.getElementById('starttime').addEventListener('change', calcularDiasSemana);
document.getElementById('endtime').addEventListener('change', calcularDiasSemana);

// Chama a função inicialmente para garantir que o campo de dias da semana seja atualizado corretamente
calcularDiasSemana();

</script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const tipoSelect = document.getElementById('tipo');
        const subtipoSelect = document.getElementById('subtipo');

        // Dados de subtipos por tipo fornecidos pelo Twig
        const subtiposPorTipo = {{ subtiposPorTipo|json_encode|raw }};

        // Desabilita o campo de subtipo inicialmente
        subtipoSelect.disabled = true;

        tipoSelect.addEventListener('change', function () {
            const selectedTipoId = tipoSelect.value;

            // Limpa os subtipos
            subtipoSelect.innerHTML = '<option value="">Selecione um Subtipo</option>';

            if (selectedTipoId) {
                // Habilita o campo de subtipo
                subtipoSelect.disabled = false;

                // Adiciona os subtipos correspondentes ao tipo selecionado
                if (subtiposPorTipo[selectedTipoId]) {
                    subtiposPorTipo[selectedTipoId].forEach(function (subtipo) {
                        const option = document.createElement('option');
                        option.value = subtipo.subtype_value;
                        option.textContent = subtipo.name;
                        subtipoSelect.appendChild(option);
                    });
                }
            } else {
                // Desabilita o campo de subtipo caso nenhum tipo seja selecionado
                subtipoSelect.disabled = true;
            }
        });
    });
</script>
