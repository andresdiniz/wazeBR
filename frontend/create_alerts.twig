<div class="container mt-3">
    <div class="row">
        <div class="col-lg-6">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h3>Criar Evento</h3>
                </div>
                <div class="card-body">
                    <form action="criar_evento.php" method="post" id="eventoForm">
                        <!-- Seção de Nome e Descrição -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <label for="nome" class="form-label">Nome do Evento</label>
                                <input type="text" class="form-control" id="nome" name="nome" required>
                            </div>
                            <div class="col-md-6">
                                <label for="descricao" class="form-label">Descrição</label>
                                <textarea class="form-control" id="descricao" name="descricao" required></textarea>
                            </div>
                        </div>

                        <!-- Seção de Tipo e Subtipo -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <label for="tipo" class="form-label">Tipo</label>
                                <select class="form-select" id="tipo" name="tipo" required>
                                    <option value="">Selecione um Tipo</option>
                                    {% for tipo in tipos %}
                                        <option value="{{ tipo.id }}">{{ tipo.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="subtipo" class="form-label">Subtipo</label>
                                <select class="form-select" id="subtipo" name="subtipo" required>
                                    <option value="">Selecione um Subtipo</option>
                                </select>
                            </div>
                        </div>

                        <!-- Seção de Início e Fim do Evento -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <label for="starttime" class="form-label">Início do Evento</label>
                                <input type="datetime-local" class="form-control" id="starttime" name="starttime" required>
                            </div>
                            <div class="col-md-6">
                                <label for="endtime" class="form-label">Fim do Evento</label>
                                <input type="datetime-local" class="form-control" id="endtime" name="endtime" required>
                            </div>
                        </div>

                        <!-- Seção de Dias da Semana -->
                        <div class="row mb-4">
                            <div class="col-md-12">
                                <label for="dias_semana" class="form-label">Dias da Semana</label>
                                <select multiple class="form-select" id="dias_semana" name="dias_semana[]" required>
                                    <option value="domingo">Domingo</option>
                                    <option value="segunda">Segunda-feira</option>
                                    <option value="terca">Terça-feira</option>
                                    <option value="quarta">Quarta-feira</option>
                                    <option value="quinta">Quinta-feira</option>
                                    <option value="sexta">Sexta-feira</option>
                                    <option value="sabado">Sábado</option>
                                </select>
                            </div>
                        </div>

                        <!-- Seção de Horários -->
                        <div id="horarios_dia" class="mb-4">
                            <!-- Espaço para adicionar campos de horário para cada dia da semana -->
                        </div>

                        <!-- Seção de Coordenadas -->
                        <div class="row mb-4">
                            <div class="col-md-12">
                                <label for="coordenadas" class="form-label">Coordenadas do Evento (lat, lon)</label>
                                <input type="text" class="form-control" id="coordenadas" name="coordenadas" required placeholder="Clique no mapa para definir as coordenadas" readonly>
                            </div>
                        </div>

                        <!-- Seção de Rua -->
                        <div class="row mb-4">
                            <div class="col-md-12">
                                <label for="rua" class="form-label">Selecione a Rua</label>
                                <select class="form-select" id="rua" name="rua" required>
                                    <option value="">Selecione uma rua</option>
                                    <!-- As opções de rua serão preenchidas dinamicamente aqui -->
                                </select>
                            </div>
                        </div>

                        <!-- Botão de envio -->
                        <div class="d-flex justify-content-end">
                            <button type="submit" class="btn btn-primary mt-3">Criar Evento</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        <div class="col-lg-6">
            <div id="map" class="mb-3" style="height: 400px;"></div>
            <!-- Exibição das vias próximas -->
            <div id="vias-proximas" class="alert alert-info">
                <!-- As vias próximas serão inseridas aqui -->
            </div>

            <!-- Controles de Sentido -->
            <div id="controles" class="mt-3"></div> 
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@turf/turf/turf.min.js"></script>

<script>
// Inicializar um mapa com Leaflet e usar a API Overpass para identificar segmentos

// Adicionar mapa ao elemento HTML
const map = L.map('map').setView([-23.55052, -46.633308], 15); // São Paulo como exemplo

// Adicionar camada do mapa base
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
}).addTo(map);

// Localizar o usuário
function locateUser() {
    map.locate({ setView: true, maxZoom: 16 });
}

// Evento para quando a localização for encontrada
map.on('locationfound', (e) => {
    const radius = e.accuracy / 2;
    L.marker(e.latlng).addTo(map).bindPopup('Você está aqui!').openPopup();
    L.circle(e.latlng, radius).addTo(map);
    console.log('Localização do usuário:', e.latlng);
});

// Evento para quando a localização não for encontrada
map.on('locationerror', (e) => {
    console.error('Erro ao localizar o usuário:', e.message);
});

// Chamar a função para localizar o usuário
locateUser();

// Função para buscar o segmento da rua entre interseções
async function getStreetSegment(lat, lon) {
    const query = `
        [out:json];
        (
            node(around:100, ${lat}, ${lon});
            way(bn)["highway"];
            >;
        );
        out geom;
    `;

    const url = `https://overpass-api.de/api/interpreter?data=${encodeURIComponent(query)}`;

    try {
        const response = await fetch(url);
        const data = await response.json();

        if (data.elements.length > 0) {
            const nodes = {};
            const ways = [];

            // Separar nós e vias
            data.elements.forEach(el => {
                if (el.type === 'node') {
                    nodes[el.id] = [el.lon, el.lat];
                } else if (el.type === 'way') {
                    ways.push(el);
                }
            });

            // Encontrar a via mais próxima e dividir entre interseções
            let closestWay = null;
            let minDistance = Infinity;

            ways.forEach(way => {
                const wayNodes = way.nodes.map(id => nodes[id]);
                const distance = turf.pointToLineDistance(turf.point([lon, lat]), turf.lineString(wayNodes), { units: 'meters' });

                if (distance < minDistance) {
                    minDistance = distance;
                    closestWay = way;
                }
            });

            if (closestWay) {
                const wayNodes = closestWay.nodes.map(id => nodes[id]);

                // Identificar interseções (nós compartilhados por múltiplas vias)
                const intersections = closestWay.nodes.filter(nodeId =>
                    data.elements.some(el => el.type === 'way' && el.id !== closestWay.id && el.nodes.includes(nodeId))
                );

                if (intersections.length >= 2) {
                    // Obter trecho entre as duas primeiras interseções
                    const startNodeIndex = closestWay.nodes.indexOf(intersections[0]);
                    const endNodeIndex = closestWay.nodes.indexOf(intersections[1]);
                    const segmentNodes = wayNodes.slice(startNodeIndex, endNodeIndex + 1);

                    // Criar segmento como GeoJSON
                    const segment = {
                        type: 'Feature',
                        properties: {},
                        geometry: {
                            type: 'LineString',
                            coordinates: segmentNodes
                        }
                    };

                    // Adicionar ao mapa
                    L.geoJSON(segment).addTo(map);
                    console.log('Trecho identificado entre interseções:', segment);

                    // Logar as coordenadas do segmento
                    console.log('Coordenadas do segmento:', segmentNodes);
                    
                    // Chamar a função para inverter as coordenadas
                    invertCoordinates(segmentNodes);
                } else {
                    console.log('Não foi possível encontrar duas interseções na via.');
                }
            } else {
                console.log('Nenhuma via encontrada próxima.');
            }
        } else {
            console.log('Nenhum elemento encontrado na consulta.');
        }
    } catch (error) {
        console.error('Erro ao buscar segmento:', error);
    }
}

// Função para inverter as coordenadas
function invertCoordinates(segmentNodes) {
    const invertedSegment = segmentNodes.reverse(); // Inverte a ordem das coordenadas
    console.log('Segmento invertido:', invertedSegment);

    // Atualizar o campo de coordenadas com o novo valor
    document.getElementById('coordenadas').value = invertedSegment.map(coord => coord.join(', ')).join(' | ');
}

// Função para exibir ruas próximas
async function displayNearbyStreets(lat, lon) {
    const query = `
        [out:json];
        (
            node(around:20, ${lat}, ${lon});
            way(bn)["highway"];
            >;
        );
        out geom;
    `;
    
    const url = `https://overpass-api.de/api/interpreter?data=${encodeURIComponent(query)}`;
    
    try {
        const response = await fetch(url);
        const data = await response.json();
        
        let streets = [];
        
        if (data.elements) {
            data.elements.forEach(element => {
                if (element.type === 'way') {
                    let streetName = element.tags.name || 'Rua sem nome';
                    streets.push(streetName);
                }
            });
            
            // Mostrar as ruas próximas no div "vias-proximas"
            document.getElementById('vias-proximas').innerHTML = `
                <strong>Ruas Próximas:</strong><br>
                ${streets.join('<br>')}
            `;
        }
    } catch (error) {
        console.error('Erro ao buscar ruas próximas:', error);
    }
}

// Função para atualizar os subtipos com base no tipo selecionado
function updateSubtypes() {
    const tipoSelect = document.getElementById('tipo');
    const subtipoSelect = document.getElementById('subtipo');
    const selectedTipo = tipoSelect.value;

    // Limpar as opções de subtipos
    subtipoSelect.innerHTML = '<option value="">Selecione um Subtipo</option>';

    // Adicionar os subtipos dependendo do tipo
    if (selectedTipo) {
        const subtipos = getSubtypesForType(selectedTipo);
        
        subtipos.forEach(subtipo => {
            const option = document.createElement('option');
            option.value = subtipo.id;
            option.textContent = subtipo.name;
            subtipoSelect.appendChild(option);
        });
    }
}

// Função fictícia para retornar os subtipos com base no tipo (substitua com dados reais)
function getSubtypesForType(tipoId) {
    // Exemplo de subtipos com base no tipo
    const subtipos = {
        '1': [{id: '1.1', name: 'Subtipo 1.1'}, {id: '1.2', name: 'Subtipo 1.2'}],
        '2': [{id: '2.1', name: 'Subtipo 2.1'}, {id: '2.2', name: 'Subtipo 2.2'}]
    };
    
    return subtipos[tipoId] || [];
}

// Atualizar subtipos quando o tipo for alterado
document.getElementById('tipo').addEventListener('change', updateSubtypes);

// Atualizar ruas e subtipos quando o mapa for clicado
map.on('click', (e) => {
    const lat = e.latlng.lat;
    const lon = e.latlng.lng;
    console.log('Coordenadas do clique:', lat, lon);

    // Exibir ruas próximas
    displayNearbyStreets(lat, lon);
    
    // Chama a função para buscar o segmento
    getStreetSegment(lat, lon);
});
</script>
