<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-polylinedecorator/1.6.0/leaflet.polylineDecorator.min.js"></script>
<div class="container mt-4 mb-4">
    <div class="row">
        <div class="col-lg-6 mb-3">
            <h3 class="text-primary">Criar Alerta</h3>
        </div>
    </div>
    <div class="row">
        <div class="col-lg-8">
            <div class="card shadow-sm p-4">
                <form action="api.php?action=cadastrar_evento" method="post" id="eventoForm">

                    <div>
                        <input type="hidden" name="id_parceiro" value="{{ id_parceiro }}">
                    </div>

                    <div class="mb-3">
                        <label for="nome" class="form-label">Descri√ß√£o do Evento</label>
                        <input type="text" class="form-control" id="nome" name="nome" required
                            placeholder="Escreva uma descri√ß√£o breve do Evento" maxlength="250">
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="tipo" class="form-label">Tipo</label>
                            <select class="form-select" id="tipo" name="tipo" required>
                                <option value="">Selecione um Tipo</option>
                                {% for tipo in tipos %}
                                <option value="{{ tipo.id }}">{{ tipo.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="subtipo" class="form-label">Subtipo</label>
                            <select class="form-select" id="subtipo" name="subtipo" required>
                                <option value="">Selecione um Subtipo</option>
                            </select>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="starttime" class="form-label">Data de In√≠cio</label>
                            <input type="date" id="starttime" class="form-control" name="starttime">
                        </div>
                        <div class="col-md-6">
                            <label for="endtime" class="form-label">Data de T√©rmino</label>
                            <input type="date" id="endtime" class="form-control" name="endtime">
                        </div>
                    </div>
                    <div id="horarios_dia" class="mb-3">
                        </div>

                    <div class="mb-3">
                        <label for="coordenadas" class="form-label">Coordenadas do Evento (lat, lon)</label>
                        <input type="text" class="form-control" id="coordenadas" name="coordenadas" required
                            placeholder="Clique no mapa para definir as coordenadas" readonly>
                    </div>

                    <div class="mb-3">
                        <label for="rua" class="form-label">Selecione a Rua</label>
                        <select class="form-select" id="ruaSelect" name="rua" required>
                            <option value="">Selecione uma rua</option>
                            </select>
                    </div>

                    <div id="segmentSelectionContainer" class="card shadow-sm p-3 mb-3 border-warning" style="display: none;">
                        <h5 class="text-warning">üì¢ Defina o Segmento da Via</h5>
                        <p class="text-muted small">Clique no mapa para definir a localiza√ß√£o. Selecione abaixo o trecho exato que deseja marcar:</p>
                        <div class="mb-3">
                            <label for="segmentOptions" class="form-label">Escolha o trecho:</label>
                            <select class="form-select" id="segmentOptions" required>
                                </select>
                        </div>
                        <button type="button" id="confirmSegmentBtn" class="btn btn-success mb-2">‚úÖ Confirmar Sele√ß√£o</button>
                        <button type="button" id="cancelSegmentBtn" class="btn btn-secondary btn-sm">Cancelar e Clicar Novamente</button>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="mb-2">
                                <label for="directionSelect" class="form-label">Escolha o Sentido</label>
                                <select id="directionSelect" class="form-select" name="directionSelect">
                                    </select>
                            </div>
                            <div id="buttonContainer" class="mt-2">
                                </div>

                            {% if id_parceiro == 99 %}
                            <div class="mb-3">
                                <label for="parceiro" class="form-label">Selecione um Parceiro</label>
                                <select class="form-select" id="parceiro" name="id_parceiro_alert" required>
                                    <option value="">Selecione um Parceiro</option>
                                    {% for parceiro in parceiros %}
                                    <option value="{{ parceiro.id }}">{{ parceiro.Nome }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            {% endif %}

                        </div>
                        <div class="col-md-6 d-flex align-items-end justify-content-end">
                            <button type="submit" class="btn btn-primary">Criar Evento</button>
                        </div>
                    </div>

                </form>
            </div>
        </div>

        <div class="col-lg-4 mt-4 mt-lg-0">
            <div id="map" class="card shadow-sm" style="height: 500px;"></div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@turf/turf/turf.min.js"></script>
<script>
/* ======================================================
   CONFIGURA√á√ÉO GLOBAL E VARI√ÅVEIS
====================================================== */
window.MAP_CONFIG = {
    SEGMENT_COLORS: {
        original: '#0000ff',
        reversed: '#ff0000',
        both: '#00ff00'
    },
    ARROW_OPTIONS: {
        pixelSize: 15,
        weight: 2
    },
    LOCAL_STORAGE_KEYS: {
        SEGMENT: 'streetSegment',
        DIRECTION: 'segmentDirection'
    }
};

window.appState = {
    map: null,
    currentSegmentNodes: null,
    currentSegmentLayer: null,
    candidateSegments: []
};

/* ======================================================
   FUN√á√ÉO: DESENHAR SEGMENTO
====================================================== */
function drawSegment(segmentNodes, direction = 'both', color = null) {
    try {
        const state = window.appState;
        const map = state.map;
        if (state.currentSegmentLayer) {
            map.removeLayer(state.currentSegmentLayer);
            state.currentSegmentLayer = null;
        }

        if (!segmentNodes || segmentNodes.length < 2) return null;

        const latLngs = segmentNodes.map(coord => [coord[1], coord[0]]);
        const usedColor = color || (
            direction === 'reversed' ? MAP_CONFIG.SEGMENT_COLORS.reversed :
            direction === 'original' ? MAP_CONFIG.SEGMENT_COLORS.original :
            MAP_CONFIG.SEGMENT_COLORS.both
        );

        const segmentLine = L.polyline(latLngs, {
            color: usedColor,
            weight: 5,
            opacity: 0.9,
            lineCap: 'round',
            lineJoin: 'round'
        });

        let arrowDecorator = null;
        if (direction !== 'both') {
            const arrowLatLngs = direction === 'reversed' ? [...latLngs].reverse() : latLngs;
            segmentLine.setLatLngs(arrowLatLngs);

            arrowDecorator = L.polylineDecorator(segmentLine, {
                patterns: [{
                    offset: '50%',
                    repeat: '100px',
                    symbol: L.Symbol.arrowHead({
                        pixelSize: MAP_CONFIG.ARROW_OPTIONS.pixelSize,
                        polygon: false,
                        pathOptions: {
                            color: usedColor,
                            weight: MAP_CONFIG.ARROW_OPTIONS.weight,
                            opacity: 0.8
                        }
                    })
                }]
            });
        }

        const layers = [segmentLine];
        if (arrowDecorator) layers.push(arrowDecorator);
        state.currentSegmentLayer = L.layerGroup(layers).addTo(map);

        map.fitBounds(segmentLine.getBounds(), { padding: [20, 20] });

        state.currentSegmentNodes = segmentNodes;
        localStorage.setItem(MAP_CONFIG.LOCAL_STORAGE_KEYS.SEGMENT, JSON.stringify(segmentNodes));
        localStorage.setItem(MAP_CONFIG.LOCAL_STORAGE_KEYS.DIRECTION, direction);

        updateDirectionControls(direction);
        updateDirectionIndicator(direction);

        return state.currentSegmentLayer;
    } catch (err) {
        console.error('drawSegment error', err);
    }
}

/* ======================================================
   FUN√á√ÉO: BUSCAR SEGMENTOS PR√ìXIMOS (Overpass)
====================================================== */
async function getStreetSegment(map, lat, lon) {
    const radiusValues = [50, 100, 200, 300, 500];
    const allCandidates = [];

    for (let radius of radiusValues) {
        const query = `
        [out:json];
        (
            node(around:${radius}, ${lat}, ${lon});
            way(bn)["highway"];
            >;
        );
        out geom;
        `;
        const url = `https://overpass-api.de/api/interpreter?data=${encodeURIComponent(query)}`;

        try {
            const resp = await fetch(url);
            const data = await resp.json();
            if (!data.elements || data.elements.length === 0) continue;

            const nodes = {};
            const ways = [];
            data.elements.forEach(el => {
                if (el.type === 'node') nodes[el.id] = [el.lon, el.lat];
                if (el.type === 'way') ways.push(el);
            });

            for (let way of ways) {
                const wayNodes = way.nodes.map(id => nodes[id]).filter(Boolean);
                if (wayNodes.length < 2) continue;

                const distance = turf.pointToLineDistance(
                    turf.point([lon, lat]),
                    turf.lineString(wayNodes),
                    { units: 'meters' }
                );

                allCandidates.push({
                    wayId: way.id,
                    nodes: wayNodes,
                    distance,
                    label: way.tags?.name || way.tags?.ref || `Way ${way.id}`
                });
            }

            if (allCandidates.length > 0) break;
        } catch (err) {
            console.error(`Erro Overpass raio ${radius}`, err);
        }
    }

    if (allCandidates.length === 0) {
        showAlert('Nenhum segmento encontrado pr√≥ximo ao clique.', 'warning');
        return;
    }

    allCandidates.sort((a, b) => a.distance - b.distance);
    allCandidates.forEach((c, i) => {
        const hue = (i * 55) % 360;
        c.color = `hsl(${hue}, 80%, 45%)`;
        c.optionLabel = `${c.label} ‚Äî ${Math.round(c.distance)}m`;
    });

    window.appState.candidateSegments = allCandidates;
    promptSegmentSelection(map, allCandidates, lat, lon);
}

/* ======================================================
   FUN√á√ÉO: CAIXA DE SELE√á√ÉO DE TRECHOS
====================================================== */
function promptSegmentSelection(map, candidates, lat, lon) {
    const container = document.getElementById('segmentSelectionContainer');
    const optionsSelect = document.getElementById('segmentOptions');
    const confirmBtn = document.getElementById('confirmSegmentBtn');
    const cancelBtn = document.getElementById('cancelSegmentBtn');

    optionsSelect.innerHTML = '';
    container.style.display = 'block';

    candidates.forEach((cand, idx) => {
        const opt = document.createElement('option');
        opt.value = idx;
        opt.textContent = cand.optionLabel;
        opt.dataset.color = cand.color;
        optionsSelect.appendChild(opt);
    });

    optionsSelect.selectedIndex = 0;

    let previewLayer = null;
    function showPreviewForIndex(i) {
        if (previewLayer) {
            map.removeLayer(previewLayer);
            previewLayer = null;
        }
        const cand = candidates[i];
        if (!cand) return;
        const latlngs = cand.nodes.map(c => [c[1], c[0]]);
        previewLayer = L.polyline(latlngs, { color: cand.color, weight: 4, opacity: 0.7 }).addTo(map);
    }

    showPreviewForIndex(0);

    optionsSelect.onchange = () => {
        showPreviewForIndex(parseInt(optionsSelect.value, 10));
    };

    confirmBtn.onclick = () => {
        const idx = parseInt(optionsSelect.value, 10);
        const selected = candidates[idx];
        if (!selected) {
            showAlert('Selecione um trecho v√°lido.', 'danger');
            return;
        }
        drawSegment(selected.nodes, 'both', selected.color);
        localStorage.setItem('streetSegment_meta', JSON.stringify({
            wayId: selected.wayId,
            label: selected.label,
            color: selected.color
        }));
        container.style.display = 'none';
        if (previewLayer) { map.removeLayer(previewLayer); previewLayer = null; }
        showAlert(`Trecho "${selected.optionLabel}" selecionado.`, 'success');
        mostrarBotaoReverso(window.appState.currentSegmentNodes || selected.nodes, map);
    };

    cancelBtn.onclick = () => {
        container.style.display = 'none';
        if (previewLayer) { map.removeLayer(previewLayer); previewLayer = null; }
        showAlert('Sele√ß√£o cancelada. Clique novamente no mapa para tentar outra via.', 'info');
    };
}

/* ======================================================
   FUN√á√ïES AUXILIARES
====================================================== */
function inverterCoordenadas(segmentNodes, map, currentDirection) {
    const reversed = [...segmentNodes].reverse();
    const newDirection = (currentDirection === 'reversed' ? 'original' : 'reversed');
    drawSegment(reversed, newDirection);
    return reversed;
}

function updateDirectionControls(direction) {
    const directionSelect = document.getElementById('directionSelect');
    if (directionSelect) directionSelect.value = direction;
    const reverseBtn = document.getElementById('reverseBtn');
    if (reverseBtn) reverseBtn.style.display =
        (direction === 'original' || direction === 'reversed') ? 'block' : 'none';
}

/* ======================================================
   INICIALIZA√á√ÉO PRINCIPAL
====================================================== */
document.addEventListener('DOMContentLoaded', function () {
    const map = initializeMap();
    window.appState.map = map;

    window.map = map;
    loadSavedSegment(map);

    map.on('click', async (e) => {
        if (document.getElementById('segmentSelectionContainer').style.display === 'block') return;

        const hasExisting = localStorage.getItem(MAP_CONFIG.LOCAL_STORAGE_KEYS.SEGMENT);
        if (hasExisting && !confirm('J√° existe um segmento selecionado. Deseja substituir?')) return;

        const lat = e.latlng.lat;
        const lon = e.latlng.lng;
        const coordInput = document.getElementById('coordenadas');
        if (coordInput) coordInput.value = `${lat.toFixed(6)}, ${lon.toFixed(6)}`;

        consultarRuaWaze(lat, lon).then(nomeRua => {
            if (nomeRua) {
                const ruaSelect = document.getElementById('ruaSelect');
                if (ruaSelect) {
                    ruaSelect.innerHTML = '';
                    const opt = document.createElement('option');
                    opt.value = nomeRua;
                    opt.textContent = nomeRua;
                    ruaSelect.appendChild(opt);
                    ruaSelect.value = nomeRua;
                }
            }
        });

        getStreetSegment(map, lat, lon);
    });

    const directionSelect = document.getElementById('directionSelect');
    if (directionSelect) {
        atualizarDirecoes(directionSelect);
        directionSelect.addEventListener('change', (e) => {
            const dir = e.target.value;
            const nodes = window.appState.currentSegmentNodes;
            if (nodes && nodes.length > 1) {
                drawSegment(nodes, dir);
                if (dir === 'single') mostrarBotaoReverso(nodes, map);
                else esconderBotaoReverso();
            }
        });
    }
});
</script>


<style>
    /* Estilos Aprimorados */
    #map {
        border-radius: 8px;
        transition: box-shadow 0.3s ease;
        height: 400px; /* Altura padr√£o */
    }

    /* Em dispositivos m√≥veis, reduzir a altura do mapa */
    @media (max-width: 768px) {
        #map {
            height: 300px;
        }
    }

    #map:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .leaflet-popup-content {
        font-size: 14px;
        padding: 8px;
    }

    .btn-warning {
        background-color: #ffc107;
        border-color: #ffc107;
        transition: all 0.3s ease;
    }

    .btn-warning:hover {
        transform: translateY(-2px);
        box-shadow: 0 2px 8px rgba(255, 193, 7, 0.3);
    }

    /* Estilo para o novo painel de sele√ß√£o */
    #segmentSelectionContainer {
        border-left: 5px solid #ffc107 !important; /* Cor de destaque */
    }

    /* Ajustes de responsividade para os cards de hor√°rios */
    @media (max-width: 576px) {
        .card .row .col-md-4 {
            flex: 0 0 100%;
            max-width: 100%;
        }
    }
</style>