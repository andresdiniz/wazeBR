<style>
    .modal-header {
        background-color: #007bff;
        color: white;
    }
    .modal-footer {
        justify-content: flex-start;
    }
    .btn-close {
        background-color: transparent;
        border: none;
        font-size: 1.5rem;
    }
</style>
</head>
<body>
<div class="container mt-4 mb-4">
    <div class="row">
        <div class="col-lg-6 mb-3">
            <h3 class="text-primary">Gerenciamento de URLs</h3>
        </div>
        <div class="col-lg-6 mb-3 text-right">
            <button class="btn btn-success" data-toggle="modal" data-target="#createModal">Adicionar URL</button>
        </div>
    </div>
    
    <!-- Tabela de URLs de Tráfego -->
    <div class="row">
        <div class="col-lg-12">
            <div class="card shadow-sm p-4">
                <h4>URLs de Tráfego</h4>
                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>ID Parceiro</th>
                            <th>URL</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for url in urls_traffic %}
                        <tr>
                            <td>{{ url.id }}</td>
                            <td>{{ url.id_parceiro }}</td>
                            <td>{{ url.url }}</td>
                            <td>
                                <button class="btn btn-primary btn-sm" data-toggle="modal" data-target="#editModal" data-id="{{ url.id }}" data-id_parceiro="{{ url.id_parceiro }}" data-url="{{ url.url }}">Editar</button>
                                <button class="btn btn-danger btn-sm" data-id="{{ url.id }}" onclick="deleteUrl({{ url.id }})">Excluir</button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Tabela de URLs de Alertas -->
    <div class="row mt-4">
        <div class="col-lg-12">
            <div class="card shadow-sm p-4">
                <h4>URLs de Alertas</h4>
                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>ID Parceiro</th>
                            <th>URL</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for url in urls_alerts %}
                        <tr>
                            <td>{{ url.id }}</td>
                            <td>{{ url.id_parceiro }}</td>
                            <td>{{ url.url }}</td>
                            <td>
                                <button class="btn btn-primary btn-sm" data-toggle="modal" data-target="#editModal" data-id="{{ url.id }}" data-id_parceiro="{{ url.id_parceiro }}" data-url="{{ url.url }}">Editar</button>
                                <button class="btn btn-danger btn-sm" data-id="{{ url.id }}" onclick="deleteUrl({{ url.id }})">Excluir</button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Tabela de URLs de Eventos -->
    <div class="row mt-4">
        <div class="col-lg-12">
            <div class="card shadow-sm p-4">
                <h4>URLs de Eventos</h4>
                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>ID Parceiro</th>
                            <th>URL</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for url in urls_events %}
                        <tr>
                            <td>{{ url.id }}</td>
                            <td>{{ url.id_parceiro }}</td>
                            <td>{{ url.url }}</td>
                            <td>
                                <button class="btn btn-primary btn-sm" data-toggle="modal" data-target="#editModal" data-id="{{ url.id }}" data-id_parceiro="{{ url.id_parceiro }}" data-url="{{ url.url }}">Editar</button>
                                <button class="btn btn-danger btn-sm" data-id="{{ url.id }}" onclick="deleteUrl({{ url.id }})">Excluir</button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- Modal de Criação -->
    <div class="modal fade" id="createModal" tabindex="-1" role="dialog" aria-labelledby="createModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="createModalLabel">Adicionar URL</h5>
                    <button type="button" class="btn-close" data-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="createForm">
                        <div class="form-group">
                            <label for="createIdParceiro">Parceiro</label>
                            <select class="form-control" id="createIdParceiro" name="id_parceiro" required>
                                {% for parceiro in parceiros %}
                                <option value="{{ parceiro.id }}">{{ parceiro.Nome }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="createNomeTabela">Nome da Tabela</label>
                            <select class="form-control" id="createNomeTabela" name="nome_tabela" required>
                                <option value="urls_traffic">URLs de Tráfego</option>
                                <option value="urls_alerts">URLs de Alertas</option>
                                <option value="urls_events">URLs de Eventos</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="createUrl">URL</label>
                            <input type="text" class="form-control" id="createUrl" name="url" required>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                            <button type="submit" class="btn btn-success">Salvar</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal de Edição -->
    <div class="modal fade" id="editModal" tabindex="-1" role="dialog" aria-labelledby="editModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editModalLabel">Editar URL</h5>
                    <button type="button" class="btn-close" data-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editForm">
                        <input type="hidden" id="editId" name="id">
                        <div class="form-group">
                            <label for="editIdParceiro">ID Parceiro</label>
                            <input type="text" class="form-control" id="editIdParceiro" name="id_parceiro" required>
                        </div>
                        <div class="form-group">
                            <label for="editUrl">URL</label>
                            <input type="text" class="form-control" id="editUrl" name="url" required>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                            <button type="submit" class="btn btn-primary">Salvar</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>


<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
<script>
// Preenche o modal de edição com os dados da URL selecionada
$('#editModal').on('show.bs.modal', function (event) {
    var button = $(event.relatedTarget);
    var id = button.data('id');
    var id_parceiro = button.data('id_parceiro');
    var url = button.data('url');
    
    var modal = $(this);
    modal.find('#editId').val(id);
    modal.find('#editIdParceiro').val(id_parceiro);
    modal.find('#editUrl').val(url);
});
document.addEventListener('DOMContentLoaded', () => {
    const config = {
        apiBase: '/api.php',
        csrfToken: document.querySelector('meta[name="csrf-token"]').content
    };

    // Função genérica para requisições
    const apiRequest = async (params, method = 'GET', body = null) => {
        const headers = {
            'Content-Type': 'application/json',
            'X-CSRF-TOKEN': config.csrfToken
        };

        try {
            const query = new URLSearchParams(params).toString();
            const url = `${config.apiBase}?${query}`;

            const response = await fetch(url, {
                method,
                headers,
                body: method !== 'GET' ? JSON.stringify(body) : null
            });

            if (!response.ok) throw new Error('Erro na requisição');
            return await response.json();

        } catch (error) {
            console.error('Erro:', error);
            showToast('danger', 'Erro na operação');
            throw error;
        }
    };

    // Busca de Usuários
    const searchUsers = async (action, query) => {
        return apiRequest({ action, query });
    };

    // Configuração genérica de busca
    const setupSearch = (inputId, resultId, action, callback) => {
        let timeout;
        const input = document.getElementById(inputId);
        const resultContainer = document.getElementById(resultId);

        input.addEventListener('input', async (e) => {
            clearTimeout(timeout);
            timeout = setTimeout(async () => {
                if (e.target.value.length >= 3) {
                    try {
                        const data = await searchUsers(action, e.target.value);
                        renderResults(resultContainer, data, callback);
                    } catch (error) {
                        resultContainer.innerHTML = '<li class="list-group-item">Erro na busca</li>';
                    }
                }
            }, 300);
        });
    };

    // Renderização de resultados
    const renderResults = (container, data, callback) => {
        if (data.success && data.users.length > 0) {
            container.innerHTML = data.users.map(user => `
                <li class="list-group-item d-flex justify-content-between align-items-center" data-id="${user.id}">
                    ${user.nome} (${user.email})
                    <button class="btn btn-sm btn-primary">${callback.label}</button>
                </li>
            `).join('');

            container.querySelectorAll('button').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const userId = e.target.closest('li').dataset.id;
                    callback.action(userId);
                });
            });
        } else {
            container.innerHTML = '<li class="list-group-item">Nenhum resultado encontrado</li>';
        }
    };

    // Configuração dos modais
    setupSearch('searchAlterar', 'resultAlterar', 'alterar', {
        label: 'Editar',
        action: async (userId) => {
            try {
                const user = await apiRequest({ action: 'get_user', id: userId });
                openEditModal(user);
            } catch (error) {
                showToast('danger', 'Erro ao carregar usuário');
            }
        }
    });

    setupSearch('searchResetSenha', 'resultResetSenha', 'reset_senha', {
        label: 'Resetar',
        action: async (userId) => {
            if (confirm('Confirmar reset de senha?')) {
                try {
                    await apiRequest({ action: 'reset_password' }, 'POST', { userId });
                    showToast('success', 'Senha resetada com sucesso');
                } catch (error) {
                    showToast('danger', 'Erro ao resetar senha');
                }
            }
        }
    });

    setupSearch('searchApagar', 'resultApagar', 'apagar', {
        label: 'Excluir',
        action: async (userId) => {
            if (confirm('Confirmar exclusão permanente?')) {
                try {
                    await apiRequest({ action: 'delete_user' }, 'DELETE', { userId });
                    showToast('success', 'Usuário excluído com sucesso');
                } catch (error) {
                    showToast('danger', 'Erro ao excluir usuário');
                }
            }
        }
    });

    // Modal de Edição
    const openEditModal = (user) => {
        document.getElementById('editUserId').value = user.id;
        document.getElementById('editUsername').value = user.username;
        document.getElementById('editEmail').value = user.email;
        new bootstrap.Modal(document.getElementById('editModal')).show();
    };

    // Submit do formulário de edição
    document.getElementById('editForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const userId = document.getElementById('editUserId').value;
        const formData = {
            username: document.getElementById('editUsername').value,
            email: document.getElementById('editEmail').value
        };

        try {
            await apiRequest({ action: 'update_user' }, 'PUT', formData);
            showToast('success', 'Usuário atualizado com sucesso');
            bootstrap.Modal.getInstance(document.getElementById('editModal')).hide();
        } catch (error) {
            showToast('danger', 'Erro ao atualizar usuário');
        }
    });

    // Submit do formulário de cadastro
    document.getElementById('formCadastrar').addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = {
            nome: document.getElementById('nomeUsuario').value,
            usuario: document.getElementById('nomeDeUsuario').value,
            email: document.getElementById('emailUsuario').value,
            senha: document.getElementById('senhaUsuario').value,
            type: document.getElementById('typeSelect').value,
            id_parceiro: document.getElementById('parceirosSelect').value
        };

        try {
            await apiRequest({ action: 'cadastrar_usuario' }, 'POST', formData);
            showToast('success', 'Usuário cadastrado com sucesso');
            bootstrap.Modal.getInstance(document.getElementById('modalCadastrar')).hide();
            e.target.reset();
        } catch (error) {
            showToast('danger', 'Erro ao cadastrar usuário');
        }
    });

    // Função para exibir notificações
    const showToast = (type, message) => {
        const toast = document.createElement('div');
        toast.className = `toast align-items-center text-white bg-${type} border-0`;
        toast.innerHTML = `
            <div class="d-flex">
                <div class="toast-body">${message}</div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        `;
        document.body.appendChild(toast);
        new bootstrap.Toast(toast).show();
        setTimeout(() => toast.remove(), 3000);
    };

    // Carregar parceiros
    const loadParceiros = async () => {
        try {
            const response = await apiRequest({ action: 'get_parceiros' });
            const select = document.getElementById('parceirosSelect');
            select.innerHTML = response.nomes.map(p => `
                <option value="${p.id}">${p.Nome}</option>
            `).join('');
        } catch (error) {
            console.error('Erro ao carregar parceiros:', error);
        }
    };

    loadParceiros();
});
</script>