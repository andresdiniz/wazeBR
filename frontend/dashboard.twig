{% block stylesheets %}
<link rel="stylesheet" href="https://cdn.datatables.net/1.12.1/css/jquery.dataTables.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.2.3/css/buttons.dataTables.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
<style>
/* Estilos otimizados para todas as tabelas */
.card {
    margin-bottom: 1.5rem;
    border: 1px solid #e3e6f0;
    border-radius: 0.35rem;
}

.card-header {
    background-color: #f8f9fc;
    padding: 0.75rem 1.25rem;
    border-bottom: 1px solid #e3e6f0;
}

.table-responsive {
    overflow-x: auto;
}

.table-sm {
    font-size: 0.875rem;
    margin-bottom: 0;
}

.table-sm th, 
.table-sm td {
    padding: 0.5rem;
    vertical-align: middle;
}

.badge {
    font-weight: 500;
    min-width: 65px;
    padding: 0.4em 0.65em;
}

.btn-group-sm > .btn {
    padding: 0.25rem 0.5rem;
    font-size: 0.75rem;
}

@media (max-width: 767.98px) {
    .d-none-mobile {
        display: none !important;
    }
    
    .table-sm {
        font-size: 0.8rem;
    }
    
    .btn-group-sm > .btn {
        padding: 0.2rem 0.3rem;
    }
}

.dataTables_wrapper .dataTables_paginate .paginate_button {
    padding: 0.25rem 0.5rem;
    margin-left: 0.25rem;
}

.metric-card {
    transition: transform 0.15s ease-in-out;
}

.metric-card:hover {
    transform: translateY(-3px);
}
</style>
{% endblock %}

{% block body %}
<div class="container-fluid">
    <!-- Cabeçalho -->
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-gray-800">Dashboard Completo de Alertas</h1>
        <div>
            <a href="#" class="btn btn-primary btn-sm shadow-sm">
                <i class="fas fa-download fa-sm"></i> Exportar Tudo
            </a>
        </div>
    </div>

    <!-- Métricas Superiores -->
    <div class="row">
        <!-- Métrica 1 -->
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card metric-card border-left-primary shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                Alertas Hoje
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ activeAlertsToday }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-bell fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Métrica 2 -->
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card metric-card border-left-success shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                Alertas Mês
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ totalAlertsThisMonth }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-calendar-alt fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Métrica 3 -->
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card metric-card border-left-info shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                                KM Congestionados
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ traficdata.total_kms_lento }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-road fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Métrica 4 -->
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card metric-card border-left-warning shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                Atraso Total
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ traficdata.total_atraso_minutos }} min</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-clock fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Seção de Tabelas -->
    <div class="row">
        <!-- Tabela de Acidentes -->
        <div class="col-xl-6 mb-4">
            <div class="card shadow-sm h-100">
                <div class="card-header d-flex justify-content-between align-items-center py-2">
                    <h6 class="m-0 font-weight-bold text-danger">
                        <i class="fas fa-car-crash mr-2"></i>Acidentes Recentes
                    </h6>
                    {% if accidentAlerts is not empty %}
                    <span class="badge badge-danger">{{ accidentAlerts|length }}</span>
                    {% endif %}
                </div>
                <div class="card-body p-2">
                    {% if accidentAlerts is not empty %}
                    <div class="table-responsive">
                        <table class="table table-striped table-sm mb-0" id="accidentsTable">
                            <thead class="thead-light">
                                <tr>
                                    <th>Cidade</th>
                                    <th class="d-none-mobile">Rua</th>
                                    <th>Data/Hora</th>
                                    <th class="text-center">Conf.</th>
                                    <th class="text-center">Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for alert in accidentAlerts %}
                                <tr>
                                    <td>{{ alert.city }}</td>
                                    <td class="d-none-mobile">{{ alert.street }}</td>
                                    <td>
                                        <div>{{ (alert.pubMillis/1000)|date('d/m/Y') }}</div>
                                        <small class="text-muted">{{ (alert.pubMillis/1000)|date('H:i') }}</small>
                                    </td>
                                    <td class="text-center">
                                        <span class="badge badge-{{ alert.confidence > 4 ? 'success' : alert.confidence > 2 ? 'warning' : 'danger' }}">
                                            {{ alert.confidence }}
                                        </span>
                                    </td>
                                    <td class="text-center">
                                        <div class="btn-group">
                                            <button class="btn btn-info btn-sm open-modal" 
                                                    data-toggle="modal" 
                                                    data-target="#alertModal"
                                                    data-alert="{{ {
                                                        'uuid': alert.uuid,
                                                        'city': alert.city,
                                                        'street': alert.street,
                                                        'location': [alert.location_x, alert.location_y]|json_encode,
                                                        'timestamp': alert.pubMillis,
                                                        'type': 'Acidente',
                                                        'confidence': alert.confidence,
                                                        'status': alert.status
                                                    }|json_encode|e('html_attr') }}">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            <a href="https://www.waze.com/ul?ll={{ alert.location_y }},{{ alert.location_x }}" 
                                               target="_blank" 
                                               class="btn btn-primary btn-sm">
                                                <i class="fab fa-waze"></i>
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-3">
                        <i class="fas fa-car-crash fa-2x text-muted mb-2"></i>
                        <p class="text-muted mb-0">Nenhum acidente registrado</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Tabela de Congestionamentos -->
        <div class="col-xl-6 mb-4">
            <div class="card shadow-sm h-100">
                <div class="card-header d-flex justify-content-between align-items-center py-2">
                    <h6 class="m-0 font-weight-bold text-warning">
                        <i class="fas fa-traffic-light mr-2"></i>Congestionamentos
                    </h6>
                    {% if jamAlerts is not empty %}
                    <span class="badge badge-warning">{{ jamAlerts|length }}</span>
                    {% endif %}
                </div>
                <div class="card-body p-2">
                    {% if jamAlerts is not empty %}
                    <div class="table-responsive">
                        <table class="table table-striped table-sm mb-0" id="jamsTable">
                            <thead class="thead-light">
                                <tr>
                                    <th>Cidade</th>
                                    <th class="d-none-mobile">Rua</th>
                                    <th>Data/Hora</th>
                                    <th class="text-center">Conf.</th>
                                    <th class="text-center">Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for alert in jamAlerts %}
                                <tr>
                                    <td>{{ alert.city }}</td>
                                    <td class="d-none-mobile">{{ alert.street }}</td>
                                    <td>
                                        <div>{{ (alert.pubMillis/1000)|date('d/m/Y') }}</div>
                                        <small class="text-muted">{{ (alert.pubMillis/1000)|date('H:i') }}</small>
                                    </td>
                                    <td class="text-center">
                                        <span class="badge badge-{{ alert.confidence > 4 ? 'success' : alert.confidence > 2 ? 'warning' : 'danger' }}">
                                            {{ alert.confidence }}
                                        </span>
                                    </td>
                                    <td class="text-center">
                                        <div class="btn-group">
                                            <button class="btn btn-info btn-sm open-modal" 
                                                    data-toggle="modal" 
                                                    data-target="#alertModal"
                                                    data-alert="{{ {
                                                        'uuid': alert.uuid,
                                                        'city': alert.city,
                                                        'street': alert.street,
                                                        'location': [alert.location_x, alert.location_y]|json_encode,
                                                        'timestamp': alert.pubMillis,
                                                        'type': 'Congestionamento',
                                                        'confidence': alert.confidence,
                                                        'status': alert.status
                                                    }|json_encode|e('html_attr') }}">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            <a href="https://www.waze.com/ul?ll={{ alert.location_y }},{{ alert.location_x }}" 
                                               target="_blank" 
                                               class="btn btn-primary btn-sm">
                                                <i class="fab fa-waze"></i>
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-3">
                        <i class="fas fa-traffic-light fa-2x text-muted mb-2"></i>
                        <p class="text-muted mb-0">Nenhum congestionamento</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Tabela de Buracos -->
        <div class="col-xl-6 mb-4">
            <div class="card shadow-sm h-100">
                <div class="card-header d-flex justify-content-between align-items-center py-2">
                    <h6 class="m-0 font-weight-bold text-dark">
                        <i class="fas fa-road mr-2"></i>Buracos Reportados
                    </h6>
                    {% if hazardAlerts is not empty %}
                    <span class="badge badge-dark">{{ hazardAlerts|length }}</span>
                    {% endif %}
                </div>
                <div class="card-body p-2">
                    {% if hazardAlerts is not empty %}
                    <div class="table-responsive">
                        <table class="table table-striped table-sm mb-0" id="hazardsTable">
                            <thead class="thead-light">
                                <tr>
                                    <th>Cidade</th>
                                    <th class="d-none-mobile">Rua</th>
                                    <th>Data/Hora</th>
                                    <th class="text-center">Conf.</th>
                                    <th class="text-center">Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for alert in hazardAlerts %}
                                <tr>
                                    <td>{{ alert.city }}</td>
                                    <td class="d-none-mobile">{{ alert.street }}</td>
                                    <td>
                                        <div>{{ (alert.pubMillis/1000)|date('d/m/Y') }}</div>
                                        <small class="text-muted">{{ (alert.pubMillis/1000)|date('H:i') }}</small>
                                    </td>
                                    <td class="text-center">
                                        <span class="badge badge-{{ alert.confidence > 4 ? 'success' : alert.confidence > 2 ? 'warning' : 'danger' }}">
                                            {{ alert.confidence }}
                                        </span>
                                    </td>
                                    <td class="text-center">
                                        <div class="btn-group">
                                            <button class="btn btn-info btn-sm open-modal" 
                                                    data-toggle="modal" 
                                                    data-target="#alertModal"
                                                    data-alert="{{ {
                                                        'uuid': alert.uuid,
                                                        'city': alert.city,
                                                        'street': alert.street,
                                                        'location': [alert.location_x, alert.location_y]|json_encode,
                                                        'timestamp': alert.pubMillis,
                                                        'type': 'Buraco',
                                                        'confidence': alert.confidence,
                                                        'status': alert.status
                                                    }|json_encode|e('html_attr') }}">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            <a href="https://www.waze.com/ul?ll={{ alert.location_y }},{{ alert.location_x }}" 
                                               target="_blank" 
                                               class="btn btn-primary btn-sm">
                                                <i class="fab fa-waze"></i>
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-3">
                        <i class="fas fa-road fa-2x text-muted mb-2"></i>
                        <p class="text-muted mb-0">Nenhum buraco reportado</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Tabela de Outros Alertas -->
        <div class="col-xl-6 mb-4">
            <div class="card shadow-sm h-100">
                <div class="card-header d-flex justify-content-between align-items-center py-2">
                    <h6 class="m-0 font-weight-bold text-info">
                        <i class="fas fa-exclamation-triangle mr-2"></i>Outros Alertas
                    </h6>
                    {% if otherAlerts is not empty %}
                    <span class="badge badge-info">{{ otherAlerts|length }}</span>
                    {% endif %}
                </div>
                <div class="card-body p-2">
                    {% if otherAlerts is not empty %}
                    <div class="table-responsive">
                        <table class="table table-striped table-sm mb-0" id="othersTable">
                            <thead class="thead-light">
                                <tr>
                                    <th>Cidade</th>
                                    <th class="d-none-mobile">Rua</th>
                                    <th>Data/Hora</th>
                                    <th class="text-center">Conf.</th>
                                    <th class="text-center">Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for alert in otherAlerts %}
                                <tr>
                                    <td>{{ alert.city }}</td>
                                    <td class="d-none-mobile">{{ alert.street }}</td>
                                    <td>
                                        <div>{{ (alert.pubMillis/1000)|date('d/m/Y') }}</div>
                                        <small class="text-muted">{{ (alert.pubMillis/1000)|date('H:i') }}</small>
                                    </td>
                                    <td class="text-center">
                                        <span class="badge badge-{{ alert.confidence > 4 ? 'success' : alert.confidence > 2 ? 'warning' : 'danger' }}">
                                            {{ alert.confidence }}
                                        </span>
                                    </td>
                                    <td class="text-center">
                                        <div class="btn-group">
                                            <button class="btn btn-info btn-sm open-modal" 
                                                    data-toggle="modal" 
                                                    data-target="#alertModal"
                                                    data-alert="{{ {
                                                        'uuid': alert.uuid,
                                                        'city': alert.city,
                                                        'street': alert.street,
                                                        'location': [alert.location_x, alert.location_y]|json_encode,
                                                        'timestamp': alert.pubMillis,
                                                        'type': 'Outro',
                                                        'confidence': alert.confidence,
                                                        'status': alert.status
                                                    }|json_encode|e('html_attr') }}">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            <a href="https://www.waze.com/ul?ll={{ alert.location_y }},{{ alert.location_x }}" 
                                               target="_blank" 
                                               class="btn btn-primary btn-sm">
                                                <i class="fab fa-waze"></i>
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-3">
                        <i class="fas fa-exclamation-triangle fa-2x text-muted mb-2"></i>
                        <p class="text-muted mb-0">Nenhum outro alerta</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block javascripts %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.12.1/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.2.3/js/dataTables.buttons.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"></script>
<script src="https://cdn.datatables.net/buttons/2.2.3/js/buttons.html5.min.js"></script>
<script>
$(document).ready(function() {
    // Configuração comum para todas as tabelas
    const tableConfig = {
        dom: '<"row"<"col-sm-12 col-md-6"l><"col-sm-12 col-md-6"f>>rt<"row"<"col-sm-12 col-md-5"i><"col-sm-12 col-md-7"p>>',
        pageLength: 10,
        lengthMenu: [5, 10, 25, 50, 100],
        autoWidth: false,
        responsive: true,
        order: [[2, 'desc']],
        language: {
            url: '//cdn.datatables.net/plug-ins/1.10.25/i18n/Portuguese-Brasil.json'
        },
        buttons: [
            {
                extend: 'excelHtml5',
                text: '<i class="fas fa-file-excel"></i> Excel',
                className: 'btn btn-success btn-sm'
            },
            {
                extend: 'pdfHtml5',
                text: '<i class="fas fa-file-pdf"></i> PDF',
                className: 'btn btn-danger btn-sm'
            }
        ]
    };

    // Inicializar todas as tabelas
    $('#accidentsTable').DataTable(tableConfig);
    $('#jamsTable').DataTable(tableConfig);
    $('#hazardsTable').DataTable(tableConfig);
    $('#othersTable').DataTable(tableConfig);
});
</script>
{% endblock %}