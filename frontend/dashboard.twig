{% block stylesheets %}
<link rel="stylesheet" href="https://cdn.datatables.net/1.12.1/css/jquery.dataTables.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.2.3/css/buttons.dataTables.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.7.1/dist/leaflet.css" />
<style>
ย ย .card-header {
ย ย ย ย background-color: #f8f9fa;
ย ย ย ย border-bottom: 1px solid #e3e6f0;
ย ย }
ย ย .dataTables_wrapper {
ย ย ย ย padding: 20px 0;
ย ย }
ย ย .alert-date {
ย ย ย ย min-width: 120px; /* Ensure date column has minimum width */
ย ย }
ย ย .map-container {
ย ย ย ย height: 400px;
ย ย ย ย width: 100%;
ย ย ย ย border-radius: 8px;
ย ย ย ย border: 1px solid #dee2e6;
ย ย ย ย overflow: hidden; /* Ensure map stays within bounds */
ย ย }
ย ย .badge-status {
ย ย ย ย font-size: 0.9em;
ย ย ย ย padding: 0.5em 0.75em;
ย ย }

ย ย .tooltip-inner {
ย ย ย ย max-width: 300px;
ย ย ย ย background-color: #333;
ย ย ย ย color: #fff;
ย ย }
ย ย .dataTables_wrapper .btn {
ย ย ย ย padding: 0.25rem 0.5rem;
ย ย ย ย font-size: 0.875rem;
ย ย }
ย ย .table-hover tbody tr:hover {
ย ย ย ย background-color: #f8f9fa;
ย ย ย ย /* cursor: pointer; Removed to avoid confusion with non-clickable rows */
ย ย }
ย ย .modal-header {
ย ย ย ย border-bottom: none; /* Remove default border */
ย ย }
ย ย .modal-body {
ย ย ย ย padding-top: 0; /* Adjust padding */
ย ย }
ย ย .modal-footer {
ย ย ย ย border-top: none; /* Remove default border */
ย ย }
ย ย .alert-details p {
ย ย ย ย margin-bottom: 0.5rem; /* Smaller margin for details */
ย ย }

</style>
{% endblock %}

{% block body %}
<div class="container-fluid">

ย ย ย ย <div class="d-sm-flex align-items-center justify-content-between mb-4">
ย ย ย ย <h1 class="h3 mb-0 text-gray-800">Dashboard de Alertas</h1>
ย ย ย ย ย ย ย ย <a href="#" class="d-none d-sm-inline-block btn btn-sm btn-primary shadow-sm" id="exportDataBtn">
ย ย ย ย ย ย <i class="fas fa-download fa-sm text-white-50"></i> Exportar Dados
ย ย ย ย </a>
ย ย </div>

ย ย ย ย <div class="row mb-4">
ย ย ย ย ย ย ย ย <div class="col-xl-3 col-md-6 mb-4">
ย ย ย ย ย ย <div class="card border-left-primary shadow h-100 py-2">
ย ย ย ย ย ย ย ย <div class="card-body">
ย ย ย ย ย ย ย ย ย ย <div class="row no-gutters align-items-center">
ย ย ย ย ย ย ย ย ย ย ย ย <div class="col mr-2">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย Alertas Ativos (Hoje)
ย ย ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div class="h5 mb-0 font-weight-bold text-gray-800">{{ activeAlertsToday }}</div>
ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย <div class="col-auto">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <i class="fas fa-bell fa-2x text-gray-300"></i>
ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย </div>
ย ย ย ย </div>

ย ย ย ย ย ย ย ย <div class="col-xl-3 col-md-6 mb-4">
ย ย ย ย ย ย <div class="card border-left-success shadow h-100 py-2">
ย ย ย ย ย ย ย ย <div class="card-body">
ย ย ย ย ย ย ย ย ย ย <div class="row no-gutters align-items-center">
ย ย ย ย ย ย ย ย ย ย ย ย <div class="col mr-2">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย Alertas Este Mรชs
ย ย ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div class="h5 mb-0 font-weight-bold text-gray-800">{{ totalAlertsThisMonth }}</div>
ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย <div class="col-auto">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <i class="fas fa-calendar-alt fa-2x text-gray-300"></i>
ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย </div>
ย ย ย ย </div>

ย ย ย ย ย ย ย ย <div class="col-xl-3 col-md-6 mb-4">
ย ย ย ย ย ย <div class="card border-left-info shadow h-100 py-2">
ย ย ย ย ย ย ย ย <div class="card-body">
ย ย ย ย ย ย ย ย ย ย <div class="row no-gutters align-items-center">
ย ย ย ย ย ย ย ย ย ย ย ย <div class="col mr-2">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย KM Congestionados (Atual)
ย ย ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div class="h5 mb-0 font-weight-bold text-gray-800">{{ traficdata.total_kms_lento|default(0) }} km</div>
ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย <div class="col-auto">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <i class="fas fa-road fa-2x text-gray-300"></i>
ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย </div>
ย ย ย ย </div>

ย ย ย ย ย ย ย ย <div class="col-xl-3 col-md-6 mb-4">
ย ย ย ย ย ย <div class="card border-left-warning shadow h-100 py-2">
ย ย ย ย ย ย ย ย <div class="card-body">
ย ย ย ย ย ย ย ย ย ย <div class="row no-gutters align-items-center">
ย ย ย ย ย ย ย ย ย ย ย ย <div class="col mr-2">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย Atraso Total (Atual)
ย ย ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div class="h5 mb-0 font-weight-bold text-gray-800">{{ traficdata.total_atraso_minutos|default(0) }} min</div>
ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย <div class="col-auto">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <i class="fas fa-clock fa-2x text-gray-300"></i>
ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย </div>
ย ย ย ย </div>
ย ย </div>

ย ย ย ย <div class="row">
ย ย ย ย ย ย ย ย <div class="col-xl-6 col-lg-12 mb-4">
ย ย ย ย ย ย <div class="card shadow">
ย ย ย ย ย ย ย ย <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
ย ย ย ย ย ย ย ย ย ย <h6 class="m-0 font-weight-bold text-primary"><i class="fas fa-car-crash mr-2"></i>Acidentes Recentes</h6>
ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย <div class="card-body">
ย ย ย ย ย ย ย ย ย ย {% if accidentAlerts is not empty %}
ย ย ย ย ย ย ย ย ย ย <table class="table table-bordered table-hover" id="accidentsTable" width="100%" cellspacing="0">
ย ย ย ย ย ย ย ย ย ย ย ย <thead>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <tr>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <th>Cidade</th>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <th>Rua</th>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <th>Localizaรงรฃo</th>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <th class="alert-date">Data</th>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <th>Confianรงa</th>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <th>Aรงรตes</th>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย </tr>
ย ย ย ย ย ย ย ย ย ย ย ย </thead>
ย ย ย ย ย ย ย ย ย ย ย ย <tbody>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย {% for alert in accidentAlerts %}
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <tr>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <td>{{ alert.city | default('Nรฃo informada') }}</td>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <td>{{ alert.street | default('Nรฃo informada') }}</td>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <td>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <a href="https://www.waze.com/ul?ll={{ alert.location_y }},{{ alert.location_x }}"
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ยtarget="_blank"
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ยclass="text-primary small"
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ยdata-toggle="tooltip" title="Ver no Waze">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย {{ alert.location_x|number_format(5) }}, {{ alert.location_y|number_format(5) }}
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย </a>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย </td>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <td class="alert-date">{{ (alert.pubMillis/1000)|date('d/m/Y H:i') }}</td>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <td>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <span class="badge badge-pill badge-{{ alert.confidence > 4 ? 'success' : alert.confidence > 2 ? 'warning' : 'danger' }}">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย {{ alert.confidence }}
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย </span>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย </td>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <td>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <button class="btn btn-sm btn-info open-modal"
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย data-toggle="tooltip" title="Ver detalhes"
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย data-alert="{{ {
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย 'uuid': alert.uuid,
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย 'city': alert.city | default('Nรฃo informada'),
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย 'street': alert.street | default('Nรฃo informada'),
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย 'location_x': alert.location_x,
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย 'location_y': alert.location_y,
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย 'pubMillis': alert.pubMillis,
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย 'type': alert.type,
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย 'subtype': alert.subtype | default('N/A'),
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย 'confidence': alert.confidence,
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย 'status': alert.status
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย }|json_encode|e('html_attr') }}"
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย >
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <i class="fas fa-info-circle"></i> Detalhes
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย </button>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย </td>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย </tr>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย {% endfor %}
ย ย ย ย ย ย ย ย ย ย ย ย </tbody>
ย ย ย ย ย ย ย ย ย ย </table>
ย ย ย ย ย ย ย ย ย ย {% else %}
ย ย ย ย ย ย ย ย ย ย <div class="alert alert-info mb-0">Nenhum acidente registrado recentemente</div>
ย ย ย ย ย ย ย ย ย ย {% endif %}
ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย </div>
ย ย ย ย </div>

ย ย ย ย ย ย ย ย <div class="col-xl-6 col-lg-12 mb-4">
ย ย ย ย ย ย <div class="card shadow">
ย ย ย ย ย ย ย ย <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
ย ย ย ย ย ย ย ย ย ย <h6 class="m-0 font-weight-bold text-primary"><i class="fas fa-traffic-light mr-2"></i>Congestionamentos Recentes</h6>
ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย <div class="card-body">
ย ย ย ย ย ย ย ย ย ย {% if jamAlerts is not empty %}
ย ย ย ย ย ย ย ย ย ย <table class="table table-bordered table-hover" id="jamsTable" width="100%" cellspacing="0">
ย ย ย ย ย ย ย ย ย ย ย ย <thead>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <tr>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <th>Cidade</th>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <th>Rua</th>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <th>Localizaรงรฃo</th>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <th class="alert-date">Data</th>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <th>Confianรงa</th>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <th>Aรงรตes</th>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย </tr>
ย ย ย ย ย ย ย ย ย ย ย ย </thead>
ย ย ย ย ย ย ย ย ย ย ย ย <tbody>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย {% for jam_alert in jamAlerts %}
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <tr>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <td>{{ jam_alert.city | default('Nรฃo informada') }}</td>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <td>{{ jam_alert.street | default('Nรฃo informada') }}</td>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <td>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <a href="https://www.waze.com/ul?ll={{ jam_alert.location_y }},{{ jam_alert.location_x }}"
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย target="_blank"
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย class="text-primary small"
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย data-toggle="tooltip" title="Ver no Waze">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย {{ jam_alert.location_x|number_format(5) }}, {{ jam_alert.location_y|number_format(5) }}
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย </a>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย </td>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <td class="alert-date">{{ (jam_alert.pubMillis/1000)|date('d/m/Y H:i') }}</td>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <td>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <span class="badge badge-pill badge-{{ jam_alert.confidence > 4 ? 'success' : jam_alert.confidence > 2 ? 'warning' : 'danger' }}">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย {{ jam_alert.confidence }}
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย </span>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย </td>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <td>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <button class="btn btn-sm btn-info open-modal"
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย data-toggle="tooltip" title="Ver detalhes"
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย data-alert="{{ {
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย 'uuid': jam_alert.uuid,
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย 'city': jam_alert.city | default('Nรฃo informada'),
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย 'street': jam_alert.street | default('Nรฃo informada'),
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย 'location_x': jam_alert.location_x,
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย 'location_y': jam_alert.location_y,
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย 'pubMillis': jam_alert.pubMillis,
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย 'type': jam_alert.type,
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย 'confidence': jam_alert.confidence,
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย 'status': jam_alert.status
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย }|json_encode|e('html_attr') }}"
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย >
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <i class="fas fa-info-circle"></i> Detalhes
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย </button>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย </td>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย </tr>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย {% endfor %}
ย ย ย ย ย ย ย ย ย ย </table>
ย ย ย ย ย ย ย ย ย ย {% else %}
ย ย ย ย ย ย ย ย ย ย <div class="alert alert-info mb-0">Nenhum congestionamento registrado recentemente</div>
ย ย ย ย ย ย ย ย ย ย {% endif %}
ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย </div>
ย ย ย ย </div>

ย ย ย ย ย ย ย ย <div class="col-xl-6 col-lg-12 mb-4">
ย ย ย ย ย ย <div class="card shadow">
ย ย ย ย ย ย ย ย <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
ย ย ย ย ย ย ย ย ย ย <h6 class="m-0 font-weight-bold text-primary"><i class="fas fa-road mr-2"></i>Buracos Recentes</h6>
ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย <div class="card-body">
ย ย ย ย ย ย ย ย ย ย {% if hazardAlerts is not empty %}
ย ย ย ย ย ย ย ย ย ย <table class="table table-bordered table-hover" id="potholesTable" width="100%" cellspacing="0"> {# Corrected ID #}
ย ย ย ย ย ย ย ย ย ย ย ย <thead>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <tr>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <th>Cidade</th>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <th>Rua</th>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <th>Localizaรงรฃo</th>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <th class="alert-date">Data</th>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <th>Confianรงa</th>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <th>Aรงรตes</th>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย </tr>
ย ย ย ย ย ย ย ย ย ย ย ย </thead>
ย ย ย ย ย ย ย ย ย ย ย ย <tbody>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย {% for pothole_alerts in hazardAlerts %}
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <tr>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <td>{{ pothole_alerts.city | default('Nรฃo informada') }}</td>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <td>{{ pothole_alerts.street | default('Nรฃo informada') }}</td>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <td>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <a href="https://www.waze.com/ul?ll={{ pothole_alerts.location_y }},{{ pothole_alerts.location_x }}"
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย target="_blank"
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย class="text-primary small"
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย data-toggle="tooltip" title="Ver no Waze">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย {{ pothole_alerts.location_x|number_format(5) }}, {{ pothole_alerts.location_y|number_format(5) }}
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย </a>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย </td>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <td class="alert-date">{{ (pothole_alerts.pubMillis/1000)|date('d/m/Y H:i') }}</td>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <td>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <span class="badge badge-pill badge-{{ pothole_alerts.confidence > 4 ? 'success' : pothole_alerts.confidence > 2 ? 'warning' : 'danger' }}">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย {{ pothole_alerts.confidence }}
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย </span>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย </td>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <td>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <button class="btn btn-sm btn-info open-modal"
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย data-toggle="tooltip" title="Ver detalhes"
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย data-alert="{{ {
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย 'uuid': pothole_alerts.uuid,
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย 'city': pothole_alerts.city | default('Nรฃo informada'),
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย 'street': pothole_alerts.street | default('Nรฃo informada'),
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย 'location_x': pothole_alerts.location_x,
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย 'location_y': pothole_alerts.location_y,
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย 'pubMillis': pothole_alerts.pubMillis,
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย 'type': pothole_alerts.type,
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย 'confidence': pothole_alerts.confidence,
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย 'status': pothole_alerts.status
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย }|json_encode|e('html_attr') }}"
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย >
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <i class="fas fa-info-circle"></i> Detalhes
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย </button>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย </td>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย </tr>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย {% endfor %}
ย ย ย ย ย ย ย ย ย ย ย ย </tbody>
ย ย ย ย ย ย ย ย ย ย </table>
ย ย ย ย ย ย ย ย ย ย {% else %}
ย ย ย ย ย ย ย ย ย ย <div class="alert alert-info mb-0">Nenhum buraco registrado recentemente</div>
ย ย ย ย ย ย ย ย ย ย {% endif %}
ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย </div>
ย ย ย ย </div>

ย ย ย ย ย ย ย ย <div class="col-xl-6 col-lg-12 mb-4">
ย ย ย ย ย ย <div class="card shadow">
ย ย ย ย ย ย ย ย <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
ย ย ย ย ย ย ย ย ย ย <h6 class="m-0 font-weight-bold text-primary"><i class="fas fa-info-circle mr-2"></i>Outros Alertas Recentes</h6>
ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย <div class="card-body">
ย ย ย ย ย ย ย ย ย ย {% if otherAlerts is not empty %}
ย ย ย ย ย ย ย ย ย ย <table class="table table-bordered table-hover" id="otherAlertsTable" width="100%" cellspacing="0"> {# Corrected ID #}
ย ย ย ย ย ย ย ย ย ย ย ย <thead>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <tr>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <th>Cidade</th>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <th>Rua</th>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <th>Localizaรงรฃo</th>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <th class="alert-date">Data</th>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <th>Confianรงa</th>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <th>Aรงรตes</th>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย </tr>
ย ย ย ย ย ย ย ย ย ย ย ย </thead>
ย ย ย ย ย ย ย ย ย ย ย ย <tbody>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย {% for orther_alerts in otherAlerts %}
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <tr>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <td>{{ orther_alerts.city | default('Nรฃo informada') }}</td>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <td>{{ orther_alerts.street | default('Nรฃo informada') }}</td>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <td>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <a href="https://www.waze.com/ul?ll={{ orther_alerts.location_y }},{{ orther_alerts.location_x }}"
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย target="_blank"
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย class="text-primary small"
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย data-toggle="tooltip" title="Ver no Waze">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย {{ orther_alerts.location_x|number_format(5) }}, {{ orther_alerts.location_y|number_format(5) }}
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย </a>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย </td>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <td class="alert-date">{{ (orther_alerts.pubMillis/1000)|date('d/m/Y H:i') }}</td>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <td>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <span class="badge badge-pill badge-{{ orther_alerts.confidence > 4 ? 'success' : orther_alerts.confidence > 2 ? 'warning' : 'danger' }}">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย {{ orther_alerts.confidence }}
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย </span>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย </td>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <td>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <button class="btn btn-sm btn-info open-modal"
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย data-toggle="tooltip" title="Ver detalhes"
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย data-alert='{{ {
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย "uuid": orther_alerts.uuid,
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย "city": orther_alerts.city | default('Nรฃo informada'),
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย "street": orther_alerts.street | default('Nรฃo informada'),
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย "location_x": orther_alerts.location_x,
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย "location_y": orther_alerts.location_y,
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย "pubMillis": orther_alerts.pubMillis,
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย "type": orther_alerts.type,
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย "confidence": orther_alerts.confidence,
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย "status": orther_alerts.status
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย }|json_encode|e('html_attr') }}'> {# Changed to html_attr for consistency #}
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <i class="fas fa-info-circle"></i> Detalhes
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย </button>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย </td>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย </tr>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย {% endfor %}
ย ย ย ย ย ย ย ย ย ย </table>
ย ย ย ย ย ย ย ย ย ย {% else %}
ย ย ย ย ย ย ย ย ย ย <div class="alert alert-info mb-0">Nenhum outro alerta registrado recentemente</div> {# Adjusted message #}
ย ย ย ย ย ย ย ย ย ย {% endif %}
ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย </div>
ย ย ย ย </div>

ย ย </div>
</div>

<div class="modal fade" id="alertModal" tabindex="-1" role="dialog" aria-labelledby="alertModalLabel" aria-hidden="true">
ย ย <div class="modal-dialog modal-lg" role="document">
ย ย ย ย <div class="modal-content p-3 shadow-lg rounded">
ย ย ย ย ย ย <div class="modal-header bg-primary text-white rounded-top py-3 px-4"> {# Added padding #}
ย ย ย ย ย ย ย ย <h5 class="modal-title" id="alertModalLabel"> {# Added ID #}
ย ย ย ย ย ย ย ย ย ย <i class="fas fa-exclamation-triangle mr-2"></i> Detalhes do Evento
ย ย ย ย ย ย ย ย </h5>
ย ย ย ย ย ย ย ย <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
ย ย ย ย ย ย ย ย ย ย <span aria-hidden="true">&times;</span>
ย ย ย ย ย ย ย ย </button>
ย ย ย ย ย ย </div>

ย ย ย ย ย ย <div class="modal-body px-4" style="max-height: 70vh; overflow-y: auto;"> {# Added horizontal padding #}
ย ย ย ย ย ย ย ย <div class="row">
ย ย ย ย ย ย ย ย ย ย <div class="col-md-6">
ย ย ย ย ย ย ย ย ย ย ย ย <div class="card border-0 shadow-sm p-3 mb-3">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <h6 class="text-primary mb-3">Informaรงรตes Gerais</h6> {# Added title #}
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <p><strong>๐ UUID:</strong> <span id="modalUuid"></span></p>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <p><strong>๐๏ธ Cidade:</strong> <span id="modalCity"></span></p>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <p><strong>๐ Rua:</strong> <span id="modalStreet"></span></p>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <p><strong>๐ก Localizaรงรฃo:</strong> <span id="modalLocation"></span></p>
ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย </div>

ย ย ย ย ย ย ย ย ย ย <div class="col-md-6">
ย ย ย ย ย ย ย ย ย ย ย ย <div class="card border-0 shadow-sm p-3 mb-3">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <h6 class="text-primary mb-3">Detalhes do Alerta</h6> {# Added title #}
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <p><strong>๐ Data:</strong> <span id="modalDate"></span></p>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <p><strong>๐ฃ๏ธ KM Estimado:</strong> <span id="modalKm" class="badge bg-secondary"></span></p> {# Changed default badge color #}
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <p><strong>๐ Confianรงa:</strong> <span id="modalConfidence" class="badge"></span></p>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <p><strong>โ๏ธ Status:</strong> <span id="modalStatus" class="badge"></span></p>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <p><strong>๐ Link Partner Hub:</strong> <a id="modalPartnerLink" class="badge bg-primary" target="_blank" rel="noopener noreferrer">Abrir</a></p> {# Added rel attribute #}
ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย </div>

ย ย ย ย ย ย ย ย <div class="card border-0 shadow-sm p-3 mb-3">
ย ย ย ย ย ย ย ย ย ย <h6 class="text-primary mb-3">Classificaรงรฃo</h6> {# Added title #}
ย ย ย ย ย ย ย ย ย ย <p><strong>๐จ Tipo:</strong> <span id="modalType"></span></p>
ย ย ย ย ย ย ย ย ย ย <p><strong>๐ Subtipo:</strong> <span id="modalSubtype"></span></p>
ย ย ย ย ย ย ย ย </div>

ย ย ย ย ย ย ย ย <div class="card border-0 shadow-sm p-3">
ย ย ย ย ย ย ย ย ย ย <h6 class="text-center text-muted mb-3">๐ Localizaรงรฃo no Mapa (Waze)</h6> {# Adjusted title #}
ย ย ย ย ย ย ย ย ย ย <div id="mapContainer" class="map-container">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย </div>

ย ย ย ย ย ย <div class="modal-footer d-flex justify-content-between px-4 py-3"> {# Added padding #}
ย ย ย ย ย ย ย ย <a id="modalWazeLink" class="btn btn-outline-primary" target="_blank" rel="noopener noreferrer"> {# Added rel attribute #}
ย ย ย ย ย ย ย ย ย ย <i class="fab fa-waze mr-1"></i> Ver no Waze
ย ย ย ย ย ย ย ย </a>
ย ย ย ย ย ย ย ย <button type="button" class="btn btn-secondary" data-dismiss="modal">
ย ย ย ย ย ย ย ย ย ย <i class="fas fa-times mr-1"></i> Fechar
ย ย ย ย ย ย ย ย </button>
ย ย ย ย ย ย </div>
ย ย ย ย </div>
ย ย </div>
</div>

{% endblock %}


{% block javascripts %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.12.1/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.2.3/js/dataTables.buttons.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"></script>
<script src="https://cdn.datatables.net/buttons/2.2.3/js/buttons.html5.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/leaflet@1.7.1/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script> {# Ensure correct Bootstrap JS version #}

<script>
ย ย $(document).ready(function() {

ย ย ย ย // Initialize DataTables for all tables
ย ย ย ย $('#accidentsTable').DataTable({
ย ย ย ย ย ย "language": {
ย ย ย ย ย ย ย ย "url": "//cdn.datatables.net/plug-ins/1.12.1/i18n/pt-BR.json" // Brazilian Portuguese localization
ย ย ย ย ย ย },
ย ย ย ย ย ย "paging": true,
ย ย ย ย ย ย "lengthChange": true,
ย ย ย ย ย ย "searching": true,
ย ย ย ย ย ย "ordering": true,
ย ย ย ย ย ย "info": true,
ย ย ย ย ย ย "autoWidth": false,
ย ย ย ย ย ย "responsive": true
ย ย ย ย });

ย ย ย ย $('#jamsTable').DataTable({
ย ย ย ย ย ย "language": {
ย ย ย ย ย ย ย ย "url": "//cdn.datatables.net/plug-ins/1.12.1/i18n/pt-BR.json"
ย ย ย ย ย ย },
ย ย ย ย ย ย "paging": true,
ย ย ย ย ย ย "lengthChange": true,
ย ย ย ย ย ย "searching": true,
ย ย ย ย ย ย "ordering": true,
ย ย ย ย ย ย "info": true,
ย ย ย ย ย ย "autoWidth": false,
ย ย ย ย ย ย "responsive": true
ย ย ย ย });

ย ย ย ย $('#potholesTable').DataTable({ {# Initializing for the corrected ID #}
ย ย ย ย ย ย "language": {
ย ย ย ย ย ย ย ย "url": "//cdn.datatables.net/plug-ins/1.12.1/i18n/pt-BR.json"
ย ย ย ย ย ย },
ย ย ย ย ย ย "paging": true,
ย ย ย ย ย ย "lengthChange": true,
ย ย ย ย ย ย "searching": true,
ย ย ย ย ย ย "ordering": true,
ย ย ย ย ย ย "info": true,
ย ย ย ย ย ย "autoWidth": false,
ย ย ย ย ย ย "responsive": true
ย ย ย ย });

ย ย ย ย $('#otherAlertsTable').DataTable({ {# Initializing for the corrected ID #}
ย ย ย ย ย ย "language": {
ย ย ย ย ย ย ย ย "url": "//cdn.datatables.net/plug-ins/1.12.1/i18n/pt-BR.json"
ย ย ย ย ย ย },
ย ย ย ย ย ย "paging": true,
ย ย ย ย ย ย "lengthChange": true,
ย ย ย ย ย ย "searching": true,
ย ย ย ย ย ย "ordering": true,
ย ย ย ย ย ย "info": true,
ย ย ย ย ย ย "autoWidth": false,
ย ย ย ย ย ย "responsive": true
ย ย ย ย });

ย ย ย ย // Tooltips
ย ย ย ย $('[data-toggle="tooltip"]').tooltip();

ย ย ย ย // Delegar evento para elementos dinรขmicos (botรตes do modal)
ย ย ย ย $(document).on('click', '.open-modal', function() {
ย ย ย ย ย ย // Destroy existing tooltips to prevent duplicates on modal open
ย ย ย ย ย ย $('[data-toggle="tooltip"]').tooltip('dispose');

ย ย ย ย ย ย const rawData = $(this).data('alert'); // Use .data() for better JSON parsing
ย ย ย ย ย ย console.log('Raw Data:', rawData);
ย ย ย ย ย ย let alertData = rawData; // If already parsed by .data(), use directly

ย ย ย ย ย ย // Fallback parsing if .data() didn't parse it (less common but safe)
ย ย ย ย ย ย if (typeof alertData === 'string') {
ย ย ย ย ย ย ย ย try {
ย ย ย ย ย ย ย ย ย ย alertData = JSON.parse(alertData);
ย ย ย ย ย ย ย ย } catch (e) {
ย ย ย ย ย ย ย ย ย ย console.error("Erro ao parsear alertData:", e);
ย ย ย ย ย ย ย ย ย ย return;
ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย }

ย ย ย ย ย ย // Preencher dados bรกsicos
ย ย ย ย ย ย $('#modalUuid').text(alertData.uuid || 'N/A');
ย ย ย ย ย ย $('#modalCity').text(alertData.city || 'Nรฃo informada');
ย ย ย ย ย ย $('#modalStreet').text(alertData.street || 'Nรฃo informada');
ย ย ย ย ย ย $('#modalLocation').text(`${alertData.location_x || 'N/A'}, ${alertData.location_y || 'N/A'}`);
ย ย ย ย ย ย $('#modalDate').text(alertData.pubMillis ? new Date(alertData.pubMillis).toLocaleString('pt-BR') : 'Nรฃo informada');
ย ย ย ย ย ย $('#modalType').text(alertData.type || 'N/A');
ย ย ย ย ย ย $('#modalSubtype').text(alertData.subtype || 'N/A');

ย ย ย ย ย ย // Configurar links
ย ย ย ย ย ย const partnerLink = `https://www.waze.com/partnerhub/map-tool/alerts?cardType=3&cardId=${alertData.uuid}`;
ย ย ย ย ย ย $('#modalPartnerLink').attr('href', alertData.uuid ? partnerLink : '#')
ย ย ย ย ย ย ย ย .text(alertData.uuid ? 'Abrir' : 'N/A')
ย ย ย ย ย ย ย ย .toggleClass('disabled', !alertData.uuid); // Disable link if no UUID

ย ย ย ย ย ย const wazeLink = `https://www.waze.com/ul?ll=${alertData.location_y},${alertData.location_x}`;
ย ย ย ย ย ย $('#modalWazeLink').attr('href', (alertData.location_y && alertData.location_x) ? wazeLink : '#')
ย ย ย ย ย ย ย ย .toggleClass('disabled', !(alertData.location_y && alertData.location_x)); // Disable link if no coords


ย ย ย ย ย ย // Status e Confianรงa
ย ย ย ย ย ย const status = alertData.status !== null ? alertData.status : 0;
ย ย ย ย ย ย $('#modalStatus')
ย ย ย ย ย ย ย ย .text(status === 1 ? "Ativo" : "Inativo")
ย ย ย ย ย ย ย ย .removeClass('badge-success badge-danger badge-secondary') // Remove previous classes
ย ย ย ย ย ย ย ย .addClass(`badge badge-pill badge-${status === 1 ? 'success' : 'danger'}`); // Use badge-pill and correct colors

ย ย ย ย ย ย const confidence = alertData.confidence !== null ? alertData.confidence : 'N/A';
ย ย ย ย ย ย let confidenceClass = 'badge-secondary'; // Default color
ย ย ย ย ย ย if (confidence > 4) {
ย ย ย ย ย ย ย ย confidenceClass = 'badge-success';
ย ย ย ย ย ย } else if (confidence > 2) {
ย ย ย ย ย ย ย ย confidenceClass = 'badge-warning';
ย ย ย ย ย ย } else if (confidence !== 'N/A') {
ย ย ย ย ย ย ย ย confidenceClass = 'badge-danger';
ย ย ย ย ย ย }

ย ย ย ย ย ย $('#modalConfidence')
ย ย ย ย ย ย ย ย .text(confidence !== 'N/A' ? `${confidence}%` : 'N/A')
ย ย ย ย ย ย ย ย .removeClass('badge-success badge-warning badge-danger badge-secondary') // Remove previous classes
ย ย ย ย ย ย ย ย .addClass(`badge badge-pill ${confidenceClass}`); // Use badge-pill

ย ย ย ย ย ย // Buscar KM (mantido se necessรกrio para outros elementos)
ย ย ย ย ย ย $('#modalKm').html('<span class="spinner-border spinner-border-sm"></span> Calculando...');
ย ย ย ย ย ย // Assuming buscarKmDnit is defined globally or in scripts.js
ย ย ย ย ย ย if(typeof buscarKmDnit === 'function') {
ย ย ย ย ย ย ย ย buscarKmDnit(alertData.location_y, alertData.location_x)
ย ย ย ย ย ย ย ย ย ย .then(km => $('#modalKm').text(km ? `KM ${km}` : "Nรฃo encontrado"))
ย ย ย ย ย ย ย ย ย ย .catch(() => $('#modalKm').html('<span class="text-danger">Erro na busca</span>'));
ย ย ย ย ย ย } else {
ย ย ย ย ย ย ย $('#modalKm').text('Funรงรฃo KM nรฃo disponรญvel');
ย ย ย ย ย ย }


ย ย ย ย ย ย // Load Waze Map iframe
ย ย ย ย ย ย const mapContainer = $('#mapContainer');
ย ย ย ย ย ย mapContainer.empty(); // Clear previous content

ย ย ย ย ย ย if (alertData.location_x && alertData.location_y) {
ย ย ย ย ย ย ย ย const iframeSrc = `https://embed.waze.com/iframe?zoom=16&lat=${alertData.location_y}&lon=${alertData.location_x}&pin=1`;
ย ย ย ย ย ย ย ย const iframe = $('<iframe>')
ย ย ย ย ย ย ย ย ย ย .attr('src', iframeSrc)
ย ย ย ย ย ย ย ย ย ย .css({ width: '100%', height: '100%', border: '0' }) // Use 100% height for map-container
ย ย ย ย ย ย ย ย ย ย .attr('loading', 'lazy');
ย ย ย ย ย ย ย ย mapContainer.append(iframe);
ย ย ย ย ย ย } else {
ย ย ย ย ย ย ย ย mapContainer.html('<div class="alert alert-warning text-center m-3">Localizaรงรฃo nรฃo disponรญvel para exibir no mapa.</div>');
ย ย ย ย ย ย }

ย ย ย ย ย ย // Show the modal (handled by Bootstrap data attributes, but good to know)
ย ย ย ย ย ย $('#alertModal').modal('show');
ย ย ย ย });

ย ย ย ย // Reset modal content when hidden
ย ย ย ย $('#alertModal').on('hidden.bs.modal', function() {
ย ย ย ย ย ย $('#modalUuid').text('');
ย ย ย ย ย ย $('#modalCity').text('');
ย ย ย ย ย ย $('#modalStreet').text('');
ย ย ย ย ย ย $('#modalLocation').text('');
ย ย ย ย ย ย $('#modalDate').text('');
ย ย ย ย ย ย $('#modalType').text('');
ย ย ย ย ย ย $('#modalSubtype').text('N/A');
ย ย ย ย ย ย $('#modalConfidence').text('').removeClass('badge-success badge-warning badge-danger badge-secondary').addClass('badge badge-secondary');
ย ย ย ย ย ย $('#modalStatus').text('').removeClass('badge-success badge-danger badge-secondary').addClass('badge badge-secondary');
ย ย ย ย ย ย $('#modalKm').text('');
ย ย ย ย ย ย $('#modalPartnerLink').attr('href', '#').text('Partner Hub').removeClass('disabled');
ย ย ย ย ย ย $('#modalWazeLink').attr('href', '#').removeClass('disabled');

ย ย ย ย ย ย // Clear the map container
ย ย ย ย ย ย $('#mapContainer').empty();

ย ย ย ย ย ย // Re-initialize tooltips for the tables
ย ย ย ย ย ย $('[data-toggle="tooltip"]').tooltip();
ย ย ย ย });
ย ย });

ย ย // If you have a separate scripts.js, ensure buscarKmDnit is defined there or globally
ย ย // For demonstration, a dummy function:
ย ย async function buscarKmDnit(lat, lon) {
ย ย ย ย // Replace with actual API call
ย ย ย ย return new Promise(resolve => {
ย ย ย ย ย ย setTimeout(() => {
ย ย ย ย ย ย ย ย // Dummy KM logic based on coordinates
ย ย ย ย ย ย ย ย if (lat && lon) {
ย ย ย ย ย ย ย ย ย ย resolve(Math.floor(Math.random() * 500) + 1); // Random KM for demo
ย ย ย ย ย ย ย ย } else {
ย ย ย ย ย ย ย ย ย ย resolve(null);
ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย }, 1000); // Simulate network delay
ย ย ย ย });
ย ย }
</script>

{# <script src="./js/scripts.js"></script> #}
{% endblock %}