{% block stylesheets %}
<link rel="stylesheet" href="https://cdn.datatables.net/1.12.1/css/jquery.dataTables.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.2.3/css/buttons.dataTables.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
<style>
    /* Estilos otimizados para todas as tabelas */
    .card {
        margin-bottom: 1.5rem;
        border: 1px solid #e3e6f0;
        border-radius: 0.35rem;
    }

    .card-header {
        background-color: #f8f9fc;
        padding: 0.75rem 1.25rem;
        border-bottom: 1px solid #e3e6f0;
    }

    .table-responsive {
        overflow-x: auto;
    }

    .table-sm {
        font-size: 0.875rem;
        margin-bottom: 0;
    }

    .table-sm th,
    .table-sm td {
        padding: 0.5rem;
        vertical-align: middle;
    }

    .badge {
        font-weight: 500;
        min-width: 65px;
        padding: 0.4em 0.65em;
    }

    .btn-group-sm>.btn {
        padding: 0.25rem 0.5rem;
        font-size: 0.75rem;
    }

    @media (max-width: 767.98px) {
        .d-none-mobile {
            display: none !important;
        }

        .table-sm {
            font-size: 0.8rem;
        }

        .btn-group-sm>.btn {
            padding: 0.2rem 0.3rem;
        }
    }

    .dataTables_wrapper .dataTables_paginate .paginate_button {
        padding: 0.25rem 0.5rem;
        margin-left: 0.25rem;
    }

    .metric-card {
        transition: transform 0.15s ease-in-out;
    }

    .metric-card:hover {
        transform: translateY(-3px);
    }
</style>
{% endblock %}

{% block body %}
<div class="container-fluid">
    <!-- Cabeçalho -->
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-gray-800">Dashboard Completo de Alertas</h1>
        <div>
            <a href="#" class="btn btn-primary btn-sm shadow-sm">
                <i class="fas fa-download fa-sm"></i> Exportar Tudo
            </a>
        </div>
    </div>

    <!-- Métricas Superiores -->
    <div class="row">
        <!-- Métrica 1 -->
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card metric-card border-left-primary shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                Alertas Hoje
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ activeAlertsToday }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-bell fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Métrica 2 -->
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card metric-card border-left-success shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                Alertas Mês
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ totalAlertsThisMonth }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-calendar-alt fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Métrica 3 -->
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card metric-card border-left-info shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                                KM Congestionados
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ traficdata.total_kms_lento }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-road fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Métrica 4 -->
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card metric-card border-left-warning shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                Atraso Total
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ traficdata.total_atraso_minutos }}
                                min</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-clock fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Seção de Tabelas -->
    <div class="row">
        <!-- Tabela de Acidentes -->
        <div class="col-xl-6 mb-4">
            <div class="card shadow-sm h-100">
                <div class="card-header d-flex justify-content-between align-items-center py-2">
                    <h6 class="m-0 font-weight-bold text-danger">
                        <i class="fas fa-car-crash mr-2"></i>Acidentes Recentes
                    </h6>
                    {% if accidentAlerts is not empty %}
                    <span class="badge badge-danger">{{ accidentAlerts|length }}</span>
                    {% endif %}
                </div>
                <div class="card-body p-2">
                    {% if accidentAlerts is not empty %}
                    <div class="table-responsive">
                        <table class="table table-striped table-sm mb-0" id="accidentsTable">
                            <thead class="thead-light">
                                <tr>
                                    <th>Cidade</th>
                                    <th class="d-none-mobile">Rua</th>
                                    <th>Data/Hora</th>
                                    <th class="text-center">Conf.</th>
                                    <th class="text-center">Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for alert in accidentAlerts %}
                                <tr>
                                    <td>{{ alert.city }}</td>
                                    <td class="d-none-mobile">{{ alert.street }}</td>
                                    <td>
                                        <div>{{ (alert.pubMillis/1000)|date('d/m/Y') }}</div>
                                        <small class="text-muted">{{ (alert.pubMillis/1000)|date('H:i') }}</small>
                                    </td>
                                    <td class="text-center">
                                        <span
                                            class="badge badge-{{ alert.confidence > 4 ? 'success' : alert.confidence > 2 ? 'warning' : 'danger' }}">
                                            {{ alert.confidence }}
                                        </span>
                                    </td>
                                    <td class="text-center">
                                        <div class="btn-group">
                                            <button class="btn btn-info btn-sm open-modal" data-toggle="modal"
                                                data-target="#alertModal" data-alert="{{ {
    'uuid': alert.uuid,
    'city': alert.city,
    'street': alert.street,
    'location': [alert.location_x, alert.location_y],
    'timestamp': alert.pubMillis,
    'type': alert.type,
    'subtype': alert.subtype,
    'confidence': alert.confidence,
    'status': alert.status
}|json_encode|e('html_attr') }}">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            <a href="https://www.waze.com/ul?ll={{ alert.location_y }},{{ alert.location_x }}"
                                                target="_blank" class="btn btn-primary btn-sm">
                                                <i class="fab fa-waze"></i>
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-3">
                        <i class="fas fa-car-crash fa-2x text-muted mb-2"></i>
                        <p class="text-muted mb-0">Nenhum acidente registrado</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Tabela de Congestionamentos -->
        <div class="col-xl-6 mb-4">
            <div class="card shadow-sm h-100">
                <div class="card-header d-flex justify-content-between align-items-center py-2">
                    <h6 class="m-0 font-weight-bold text-warning">
                        <i class="fas fa-traffic-light mr-2"></i>Congestionamentos
                    </h6>
                    {% if jamAlerts is not empty %}
                    <span class="badge badge-warning">{{ jamAlerts|length }}</span>
                    {% endif %}
                </div>
                <div class="card-body p-2">
                    {% if jamAlerts is not empty %}
                    <div class="table-responsive">
                        <table class="table table-striped table-sm mb-0" id="jamsTable">
                            <thead class="thead-light">
                                <tr>
                                    <th>Cidade</th>
                                    <th class="d-none-mobile">Rua</th>
                                    <th>Data/Hora</th>
                                    <th class="text-center">Conf.</th>
                                    <th class="text-center">Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for alert in jamAlerts %}
                                <tr>
                                    <td>{{ alert.city }}</td>
                                    <td class="d-none-mobile">{{ alert.street }}</td>
                                    <td>
                                        <div>{{ (alert.pubMillis/1000)|date('d/m/Y') }}</div>
                                        <small class="text-muted">{{ (alert.pubMillis/1000)|date('H:i') }}</small>
                                    </td>
                                    <td class="text-center">
                                        <span
                                            class="badge badge-{{ alert.confidence > 4 ? 'success' : alert.confidence > 2 ? 'warning' : 'danger' }}">
                                            {{ alert.confidence }}
                                        </span>
                                    </td>
                                    <td class="text-center">
                                        <div class="btn-group">
                                            <button class="btn btn-info btn-sm open-modal" data-toggle="modal"
                                                data-target="#alertModal" data-alert="{{ {
    'uuid': alert.uuid,
    'city': alert.city,
    'street': alert.street,
    'location': [alert.location_x, alert.location_y],
    'timestamp': alert.pubMillis,
    'type': alert.type,
    'subtype': alert.subtype,
    'confidence': alert.confidence,
    'status': alert.status
}|json_encode|e('html_attr') }}">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            <a href="https://www.waze.com/ul?ll={{ alert.location_y }},{{ alert.location_x }}"
                                                target="_blank" class="btn btn-primary btn-sm">
                                                <i class="fab fa-waze"></i>
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-3">
                        <i class="fas fa-traffic-light fa-2x text-muted mb-2"></i>
                        <p class="text-muted mb-0">Nenhum congestionamento</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Tabela de Buracos -->
        <div class="col-xl-6 mb-4">
            <div class="card shadow-sm h-100">
                <div class="card-header d-flex justify-content-between align-items-center py-2">
                    <h6 class="m-0 font-weight-bold text-dark">
                        <i class="fas fa-road mr-2"></i>Buracos Reportados
                    </h6>
                    {% if hazardAlerts is not empty %}
                    <span class="badge badge-dark">{{ hazardAlerts|length }}</span>
                    {% endif %}
                </div>
                <div class="card-body p-2">
                    {% if hazardAlerts is not empty %}
                    <div class="table-responsive">
                        <table class="table table-striped table-sm mb-0" id="hazardsTable">
                            <thead class="thead-light">
                                <tr>
                                    <th>Cidade</th>
                                    <th class="d-none-mobile">Rua</th>
                                    <th>Data/Hora</th>
                                    <th class="text-center">Conf.</th>
                                    <th class="text-center">Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for alert in hazardAlerts %}
                                <tr>
                                    <td>{{ alert.city }}</td>
                                    <td class="d-none-mobile">{{ alert.street }}</td>
                                    <td>
                                        <div>{{ (alert.pubMillis/1000)|date('d/m/Y') }}</div>
                                        <small class="text-muted">{{ (alert.pubMillis/1000)|date('H:i') }}</small>
                                    </td>
                                    <td class="text-center">
                                        <span
                                            class="badge badge-{{ alert.confidence > 4 ? 'success' : alert.confidence > 2 ? 'warning' : 'danger' }}">
                                            {{ alert.confidence }}
                                        </span>
                                    </td>
                                    <td class="text-center">
                                        <div class="btn-group">
                                            <button class="btn btn-info btn-sm open-modal" data-toggle="modal"
                                                data-target="#alertModal" data-alert="{{ {
    'uuid': alert.uuid,
    'city': alert.city,
    'street': alert.street,
    'location': [alert.location_x, alert.location_y],
    'timestamp': alert.pubMillis,
    'type': alert.type,
    'subtype': alert.subtype,
    'confidence': alert.confidence,
    'status': alert.status
}|json_encode|e('html_attr') }}">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            <a href="https://www.waze.com/ul?ll={{ alert.location_y }},{{ alert.location_x }}"
                                                target="_blank" class="btn btn-primary btn-sm">
                                                <i class="fab fa-waze"></i>
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-3">
                        <i class="fas fa-road fa-2x text-muted mb-2"></i>
                        <p class="text-muted mb-0">Nenhum buraco reportado</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Tabela de Outros Alertas -->
        <div class="col-xl-6 mb-4">
            <div class="card shadow-sm h-100">
                <div class="card-header d-flex justify-content-between align-items-center py-2">
                    <h6 class="m-0 font-weight-bold text-info">
                        <i class="fas fa-exclamation-triangle mr-2"></i>Outros Alertas
                    </h6>
                    {% if otherAlerts is not empty %}
                    <span class="badge badge-info">{{ otherAlerts|length }}</span>
                    {% endif %}
                </div>
                <div class="card-body p-2">
                    {% if otherAlerts is not empty %}
                    <div class="table-responsive">
                        <table class="table table-striped table-sm mb-0" id="othersTable">
                            <thead class="thead-light">
                                <tr>
                                    <th>Cidade</th>
                                    <th class="d-none-mobile">Rua</th>
                                    <th>Data/Hora</th>
                                    <th class="text-center">Conf.</th>
                                    <th class="text-center">Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for alert in otherAlerts %}
                                <tr>
                                    <td>{{ alert.city }}</td>
                                    <td class="d-none-mobile">{{ alert.street }}</td>
                                    <td>
                                        <div>{{ (alert.pubMillis/1000)|date('d/m/Y') }}</div>
                                        <small class="text-muted">{{ (alert.pubMillis/1000)|date('H:i') }}</small>
                                    </td>
                                    <td class="text-center">
                                        <span
                                            class="badge badge-{{ alert.confidence > 4 ? 'success' : alert.confidence > 2 ? 'warning' : 'danger' }}">
                                            {{ alert.confidence }}
                                        </span>
                                    </td>
                                    <td class="text-center">
                                        <div class="btn-group">
                                            <button class="btn btn-info btn-sm open-modal" data-toggle="modal"
                                                data-target="#alertModal" data-alert="{{ {
    'uuid': alert.uuid,
    'city': alert.city,
    'street': alert.street,
    'location': [alert.location_x, alert.location_y],
    'timestamp': alert.pubMillis,
    'type': alert.type,
    'subtype': alert.subtype,
    'confidence': alert.confidence,
    'status': alert.status
}|json_encode|e('html_attr') }}">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            <a href="https://www.waze.com/ul?ll={{ alert.location_y }},{{ alert.location_x }}"
                                                target="_blank" class="btn btn-primary btn-sm">
                                                <i class="fab fa-waze"></i>
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-3">
                        <i class="fas fa-exclamation-triangle fa-2x text-muted mb-2"></i>
                        <p class="text-muted mb-0">Nenhum outro alerta</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}


{# Remova todos os includes de modal das linhas #}

<!-- Modal Único -->
<div class="modal fade" id="alertModal" tabindex="-1" aria-labelledby="alertModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content shadow-lg rounded">
            <div class="modal-header bg-primary text-white rounded-top">
                <h5 class="modal-title">
                    <i class="fas fa-exclamation-triangle"></i> Detalhes do Evento
                </h5>
                <button type="button" class="close text-white" data-dismiss="modal" aria-label="Fechar">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>

            <div class="modal-body" style="max-height: 75vh; overflow-y: auto; padding: 1.5rem;">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <div class="bg-light p-3 rounded shadow-sm border">
                            <h6><i class="fas fa-info-circle mr-2"></i> Informações Básicas</h6>
                            <hr class="my-2">
                            <p><strong><i class="fas fa-fingerprint mr-2"></i> UUID:</strong> <span
                                    id="modalUuid"></span></p>
                            <p><strong><i class="fas fa-city mr-2"></i> Cidade:</strong> <span id="modalCity"></span>
                            </p>
                            <p><strong><i class="fas fa-road mr-2"></i> Rua:</strong> <span id="modalStreet"></span></p>
                            <p><strong><i class="fas fa-map-marker-alt mr-2"></i> Localização:</strong>
                                Lat: <span id="modalLat"></span>, Lon: <span id="modalLon"></span>
                            </p>
                        </div>
                    </div>

                    <div class="col-md-6 mb-3">
                        <div class="bg-light p-3 rounded shadow-sm border">
                            <h6><i class="fas fa-clock mr-2"></i> Detalhes Adicionais</h6>
                            <hr class="my-2">
                            <p><strong><i class="far fa-calendar-alt mr-2"></i> Data:</strong>
                                <span id="modalDate"></span>
                                <small class="text-muted">(UTC)</small>
                            </p>
                            <p><strong><i class="fas fa-tachometer-alt mr-2"></i> KM Estimado:</strong>
                                <span id="modalKm" class="badge badge-info"></span>
                            </p>
                            <p><strong><i class="fas fa-check-double mr-2"></i> Confiança:</strong>
                                <span id="modalConfidence" class="badge"></span>
                            </p>
                            <p><strong><i class="fas fa-traffic-light mr-2"></i> Status:</strong>
                                <span id="modalStatus" class="badge"></span>
                            </p>
                            <p><strong><i class="fas fa-tags mr-2"></i> Tipo:</strong> <span id="modalType"></span></p>
                            <p><strong><i class="fas fa-tag mr-2"></i> Subtipo:</strong> <span id="modalSubtype"></span>
                            </p>
                            <p><strong><i class="fas fa-link mr-2"></i> Waze Partner Hub:</strong>
                                <a id="modalPartnerLink" class="badge badge-primary text-decoration-none"
                                    target="_blank" rel="noopener noreferrer"
                                    aria-label="Abrir alerta no Waze Partner Hub">
                                    Ver Detalhes ↗
                                </a>
                            </p>
                        </div>
                    </div>
                </div>

                <hr class="my-3">
                <h6 class="text-center text-muted mb-3"><i class="fas fa-map-marked-alt mr-2"></i> Localização no Mapa
                </h6>
                <iframe id="modalMap" class="rounded shadow-sm border"
                    style="width: 100%; height: 300px; border-color: #e0e0e0;" allow="geolocation *; fullscreen"
                    title="Localização exata do alerta" loading="lazy" referrerpolicy="strict-origin-when-cross-origin"
                    aria-describedby="map-description">
                </iframe>
                <small id="map-description" class="form-text text-muted text-center">
                    Mapa interativo mostrando a localização precisa do alerta.
                </small>

                <hr class="my-3">
                <h6 class="text-center text-muted mb-3"><i class="fas fa-street-view mr-2"></i> Street View</h6>
                <iframe id="modalStreetView" width="100%" height="300" frameborder="0" style="border:0" allowfullscreen
                    loading="lazy" class="rounded shadow-sm border">
                </iframe>
                <small class="form-text text-muted text-center">
                    Visualização do Street View da localização (API Key do Google Maps é necessária).
                </small>
            </div>

            <div class="modal-footer d-flex justify-content-end">
                <a id="modalWazeLink" class="btn btn-outline-primary" target="_blank">
                    <i class="fab fa-waze mr-2"></i> Ver no Waze
                </a>
                <button type="button" class="btn btn-secondary" data-dismiss="modal">
                    <i class="fas fa-times mr-2"></i> Fechar
                </button>
                <button type="button" class="btn btn-success ml-2" id="modalConfirmBtn">
                    <i class="fas fa-check mr-2"></i> Confirmar
                </button>
            </div>
        </div>
    </div>
</div>

{% block javascripts %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    // Resolver conflitos de versão do jQuery
    var $jq = jQuery.noConflict(true);
</script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
<script src="https://cdn.datatables.net/1.12.1/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.2.3/js/dataTables.buttons.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"></script>
<script src="https://cdn.datatables.net/buttons/2.2.3/js/buttons.html5.min.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        // Configuração do modal corrigida
        $('#alertModal').on('show.bs.modal', async function (event) {
            const button = $(event.relatedTarget);

            try {
                // 1. Corrigir o parse dos dados
                // Correção definitiva para o parse dos dados
                const rawData = button.data('alert');
                let alertData;

                if (typeof rawData === 'string') {
                    alertData = JSON.parse(rawData.replace(/&quot;/g, '"'));
                } else {
                    alertData = rawData;
                }

                console.log('Dados do alerta:', alertData);

                // 2. Preencher dados básicos
                $('#modalUuid').text(alertData.uuid);
                $('#modalCity').text(alertData.city);
                $('#modalStreet').text(alertData.street);
                $('#modalLat').text(alertData.location[1].toFixed(6));
                $('#modalLon').text(alertData.location[0].toFixed(6));
                $('#modalDate').text(new Date(alertData.timestamp).toLocaleString('pt-BR'));
                $('#modalType').text(alertData.type);
                $('#modalSubtype').text(alertData.subtype || 'N/A');

                // 3. Atualizar iframes corretamente
                const wazeSrc = `https://embed.waze.com/iframe?zoom=16&lat=${alertData.location[1]}&lon=${alertData.location[0]}&pin=1`;
                $('#modalMap').attr('src', wazeSrc);

                const streetViewSrc = `https://www.google.com/maps/embed/v1/streetview?key=SUA_CHAVE&location=${alertData.location[1]},${alertData.location[0]}`;
                $('#modalStreetView').attr('src', streetViewSrc);

                // 4. Atualizar links
                $('#modalPartnerLink').attr('href', `https://www.waze.com/partnerhub/map-tool/alerts?cardType=3&cardId=${alertData.uuid}`);
                $('#modalWazeLink').attr('href', `https://www.waze.com/ul?ll=${alertData.location[1]},${alertData.location[0]}`);

                // 5. Atualizar status e confiança
                $('#modalStatus')
                    .text(alertData.status === 1 ? "Ativo" : "Inativo")
                    .removeClass()
                    .addClass(`badge badge-${alertData.status === 1 ? 'success' : 'danger'}`);

                $('#modalConfidence')
                    .html(`${alertData.confidence} - ${['Baixa', 'Média', 'Alta'][Math.floor(alertData.confidence / 2)]}`)
                    .removeClass()
                    .addClass(`badge badge-${alertData.confidence > 4 ? 'success' : alertData.confidence >= 3 ? 'warning' : 'danger'}`);

                // 6. Buscar KM com tratamento de erro
                $('#modalKm').html('<span class="spinner-border spinner-border-sm"></span> Calculando...');
                try {
                    const km = await buscarKmDnit(alertData.location[1], alertData.location[0]);
                    console.log("Resultado da busca KM:", km);
                    $('#modalKm').text(typeof km === 'number' ? `KM ${km.toFixed(2)}` : 'Não encontrado');
                } catch (error) {
                    console.error("Erro ao buscar KM:", error);
                    $('#modalKm').text('Erro na busca').addClass('text-danger');
                }

                // 7. Atualizar tooltips após carregamento
                $('[data-toggle="tooltip"]').tooltip('dispose').tooltip();

            } catch (error) {
                console.error('Erro ao cargar dados do alerta:', error);
                $('#alertModal').modal('hide');
                alert('Erro ao carregar detalhes do alerta');
            }
        });

        // Inicialização do DataTables
        $('.table').DataTable({
            // Sua configuração do DataTables
        });
    });

</script>
{% endblock %}