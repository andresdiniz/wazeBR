
{% block stylesheets %}
<link rel="stylesheet" href="https://cdn.datatables.net/1.12.1/css/jquery.dataTables.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.2.3/css/buttons.dataTables.min.css">
<style>
    .card-header {
        background-color: #f8f9fa;
    }
    .dataTables_wrapper {
        padding: 20px 0;
    }
    .alert-date {
        min-width: 120px;
    }
    .map-container {
        height: 400px;
        width: 100%;
        border-radius: 8px;
        border: 1px solid #dee2e6;
    }
    .badge-status {
        font-size: 0.9em;
        padding: 0.5em 0.75em;
    }

    .tooltip-inner {
        max-width: 300px;
        background-color: #333;
    }
    .dataTables_wrapper .btn {
        padding: 0.25rem 0.5rem;
        font-size: 0.875rem;
    }
    .table-hover tbody tr:hover {
        background-color: #f8f9fa;
        cursor: pointer;
    }

</style>
{% endblock %}

{% block body %}
<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard de Alertas</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 text-gray-800">
  <div class="container mx-auto p-4 space-y-6">
    <!-- M√©tricas do topo -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
      <div class="bg-white shadow rounded p-4 text-center">
        <p class="text-sm text-blue-500">Alertas Ativos (Hoje)</p>
        <p class="text-2xl font-bold">{{ activeAlertsToday }}</p>
      </div>
      <div class="bg-white shadow rounded p-4 text-center">
        <p class="text-sm text-green-500">Alertas Este M√™s</p>
        <p class="text-2xl font-bold">{{ totalAlertsThisMonth }}</p>
      </div>
      <div class="bg-white shadow rounded p-4 text-center">
        <p class="text-sm text-cyan-500">KM Congestionados</p>
        <p class="text-2xl font-bold">{{ traficdata.total_kms_lento }} km</p>
      </div>
      <div class="bg-white shadow rounded p-4 text-center">
        <p class="text-sm text-yellow-500">Atraso Total</p>
        <p class="text-2xl font-bold">{{ traficdata.total_atraso_minutos }} min</p>
      </div>
    </div>

    <!-- Alertas -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <!-- Acidentes Recentes -->
      <div class="bg-white shadow rounded p-4">
        <h2 class="text-lg font-semibold mb-2">Acidentes Recentes</h2>
        {% if accidentAlerts is empty %}
          <p class="text-sm text-gray-500">Nenhum acidente registrado recentemente</p>
        {% else %}
          <!-- Lista de acidentes -->
        {% endif %}
      </div>

      <!-- Congestionamentos Recentes -->
      <div class="bg-white shadow rounded p-4">
        <h2 class="text-lg font-semibold mb-2">Congestionamentos Recentes</h2>
        {% if jamAlerts is empty %}
          <p class="text-sm text-gray-500">Nenhum congestionamento registrado recentemente</p>
        {% else %}
          <!-- Lista de congestionamentos -->
        {% endif %}
      </div>
    </div>

    <!-- Tabelas Detalhadas -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <!-- Buracos Recentes -->
      <div class="bg-white shadow rounded p-4 overflow-auto">
        <h2 class="text-lg font-semibold mb-4">Buracos Recentes</h2>
        <table class="min-w-full text-sm">
          <thead>
            <tr>
              <th class="text-left">Cidade</th>
              <th class="text-left">Rua</th>
              <th class="text-left">Data</th>
              <th class="text-left">Confian√ßa</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            {% for alert in hazardAlerts %}
              <tr class="border-t">
                <td>{{ alert.city }}</td>
                <td>{{ alert.street }}</td>
                <td>{{ alert.pubMillis|date("d/m/Y") }}</td>
                <td>{{ alert.confidence }}</td>
                <td><a href="#" class="text-blue-500 hover:underline">Detalhes</a></td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <!-- Outros Alertas Recentes -->
      <div class="bg-white shadow rounded p-4 overflow-auto">
        <h2 class="text-lg font-semibold mb-4">Outros Alertas Recentes</h2>
        <table class="min-w-full text-sm">
          <thead>
            <tr>
              <th class="text-left">Cidade</th>
              <th class="text-left">Rua</th>
              <th class="text-left">Data</th>
              <th class="text-left">Confian√ßa</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            {% for alert in otherAlerts %}
              <tr class="border-t">
                <td>{{ alert.city }}</td>
                <td>{{ alert.street }}</td>
                <td>{{ alert.pubMillis|date("d/m/Y") }}</td>
                <td>{{ alert.confidence }}</td>
                <td><a href="#" class="text-blue-500 hover:underline">Detalhes</a></td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</body>
</html>


<!-- Modal √önico -->
<div class="modal fade" id="alertModal" tabindex="-1" aria-labelledby="alertModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content p-3 shadow-lg rounded">
            <div class="modal-header bg-primary text-white rounded-top">
                <h5 class="modal-title">
                    <i class="fas fa-exclamation-triangle"></i> Detalhes do Evento
                </h5>
                <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>

            <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                <div class="row">
                    <div class="col-md-6">
                        <div class="card border-0 shadow-sm p-3 mb-3">
                            <p><strong>üìå UUID:</strong> <span id="modalUuid"></span></p>
                            <p><strong>üèôÔ∏è Cidade:</strong> <span id="modalCity"></span></p>
                            <p><strong>üìç Rua:</strong> <span id="modalStreet"></span></p>
                            <p><strong>üì° Localiza√ß√£o:</strong> <span id="modalLocation"></span></p>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="alert-details">
                            <p><strong>üìÖ Data:</strong> <span id="modalDate"></span></p>
                            <p><strong>üõ£Ô∏è KM Estimado:</strong> <span id="modalKm" class="badge bg-info"></span></p>
                            <p><strong>üîç Confian√ßa:</strong> <span id="modalConfidence" class="badge"></span></p>
                            <p><strong>‚ö†Ô∏è Status:</strong> <span id="modalStatus" class="badge"></span></p>
                            <p><strong>üîó Link:</strong> <a id="modalPartnerLink" class="badge bg-primary" target="_blank">Partner Hub</a></p>
                        </div>
                    </div>
                </div>

                <div class="card border-0 shadow-sm p-3 mb-3">
                    <p><strong>üö® Tipo:</strong> <span id="modalType"></span></p>
                    <p><strong>üìå Subtipo:</strong> <span id="modalSubtype"></span></p>
                </div>

                <div class="card border-0 shadow-sm p-3">
                    <h6 class="text-center text-muted">üìç Localiza√ß√£o no Mapa</h6>
                    <div id="mapContainer" class="map-container"></div>
                </div>
            </div>

            <div class="modal-footer d-flex justify-content-between">
                <a id="modalWazeLink" class="btn btn-outline-primary" target="_blank">
                    <i class="fab fa-waze"></i> Ver no Waze
                </a>
                <button type="button" class="btn btn-secondary" data-dismiss="modal">
                    <i class="fas fa-times"></i> Fechar
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}


{% block javascripts %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.12.1/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.2.3/js/dataTables.buttons.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"></script>
<script src="https://cdn.datatables.net/buttons/2.2.3/js/buttons.html5.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/leaflet@1.7.1/dist/leaflet.js"></script>

<script>
    document.addEventListener("DOMContentLoaded", function() {    
        // Tooltips
    $('[data-toggle="tooltip"]').tooltip({
        trigger: 'hover',
        placement: 'top'
    });
        // Delegar evento para elementos din√¢micos
        $(document).on('click', '.open-modal', function() {
            const raw = $(this).attr('data-alert'); // Use $(this) para referenciar o bot√£o clicado
            console.log('Raw:', raw);
            let alertData;
            locale = "PT-BR";
            try {
                alertData = JSON.parse(raw);
                console.log('Parsed alertData:', alertData);
            } catch (e) {
                console.error("Erro ao parsear alertData:", e);
                return;
            }
            
            console.log(document.getElementById('modalUuid')); // Deve retornar um elemento, n√£o null
            // Atualizar iframe do Waze
            const wazeFrame = document.getElementById('mapContainer');
            const src = `https://embed.waze.com/iframe?zoom=16&lat=${alertData.location_y}&lon=${alertData.location_x}&pin=1`;  
            
            console.log('Waze Frame Source:', src); // Verifique se o src est√° correto
            wazeFrame.innerHTML = ''; // Limpar conte√∫do anterior
            wazeFrame.src = src;
    
            // Preencher dados b√°sicos
            $('#modalUuid').text(alertData.uuid);
            console.log('UUID inserido no modal:', $('#modalUuid').text());
            $('#modalCity').text(alertData.city || 'N√£o informada');
            $('#modalStreet').text(alertData.street || 'N√£o informada');
            $('#modalLocation').text(`${alertData.location_x}, ${alertData.location_y}`);
            $('#modalDate').text(new Date(alertData.pubMillis).toLocaleString('pt-BR'));
            $('#modalType').text(alertData.type);
            $('#modalSubtype').text(alertData.subtype || 'N/A');
    
            // Configurar links
            $('#modalPartnerLink').attr({
                href: `https://www.waze.com/partnerhub/map-tool/alerts?cardType=3&cardId=${alertData.uuid}`,
                title: "Abrir no Partner Hub"
            });
            
            $('#modalWazeLink').attr({
                href: `https://www.waze.com/ul?ll=${alertData.location_y},${alertData.location_x}`,
                title: "Abrir no Waze"
            });
    
            // Status e Confian√ßa
            const status = alertData.status !== null ? alertData.status : 0;
            $('#modalStatus')
                .text(status === 1 ? "Ativo" : "Inativo")
                .removeClass()
                .addClass(`badge bg-${status === 1 ? 'success' : 'danger'}`);
    
            const confidence = alertData.confidence || 0;
            $('#modalConfidence')
                .text(`${confidence}%`)
                .removeClass()
                .addClass(`badge bg-${
                    confidence > 4 ? 'success' : 
                    confidence > 2 ? 'warning' : 'danger'
                }`);
    
            // Buscar KM (mantido se necess√°rio para outros elementos)
            $('#modalKm').html('<span class="spinner-border spinner-border-sm"></span> Calculando...');
            if(typeof buscarKmDnit === 'function') {
                buscarKmDnit(alertData.location_y, alertData.location_x)
                    .then(km => $('#modalKm').text(km ? `KM ${km}` : "N√£o encontrado"))
                    .catch(() => $('#modalKm').html('<span class="text-danger">Erro na busca</span>'));
            }

            const mapContainer = document.getElementById('mapContainer');
            mapContainer.innerHTML = ''; // Limpa conte√∫do anterior
            
            // Cria novo iframe
            const iframe = document.createElement('iframe');
            iframe.setAttribute('src', src);
            iframe.style.width = '100%';
            iframe.style.height = '400px';
            iframe.style.border = '0';
            iframe.loading = 'lazy';
            mapContainer.appendChild(iframe);
        });
    
        // Resetar ao fechar modal
    $('#alertModal').on('hidden.bs.modal', function() {
        $('#modalUuid').text('');
        $('#modalCity').text('');
        $('#modalStreet').text('');
        $('#modalLocation').text('');
        $('#modalDate').text('');
        $('#modalType').text('');
        $('#modalSubtype').text('N/A'); // Ou o valor padr√£o que voc√™ deseja
        $('#modalConfidence').text('').removeClass();
        $('#modalStatus').text('').removeClass();
        $('#modalKm').text('');
        $('#modalPartnerLink').attr('href', '#').removeAttr('title'); // Resetar link
        $('#modalWazeLink').attr('href', '#').removeAttr('title');     // Resetar link

        // Limpar o iframe do mapa tamb√©m (opcional, mas pode ser √∫til)
        const mapContainer = document.getElementById('mapContainer');
        mapContainer.innerHTML = '';
    });
    });
</script>

<script src="./js/scripts.js"></script>
{% endblock %}