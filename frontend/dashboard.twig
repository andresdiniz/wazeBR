
{% block stylesheets %}
<link rel="stylesheet" href="https://cdn.datatables.net/1.12.1/css/jquery.dataTables.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.2.3/css/buttons.dataTables.min.css">
<style>
    .card-header {
        background-color: #f8f9fa;
    }
    .dataTables_wrapper {
        padding: 20px 0;
    }
    .alert-date {
        min-width: 120px;
    }
    .map-container {
        height: 400px;
        width: 100%;
        border-radius: 8px;
        border: 1px solid #dee2e6;
    }
    .badge-status {
        font-size: 0.9em;
        padding: 0.5em 0.75em;
    }
</style>
{% endblock %}

{% block body %}
<div class="container-fluid">

    <!-- Page Heading -->
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-gray-800">Dashboard de Alertas</h1>
        <a href="#" class="d-none d-sm-inline-block btn btn-sm btn-primary shadow-sm">
            <i class="fas fa-download fa-sm text-white-50"></i> Exportar Dados
        </a>
    </div>

    <!-- Metrics Row -->
    <div class="row">
        <!-- Cards de M√©tricas -->
        <div class="col-lg-3 col-md-6 mb-4">
            <div class="card border-left-primary shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                Alertas Ativos (Hoje)
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ activeAlertsToday }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-bell fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-3 col-md-6 mb-4">
            <div class="card border-left-success shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                Alertas Este M√™s
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ totalAlertsThisMonth }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-calendar-alt fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-3 col-md-6 mb-4">
            <div class="card border-left-info shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                                KM Congestionados
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ traficdata.total_kms_lento }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-road fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-3 col-md-6 mb-4">
            <div class="card border-left-warning shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                Atraso Total
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ traficdata.total_atraso_minutos }} min</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-clock fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabelas de Alertas -->
    <div class="row">
        <!-- Tabela de Acidentes -->
        <div class="col-xl-6 col-lg-6">
            <div class="card shadow mb-4">
                <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                    <h6 class="m-0 font-weight-bold text-primary">Acidentes Recentes</h6>
                </div>
                <div class="card-body">
                    {% if accidentAlerts is not empty %}
                    <table class="table table-bordered table-hover" id="accidentsTable">
                        <thead>
                            <tr>
                                <th>Cidade</th>
                                <th>Rua</th>
                                <th>Localiza√ß√£o</th>
                                <th>Data</th>
                                <th>Confian√ßa</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for alert in accidentAlerts %}
                            <tr>
                                <td>{{ alert.city }}</td>
                                <td>{{ alert.street }}</td>
                                <td>
                                    <a href="https://www.waze.com/ul?ll={{ alert.location_y }},{{ alert.location_x }}" 
                                       target="_blank" 
                                       class="text-primary">
                                        {{ alert.location_x|number_format(5) }}, {{ alert.location_y|number_format(5) }}
                                    </a>
                                </td>
                                <td class="alert-date">{{ (alert.pubMillis/1000)|date('d/m/Y H:i') }}</td>
                                <td>
                                    <span class="badge badge-{{ alert.confidence > 7 ? 'success' : alert.confidence > 4 ? 'warning' : 'danger' }}">
                                        {{ alert.confidence }}%
                                    </span>
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-info open-modal" 
                                            data-toggle="modal" 
                                            data-target="#alertModal"
                                            data-alert="{{ {
                                                'uuid': alert.uuid,
                                                'city': alert.city,
                                                'street': alert.street,
                                                'location_x': alert.location_x,
                                                'location_y': alert.location_y,
                                                'pubMillis': alert.pubMillis,
                                                'type': alert.type,
                                                'subtype': alert.subtype,
                                                'confidence': alert.confidence,
                                                'status': alert.status
                                            }|json_encode|e('html_attr') }}">
                                        <i class="fas fa-info-circle"></i> Detalhes
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    {% else %}
                    <div class="alert alert-info">Nenhum acidente registrado recentemente</div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Tabela de Congestionamentos -->
        <div class="col-xl-6 col-lg-6">
            <div class="card shadow mb-4">
                <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                    <h6 class="m-0 font-weight-bold text-primary">Congestionamentos Recentes</h6>
                </div>
                <div class="card-body">
                    {% if jamAlerts is not empty %}
                    <table class="table table-bordered table-hover" id="jamsTable">
                        <thead>
                            <tr>
                                <th>Cidade</th>
                                <th>Rua</th>
                                <th>Localiza√ß√£o</th>
                                <th>Data</th>
                                <th>Confian√ßa</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for jam_alert in jamAlerts %}
                            <tr>
                                <td>{{ jam_alert.city }}</td>
                                <td>{{ jam_alert.street }}</td>
                                <td>
                                    <a href="https://www.waze.com/ul?ll={{ jam_alert.location_y }},{{ jam_alert.location_x }}" 
                                    target="_blank" 
                                    class="text-primary">
                                        {{ jam_alert.location_x|number_format(5) }}, {{ jam_alert.location_y|number_format(5) }}
                                    </a>
                                </td>
                                <td class="alert-date">{{ (jam_alert.pubMillis/1000)|date('d/m/Y H:i') }}</td>
                                <td>
                                    <span class="badge badge-{{ jam_alert.confidence > 7 ? 'success' : jam_alert.confidence > 4 ? 'warning' : 'danger' }}">
                                        {{ jam_alert.confidence }}%
                                    </span>
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-info open-modal" 
                                            data-toggle="modal" 
                                            data-target="#alertModal"
                                            data-alert="{{ {
                                                'uuid': jam_alert.uuid,
                                                'city': jam_alert.city,
                                                'street': jam_alert.street,
                                                'location_x': jam_alert.location_x,
                                                'location_y': jam_alert.location_y,
                                                'pubMillis': jam_alert.pubMillis,
                                                'type': jam_alert.type,
                                                'confidence': jam_alert.confidence,
                                                'status': jam_alert.status
                                            }|json_encode|e('html_attr') }}">
                                        <i class="fas fa-info-circle"></i> Detalhes
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    {% else %}
                    <div class="alert alert-info">Nenhum congestionamento registrado recentemente</div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Tabela de Buracos -->
        <div class="col-xl-6 col-lg-6">
            <div class="card shadow mb-4">
                <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                    <h6 class="m-0 font-weight-bold text-primary">Buracos Recentes</h6>
                </div>
                <div class="card-body">
                    {% if hazardAlerts is not empty %}
                    <table class="table table-bordered table-hover" id="jamsTable">
                        <thead>
                            <tr>
                                <th>Cidade</th>
                                <th>Rua</th>
                                <th>Localiza√ß√£o</th>
                                <th>Data</th>
                                <th>Confian√ßa</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for pothole_alerts in hazardAlerts %}
                            <tr>
                                <td>{{ pothole_alerts.city }}</td>
                                <td>{{ pothole_alerts.street }}</td>
                                <td>
                                    <a href="https://www.waze.com/ul?ll={{ pothole_alerts.location_y }},{{ pothole_alerts.location_x }}" 
                                    target="_blank" 
                                    class="text-primary">
                                        {{ pothole_alerts.location_x|number_format(5) }}, {{ pothole_alerts.location_y|number_format(5) }}
                                    </a>
                                </td>
                                <td class="alert-date">{{ (pothole_alerts.pubMillis/1000)|date('d/m/Y H:i') }}</td>
                                <td>
                                    <span class="badge badge-{{ pothole_alerts.confidence > 7 ? 'success' : pothole_alerts.confidence > 4 ? 'warning' : 'danger' }}">
                                        {{ pothole_alerts.confidence }}%
                                    </span>
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-info open-modal" 
                                            data-toggle="modal" 
                                            data-target="#alertModal"
                                            data-alert="{{ {
                                                'uuid': pothole_alerts.uuid,
                                                'city': pothole_alerts.city,
                                                'street': pothole_alerts.street,
                                                'location_x': pothole_alerts.location_x,
                                                'location_y': pothole_alerts.location_y,
                                                'pubMillis': pothole_alerts.pubMillis,
                                                'type': pothole_alerts.type,
                                                'confidence': pothole_alerts.confidence,
                                                'status': pothole_alerts.status
                                            }|json_encode|e('html_attr') }}">
                                        <i class="fas fa-info-circle"></i> Detalhes
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    {% else %}
                    <div class="alert alert-info">Nenhum buraco registrado</div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Tabela de Outros Alertas -->
        <div class="col-xl-6 col-lg-6">
            <div class="card shadow mb-4">
                <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                    <h6 class="m-0 font-weight-bold text-primary">Outros Alertas Recentes</h6>
                </div>
                <div class="card-body">
                    {% if otherAlerts is not empty %}
                    <table class="table table-bordered table-hover" id="jamsTable">
                        <thead>
                            <tr>
                                <th>Cidade</th>
                                <th>Rua</th>
                                <th>Localiza√ß√£o</th>
                                <th>Data</th>
                                <th>Confian√ßa</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for orther_alerts in otherAlerts %}
                            <tr>
                                <td>{{ orther_alerts.city }}</td>
                                <td>{{ orther_alerts.street }}</td>
                                <td>
                                    <a href="https://www.waze.com/ul?ll={{ orther_alerts.location_y }},{{ orther_alerts.location_x }}" 
                                    target="_blank" 
                                    class="text-primary">
                                        {{ orther_alerts.location_x|number_format(5) }}, {{ orther_alerts.location_y|number_format(5) }}
                                    </a>
                                </td>
                                <td class="alert-date">{{ (orther_alerts.pubMillis/1000)|date('d/m/Y H:i') }}</td>
                                <td>
                                    <span class="badge badge-{{ orther_alerts.confidence > 7 ? 'success' : orther_alerts.confidence > 4 ? 'warning' : 'danger' }}">
                                        {{ orther_alerts.confidence }}%
                                    </span>
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-info open-modal" 
                                            data-toggle="modal" 
                                            data-target="#alertModal"
                                            data-alert="{{ {
                                                'uuid': orther_alerts.uuid,
                                                'city': orther_alerts.city,
                                                'street': orther_alerts.street,
                                                'location_x': orther_alerts.location_x,
                                                'location_y': orther_alerts.location_y,
                                                'pubMillis': orther_alerts.pubMillis,
                                                'type': orther_alerts.type,
                                                'confidence': orther_alerts.confidence,
                                                'status': orther_alerts.status
                                            }|json_encode|e('html_attr') }}">
                                        <i class="fas fa-info-circle"></i> Detalhes
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    {% else %}
                    <div class="alert alert-info">Nenhum buraco registrado</div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Repetir estrutura para outras tabelas (Buracos, Congestionamentos, Outros Alertas) -->
        <!-- ... -->

    </div>
</div>

<!-- Modal √önico -->
<div class="modal fade" id="alertModal" tabindex="-1" aria-labelledby="alertModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content p-3 shadow-lg rounded">
            <div class="modal-header bg-primary text-white rounded-top">
                <h5 class="modal-title">
                    <i class="fas fa-exclamation-triangle"></i> Detalhes do Evento
                </h5>
                <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>

            <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                <div class="row">
                    <div class="col-md-6">
                        <div class="card border-0 shadow-sm p-3 mb-3">
                            <p><strong>üìå UUID:</strong> <span id="modalUuid"></span></p>
                            <p><strong>üèôÔ∏è Cidade:</strong> <span id="modalCity"></span></p>
                            <p><strong>üìç Rua:</strong> <span id="modalStreet"></span></p>
                            <p><strong>üì° Localiza√ß√£o:</strong> <span id="modalLocation"></span></p>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="alert-details">
                            <p><strong>üìÖ Data:</strong> <span id="modalDate"></span></p>
                            <p><strong>üõ£Ô∏è KM Estimado:</strong> <span id="modalKm" class="badge bg-info"></span></p>
                            <p><strong>üîç Confian√ßa:</strong> <span id="modalConfidence" class="badge"></span></p>
                            <p><strong>‚ö†Ô∏è Status:</strong> <span id="modalStatus" class="badge"></span></p>
                            <p><strong>üîó Link:</strong> <a id="modalPartnerLink" class="badge bg-primary" target="_blank">Partner Hub</a></p>
                        </div>
                    </div>
                </div>

                <div class="card border-0 shadow-sm p-3 mb-3">
                    <p><strong>üö® Tipo:</strong> <span id="modalType"></span></p>
                    <p><strong>üìå Subtipo:</strong> <span id="modalSubtype"></span></p>
                </div>

                <div class="card border-0 shadow-sm p-3">
                    <h6 class="text-center text-muted">üìç Localiza√ß√£o no Mapa</h6>
                    <div id="mapContainer" class="map-container"></div>
                </div>
            </div>

            <div class="modal-footer d-flex justify-content-between">
                <a id="modalWazeLink" class="btn btn-outline-primary" target="_blank">
                    <i class="fab fa-waze"></i> Ver no Waze
                </a>
                <button type="button" class="btn btn-secondary" data-dismiss="modal">
                    <i class="fas fa-times"></i> Fechar
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block javascripts %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.12.1/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.2.3/js/dataTables.buttons.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"></script>
<script src="https://cdn.datatables.net/buttons/2.2.3/js/buttons.html5.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/leaflet@1.7.1/dist/leaflet.js"></script>

<script>
    document.addEventListener("DOMContentLoaded", function() {    
        // Delegar evento para elementos din√¢micos
        $(document).on('click', '.open-modal', function() {
            const alertData = JSON.parse($(this).data('alert'));
            console.log(alertData);
            const locale = 'pt'; // Altere conforme necess√°rio (pt-BR, en-US, etc)
            
            // Atualizar iframe do Waze
            const wazeFrame = document.getElementById('wazeMapIframe');
            const src = `https://embed.waze.com/${locale}/iframe?zoom=16` +
                        `&lat=${alertData.location_x}` +
                        `&lon=${alertData.location_y}` +
                        `&pin=1` +
                        `&campaign=alerts_${alertData.uuid}` +
                        `&vehicle=car` +
                        `&hidegeopins=false` +
                        `&timestamp=${alertData.pubMillis}`;
            
            wazeFrame.src = src;
    
            // Preencher dados b√°sicos
            $('#modalUuid').text(alertData.uuid);
            $('#modalCity').text(alertData.city || 'N√£o informada');
            $('#modalStreet').text(alertData.street || 'N√£o informada');
            $('#modalLocation').text(`${alertData.location_x}, ${alertData.location_y}`);
            $('#modalDate').text(new Date(alertData.pubMillis).toLocaleString('pt-BR'));
            $('#modalType').text(alertData.type);
            $('#modalSubtype').text(alertData.subtype || 'N/A');
    
            // Configurar links
            $('#modalPartnerLink').attr({
                href: `https://www.waze.com/partnerhub/map-tool/alerts?cardType=3&cardId=${alertData.uuid}`,
                title: "Abrir no Partner Hub"
            });
            
            $('#modalWazeLink').attr({
                href: `https://www.waze.com/ul?ll=${alertData.location_x},${alertData.location_y}`,
                title: "Abrir no Waze"
            });
    
            // Status e Confian√ßa
            const status = alertData.status !== null ? alertData.status : 0;
            $('#modalStatus')
                .text(status === 1 ? "Ativo" : "Inativo")
                .removeClass()
                .addClass(`badge bg-${status === 1 ? 'success' : 'danger'}`);
    
            const confidence = alertData.confidence || 0;
            $('#modalConfidence')
                .text(`${confidence}%`)
                .removeClass()
                .addClass(`badge bg-${
                    confidence > 7 ? 'success' : 
                    confidence > 4 ? 'warning' : 'danger'
                }`);
    
            // Buscar KM (mantido se necess√°rio para outros elementos)
            $('#modalKm').html('<span class="spinner-border spinner-border-sm"></span> Calculando...');
            if(typeof buscarKmDnit === 'function') {
                buscarKmDnit(alertData.location_x, alertData.location_y)
                    .then(km => $('#modalKm').text(km ? `KM ${km}` : "N√£o encontrado"))
                    .catch(() => $('#modalKm').html('<span class="text-danger">Erro na busca</span>'));
            }
        });
    
        // Resetar ao fechar modal
        $('#alertModal').on('hidden.bs.modal', function() {
            $('#modalKm').text('');
            $('#modalConfidence, #modalStatus').removeClass();
        });
    });
</script>

<script src="./js/scripts.js"></script>
{% endblock %}