
{% block stylesheets %}
<link rel="stylesheet" href="https://cdn.datatables.net/1.12.1/css/jquery.dataTables.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.2.3/css/buttons.dataTables.min.css">
<style>
    /* Your existing custom styles */
Â  Â  .card-header {
Â  Â  Â  Â  background-color: #f8f9fa;
Â  Â  Â  Â  border-bottom: 1px solid #e3e6f0;
Â  Â  }
Â  Â  .dataTables_wrapper {
Â  Â  Â  Â  padding: 20px 0;
Â  Â  }
Â  Â  .alert-date {
Â  Â  Â  Â  min-width: 120px; /* Ensure date column has minimum width */
Â  Â  }
Â  Â  .map-container {
Â  Â  Â  Â  height: 400px;
Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  border-radius: 8px;
Â  Â  Â  Â  border: 1px solid #dee2e6;
Â  Â  Â  Â  overflow: hidden; /* Ensure map stays within bounds */
Â  Â  }
Â  Â  .badge-status {
Â  Â  Â  Â  font-size: 0.9em;
Â  Â  Â  Â  padding: 0.5em 0.75em;
Â  Â  }

Â  Â  .tooltip-inner {
Â  Â  Â  Â  max-width: 300px;
Â  Â  Â  Â  background-color: #333;
Â  Â  Â  Â  color: #fff;
Â  Â  }
Â  Â  .dataTables_wrapper .btn {
Â  Â  Â  Â  padding: 0.25rem 0.5rem;
Â  Â  Â  Â  font-size: 0.875rem;
Â  Â  }
Â  Â  .table-hover tbody tr:hover {
Â  Â  Â  Â  background-color: #f8f9fa;
Â  Â  }
Â  Â  .modal-header {
Â  Â  Â  Â  border-bottom: none; /* Remove default border */
Â  Â  }
Â  Â  .modal-body {
Â  Â  Â  Â  padding-top: 0; /* Adjust padding */
Â  Â  }
Â  Â  .modal-footer {
Â  Â  Â  Â  border-top: none; /* Remove default border */
Â  Â  }
Â  Â  .alert-details p {
Â  Â  Â  Â  margin-bottom: 0.5rem; /* Smaller margin for details */
Â  Â  }

    /* Custom style for Street View button */
    .btn-streetview {
Â  Â  Â  Â  color: #fff;
Â  Â  Â  Â  background-color: #fbbc05; /* Google yellow */
Â  Â  Â  Â  border-color: #fbbc05;
Â  Â  }
Â  Â  .btn-streetview:hover {
Â  Â  Â  Â  color: #fff;
Â  Â  Â  Â  background-color: #e0a800;
Â  Â  Â  Â  border-color: #d39e00;
Â  Â  }
Â  Â  .btn-streetview:focus, .btn-streetview.focus {
Â  Â  Â  Â  box-shadow: 0 0 0 0.2rem rgba(222, 167, 12,.5);
Â  Â  }
Â  Â  .btn-streetview.disabled, .btn-streetview:disabled {
Â  Â  Â  Â  color: #fff;
Â  Â  Â  Â  background-color: #fbbc05;
Â  Â  Â  Â  border-color: #fbbc05;
        opacity: 0.65; /* Standard disabled look */
Â  Â  }

    .card-header {
        background-color: #f8f9fa;
    }
    .dataTables_wrapper {
        padding: 20px 0;
    }
    .alert-date {
        min-width: 120px;
    }
    .map-container {
        height: 400px;
        width: 100%;
        border-radius: 8px;
        border: 1px solid #dee2e6;
    }
    .badge-status {
        font-size: 0.9em;
        padding: 0.5em 0.75em;
    }

    .tooltip-inner {
        max-width: 300px;
        background-color: #333;
    }
    .dataTables_wrapper .btn {
        padding: 0.25rem 0.5rem;
        font-size: 0.875rem;
    }
    .table-hover tbody tr:hover {
        background-color: #f8f9fa;
        cursor: pointer;
    }

</style>
{% endblock %}

{% block body %}
<div class="container-fluid">

    <!-- Page Heading -->
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-gray-800">Dashboard de Alertas</h1>
        <a href="#" class="d-none d-sm-inline-block btn btn-sm btn-primary shadow-sm">
            <i class="fas fa-download fa-sm text-white-50"></i> Exportar Dados
        </a>
    </div>

    <!-- Metrics Row -->
    <div class="row">
        <!-- Cards de MÃ©tricas -->
        <div class="col-lg-3 col-md-6 mb-4">
            <div class="card border-left-primary shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                Alertas Ativos (Hoje)
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ activeAlertsToday }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-bell fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-3 col-md-6 mb-4">
            <div class="card border-left-success shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                Alertas Este MÃªs
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ totalAlertsThisMonth }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-calendar-alt fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-3 col-md-6 mb-4">
            <div class="card border-left-info shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                                KM Congestionados
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ traficdata.total_kms_lento }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-road fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-3 col-md-6 mb-4">
            <div class="card border-left-warning shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                Atraso Total
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ traficdata.total_atraso_minutos }} min</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-clock fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabelas de Alertas -->
    <div class="row">
        <!-- Tabela de Acidentes -->
        <div class="col-xl-6 col-lg-6">
            <div class="card shadow mb-4">
                <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                    <h6 class="m-0 font-weight-bold text-primary">Acidentes Recentes</h6>
                </div>
                <div class="card-body">
                    {% if accidentAlerts is not empty %}
                    <table class="table table-bordered table-hover" id="accidentsTable">
                        <thead>
                            <tr>
                                <th>Cidade</th>
                                <th>Rua</th>
                                <th>LocalizaÃ§Ã£o</th>
                                <th>Data</th>
                                <th>ConfianÃ§a</th>
                                <th>AÃ§Ãµes</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for alert in accidentAlerts %}
                            <tr>
                                <td>{{ alert.city }}</td>
                                <td>{{ alert.street }}</td>
                                <td>
                                    <a href="https://www.waze.com/ul?ll={{ alert.location_y }},{{ alert.location_x }}" 
                                       target="_blank" 
                                       class="text-primary">
                                        {{ alert.location_x|number_format(5) }}, {{ alert.location_y|number_format(5) }}
                                    </a>
                                </td>
                                <td class="alert-date">{{ (alert.pubMillis/1000)|date('d/m/Y H:i') }}</td>
                                <td>
                                    <span class="badge badge-{{ alert.confidence > 4 ? 'success' : alert.confidence > 2 ? 'warning' : 'danger' }}">
                                        {{ alert.confidence }}
                                    </span>
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-info open-modal" 
                                            data-toggle="modal" 
                                            data-target="#alertModal"
                                            data-alert="{{ {
                                                'uuid': alert.uuid,
                                                'city': alert.city,
                                                'street': alert.street,
                                                'location_x': alert.location_x,
                                                'location_y': alert.location_y,
                                                'pubMillis': alert.pubMillis,
                                                'type': alert.type,
                                                'subtype': alert.subtype,
                                                'confidence': alert.confidence,
                                                'status': alert.status
                                            }|json_encode|e('html_attr') }}">
                                        <i class="fas fa-info-circle"></i> Detalhes
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    {% else %}
                    <div class="alert alert-info">Nenhum acidente registrado recentemente</div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Tabela de Congestionamentos -->
        <div class="col-xl-6 col-lg-6">
            <div class="card shadow mb-4">
                <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                    <h6 class="m-0 font-weight-bold text-primary">Congestionamentos Recentes</h6>
                </div>
                <div class="card-body">
                    {% if jamAlerts is not empty %}
                    <table class="table table-bordered table-hover" id="jamsTable">
                        <thead>
                            <tr>
                                <th>Cidade</th>
                                <th>Rua</th>
                                <th>LocalizaÃ§Ã£o</th>
                                <th>Data</th>
                                <th>ConfianÃ§a</th>
                                <th>AÃ§Ãµes</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for jam_alert in jamAlerts %}
                            <tr>
                                <td>{{ jam_alert.city }}</td>
                                <td>{{ jam_alert.street }}</td>
                                <td>
                                    <a href="https://www.waze.com/ul?ll={{ jam_alert.location_y }},{{ jam_alert.location_x }}" 
                                    target="_blank" 
                                    class="text-primary">
                                        {{ jam_alert.location_x|number_format(5) }}, {{ jam_alert.location_y|number_format(5) }}
                                    </a>
                                </td>
                                <td class="alert-date">{{ (jam_alert.pubMillis/1000)|date('d/m/Y H:i') }}</td>
                                <td>
                                    <span class="badge badge-{{ jam_alert.confidence > 4 ? 'success' : jam_alert.confidence > 2 ? 'warning' : 'danger' }}">
                                        {{ jam_alert.confidence }}
                                    </span>
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-info open-modal" 
                                            data-toggle="modal" 
                                            data-target="#alertModal"
                                            data-alert="{{ {
                                                'uuid': jam_alert.uuid,
                                                'city': jam_alert.city,
                                                'street': jam_alert.street,
                                                'location_x': jam_alert.location_x,
                                                'location_y': jam_alert.location_y,
                                                'pubMillis': jam_alert.pubMillis,
                                                'type': jam_alert.type,
                                                'confidence': jam_alert.confidence,
                                                'status': jam_alert.status
                                            }|json_encode|e('html_attr') }}">
                                        <i class="fas fa-info-circle"></i> Detalhes
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    {% else %}
                    <div class="alert alert-info">Nenhum congestionamento registrado recentemente</div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Tabela de Buracos -->
        <div class="col-xl-6 col-lg-6">
            <div class="card shadow mb-4">
                <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                    <h6 class="m-0 font-weight-bold text-primary">Buracos Recentes</h6>
                </div>
                <div class="card-body">
                    {% if hazardAlerts is not empty %}
                    <table class="table table-bordered table-hover" id="jamsTable">
                        <thead>
                            <tr>
                                <th>Cidade</th>
                                <th>Rua</th>
                                <th>LocalizaÃ§Ã£o</th>
                                <th>Data</th>
                                <th>ConfianÃ§a</th>
                                <th>AÃ§Ãµes</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for pothole_alerts in hazardAlerts %}
                            <tr>
                                <td>{{ pothole_alerts.city }}</td>
                                <td>{{ pothole_alerts.street }}</td>
                                <td>
                                    <a href="https://www.waze.com/ul?ll={{ pothole_alerts.location_y }},{{ pothole_alerts.location_x }}" 
                                    target="_blank" 
                                    class="text-primary">
                                        {{ pothole_alerts.location_x|number_format(5) }}, {{ pothole_alerts.location_y|number_format(5) }}
                                    </a>
                                </td>
                                <td class="alert-date">{{ (pothole_alerts.pubMillis/1000)|date('d/m/Y H:i') }}</td>
                                <td>
                                    <span class="badge badge-{{ pothole_alerts.confidence > 4 ? 'success' : pothole_alerts.confidence > 2 ? 'warning' : 'danger' }}">
                                        {{ pothole_alerts.confidence }}
                                    </span>
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-info open-modal" 
                                            data-toggle="modal" 
                                            data-target="#alertModal"
                                            data-alert="{{ {
                                                'uuid': pothole_alerts.uuid,
                                                'city': pothole_alerts.city,
                                                'street': pothole_alerts.street,
                                                'location_x': pothole_alerts.location_x,
                                                'location_y': pothole_alerts.location_y,
                                                'pubMillis': pothole_alerts.pubMillis,
                                                'type': pothole_alerts.type,
                                                'confidence': pothole_alerts.confidence,
                                                'status': pothole_alerts.status
                                            }|json_encode|e('html_attr') }}">
                                        <i class="fas fa-info-circle"></i> Detalhes
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    {% else %}
                    <div class="alert alert-info">Nenhum buraco registrado</div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Tabela de Outros Alertas -->
        <div class="col-xl-6 col-lg-6">
            <div class="card shadow mb-4">
                <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                    <h6 class="m-0 font-weight-bold text-primary">Outros Alertas Recentes</h6>
                </div>
                <div class="card-body">
                    {% if otherAlerts is not empty %}
                    <table class="table table-bordered table-hover" id="jamsTable">
                        <thead>
                            <tr>
                                <th>Cidade</th>
                                <th>Rua</th>
                                <th>LocalizaÃ§Ã£o</th>
                                <th>Data</th>
                                <th>ConfianÃ§a</th>
                                <th>AÃ§Ãµes</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for orther_alerts in otherAlerts %}
                            <tr>
                                <td>{{ orther_alerts.city }}</td>
                                <td>{{ orther_alerts.street }}</td>
                                <td>
                                    <a href="https://www.waze.com/ul?ll={{ orther_alerts.location_y }},{{ orther_alerts.location_x }}" 
                                    target="_blank" 
                                    class="text-primary">
                                        {{ orther_alerts.location_x|number_format(5) }}, {{ orther_alerts.location_y|number_format(5) }}
                                    </a>
                                </td>
                                <td class="alert-date">{{ (orther_alerts.pubMillis/1000)|date('d/m/Y H:i') }}</td>
                                <td>
                                    <span class="badge badge-{{ orther_alerts.confidence > 4 ? 'success' : orther_alerts.confidence > 2 ? 'warning' : 'danger' }}">
                                        {{ orther_alerts.confidence }}
                                    </span>
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-info open-modal" 
                                        data-toggle="modal" 
                                        data-target="#alertModal"
                                        data-alert='{{ {
                                            "uuid": orther_alerts.uuid,
                                            "city": orther_alerts.city,
                                            "street": orther_alerts.street,
                                            "location_x": orther_alerts.location_x,
                                            "location_y": orther_alerts.location_y,
                                            "pubMillis": orther_alerts.pubMillis,
                                            "type": orther_alerts.type,
                                            "confidence": orther_alerts.confidence,
                                            "status": orther_alerts.status
                                        }|json_encode|e('js') }}'>
                                    <i class="fas fa-info-circle"></i> Detalhes
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    {% else %}
                    <div class="alert alert-info">Nenhum alerta registrado</div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Repetir estrutura para outras tabelas (Buracos, Congestionamentos, Outros Alertas) -->
        <!-- ... -->

    </div>
</div>

<!-- Modal Ãšnico -->
<div class="modal fade" id="alertModal" tabindex="-1" role="dialog" aria-labelledby="alertModalLabel" aria-hidden="true">
    Â  Â  <div class="modal-dialog modal-lg" role="document">
    Â  Â  Â  Â  <div class="modal-content p-3 shadow-lg rounded">
    Â  Â  Â  Â  Â  Â  <div class="modal-header bg-primary text-white rounded-top py-3 px-4">
    Â  Â  Â  Â  Â  Â  Â  Â  <h5 class="modal-title" id="alertModalLabel">
    Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <i class="fas fa-exclamation-triangle mr-2"></i> Detalhes do Evento
    Â  Â  Â  Â  Â  Â  Â  Â  </h5>
    Â  Â  Â  Â  Â  Â  Â  Â  <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
    Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span aria-hidden="true">&times;</span>
    Â  Â  Â  Â  Â  Â  Â  Â  </button>
    Â  Â  Â  Â  Â  Â  </div>
    
    Â  Â  Â  Â  Â  Â  <div class="modal-body px-4" style="max-height: 70vh; overflow-y: auto;">
    Â  Â  Â  Â  Â  Â  Â  Â  <div class="row">
    Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="col-md-6">
    Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="card border-0 shadow-sm p-3 mb-3">
    Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h6 class="text-primary mb-3">InformaÃ§Ãµes Gerais</h6>
    Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p><strong>ğŸ“Œ UUID:</strong> <span id="modalUuid"></span></p>
    Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p><strong>ğŸ™ï¸ Cidade:</strong> <span id="modalCity"></span></p>
    Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p><strong>ğŸ“ Rua:</strong> <span id="modalStreet"></span></p>
    Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p><strong>ğŸ“¡ LocalizaÃ§Ã£o:</strong> <span id="modalLocation"></span></p>
    Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
    Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
    
    Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="col-md-6">
    Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="card border-0 shadow-sm p-3 mb-3">
    Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h6 class="text-primary mb-3">Detalhes do Alerta</h6>
    Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p><strong>ğŸ“… Data:</strong> <span id="modalDate"></span></p>
    Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p><strong>ğŸ›£ï¸ KM Estimado:</strong> <span id="modalKm" class="badge bg-secondary"></span></p>
    Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p><strong>ğŸ” ConfianÃ§a:</strong> <span id="modalConfidence" class="badge"></span></p>
    Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p><strong>âš ï¸ Status:</strong> <span id="modalStatus" class="badge"></span></p>
    Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p><strong>ğŸ”— Link Partner Hub:</strong> <a id="modalPartnerLink" class="badge bg-primary" target="_blank" rel="noopener noreferrer">Abrir</a></p>
    Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
    Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
    Â  Â  Â  Â  Â  Â  Â  Â  </div>
    
    Â  Â  Â  Â  Â  Â  Â  Â  <div class="card border-0 shadow-sm p-3 mb-3">
    Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h6 class="text-primary mb-3">ClassificaÃ§Ã£o</h6>
    Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p><strong>ğŸš¨ Tipo:</strong> <span id="modalType"></span></p>
    Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p><strong>ğŸ“Œ Subtipo:</strong> <span id="modalSubtype"></span></p>
    Â  Â  Â  Â  Â  Â  Â  Â  </div>
    
    Â  Â  Â  Â  Â  Â  Â  Â  <div class="card border-0 shadow-sm p-3">
    Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h6 class="text-center text-muted mb-3">ğŸ“ LocalizaÃ§Ã£o no Mapa (Waze)</h6>
    Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="mapContainer" class="map-container">
    Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
    Â  Â  Â  Â  Â  Â  Â  Â  </div>
    Â  Â  Â  Â  Â  Â  </div>
    
    Â  Â  Â  Â  Â  Â  <div class="modal-footer d-flex justify-content-between px-4 py-3">
    Â  Â  Â  Â  Â  Â  Â  Â  <div class="d-flex"> {# Grouping buttons #}
    Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <a id="modalWazeLink" class="btn btn-outline-primary mr-2" target="_blank" rel="noopener noreferrer">
    Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <i class="fab fa-waze mr-1"></i> Ver no Waze
    Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </a>
    Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  {# Added Street View Link Here #}
    Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <a id="modalStreetViewLink" class="btn btn-streetview" target="_blank" rel="noopener noreferrer">
    Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <i class="fas fa-street-view mr-1"></i> Street View
    Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </a>
    Â  Â  Â  Â  Â  Â  Â  Â  </div>
    Â  Â  Â  Â  Â  Â  Â  Â  <button type="button" class="btn btn-secondary" data-dismiss="modal">
    Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <i class="fas fa-times mr-1"></i> Fechar
    Â  Â  Â  Â  Â  Â  Â  Â  </button>
    Â  Â  Â  Â  Â  Â  </div>
    Â  Â  Â  Â  </div>
    Â  Â  Â </div>
 Â  </div>
 

{% endblock %}


{% block javascripts %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.12.1/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.2.3/js/dataTables.buttons.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"></script>
<script src="https://cdn.datatables.net/buttons/2.2.3/js/buttons.html5.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/leaflet@1.7.1/dist/leaflet.js"></script>

<script>
    document.addEventListener("DOMContentLoaded", function() {    
        // Tooltips
    $('[data-toggle="tooltip"]').tooltip({
        trigger: 'hover',
        placement: 'top'
    });
        // Delegar evento para elementos dinÃ¢micos
        $(document).on('click', '.open-modal', function() {
            const raw = $(this).attr('data-alert'); // Use $(this) para referenciar o botÃ£o clicado
            console.log('Raw:', raw);
            let alertData;
            locale = "PT-BR";
            try {
                alertData = JSON.parse(raw);
                console.log('Parsed alertData:', alertData);
            } catch (e) {
                console.error("Erro ao parsear alertData:", e);
                return;
            }
            
            console.log(document.getElementById('modalUuid')); // Deve retornar um elemento, nÃ£o null
            // Atualizar iframe do Waze
            const wazeFrame = document.getElementById('mapContainer');
            const src = `https://embed.waze.com/iframe?zoom=16&lat=${alertData.location_y}&lon=${alertData.location_x}&pin=1`;  
            
            console.log('Waze Frame Source:', src); // Verifique se o src estÃ¡ correto
            wazeFrame.innerHTML = ''; // Limpar conteÃºdo anterior
            wazeFrame.src = src;
    
            // Preencher dados bÃ¡sicos
            $('#modalUuid').text(alertData.uuid);
            console.log('UUID inserido no modal:', $('#modalUuid').text());
            $('#modalCity').text(alertData.city || 'NÃ£o informada');
            $('#modalStreet').text(alertData.street || 'NÃ£o informada');
            $('#modalLocation').text(`${alertData.location_x}, ${alertData.location_y}`);
            $('#modalDate').text(new Date(alertData.pubMillis).toLocaleString('pt-BR'));
            $('#modalType').text(alertData.type);
            $('#modalSubtype').text(alertData.subtype || 'N/A');
    
            // Configurar links
            $('#modalPartnerLink').attr({
                href: `https://www.waze.com/partnerhub/map-tool/alerts?cardType=3&cardId=${alertData.uuid}`,
                title: "Abrir no Partner Hub"
            });
            
            $('#modalWazeLink').attr({
                href: `https://www.waze.com/ul?ll=${alertData.location_y},${alertData.location_x}`,
                title: "Abrir no Waze"
            });
    
            // Status e ConfianÃ§a
            const status = alertData.status !== null ? alertData.status : 0;
            $('#modalStatus')
                .text(status === 1 ? "Ativo" : "Inativo")
                .removeClass()
                .addClass(`badge bg-${status === 1 ? 'success' : 'danger'}`);
    
            const confidence = alertData.confidence || 0;
            $('#modalConfidence')
                .text(`${confidence}%`)
                .removeClass()
                .addClass(`badge bg-${
                    confidence > 4 ? 'success' : 
                    confidence > 2 ? 'warning' : 'danger'
                }`);
    
            // Buscar KM (mantido se necessÃ¡rio para outros elementos)
            $('#modalKm').html('<span class="spinner-border spinner-border-sm"></span> Calculando...');
            if(typeof buscarKmDnit === 'function') {
                buscarKmDnit(alertData.location_y, alertData.location_x)
                    .then(km => $('#modalKm').text(km ? `KM ${km}` : "NÃ£o encontrado"))
                    .catch(() => $('#modalKm').html('<span class="text-danger">Erro na busca</span>'));
            }

            const mapContainer = document.getElementById('mapContainer');
            mapContainer.innerHTML = ''; // Limpa conteÃºdo anterior
            
            // Cria novo iframe
            const iframe = document.createElement('iframe');
            iframe.setAttribute('src', src);
            iframe.style.width = '100%';
            iframe.style.height = '400px';
            iframe.style.border = '0';
            iframe.loading = 'lazy';
            mapContainer.appendChild(iframe);
        });
    
        // Resetar ao fechar modal
    $('#alertModal').on('hidden.bs.modal', function() {
        $('#modalUuid').text('');
        $('#modalCity').text('');
        $('#modalStreet').text('');
        $('#modalLocation').text('');
        $('#modalDate').text('');
        $('#modalType').text('');
        $('#modalSubtype').text('N/A'); // Ou o valor padrÃ£o que vocÃª deseja
        $('#modalConfidence').text('').removeClass();
        $('#modalStatus').text('').removeClass();
        $('#modalKm').text('');
        $('#modalPartnerLink').attr('href', '#').removeAttr('title'); // Resetar link
        $('#modalWazeLink').attr('href', '#').removeAttr('title');     // Resetar link

        // Limpar o iframe do mapa tambÃ©m (opcional, mas pode ser Ãºtil)
        const mapContainer = document.getElementById('mapContainer');
        mapContainer.innerHTML = '';
    });
    });
</script>

<script src="./js/scripts.js"></script>
{% endblock %}