<div class="modal fade" id="alertModal{{ alert.uuid }}" tabindex="-1" aria-labelledby="alertModalLabel" aria-hidden="true"
     data-bs-lat="{{ alert.location_y }}" data-bs-lon="{{ alert.location_x }}">
    <div class="modal-dialog modal-lg">
        <div class="modal-content p-3 shadow-lg rounded">
            <div class="modal-header bg-primary text-white rounded-top">
                <h5 class="modal-title">
                    <i class="fas fa-exclamation-triangle"></i> Detalhes do Evento
                </h5>
                <button type="button" class="btn-close text-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                <div class="row">
                    <div class="col-md-6">
                        <div class="card border-0 shadow-sm p-3 mb-3">
                            <p><strong>üìå UUID:</strong> {{ alert.uuid }}</p>
                            <p><strong>üèôÔ∏è Cidade:</strong> {{ alert.city }}</p>
                            <p><strong>üìç Rua:</strong> {{ alert.street }}</p>
                            <p><strong>üì° Localiza√ß√£o:</strong> Lat: {{ alert.location_y }}, Lon: {{ alert.location_x }}</p>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="alert-details">
                            <p><strong>üìÖ Data:</strong>
                                {{ (alert.pubMillis / 1000) | date("d/m/Y H:i") }}
                                <small class="text-muted">(UTC)</small>
                            </p>

                            <p><strong>üõ£Ô∏è KM Estimado:</strong>
                                <span id="km-value-{{ alert.uuid }}" class="badge bg-info">
                                    {% if alert.estimated_km %}
                                        KM {{ alert.estimated_km|number_format(2, ',') }}
                                    {% else %}
                                        <span class="spinner-border spinner-border-sm" role="status"></span> Calculando...
                                    {% endif %}
                                </span>
                            </p>

                            <p><strong>üîç Confian√ßa:</strong>
                                <span class="badge bg-{{ alert.confidence > 4 ? 'success' : (alert.confidence >= 3 ? 'warning' : 'danger') }}"
                                      data-bs-toggle="tooltip"
                                      title="N√≠vel de confian√ßa na precis√£o do alerta">
                                    {{ alert.confidence }} - {{ ['Baixa', 'M√©dia', 'Alta'][alert.confidence//2] }}
                                </span>
                            </p>

                            <p><strong>‚ö†Ô∏è Status:</strong>
                                <span class="badge bg-{{ alert.status == 1 ? 'success' : 'danger' }}">
                                    {{ alert.status == 1 ? "Ativo" : "Inativo" }}
                                    <span class="visually-hidden">Status do alerta</span>
                                </span>
                            </p>

                            <p><strong>üîó Link Relacionado:</strong>
                                <a href="https://www.waze.com/partnerhub/map-tool/alerts?cardType=3&cardId={{ alert.uuid }}"
                                   class="badge bg-primary text-decoration-none"
                                   target="_blank"
                                   rel="noopener noreferrer"
                                   aria-label="Abrir alerta no Waze">
                                    Ver no Waze Partner Hub ‚Üó
                                </a>
                            </p>
                        </div>
                    </div>
                </div>

                <div class="card border-0 shadow-sm p-3 mb-3">
                    <p id = "tipo-alerta-{{ alert.uuid }}"><strong>üö® Tipo:</strong> {{ alert.type }}</p>
                    <p id="subtipo-alerta-{{ alert.uuid }}"><strong>üìå Subtipo:</strong> {{ alert.subtype }}</p>
                </div>

                <div class="card border-0 shadow-sm p-3">
                    <h6 class="text-center text-muted">üìç Localiza√ß√£o no Mapa (Waze)</h6>
                    <iframe
                        id="map-{{ alert.uuid }}"
                        class="rounded shadow-sm border"
                        src="https://embed.waze.com/{{ user.locale }}/iframe?zoom=16&lat={{ alert.location_y }}&lon={{ alert.location_x }}&pin=1&campaign=alerts_{{ alert.uuid }}&vehicle=car&hidegeopins=false&timestamp={{ alert.pubMillis }}"
                        style="width: 100%; height: 400px; min-height: 300px; border-color: #e0e0e0;"
                        allow="geolocation *; fullscreen"
                        title="Localiza√ß√£o exata do alerta {{ alert.code }} no mapa"
                        loading="lazy"
                        referrerpolicy="strict-origin-when-cross-origin"
                        aria-describedby="map-description-{{ alert.uuid }}"
                    ></iframe>
                    <small id="map-description-{{ alert.uuid }}" class="text-muted">
                        Mapa interativo mostrando a localiza√ß√£o precisa do alerta {{ alert.uuid }}. Clique no bot√£o abaixo para abrir no Waze.
                    </small>
                </div>
            </div>

            <div class="modal-footer d-flex justify-content-between">
                <a href="https://www.waze.com/ul?ll={{ alert.location_y }},{{ alert.location_x }}"
                   class="btn btn-outline-primary" target="_blank">
                    <i class="fab fa-waze"></i> Ver no Waze
                </a>

                <button type="button" class="btn btn-success" onclick="confirmarAlerta('{{ alert.uuid }}')">
                    <i class="fas fa-check"></i> Confirmar Alerta
                </button>

                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> Fechar
                </button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
    document.querySelectorAll("[id^=alertModal]").forEach(modal => {
        modal.addEventListener("show.bs.modal", async function () {
            const uuid = modal.id.replace("alertModal", "");
            const latitude = parseFloat(modal.getAttribute("data-bs-lat"));
            const longitude = parseFloat(modal.getAttribute("data-bs-lon"));

            if (!isNaN(latitude) && !isNaN(longitude)) {
                const km = await buscarKmDnit(longitude, latitude);
                document.getElementById(`km-value-${uuid}`).textContent = km;
            }
        });
    });

    // Inicialize tooltips do Bootstrap 5
    const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]')
    const tooltipList = [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl))
});

async function buscarKmDnit(longitude, latitude) {
    // Sua l√≥gica para buscar o KM do DNIT usando latitude e longitude
    console.log(`Buscando KM para lon: ${longitude}, lat: ${latitude}`);
    // Simula√ß√£o de uma chamada de API
    return new Promise(resolve => {
        setTimeout(() => {
            const kmAleatorio = Math.floor(Math.random() * 1000).toFixed(2);
            resolve(`KM ${kmAleatorio}`);
        }, 750);
    });
}

function confirmarAlerta(uuid) {
    console.log(`Alerta ${uuid} confirmado! (Implemente a l√≥gica de confirma√ß√£o)`);
    // Aqui voc√™ implementaria a l√≥gica para confirmar o alerta
}
</script>