<div class="modal fade" id="alertModal{{ alert.uuid }}" tabindex="-1" aria-labelledby="alertModalLabel" aria-hidden="true"
    data-lat="{{ alert.location_y }}" data-lon="{{ alert.location_x }}">
    
    <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content shadow-lg rounded">
            
            {# HEADER - Detalhes do Evento #}
            <div class="modal-header bg-dark text-white rounded-top p-3">
                <h5 class="modal-title h4" id="alertModalLabel">
                    <i class="fas fa-exclamation-triangle me-2"></i> Detalhes do Alerta: {{ alert.type }} ({{ alert.subtype }})
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>

            {# BODY - Conteúdo com Scroll #}
            <div class="modal-body p-4">
                
                <div class="row">
                    
                    {# COLUNA 1: Informações Básicas e Localização #}
                    <div class="col-lg-6 mb-4">
                        <div class="card h-100 border-primary shadow-sm">
                            <div class="card-header bg-primary text-white">
                                <h6 class="mb-0"><i class="fas fa-info-circle me-2"></i> Informações Básicas</h6>
                            </div>
                            <div class="card-body">
                                <p class="mb-2"><strong><i class="fas fa-fingerprint me-2"></i> UUID:</strong> <span class="text-monospace small">{{ alert.uuid }}</span></p>
                                <p class="mb-2"><strong><i class="far fa-calendar-alt me-2"></i> Data (UTC):</strong> 
                                    <span class="fw-bold text-dark">{{ (alert.pubMillis / 1000) | date("d/m/Y H:i:s") }}</span>
                                </p>
                                <p class="mb-2"><strong><i class="fas fa-city me-2"></i> Cidade:</strong> {{ alert.city }}</p>
                                <p class="mb-2"><strong><i class="fas fa-road me-2"></i> Rua:</strong> {{ alert.street }}</p>
                                <p class="mb-2">
                                    <strong><i class="fas fa-map-marker-alt me-2"></i> Coordenadas:</strong>
                                    <span class="text-muted">Lat: {{ alert.location_y|round(6) }}, Lon: {{ alert.location_x|round(6) }}</span>
                                </p>
                            </div>
                            <div class="card-footer bg-light border-top text-end">
                                <a href="https://www.waze.com/ul?ll={{ alert.location_y }},{{ alert.location_x }}"
                                    class="btn btn-sm btn-outline-info" target="_blank" rel="noopener noreferrer">
                                    <i class="fab fa-waze me-1"></i> Abrir no Waze
                                </a>
                            </div>
                        </div>
                    </div>

                    {# COLUNA 2: Detalhes Adicionais e Status #}
                    <div class="col-lg-6 mb-4">
                        <div class="card h-100 border-info shadow-sm">
                            <div class="card-header bg-info text-white">
                                <h6 class="mb-0"><i class="fas fa-clock me-2"></i> Detalhes Adicionais</h6>
                            </div>
                            <div class="card-body">
                                
                                <p class="mb-2">
                                    <strong><i class="fas fa-tachometer-alt me-2"></i> KM Estimado:</strong>
                                    <span id="modalKm{{ alert.uuid }}" class="badge bg-secondary p-2 ms-2 fw-normal">Calculando...</span>
                                </p>
                                
                                <p class="mb-2">
                                    <strong><i class="fas fa-check-double me-2"></i> Confiança:</strong>
                                    {% set confidence_class = alert.confidence > 4 ? 'bg-success' : (alert.confidence >= 3 ? 'bg-warning text-dark' : 'bg-danger') %}
                                    {% set confidence_text = ['Baixa', 'Média', 'Alta'][(alert.confidence // 2)|min(2)] %}
                                    
                                    <span class="badge {{ confidence_class }} p-2 ms-2"
                                        data-bs-toggle="tooltip" data-bs-placement="top"
                                        title="Nível de confiança na precisão do alerta: {{ alert.confidence }}">
                                        {{ confidence_text }} ({{ alert.confidence }})
                                    </span>
                                </p>
                                
                                <p class="mb-2">
                                    <strong><i class="fas fa-traffic-light me-2"></i> Status:</strong>
                                    {% set status_class = alert.status == 1 ? 'bg-success' : 'bg-danger' %}
                                    {% set status_text = alert.status == 1 ? "Ativo" : "Inativo" %}
                                    <span class="badge {{ status_class }} p-2 ms-2">
                                        {{ status_text }}
                                    </span>
                                </p>
                                
                                <p class="mb-2"><strong><i class="fas fa-tags me-2"></i> Tipo:</strong> {{ alert.type }}</p>
                                <p class="mb-2"><strong><i class="fas fa-tag me-2"></i> Subtipo:</strong> {{ alert.subtype }}</p>

                            </div>
                            <div class="card-footer bg-light border-top text-end">
                                <a href="https://www.waze.com/partnerhub/map-tool/alerts?cardType=3&cardId={{ alert.uuid }}"
                                    class="btn btn-sm btn-outline-dark"
                                    target="_blank"
                                    rel="noopener noreferrer"
                                    aria-label="Abrir alerta no Waze Partner Hub">
                                    <i class="fas fa-link me-1"></i> Ver no Partner Hub ↗
                                </a>
                            </div>
                        </div>
                    </div>
                </div>

                {# MAPA WAZE #}
                <h5 class="text-center text-muted mt-3 mb-3 border-bottom pb-2"><i class="fas fa-map-marked-alt me-2"></i> Localização no Mapa</h5>
                <iframe
                    id="map-{{ alert.uuid }}"
                    class="rounded shadow-sm border border-secondary"
                    src="https://embed.waze.com/{{ user.locale|default('pt') }}/iframe?zoom=16&lat={{ alert.location_y }}&lon={{ alert.location_x }}&pin=1&campaign=alerts_{{ alert.uuid }}&vehicle=car&hidegeopins=false&timestamp={{ alert.pubMillis }}"
                    style="width: 100%; height: 400px; border-color: #e0e0e0;"
                    allow="geolocation *; fullscreen"
                    title="Localização exata do alerta {{ alert.uuid }} no mapa Waze"
                    loading="lazy">
                </iframe>
                
                {# STREET VIEW - Nota: O iframe do Street View é complexo e pode exigir uma chave de API válida para funcionar. #}
                <h5 class="text-center text-muted mt-4 mb-3 border-bottom pb-2"><i class="fas fa-street-view me-2"></i> Street View (Visualização de Rua)</h5>
                <iframe
                    width="100%"
                    height="400"
                    frameborder="0"
                    style="border:0;"
                    src="http://maps.google.com/maps?q=&layer=c&cbll={{ alert.location_y }},{{ alert.location_x }}&cbp=12,20,0,0,0&ved=0ahUKEwjG_4W-w-b8AhXpLEQIHf_KCGgQ0tQDCAQ&source=embed"
                    allowfullscreen
                    loading="lazy"
                    class="rounded shadow-sm border border-secondary">
                </iframe>
                <small class="form-text text-muted text-center d-block mt-2">
                    A visualização de rua pode depender da disponibilidade de dados e da API Key do Google Maps (Embed API ou Street View Service).
                </small>

            </div>

            {# FOOTER - Ações #}
            <div class="modal-footer d-flex justify-content-between p-3 bg-light rounded-bottom">
                
                <a href="https://www.waze.com/ul?ll={{ alert.location_y }},{{ alert.location_x }}"
                    class="btn btn-outline-dark me-auto" target="_blank">
                    <i class="fab fa-waze me-2"></i> Navegar (Waze App)
                </a>

                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i> Fechar
                </button>
                
                <button type="button" class="btn btn-success ml-2" onclick="confirmarAlerta('{{ alert.uuid }}')">
                    <i class="fas fa-check me-2"></i> Confirmar Alerta
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Usando data-bs-dismiss para compatibilidade com Bootstrap 5
document.addEventListener("DOMContentLoaded", function () {
    const alertModals = document.querySelectorAll("[id^=alertModal]");
    
    alertModals.forEach(modal => {
        // Usando o evento 'show.bs.modal' do Bootstrap
        modal.addEventListener("show.bs.modal", async function () {
            const uuid = modal.id.replace("alertModal", "");
            const latitude = parseFloat(modal.getAttribute("data-lat"));
            const longitude = parseFloat(modal.getAttribute("data-lon"));

            console.log(`Modal ${uuid} aberto. Latitude: ${latitude}, Longitude: ${longitude}`);
            
            if (!isNaN(latitude) && !isNaN(longitude)) {
                // Ajuste para usar a ID única no span do KM
                const kmSpan = document.getElementById(`modalKm${uuid}`);
                
                if (kmSpan && kmSpan.textContent.includes('Calculando')) {
                    // Função a ser implementada no seu JS para buscar o KM
                    const km = await buscarKmDnit(longitude, latitude); 
                    
                    kmSpan.textContent = km !== null ? `KM ${km.toFixed(2).replace('.', ',')}` : 'Não encontrado';
                }
            }
        });
        
        // Inicializar Tooltips do Bootstrap 5
        const tooltipTriggerList = [].slice.call(modal.querySelectorAll('[data-bs-toggle="tooltip"]'));
        tooltipTriggerList.map(function (tooltipTriggerEl) {
          return new bootstrap.Tooltip(tooltipTriggerEl)
        });
    });
});

// Placeholder para a função de confirmar alerta
function confirmarAlerta(uuid) {
    alert(`Alerta ${uuid} confirmado! (Funcionalidade a ser implementada)`);
    // Aqui você chamaria sua função para confirmar o alerta no backend
}
</script>