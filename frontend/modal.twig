<div class="modal fade" id="alertModal{{ alert.uuid }}" tabindex="-1" aria-labelledby="alertModalLabel" aria-hidden="true"
    data-lat="{{ alert.location_y }}" data-lon="{{ alert.location_x }}">
    <div class="modal-dialog modal-lg">
        <div class="modal-content shadow-lg rounded">
            <div class="modal-header bg-primary text-white rounded-top">
                <h5 class="modal-title">
                    <i class="fas fa-exclamation-triangle"></i> Detalhes do Evento
                </h5>
                <button type="button" class="close text-white" data-dismiss="modal" aria-label="Fechar">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>

            <div class="modal-body" style="max-height: 75vh; overflow-y: auto; padding: 1.5rem;">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <div class="bg-light p-3 rounded shadow-sm border">
                            <h6><i class="fas fa-info-circle mr-2"></i> Informações Básicas</h6>
                            <hr class="my-2">
                            <p><strong><i class="fas fa-fingerprint mr-2"></i> UUID:</strong> {{ alert.uuid }}</p>
                            <p><strong><i class="fas fa-city mr-2"></i> Cidade:</strong> {{ alert.city }}</p>
                            <p><strong><i class="fas fa-road mr-2"></i> Rua:</strong> {{ alert.street }}</p>
                            <p><strong><i class="fas fa-map-marker-alt mr-2"></i> Localização:</strong>
                                Lat: {{ alert.location_y|round(6) }}, Lon: {{ alert.location_x|round(6) }}
                            </p>
                        </div>
                    </div>

                    <div class="col-md-6 mb-3">
                        <div class="bg-light p-3 rounded shadow-sm border">
                            <h6><i class="fas fa-clock mr-2"></i> Detalhes Adicionais</h6>
                            <hr class="my-2">
                            <p><strong><i class="far fa-calendar-alt mr-2"></i> Data:</strong>
                                {{ (alert.pubMillis / 1000) | date("d/m/Y H:i") }}
                                <small class="text-muted">(UTC)</small>
                            </p>
                            <p><strong><i class="fas fa-tachometer-alt mr-2"></i> KM Estimado:</strong>
                                <span id="km-value-{{ alert.uuid }}" class="badge badge-info">
                                    {% if alert.estimated_km %}
                                        KM {{ alert.estimated_km|number_format(2, ',') }}
                                    {% else %}
                                        <span class="spinner-border spinner-border-sm" role="status"></span> Calculando...
                                    {% endif %}
                                </span>
                            </p>
                            <p><strong><i class="fas fa-check-double mr-2"></i> Confiança:</strong>
                                <span class="badge badge-{{ alert.confidence > 4 ? 'success' : (alert.confidence >= 3 ? 'warning' : 'danger') }}"
                                    data-toggle="tooltip"
                                    title="Nível de confiança na precisão do alerta">
                                    {{ alert.confidence }} - {{ ['Baixa', 'Média', 'Alta'][alert.confidence//2] }}
                                </span>
                            </p>
                            <p><strong><i class="fas fa-traffic-light mr-2"></i> Status:</strong>
                                <span class="badge badge-{{ alert.status == 1 ? 'success' : 'danger' }}">
                                    {{ alert.status == 1 ? "Ativo" : "Inativo" }}
                                    <span class="visually-hidden">Status do alerta</span>
                                </span>
                            </p>
                            <p><strong><i class="fas fa-tags mr-2"></i> Tipo:</strong> {{ alert.type }}</p>
                            <p><strong><i class="fas fa-tag mr-2"></i> Subtipo:</strong> {{ alert.subtype }}</p>
                            <p><strong><i class="fas fa-link mr-2"></i> Waze Partner Hub:</strong>
                                <a href="https://www.waze.com/partnerhub/map-tool/alerts?cardType=3&cardId={{ alert.uuid }}"
                                    class="badge badge-primary text-decoration-none"
                                    target="_blank"
                                    rel="noopener noreferrer"
                                    aria-label="Abrir alerta no Waze Partner Hub">
                                    Ver Detalhes ↗
                                </a>
                            </p>
                        </div>
                    </div>
                </div>

                <hr class="my-3">
                <h6 class="text-center text-muted mb-3"><i class="fas fa-map-marked-alt mr-2"></i> Localização no Mapa</h6>
                <iframe
                    id="map-{{ alert.uuid }}"
                    class="rounded shadow-sm border"
                    src="https://embed.waze.com/{{ user.locale }}/iframe?zoom=16&lat={{ alert.location_y }}&lon={{ alert.location_x }}&pin=1&campaign=alerts_{{ alert.uuid }}&vehicle=car&hidegeopins=false&timestamp={{ alert.pubMillis }}"
                    style="width: 100%; height: 300px; border-color: #e0e0e0;"
                    allow="geolocation *; fullscreen"
                    title="Localização exata do alerta {{ alert.code }} no mapa"
                    loading="lazy"
                    referrerpolicy="strict-origin-when-cross-origin"
                    aria-describedby="map-description-{{ alert.uuid }}">
                </iframe>
                <small id="map-description-{{ alert.uuid }}" class="form-text text-muted text-center">
                    Mapa interativo mostrando a localização precisa do alerta.
                </small>

                <hr class="my-3">
                <h6 class="text-center text-muted mb-3"><i class="fas fa-street-view mr-2"></i> Street View</h6>
                <iframe
                    width="100%"
                    height="300"
                    frameborder="0"
                    style="border:0"
                    src="https://www.google.com/maps/embed/v1/streetview?key=YOUR_GOOGLE_MAPS_API_KEY&location={{ alert.location_y }},{{ alert.location_x }}&fov=80&heading=70&pitch=0"
                    allowfullscreen
                    loading="lazy"
                    class="rounded shadow-sm border">
                </iframe>
                <small class="form-text text-muted text-center">
                    Visualização do Street View da localização (API Key do Google Maps é necessária).
                </small>

            </div>

            <div class="modal-footer d-flex justify-content-end">
                <a href="https://www.waze.com/ul?ll={{ alert.location_y }},{{ alert.location_x }}"
                    class="btn btn-outline-primary" target="_blank">
                    <i class="fab fa-waze mr-2"></i> Ver no Waze
                </a>
                <button type="button" class="btn btn-secondary" data-dismiss="modal">
                    <i class="fas fa-times mr-2"></i> Fechar
                </button>
                <button type="button" class="btn btn-success ml-2" onclick="confirmarAlerta('{{ alert.uuid }}')">
                    <i class="fas fa-check mr-2"></i> Confirmar
                </button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
    const alertModals = document.querySelectorAll("[id^=alertModal]");
    alertModals.forEach(modal => {
        modal.addEventListener("show.bs.modal", async function () {
            const uuid = modal.id.replace("alertModal", "");
            const latitude = parseFloat(modal.getAttribute("data-lat"));
            const longitude = parseFloat(modal.getAttribute("data-lon"));

            if (!isNaN(latitude) && !isNaN(longitude)) {
                const kmSpan = document.getElementById(`km-value-${uuid}`);
                if (kmSpan && kmSpan.textContent.includes('Calculando')) {
                    const km = await buscarKmDnit(longitude, latitude);
                    kmSpan.textContent = km !== null ? `KM ${km.toFixed(2).replace('.', ',')}` : 'Não encontrado';
                }
            }
        });
    });

    // Inicializar tooltips do Bootstrap
    $(function () {
        $('[data-toggle="tooltip"]').tooltip()
    })
});

// Placeholder para a função de buscar KM
async function buscarKmDnit(longitude, latitude) {
    // Simulação de chamada de API
    console.log("Buscando KM para:", latitude, longitude);
    await new Promise(resolve => setTimeout(resolve, 1000));
    // Retorne o valor real do KM aqui
    const randomKM = Math.random() * 100;
    return randomKM;
}

// Placeholder para a função de confirmar alerta
function confirmarAlerta(uuid) {
    alert(`Alerta ${uuid} confirmado! (Funcionalidade não implementada)`);
    // Aqui você chamaria sua função para confirmar o alerta no backend
}
</script>