<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<!-- Chart.js -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.0/font/bootstrap-icons.css">
<script src="https://cdn.plot.ly/plotly-2.30.0.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/vis/4.21.0/vis.min.js"></script>

<!-- Adicione estas dependências no head -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/gridstack.js/7.2.3/gridstack-all.min.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/gridstack.js/7.2.3/gridstack-all.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/vis/4.21.0/vis.min.css" type="text/css" />



<style>
    .chart-container {
        position: relative;
        min-height: 300px;
    }

    @media (max-width: 768px) {
        .chart-container {
            height: 250px !important;
        }

        #heatmapChart {
            height: 300px !important;
        }
    }

    /* Ajustes adicionais */
    .summary-item {
        transition: transform 0.2s;
    }

    .summary-item:hover {
        transform: translateY(-2px);
    }

    .chart-container {
        min-height: 250px;
    }

    @media (max-width: 768px) {
        .summary-value {
            font-size: 1.5rem !important;
        }

        .card-header h5 {
            font-size: 0.9rem !important;
        }

        .chart-container {
            height: 250px !important;
        }
    }

    .insight {
        background: #f8f9fa;
        border-left: 4px solid #0d6efd;
        padding: 1rem;
        margin: 1rem 0;
        border-radius: 4px;
        font-size: 0.9rem;
    }

    .card {
        margin-bottom: 20px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .card-header {
        font-weight: 500;
        background-color: #f8f9fa;
    }

    .summary-item {
        padding: 15px;
        border-radius: 5px;
        margin-bottom: 10px;
        background-color: #f8f9fa;
    }

    .summary-value {
        font-size: 24px;
        font-weight: bold;
    }

    .summary-label {
        font-size: 14px;
        color: #6c757d;
    }

    .table-responsive {
        max-height: 400px;
        overflow-y: auto;
    }

    #hourlyChart,
    #weekdayChart,
    #levelChart,
    #monthlyChart,
    #cityChart,
    #roadTypeChart,
    #delayDistChart,
    #lengthVsDelayChart {
        height: 300px;
    }

    .nav-tabs .nav-link {
        color: #495057;
    }

    .nav-tabs .nav-link.active {
        font-weight: bold;
    }


    .table-hover tbody tr:hover {
        background-color: #f8f9fa;
    }

    .badge.bg-danger {
        background-color: #dc3545 !important;
        color: white;
        padding: 4px 8px;
        border-radius: 12px;
    }

    .chart-container {
        min-height: 300px;
    }

    @media (max-width: 768px) {
        .chart-container {
            height: 300px !important;
        }

        .table td,
        .table th {
            padding: 0.75rem;
            font-size: 0.9rem;
        }
    }
</style>
</head>

<body>
    <div class="container-fluid py-4">
        <h1 class="mb-4">Dashboard de Análise de Congestionamentos</h1>

        <!-- Nav tabs para principais análises -->
        <ul class="nav nav-tabs mb-4" id="analysisTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview"
                    type="button" role="tab" aria-controls="overview" aria-selected="true">Visão Geral</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="segments-tab" data-bs-toggle="tab" data-bs-target="#segments" type="button"
                    role="tab" aria-controls="segments" aria-selected="false">Segmentos</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="time-tab" data-bs-toggle="tab" data-bs-target="#time" type="button"
                    role="tab" aria-controls="time" aria-selected="false">Análise Temporal</button>
            </li>
        </ul>

        <!-- Tab content -->
        <div class="tab-content" id="analysisTabContent">
            <!-- Visão Geral -->
            <div class="tab-pane fade show active" id="overview" role="tabpanel" aria-labelledby="overview-tab">
                <div class="row gy-3">
                    <!-- Cartões de resumo -->
                    <div class="col-12">
                        <div class="card shadow-sm">
                            <div class="card-header bg-primary text-white py-2">
                                <h5 class="mb-0 fs-6">Resumo dos Congestionamentos</h5>
                            </div>
                            <div class="card-body p-2">
                                <div class="row row-cols-2 row-cols-lg-4 g-1 g-lg-3">
                                    <div class="col">
                                        <div class="summary-item bg-light rounded p-2 text-center h-100">
                                            <div class="summary-value display-6 fw-bold text-primary">{{
                                                resumo['total']|number_format(0, '', '') }}</div>
                                            <div class="summary-label small text-muted">Total</div>
                                        </div>
                                    </div>
                                    <div class="col">
                                        <div class="summary-item bg-light rounded p-2 text-center h-100">
                                            <div class="summary-value display-6 fw-bold text-danger">{{
                                                (resumo['atraso_medio']/60)|number_format(1) }}</div>
                                            <div class="summary-label small text-muted">Atraso Médio (min)</div>
                                        </div>
                                    </div>
                                    <div class="col">
                                        <div class="summary-item bg-light rounded p-2 text-center h-100">
                                            <div class="summary-value display-6 fw-bold text-success">{{
                                                (resumo['comprimento_medio']/1000)|number_format(2) }}</div>
                                            <div class="summary-label small text-muted">Comprimento (km)</div>
                                        </div>
                                    </div>
                                    <div class="col">
                                        <div class="summary-item bg-light rounded p-2 text-center h-100">
                                            <div class="summary-value display-6 fw-bold text-warning">{{
                                                (resumo['max_atraso']/60)|number_format(1) }}</div>
                                            <div class="summary-label small text-muted">Máx. Atraso (min)</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Gráficos -->
                    <div class="col-12 col-lg-6">
                        <div class="card shadow-sm h-100">
                            <div class="card-header bg-secondary text-white py-2">
                                <h5 class="mb-0 fs-6">Distribuição por Hora</h5>
                            </div>
                            <div class="card-body p-2">
                                <div class="chart-container"
                                    style="position: relative; height: 300px; min-height: 250px">
                                    <canvas id="hourlyChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-12 col-lg-6">
                        <div class="card shadow-sm h-100">
                            <div class="card-header bg-secondary text-white py-2">
                                <h5 class="mb-0 fs-6">Distribuição por Dia</h5>
                            </div>
                            <div class="card-body p-2">
                                <div class="chart-container"
                                    style="position: relative; height: 300px; min-height: 250px">
                                    <canvas id="weekdayChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-12 col-lg-6">
                        <div class="card shadow-sm h-100">
                            <div class="card-header bg-secondary text-white py-2">
                                <h5 class="mb-0 fs-6">Níveis de Congestionamento</h5>
                            </div>
                            <div class="card-body p-2">
                                <div class="chart-container"
                                    style="position: relative; height: 300px; min-height: 250px">
                                    <canvas id="levelChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-12 col-lg-6">
                        <div class="card shadow-sm h-100">
                            <div class="card-header bg-secondary text-white py-2">
                                <h5 class="mb-0 fs-6">Ruas mais Afetadas</h5>
                            </div>
                            <div class="card-body p-2">
                                <div class="chart-container"
                                    style="position: relative; height: 300px; min-height: 250px">
                                    <canvas id="delayDistChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>


            <!-- Segmentos -->
            <div class="tab-pane fade" id="segments" role="tabpanel" aria-labelledby="segments-tab">
                <div class="row g-3">
                    <!-- Top Segmentos -->
                    <div class="col-12">
                        <div class="card shadow-sm">
                            <div class="card-header bg-primary text-white py-2">
                                <h5 class="mb-0">Segmentos Mais Congestionados</h5>
                            </div>
                            <div class="card-body p-0">
                                <div class="table-responsive">
                                    <table class="table table-hover align-middle mb-0">
                                        <thead class="table-light">
                                            <tr>
                                                <th>ID Segmento</th>
                                                <th>Rua</th>
                                                <th>Contagem</th>
                                                <th>Atraso Médio (min)</th>
                                                <th>Comprimento Médio (m)</th>
                                                <th>Atraso Máx (min)</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for segment in segmentos %}
                                            <tr>
                                                <td class="fw-bold">{{ segment.segmento }}</td>
                                                <td>{{ segment.rua }}</td>
                                                <td>
                                                    <span class="badge bg-danger">{{ segment.total }}</span>
                                                </td>
                                                <td>{{ segment.atraso_medio_min }}</td>
                                                <td>{{ segment.comprimento_medio_m }}</td>
                                                <td>{{ segment.atraso_max_min }}</td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Top Ruas -->
                    <div class="col-12">
                        <div class="card shadow-sm">
                            <div class="card-header bg-primary text-white py-2">
                                <h5 class="mb-0">Ruas Mais Problemáticas</h5>
                            </div>
                            <div class="card-body p-0">
                                <div class="table-responsive">
                                    <table class="table table-hover align-middle mb-0">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Rua</th>
                                                <th>Contagem</th>
                                                <th>Atraso Médio (min)</th>
                                                <th>Comprimento Médio (m)</th>
                                                <th>Atraso Máx (min)</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for street in ruas %}
                                            <tr>
                                                <td>{{ street.rua }}</td>
                                                <td>
                                                    <span class="badge bg-danger">{{ street.total }}</span>
                                                </td>
                                                <td>{{ street.atraso_medio_min }}</td>
                                                <td>{{ street.comprimento_medio_m }}</td>
                                                <td>{{ street.atraso_max_min }}</td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Relação Tamanho vs Atraso -->
                    <div class="col-12">
                        <div class="card shadow-sm">
                            <div class="card-header bg-primary text-white py-2">
                                <h5 class="mb-0">Relação entre Comprimento e Atraso</h5>
                            </div>
                            <div class="card-body">
                                <div class="chart-container" style="height: 400px;">
                                    <canvas id="lengthVsDelayChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Análise Temporal -->
            <div class="tab-pane fade" id="time" role="tabpanel" aria-labelledby="time-tab">
                <div class="row g-3">
                    <!-- Tendência Mensal -->
                    <div class="col-12">
                        <div class="card shadow-sm h-100">
                            <div class="card-header bg-primary text-white py-2">
                                <h5 class="mb-0">Evolução Mensal</h5>
                            </div>
                            <div class="card-body">
                                <div class="chart-container" style="height: 300px;">
                                    <canvas id="monthlyChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Heatmap por Hora/Dia -->
                    <div class="col-12">
                        <div class="card shadow-sm h-100">
                            <div class="card-header bg-primary text-white py-2">
                                <h5 class="mb-0">Intensidade por Hora e Dia</h5>
                            </div>
                            <div class="card-body p-2">
                                <div id="heatmapChart" style="height: 400px;"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Novos Gráficos Integrados -->
                    <div class="col-12 col-lg-6">
                        <div class="card shadow-sm h-100">
                            <div class="card-header bg-primary text-white py-2">
                                <h5 class="mb-0">Extensão Horária</h5>
                            </div>
                            <div class="card-body">
                                <div class="chart-container" style="height: 300px;">
                                    <canvas id="totalKmHourlyChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-12 col-lg-6">
                        <div class="card shadow-sm h-100">
                            <div class="card-header bg-primary text-white py-2">
                                <h5 class="mb-0">Comparativo Semanal</h5>
                            </div>
                            <div class="card-body">
                                <div class="chart-container" style="height: 300px;">
                                    <canvas id="weekdayComparisonChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Novos Gráficos Integrados -->
                    <div class="col-12 col-lg-6">
                        <div class="card shadow-sm h-100">
                            <div class="card-header bg-primary text-white py-2">
                                <h5 class="mb-0">Duração Horária</h5>
                            </div>
                            <div class="card-body">
                                <div class="chart-container" style="height: 300px;">
                                    <canvas id="durationTimeChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-12 col-lg-6">
                        <div class="card shadow-sm h-100">
                            <div class="card-header bg-primary text-white py-2">
                                <h5 class="mb-0">Comparativo Dia de Semana final de semana</h5>
                            </div>
                            <div class="card-body">
                                <div class="chart-container" style="height: 300px;">
                                    <canvas id="weekendComparisonChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Novos Gráficos Integrados -->
                    <div class="col-12 col-lg-6">
                        <div class="card shadow-sm h-100">
                            <div class="card-header bg-primary text-white py-2">
                                <h5 class="mb-0">Por tipo de via</h5>
                            </div>
                            <div class="card-body">
                                <div class="chart-container" style="height: 300px;">
                                    <canvas id="roadTypeRadarChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-12 col-lg-6">
                        <div class="card shadow-sm h-100">
                            <div class="card-header bg-primary text-white py-2">
                                <h5 class="mb-0">Histograma</h5>
                            </div>
                            <div class="card-body">
                                <div class="chart-container" style="height: 300px;">
                                    <canvas id="durationHistogram"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-12 col-lg-6">
                        <div class="card shadow-sm h-100">
                            <div class="card-header bg-primary text-white py-2">
                                <h5 class="mb-0">Linha do tempo</h5>
                            </div>
                            <div class="card-body">
                                <div class="chart-container" style="height: 300px;">
                                    <canvas id="timelineChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>

                    
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap Bundle com Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Adicione antes do fechamento do body -->
    <script>
        // Converta os dados para JSON no console
        //console.log('Dados do Dashboard:', {{ resumo|json_encode|raw }});
    </script>

    <!-- Script para dashboard -->
    <script>
        // Dados para gráficos extraídos da variável PHp
        const data = {{ horario| json_encode(constant('JSON_HEX_TAG')) | raw }};
        const datasemana = {{ semanal| json_encode(constant('JSON_HEX_TAG')) | raw }};
        const dadosnivel = {{ niveis| json_encode(constant('JSON_HEX_TAG')) | raw }};
        const dadosatraso = {{ ruas| json_encode(constant('JSON_HEX_TAG')) | raw }};
        const mensal = {{ mes| json_encode(constant('JSON_HEX_TAG')) | raw }};
        const atrasocomprimento = {{ length_delay| json_encode(constant('JSON_HEX_TAG')) | raw }};
        const diaxsemana = {{ dia_hora| json_encode(constant('JSON_HEX_TAG')) | raw }};
        const km_por_hora = {{ km_por_hora| json_encode(constant('JSON_HEX_TAG')) | raw }};
        const km_por_dia_semana = {{ km_por_dia_semana| json_encode(constant('JSON_HEX_TAG')) | raw }};
        const media_km_por_hora = {{ media_km_por_hora| json_encode(constant('JSON_HEX_TAG')) | raw }};
        const media_km_por_dia_semana = {{ media_km_por_dia_semana| json_encode(constant('JSON_HEX_TAG')) | raw }};
        const jams = {{ jams| json_encode(constant('JSON_HEX_TAG')) | raw }};


        console.log('Todos os congestionamentos:', jams);
        console.log('Dados do gráfico de dias da semana:', km_por_dia_semana);
        console.log('Dados do gráfico de horas media:', media_km_por_hora);
        console.log('Dados do gráfico de dias da semana media:', media_km_por_dia_semana);

    </script>
    <script src="../js/traffic-dashboard.js"></script>
</body>

</html>