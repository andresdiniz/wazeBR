<!-- Leaflet CSS + JS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<!-- Highcharts -->
<script src="https://code.highcharts.com/highcharts.js"></script>
<script src="https://code.highcharts.com/modules/heatmap.js"></script>
<script src="https://code.highcharts.com/modules/exporting.js"></script>
<style>
    /* Reutilizando estilos do home.twig */
    :root {
        --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        --success-gradient: linear-gradient(135deg, #1cc88a 0%, #13855c 100%);
        --warning-gradient: linear-gradient(135deg, #f6c23e 0%, #dda20a 100%);
        --danger-gradient: linear-gradient(135deg, #e74a3b 0%, #be2617 100%);
        --info-gradient: linear-gradient(135deg, #36b9cc 0%, #258391 100%);
        --card-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        --card-shadow-hover: 0 8px 30px rgba(0, 0, 0, 0.12);
        
        /* Variáveis para modo claro */
        --bg-color: #f8f9fc;
        --card-bg: #ffffff;
        --text-primary: #2c3e50;
        --text-secondary: #858796;
        --text-muted: #858796;
        --border-color: #e3e6f0;
        --table-hover: #f8f9fc;
        --header-border: #e3e6f0;
        --legend-bg: #ffffff;
        --empty-icon-color: #d1d3e2;
    }

    /* Modo Escuro */
    body.dark-mode {
        --bg-color: #1a1d29;
        --card-bg: #252836;
        --text-primary: #e4e6eb;
        --text-secondary: #b0b3b8;
        --text-muted: #8a8d93;
        --border-color: #3a3d4a;
        --table-hover: #2d3142;
        --header-border: #3a3d4a;
        --legend-bg: #252836;
        --empty-icon-color: #3a3d4a;
        --card-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        --card-shadow-hover: 0 8px 30px rgba(0, 0, 0, 0.4);
    }

    /* Header da página */
    .page-header {
        margin-bottom: 2rem;
        padding-bottom: 1rem;
        border-bottom: 2px solid var(--header-border);
    }

    .page-header h1 {
        font-size: 2rem;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 0.5rem;
    }

    .page-header .subtitle {
        color: var(--text-secondary);
        font-size: 0.95rem;
    }

    /* Cards modernos */
    .modern-card {
        border: none;
        border-radius: 1rem;
        overflow: hidden;
        transition: all 0.3s ease;
        box-shadow: var(--card-shadow);
        background: var(--card-bg);
    }

    .modern-card:hover {
        box-shadow: var(--card-shadow-hover);
    }

    .modern-card-header {
        background: var(--primary-gradient);
        color: white;
        padding: 1.25rem 1.5rem;
        font-weight: 700;
        display: flex;
        align-items: center;
        justify-content: space-between;
        font-size: 1.05rem;
    }

    .modern-card-header.bg-warning-gradient {
        background: var(--warning-gradient);
    }

    .modern-card-header.bg-danger-gradient {
        background: var(--danger-gradient);
    }

    .modern-card-header.bg-info-gradient {
        background: var(--info-gradient);
    }

    .modern-card-header.bg-success-gradient {
        background: var(--success-gradient);
    }

    /* Badge contador */
    .badge-counter {
        background: rgba(255, 255, 255, 0.25);
        padding: 0.4rem 0.75rem;
        border-radius: 50px;
        font-weight: 700;
        font-size: 0.95rem;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.3);
    }

    /* Tabelas melhoradas */
    .modern-table {
        margin-bottom: 0;
        width: 100%;
        border-collapse: collapse;
    }

    .modern-table thead th {
        background: var(--table-hover);
        border: none;
        font-weight: 700;
        text-transform: uppercase;
        font-size: 0.75rem;
        color: var(--text-secondary);
        padding: 1rem 0.75rem;
        letter-spacing: 0.5px;
        position: sticky;
        top: 0;
        z-index: 10;
        white-space: nowrap;
    }

    .modern-table tbody tr {
        transition: all 0.2s ease;
        border-bottom: 1px solid var(--border-color);
    }

    .modern-table tbody tr:hover {
        background-color: var(--table-hover);
        transform: translateX(3px);
    }

    .modern-table tbody tr:last-child {
        border-bottom: none;
    }

    .modern-table tbody td {
        padding: 1rem 0.75rem;
        vertical-align: middle;
        color: var(--text-primary);
        white-space: nowrap;
    }

    .modern-table .fw-bold {
        color: var(--text-primary);
    }

    .modern-table .text-muted,
    .modern-table small.text-muted {
        color: var(--text-muted) !important;
    }

    /* Badges melhorados */
    .modern-badge {
        padding: 0.5rem 0.875rem;
        border-radius: 50px;
        font-weight: 700;
        font-size: 0.8rem;
        min-width: 65px;
        display: inline-block;
        text-align: center;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    /* Botões de ação */
    .action-btn {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
        border: none;
        margin: 0 3px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .action-btn:hover {
        transform: translateY(-3px) scale(1.1);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    .action-btn i {
        font-size: 0.9rem;
    }

    /* Estado vazio */
    .empty-state {
        text-align: center;
        padding: 4rem 1rem;
    }

    .empty-state i {
        font-size: 5rem;
        color: var(--empty-icon-color);
        margin-bottom: 1.5rem;
        opacity: 0.4;
    }

    .empty-state h5 {
        color: var(--text-primary);
        font-weight: 600;
        margin-bottom: 0.5rem;
    }

    .empty-state p {
        color: var(--text-secondary);
        font-size: 0.95rem;
        margin-bottom: 0;
    }

    /* Loading spinner */
    .loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: var(--card-bg);
        opacity: 0.95;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        border-radius: 1rem;
    }

    .spinner {
        width: 50px;
        height: 50px;
        border: 4px solid var(--border-color);
        border-top: 4px solid #4e73df;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    .loading-text {
        margin-top: 1rem;
        color: var(--text-secondary);
        font-weight: 600;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* Modal personalizado */
    .custom-modal .modal-content {
        border: none;
        border-radius: 1rem;
        background: var(--card-bg);
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }

    .custom-modal .modal-header {
        background: var(--primary-gradient);
        color: white;
        border-radius: 1rem 1rem 0 0;
        padding: 1.5rem;
        border: none;
    }

    .custom-modal .modal-header .close {
        color: white;
        opacity: 0.8;
        text-shadow: none;
    }

    .custom-modal .modal-header .close:hover {
        opacity: 1;
    }

    .custom-modal .modal-body {
        padding: 1.5rem;
        color: var(--text-primary);
    }

    .custom-modal .modal-footer {
        border-top: 1px solid var(--border-color);
        padding: 1rem 1.5rem;
    }

    /* Mapa */
    #mapContainer {
        height: 500px;
        width: 100%;
        border-radius: 0.75rem;
        box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.05);
        z-index: 1;
    }

    /* Insights cards */
    .insight-card {
        background: var(--card-bg);
        border-radius: 0.75rem;
        padding: 1.25rem;
        box-shadow: var(--card-shadow);
        border-left: 4px solid;
        height: 100%;
        transition: transform 0.3s ease;
    }

    .insight-card:hover {
        transform: translateY(-5px);
    }

    .insight-card.danger {
        border-left-color: #e74a3b;
    }

    .insight-card.warning {
        border-left-color: #f6c23e;
    }

    .insight-card.info {
        border-left-color: #36b9cc;
    }

    .insight-card.success {
        border-left-color: #1cc88a;
    }

    .insight-card-value {
        font-size: 2rem;
        font-weight: 800;
        line-height: 1;
        margin-bottom: 0.5rem;
        color: var(--text-primary);
    }

    .insight-card-label {
        font-size: 0.85rem;
        color: var(--text-secondary);
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    /* Tooltip customizado */
    .custom-tooltip {
        background: var(--card-bg) !important;
        color: var(--text-primary) !important;
        padding: 0.5rem 0.75rem !important;
        border-radius: 0.5rem !important;
        font-size: 0.85rem !important;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3) !important;
        border: 1px solid var(--border-color) !important;
    }

    /* Animações de entrada */
    .fade-in {
        animation: fadeIn 0.6s ease-out;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(30px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* Scroll customizado para tabelas */
    .table-responsive::-webkit-scrollbar {
        height: 8px;
    }

    .table-responsive::-webkit-scrollbar-track {
        background: var(--border-color);
        border-radius: 10px;
    }

    .table-responsive::-webkit-scrollbar-thumb {
        background: var(--text-muted);
        border-radius: 10px;
    }

    .table-responsive::-webkit-scrollbar-thumb:hover {
        background: var(--text-secondary);
    }

    /* Highcharts no modo escuro */
    body.dark-mode .highcharts-background {
        fill: var(--card-bg);
    }

    body.dark-mode .highcharts-title,
    body.dark-mode .highcharts-axis-title,
    body.dark-mode .highcharts-axis-labels text {
        fill: var(--text-primary) !important;
        color: var(--text-primary) !important;
    }

    body.dark-mode .highcharts-grid-line {
        stroke: var(--border-color);
    }

    /* ---------- RESPONSIVIDADE DA TABELA ---------- */
    @media (max-width: 1199.98px) {
        .modern-table th,
        .modern-table td {
            font-size: 0.9rem;
            padding: 0.875rem 0.625rem;
        }
    }

    @media (max-width: 991.98px) {
        .modern-table th,
        .modern-table td {
            font-size: 0.85rem;
            padding: 0.75rem 0.5rem;
        }
        
        .modern-table thead th:nth-child(4),
        .modern-table thead th:nth-child(5),
        .modern-table tbody td:nth-child(4),
        .modern-table tbody td:nth-child(5) {
            display: none;
        }
        
        .modern-badge {
            padding: 0.35rem 0.65rem;
            font-size: 0.75rem;
            min-width: 55px;
        }
        
        .action-btn {
            width: 34px;
            height: 34px;
            margin: 0 2px;
        }
        
        .action-btn i {
            font-size: 0.85rem;
        }
    }

    @media (max-width: 767.98px) {
        .modern-table {
            display: block;
            overflow-x: auto;
            white-space: nowrap;
        }
        
        .modern-table thead {
            display: none;
        }
        
        .modern-table tbody {
            display: block;
        }
        
        .modern-table tbody tr {
            display: block;
            margin-bottom: 1rem;
            border: 1px solid var(--border-color);
            border-radius: 0.75rem;
            padding: 1rem;
            background: var(--card-bg);
            box-shadow: var(--card-shadow);
        }
        
        .modern-table tbody tr:hover {
            transform: translateY(-3px);
        }
        
        .modern-table tbody td {
            display: block;
            padding: 0.5rem 0;
            border-bottom: 1px solid var(--border-color);
            text-align: right;
            position: relative;
            padding-left: 50%;
            white-space: normal;
        }
        
        .modern-table tbody td:last-child {
            border-bottom: none;
            padding-top: 1rem;
            padding-left: 0;
            text-align: center;
        }
        
        .modern-table tbody td::before {
            content: attr(data-label);
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            text-align: left;
            width: calc(50% - 1rem);
        }
        
        .modern-table tbody td:first-child::before {
            content: "Rota";
        }
        
        .modern-table tbody td:nth-child(2)::before {
            content: "Início";
        }
        
        .modern-table tbody td:nth-child(3)::before {
            content: "Destino";
        }
        
        .modern-table tbody td:nth-child(6)::before {
            content: "Vel. Atual";
        }
        
        .modern-table tbody td:nth-child(7)::before {
            content: "Tempo Atual";
        }
        
        .modern-table tbody td:nth-child(8)::before {
            content: "Atraso";
        }
        
        .modern-table tbody td:nth-child(9)::before {
            content: "Ações";
        }
        
        /* Ocultar colunas menos importantes em mobile */
        .modern-table tbody td:nth-child(4),
        .modern-table tbody td:nth-child(5) {
            display: none;
        }
        
        /* Ajustar conteúdo das células */
        .modern-table .fw-bold {
            font-size: 0.9rem;
        }
        
        .modern-table small.text-muted {
            font-size: 0.75rem;
        }
        
        /* Badge de atraso */
        .modern-badge {
            min-width: 50px;
            padding: 0.3rem 0.6rem;
        }
        
        /* Container da tabela */
        .table-responsive {
            border: none;
            padding: 0;
        }
    }

    @media (max-width: 575.98px) {
        .modern-table tbody tr {
            padding: 0.75rem;
            margin-bottom: 0.75rem;
        }
        
        .modern-table tbody td {
            padding: 0.4rem 0;
            font-size: 0.8rem;
            padding-left: 45%;
        }
        
        .modern-table tbody td::before {
            font-size: 0.75rem;
            width: calc(45% - 1rem);
        }
        
        .action-btn {
            width: 32px;
            height: 32px;
        }
        
        .empty-state {
            padding: 2rem 1rem;
        }
        
        .empty-state i {
            font-size: 3.5rem;
        }
        
        .empty-state h5 {
            font-size: 1rem;
        }
        
        .empty-state p {
            font-size: 0.85rem;
        }
    }

    /* ---------- RESPONSIVIDADE DO MODAL ---------- */
    @media (max-width: 1199.98px) {
        .custom-modal .modal-xl {
            max-width: 95%;
            margin: 0.5rem auto;
        }
    }

    @media (max-width: 991.98px) {
        .custom-modal .modal-xl {
            max-width: 100%;
            margin: 0;
        }
        
        #mapContainer {
            height: 400px;
        }
        
        .modal-body .row {
            flex-direction: column;
        }
        
        .modal-body .col-lg-8,
        .modal-body .col-lg-4 {
            width: 100%;
            max-width: 100%;
        }
        
        .modal-body .col-lg-4 {
            margin-top: 1.5rem;
        }
        
        #heatmapChart {
            height: 150px;
            margin-top: 1rem;
        }
        
        #lineChartContainer {
            height: 200px;
        }
        
        .insight-card {
            padding: 1rem;
        }
        
        .insight-card-value {
            font-size: 1.5rem;
        }
        
        .insight-card-label {
            font-size: 0.8rem;
        }
    }

    @media (max-width: 767.98px) {
        .custom-modal .modal-dialog {
            margin: 0;
            max-height: 90vh;
        }
        
        .custom-modal .modal-content {
            border-radius: 0.5rem;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            padding: 1rem;
        }
        
        .modal-body {
            padding: 1rem !important;
            max-height: calc(90vh - 130px);
            overflow-y: auto;
        }
        
        #mapContainer {
            height: 300px;
        }
        
        .insight-card {
            margin-bottom: 0.5rem;
        }
        
        .modal-footer {
            padding: 0.75rem 1rem;
        }
        
        /* Ajustar layout dos insights em grid 2x2 */
        #insightsContainer .col-6 {
            width: 50%;
            padding: 0.25rem;
        }
    }

    @media (max-width: 575.98px) {
        #mapContainer {
            height: 250px;
        }
        
        #heatmapChart {
            height: 120px;
        }
        
        #lineChartContainer {
            height: 180px;
        }
        
        .insight-card-value {
            font-size: 1.25rem;
        }
        
        .modal-title {
            font-size: 1rem;
        }
        
        .modal-header .btn-close {
            width: 24px;
            height: 24px;
            background-size: 12px;
        }
    }

    /* ---------- MELHORIAS PARA TABLETS ---------- */
    @media (min-width: 768px) and (max-width: 991.98px) {
        .modern-table th,
        .modern-table td {
            padding: 0.875rem 0.625rem;
        }
        
        .modern-table thead th:nth-child(4),
        .modern-table thead th:nth-child(5),
        .modern-table tbody td:nth-child(4),
        .modern-table tbody td:nth-child(5) {
            display: table-cell;
        }
        
        /* Ajustar largura das colunas */
        .modern-table th:nth-child(1),
        .modern-table td:nth-child(1) {
            width: 25%;
        }
        
        .modern-table th:nth-child(2),
        .modern-table td:nth-child(2),
        .modern-table th:nth-child(3),
        .modern-table td:nth-child(3) {
            width: 15%;
        }
        
        .modern-table th:nth-child(9),
        .modern-table td:nth-child(9) {
            width: 8%;
        }
    }

    /* ---------- ANIMAÇÕES RESPONSIVAS ---------- */
    @media (prefers-reduced-motion: reduce) {
        .fade-in,
        .modern-table tbody tr,
        .action-btn,
        .insight-card,
        .modern-card {
            animation: none;
            transition: none;
        }
    }

    /* ---------- SUPORTE PARA ORIENTAÇÃO ---------- */
    @media (orientation: landscape) and (max-height: 600px) {
        .custom-modal .modal-dialog {
            max-height: 80vh;
        }
        
        .modal-body {
            max-height: calc(80vh - 130px);
        }
        
        #mapContainer {
            height: 250px;
        }
    }

    /* Ajustes para DataTables responsivo */
    .dataTables_wrapper {
        width: 100%;
    }
    
    .dataTables_wrapper .dataTables_length,
    .dataTables_wrapper .dataTables_filter,
    .dataTables_wrapper .dataTables_info,
    .dataTables_wrapper .dataTables_paginate {
        padding: 0.5rem;
    }
    
    @media (max-width: 767.98px) {
        .dataTables_wrapper .dataTables_length,
        .dataTables_wrapper .dataTables_filter {
            float: none;
            text-align: center;
            margin-bottom: 0.5rem;
        }
        
        .dataTables_wrapper .dataTables_filter input {
            width: 100%;
            max-width: 300px;
            margin: 0 auto;
        }
    }
</style>
<div class="container-fluid px-3 px-lg-4 mt-4">
    <!-- Header da Página -->
    <div class="page-header fade-in">
        <div class="d-flex justify-content-between align-items-start flex-wrap gap-3">
            <div>
                <h1>
                    <i class="fas fa-route me-2"></i>
                    ROTAS Monitoradas
                </h1>
                <p class="subtitle mb-0">
                    Monitoramento inteligente de rotas e tempo de viagem
                </p>
            </div>
            <div class="d-flex align-items-center gap-3">
                <span class="badge bg-success">
                    <i class="fas fa-sync-alt me-1"></i>
                    Atualizado em tempo real
                </span>
            </div>
        </div>
    </div>
    <!-- Cards de Estatísticas de Rotas -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6 mb-3 fade-in">
            <div class="insight-card success">
                <div class="insight-card-value">
                    {{ routes|length }}
                </div>
                <div class="insight-card-label">
                    Total de Rotas
                </div>
                <small class="text-muted">
                    Monitoradas ativamente
                </small>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-3 fade-in" style="animation-delay: 0.1s;">
            {% set delayed_routes = 0 %}
            {% for route in routes %}
                {% set delay_minutes = ((route.avg_time|default(0) - route.historic_time|default(0)) / 60) %}
                {% if delay_minutes > 1 %}
                    {% set delayed_routes = delayed_routes + 1 %}
                {% endif %}
            {% endfor %}
            <div class="insight-card
                    {% if delayed_routes > (routes|length * 0.5) %}
                    danger
                    {% elseif delayed_routes > 0 %}
                    warning
                    {% else %}
                    info
                    {% endif %}
                ">
                <div class="insight-card-value">
                    {{ delayed_routes }}
                </div>
                <div class="insight-card-label">
                    Rotas com Atraso
                </div>
                <small class="text-muted">
                    > 1 minuto de atraso
                </small>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-3 fade-in" style="animation-delay: 0.2s;">
            <div class="insight-card info">
                <div class="insight-card-value">
                    {% set total_length = 0 %}
                    {% for route in routes %}
                        {% set total_length = total_length + (route.length|default(0) / 1000) %}
                    {% endfor %}
                    {{ total_length|number_format(1) }}
                    km
                </div>
                <div class="insight-card-label">
                    Extensão Total
                </div>
                <small class="text-muted">
                    Soma de todas as rotas
                </small>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-3 fade-in" style="animation-delay: 0.3s;">
            <div class="insight-card warning">
                <div class="insight-card-value">
                    {% if routes|length > 0 %}
                        {% set avg_delay = 0 %}
                        {% for route in routes %}
                            {% set delay_minutes = ((route.avg_time|default(0) - route.historic_time|default(0)) / 60) %}
                            {% set avg_delay = avg_delay + delay_minutes %}
                        {% endfor %}
                        {{ (avg_delay / routes|length)|number_format(1) }}
                        min
                    {% else %}
                        0.0 min
                    {% endif %}
                </div>
                <div class="insight-card-label">
                    Atraso Médio
                </div>
                <small class="text-muted">
                    Por rota
                </small>
            </div>
        </div>
    </div>
    <!-- Card de Rotas -->
    <div class="row mb-4">
        <div class="col-12 fade-in">
            <div class="card modern-card">
                <div class="modern-card-header bg-info-gradient">
                    <span>
                        <i class="fas fa-route me-2"></i>
                        Detalhes das Rotas Monitoradas
                    </span>
                    {% if routes is not empty %}
                        <span class="badge-counter">
                            {{ routes|length }}
                            rotas
                        </span>
                    {% endif %}
                </div>
                <div class="card-body p-0 position-relative">
                    {% if routes is not empty %}
                        <div class="table-responsive">
                            <table class="table modern-table" id="routesTable">
                                <thead>
                                    <tr>
                                        <th>
                                            Nome da Rota
                                        </th>
                                        <th>
                                            Início
                                        </th>
                                        <th>
                                            Fim
                                        </th>
                                        <th class="d-none d-lg-table-cell text-center">
                                            Vel. Normal
                                        </th>
                                        <th class="d-none d-lg-table-cell text-center">
                                            Tempo Normal
                                        </th>
                                        <th class="text-center">
                                            Vel. Atual
                                        </th>
                                        <th class="text-center">
                                            Tempo Atual
                                        </th>
                                        <th class="text-center">
                                            Atraso
                                        </th>
                                        <th class="text-center">
                                            Ações
                                        </th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for route in routes %}
                                        {% set historic_time = route.historic_time|default(0) %}
                                        {% set avg_time = route.avg_time|default(0) %}
                                        {% set delay_minutes = (avg_time - historic_time) / 60 %}
                                        <tr class="fade-in route-row" style="animation-delay: {{ loop.index0 * 0.05 }}s;" data-route-id="{{ route.id }}" data-route-name="{{ route.name }}" data-from-name="{{ route.from_name }}" data-to-name="{{ route.to_name }}" data-from-lat="{{ route.from_lat|default(-20.66) }}" data-from-lon="{{ route.from_lon|default(-43.79) }}" data-to-lat="{{ route.to_lat|default(-20.67) }}" data-to-lon="{{ route.to_lon|default(-43.78) }}" data-historic-speed="{{ route.historic_speed|default(60) }}" data-avg-speed="{{ route.avg_speed|default(45) }}" data-historic-time="{{ route.historic_time|default(1800) }}" data-avg-time="{{ route.avg_time|default(2400) }}" data-length="{{ route.length|default(15000) }}">
                                            <td data-label="Rota">
                                                <div class="fw-bold text-primary">
                                                    {{ route.name }}
                                                </div>
                                                <small class="text-muted d-lg-none">
                                                    <i class="fas fa-flag-checkered me-1"></i>
                                                    {{ route.from_name }}
                                                    →
                                                    {{ route.to_name }}
                                                </small>
                                            </td>
                                            <td data-label="Início">
                                                <span class="text-truncate d-inline-block" style="max-width: 150px;">
                                                    <i class="fas fa-map-marker-alt text-success me-1"></i>
                                                    {{ route.from_name }}
                                                </span>
                                            </td>
                                            <td data-label="Destino">
                                                <span class="text-truncate d-inline-block" style="max-width: 150px;">
                                                    <i class="fas fa-flag-checkered text-danger me-1"></i>
                                                    {{ route.to_name }}
                                                </span>
                                            </td>
                                            <td class="d-none d-lg-table-cell text-center" data-label="Vel. Normal">
                                                <div class="fw-bold">
                                                    {{ route.historic_speed|default(0)|number_format(1) }}
                                                </div>
                                                <small class="text-muted">
                                                    km/h
                                                </small>
                                            </td>
                                            <td class="d-none d-lg-table-cell text-center" data-label="Tempo Normal">
                                                <div class="fw-bold">
                                                    {{ (historic_time / 60)|number_format(1) }}
                                                </div>
                                                <small class="text-muted">
                                                    min
                                                </small>
                                            </td>
                                            <td class="text-center" data-label="Vel. Atual">
                                                <div class="fw-bold
                                                        {% if route.avg_speed < route.historic_speed * 0.7 %}
                                                        text-danger
                                                        {% elseif route.avg_speed < route.historic_speed * 0.9 %}
                                                        text-warning
                                                        {% else %}
                                                        text-success
                                                        {% endif %}
                                                    ">
                                                    {{ route.avg_speed|default(0)|number_format(1) }}
                                                </div>
                                                <small class="text-muted">
                                                    km/h
                                                </small>
                                            </td>
                                            <td class="text-center" data-label="Tempo Atual">
                                                <div class="fw-bold">
                                                    {{ (avg_time / 60)|number_format(1) }}
                                                </div>
                                                <small class="text-muted">
                                                    min
                                                </small>
                                            </td>
                                            <td class="text-center" data-label="Atraso">
                                                <span class="modern-badge
                                                        {% if delay_minutes > 5 %}
                                                        badge-danger
                                                        {% elseif delay_minutes > 1 %}
                                                        badge-warning
                                                        {% else %}
                                                        badge-success
                                                        {% endif %}
                                                    ">
                                                    {{ delay_minutes|number_format(1) }}
                                                    min
                                                </span>
                                            </td>
                                            <td class="text-center" data-label="Ações">
                                                <button class="btn btn-info action-btn view-route" data-bs-toggle="modal" data-bs-target="#mapModal" title="Ver detalhes da rota">
                                                    <i class="fas fa-map-marker-alt"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="empty-state">
                            <i class="fas fa-route"></i>
                            <h5>
                                Nenhuma rota monitorada
                            </h5>
                            <p>
                                Não há rotas configuradas ou dados disponíveis no momento.
                            </p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Modal de Detalhes da Rota -->
<div class="modal fade custom-modal" id="mapModal" tabindex="-1" aria-labelledby="mapModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalRouteName">
                    <i class="fas fa-route me-2"></i>
                    Detalhes da Rota
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="loadingIndicator" class="loading-overlay" style="display: none;">
                    <div class="spinner"></div>
                    <div class="loading-text">
                        Carregando dados da rota...
                    </div>
                </div>
                <div class="row">
                    <div class="col-lg-8 mb-4 mb-lg-0">
                        <div id="mapContainer" class="rounded" style="height: 500px;"></div>
                        <div class="mt-3">
                            <div id="heatmapChart" style="height: 200px; border-radius: 0.75rem; overflow: hidden;"></div>
                        </div>
                    </div>
                    <div class="col-lg-4">
                        <div class="card modern-card h-100">
                            <div class="modern-card-header bg-primary-gradient">
                                <span>
                                    <i class="fas fa-chart-bar me-2"></i>
                                    Insights da Rota
                                </span>
                            </div>
                            <div class="card-body">
                                <div id="insightsContainer" class="row g-3"><!-- Conteúdo será inserido aqui via JavaScript -->
                                </div>
                                <div id="lineChartContainer" class="mt-4" style="height: 250px;"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    Fechar
                </button>
            </div>
        </div>
    </div>
</div>
<script>
    // Cache em memória das rotas
    const routeCache = {};

    console.log('Script de rotas carregado');

document.addEventListener("DOMContentLoaded", function () {

    let routeMap = null;
    let routeLine = null;

    // ================================
    // CLICK NO BOTÃO "VER ROTA"
    // ================================
    $(document).on('click', '.view-route', async function () {

        const row = $(this).closest('tr');

        const routeData = {
            id: row.data('route-id'),
            name: row.data('route-name'),
            from_name: row.data('from-name'),
            to_name: row.data('to-name'),
            historic_speed: parseFloat(row.data('historic-speed')),
            avg_speed: parseFloat(row.data('avg-speed')),
            historic_time: parseFloat(row.data('historic-time')),
            avg_time: parseFloat(row.data('avg-time')),
            length: parseFloat(row.data('length'))
        };

        console.log('Carregando detalhes da rota:', routeData);

        document.getElementById('modalRouteName').innerHTML =
            `<i class="fas fa-route me-2"></i>${routeData.name} (${routeData.from_name} → ${routeData.to_name})`;

        $('#mapContainer').empty();
        $('#insightsContainer').empty();
        $('#lineChartContainer').empty();
        $('#heatmapChart').empty();

        renderInsights(routeData);
        await loadRouteLines(routeData.id, routeData);
        initCharts(routeData);
    });

    // ================================
    // CARREGA ROTA PELO BACKEND
    // ================================
    async function loadRouteLines(routeId, routeData) {

    try {

        // ✅ USAR CACHE SE EXISTIR
        let lines;
        if (routeCache[routeId]) {
            console.log('Rota carregada do cache:', routeId);
            lines = routeCache[routeId];
        } else {
            const response = await fetch(
                `/api.php?action=get_route_lines&route_id=${encodeURIComponent(routeId)}`
            );

            if (!response.ok) {
                throw new Error('Erro ao buscar rota');
            }

            lines = await response.json();

            if (!Array.isArray(lines) || lines.length === 0) {
                throw new Error('Nenhuma coordenada encontrada');
            }

            // Ordenar e salvar no cache
            lines.sort((a, b) => (a.sequence ?? 0) - (b.sequence ?? 0));
            routeCache[routeId] = lines;
        }

        // Converter para Leaflet
        const latLngs = lines.map(p => [parseFloat(p.y), parseFloat(p.x)]);

        // Reset mapa
        if (routeMap) {
            routeMap.remove();
            routeMap = null;
        }

        routeMap = L.map('mapContainer');
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap',
            maxZoom: 19
        }).addTo(routeMap);

        const routeColor = getRouteColor(routeData);

        // ✅ POLYLINE ANIMADA
        routeLine = L.polyline([], {
            color: routeColor,
            weight: 5,
            opacity: 0.9,
            lineJoin: 'round'
        }).addTo(routeMap);

        routeMap.fitBounds(latLngs, { padding: [40, 40] });

        // Animação do desenho
        let i = 0;
        const drawInterval = setInterval(() => {
            if (i >= latLngs.length) {
                clearInterval(drawInterval);
                return;
            }
            routeLine.addLatLng(latLngs[i]);
            i++;
        }, 10); // velocidade do desenho

        // Marcadores
        L.marker(latLngs[0]).addTo(routeMap).bindPopup('Início da rota');
        L.marker(latLngs[latLngs.length - 1]).addTo(routeMap).bindPopup('Fim da rota');

        setTimeout(() => routeMap.invalidateSize(), 300);

    } catch (err) {
        console.error(err);
        alert('Erro ao carregar rota no mapa');
    }
}

    // ================================
    // INSIGHTS
    // ================================
    function renderInsights(routeData) {

        const delay = ((routeData.avg_time - routeData.historic_time) / 60).toFixed(1);
        const km = (routeData.length / 1000).toFixed(2);

        document.getElementById('insightsContainer').innerHTML = `
            <div class="col-6">
                <div class="insight-card ${delay > 5 ? 'danger' : delay > 1 ? 'warning' : 'success'}">
                    <div class="insight-card-value">${delay}</div>
                    <div class="insight-card-label">Atraso (min)</div>
                </div>
            </div>
            <div class="col-6">
                <div class="insight-card info">
                    <div class="insight-card-value">${km}</div>
                    <div class="insight-card-label">Distância (km)</div>
                </div>
            </div>
            <div class="col-6">
                <div class="insight-card ${delay > 5 ? 'danger' : delay > 1 ? 'warning' : 'success'}">
                    <div class="insight-card-value">${avg_time}</div>
                    <div class="insight-card-label">Atraso (min)</div>
                </div>
            </div>
            <div class="col-6">
                <div class="insight-card info">
                    <div class="insight-card-value">${historic_time}</div>
                    <div class="insight-card-label">Distância (km)</div>
                </div>
            </div>
        `;
    }

    // ================================
    // CHARTS (mantido)
    // ================================
    function initCharts(routeData) {
        Highcharts.chart('lineChartContainer', {
            chart: { backgroundColor: 'transparent' },
            title: { text: 'Velocidade da Rota' },
            xAxis: { categories: ['00h', '06h', '12h', '18h'] },
            series: [{
                name: 'Atual',
                data: [
                    routeData.avg_speed * 0.9,
                    routeData.avg_speed,
                    routeData.avg_speed * 0.95,
                    routeData.avg_speed * 0.85
                ]
            }, {
                name: 'Histórica',
                data: [
                    routeData.historic_speed,
                    routeData.historic_speed,
                    routeData.historic_speed,
                    routeData.historic_speed
                ],
                dashStyle: 'Dash'
            }],
            credits: { enabled: false }
        });
    }

    // ================================
    // LIMPEZA AO FECHAR MODAL
    // ================================
    $('#mapModal').on('hidden.bs.modal', function () {
        if (routeMap) {
            routeMap.remove();
            routeMap = null;
        }
    });

    // ================================
    // Gera Cores para as rotas
    // ================================
    function getRouteColor(routeData) {
        const delay = (routeData.avg_time - routeData.historic_time) / 60;

        if (delay > 5) return '#e74a3b';   // vermelho
        if (delay > 1) return '#f6c23e';   // amarelo
        return '#1cc88a';                 // verde
    }
});
</script>
