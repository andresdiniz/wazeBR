{% extends 'layouts/base.twig' %}

{% block title %}Rotas{% endblock %}

{% block head_links %}
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script src="https://code.highcharts.com/highcharts.js"></script>
    <script src="https://code.highcharts.com/modules/heatmap.js"></script>
    <script src="https://code.highcharts.com/modules/exporting.js"></script>

    {{ parent() }}

    <style>
        /* Estilos base (reutilizados) */
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --success-gradient: linear-gradient(135deg, #1cc88a 0%, #13855c 100%);
            --warning-gradient: linear-gradient(135deg, #f6c23e 0%, #dda20a 100%);
            --danger-gradient: linear-gradient(135deg, #e74a3b 0%, #be2617 100%);
            --info-gradient: linear-gradient(135deg, #36b9cc 0%, #258391 100%);
            --card-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
            --text-primary: #4e73df;
            --text-secondary: #858796;
            --border-color: #e3e6f0;
        }

        /* Melhoria de Responsividade para Tabela */
        /* Garante que o container da tabela DataTables se ajuste bem no mobile */
        .dataTables_wrapper {
            padding-bottom: 20px; /* Espaço para paginação */
        }

        /* Estilo para a coluna de detalhes (o '+' que abre os dados no mobile) */
        #routesTable.dtr-inline.collapsed > tbody > tr > td:first-child:before,
        #routesTable.dtr-inline.collapsed > tbody > tr > th:first-child:before {
            background-color: var(--text-primary);
            border-radius: 50%;
            top: 14px;
            left: 5px;
            height: 15px;
            width: 15px;
            text-align: center;
            line-height: 15px;
            color: white;
            box-shadow: 0 0 3px rgba(0, 0, 0, 0.3);
        }

        /* Estilos específicos do Modal */
        #mapContainer {
            height: 400px;
            width: 100%;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .insight-card {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            color: white;
            box-shadow: var(--card-shadow);
            transition: transform 0.2s ease;
        }

        .insight-card:hover {
            transform: translateY(-2px);
        }

        .insight-card.danger { background: var(--danger-gradient); }
        .insight-card.warning { background: var(--warning-gradient); }
        .insight-card.success { background: var(--success-gradient); }
        .insight-card.info { background: var(--info-gradient); }

        .insight-card-value {
            font-size: 2.0rem;
            font-weight: 700;
        }

        .insight-card-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        /* Loading Indicator */
        #loadingIndicator {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            z-index: 1000;
            display: none; /* Inicia oculto */
            align-items: center;
            justify-content: center;
            flex-direction: column;
            border-radius: 8px;
        }

        #loadingIndicator i {
            font-size: 2rem;
            color: var(--text-primary);
        }
    </style>
{% endblock %}

{% block content %}

<div class="container-fluid">

    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-gray-800"><i class="fas fa-route me-2"></i> Dashboard de Rotas</h1>
        <span id="currentTime" class="text-muted d-none d-sm-inline-block"></span>
    </div>

    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">Rotas Monitoradas</h6>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-bordered" id="routesTable" width="100%" cellspacing="0">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Nome</th>
                            <th>Origem</th>
                            <th>Destino</th>
                            <th>V. Média (km/h)</th>
                            <th>V. Histórica (km/h)</th>
                            <th>T. Médio (min)</th>
                            <th>T. Histórico (min)</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for route in routes %}
                        <tr data-route-id="{{ route.id }}">
                            <td>{{ route.id }}</td>
                            <td>{{ route.name }}</td>
                            <td>{{ route.from_name }}</td>
                            <td>{{ route.to_name }}</td>
                            <td>{{ route.avg_speed|number_format(1, ',', '.') }}</td>
                            <td>{{ route.historic_speed|number_format(1, ',', '.') }}</td>
                            <td>{{ (route.avg_time / 60)|number_format(1, ',', '.') }}</td>
                            <td>{{ (route.historic_time / 60)|number_format(1, ',', '.') }}</td>
                            <td>
                                <button class="btn btn-sm btn-primary view-route"
                                        data-bs-toggle="modal"
                                        data-bs-target="#mapModal"
                                        title="Ver detalhes da rota">
                                    <i class="fas fa-eye"></i> Detalhes
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                        </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="mapModal" tabindex="-1" role="dialog" aria-labelledby="mapModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl" role="document">
        <div class="modal-content">
            <div id="loadingIndicator">
                <i class="fas fa-sync-alt fa-spin"></i>
                <p class="mt-2 text-primary">Carregando dados...</p>
            </div>
            <div class="modal-header">
                <h5 class="modal-title text-primary" id="modalRouteName">Detalhes da Rota</h5>
                <button class="btn-close" type="button" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-lg-6 mb-4">
                        <div id="mapContainer"></div>
                    </div>
                    
                    <div class="col-lg-6">
                        <h6 class="text-gray-800 mb-3">Insights de Tráfego</h6>
                        <div class="row" id="insightsContainer">
                            </div>
                    </div>
                </div>

                <hr>

                <div class="row">
                    <div class="col-lg-6 mb-4">
                        <div id="lineChartContainer" style="height: 300px;"></div>
                    </div>
                    
                    <div class="col-lg-6 mb-4">
                        <div id="heatmapChart" style="height: 300px;"></div>
                    </div>
                </div>

            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" type="button" data-bs-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block custom_scripts %}
<script>
document.addEventListener("DOMContentLoaded", function () {
    
    // Inicializar Tooltips do Bootstrap
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[title]'));
    tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl, {
            customClass: 'custom-tooltip'
        });
    });

    // Configuração do DataTable (Ajustada para Responsividade)
    if ($('#routesTable').length) {
        $('#routesTable').DataTable({
            language: {
                url: '//cdn.datatables.net/plug-ins/1.10.25/i18n/Portuguese-Brasil.json'
            },
            // ESSENCIAL PARA TELAS PEQUENAS: Habilita colapsamento de colunas e o ícone '+'
            responsive: true, 
            // Permite rolagem horizontal para garantir que todos os dados caibam
            scrollX: true, 
            pageLength: 10,
            lengthMenu: [[10, 25, 50, -1], [10, 25, 50, "Todos"]],
            order: [[0, 'asc']],
            columnDefs: [
                { orderable: false, targets: [8] }, // Coluna de Ações
                // DataTables define automaticamente quais colunas colapsar.
                // A coluna de ações (index 8) será movida para a linha de detalhes
                // acessível pelo ícone '+' em telas pequenas.
            ],
            dom: '<"row mb-3"<"col-sm-12 col-md-6"l><"col-sm-12 col-md-6"f>>' +
                 '<"row"<"col-sm-12"tr>>' +
                 '<"row mt-3"<"col-sm-12 col-md-5"i><"col-sm-12 col-md-7"p>>',
            initComplete: function() {
                console.log('Tabela de rotas carregada com sucesso');
            }
        });
    }

    // Variável global para armazenar o mapa
    let routeMap = null;
    // Variável global para armazenar os dados da rota após o AJAX
    let currentRouteData = null; 

    // BLOCO DE LÓGICA: Busca de detalhes da rota via API (mantido da correção anterior)
    function fetchRouteDetails(routeId) {
        const loadingIndicator = document.getElementById('loadingIndicator');
        // Exibe o loading
        if (loadingIndicator) loadingIndicator.style.display = 'flex'; 

        // Limpa containers visuais antes da nova requisição
        $('#insightsContainer').empty();
        $('#lineChartContainer').empty();
        $('#heatmapChart').empty();
        
        // Limpa o mapa existente (importante para evitar flashes)
        $('#mapContainer').empty(); 
        if (routeMap) { 
            routeMap.remove();
            routeMap = null;
        }

        $.ajax({
            url: 'api.php', 
            type: 'POST',
            data: {
                action: 'get_route_details', 
                route_id: routeId
            },
            dataType: 'json',
            success: function (response) {
                if (loadingIndicator) loadingIndicator.style.display = 'none'; 

                if (response.status === 'success' && response.data) {
                    currentRouteData = response.data; // ARMAZENA DADOS GLOBALMENTE
                    
                    // Atualiza o conteúdo textual e gráficos (SEM O MAPA)
                    updateModalContent(currentRouteData); 

                    // Se o modal já estiver aberto (transição foi rápida), inicializa o mapa
                    if ($('#mapModal').hasClass('show')) {
                        initMap(currentRouteData);
                    }

                } else {
                    alert('Erro ao carregar detalhes da rota: ' + (response.message || 'Resposta inválida da API.'));
                    console.error('API Error:', response.message);
                }
            },
            error: function (xhr, status, error) {
                if (loadingIndicator) loadingIndicator.style.display = 'none'; 
                alert('Erro de comunicação com o servidor. Verifique o caminho da api.php.');
                console.error('AJAX Error:', status, error);
            }
        });
    }
    
    // Configuração dos botões de visualização de rota
    $(document).on('click', '.view-route', function () {
        const row = $(this).closest('tr');
        const routeId = row.data('route-id'); 
        
        // Inicia a busca na API e a abertura do modal é feita pelo data-bs-target
        fetchRouteDetails(routeId);
    });

    // Função para atualizar o conteúdo do modal
    function updateModalContent(routeData) {
        // Atualizar título do modal
        document.getElementById('modalRouteName').innerHTML = 
            `<i class="fas fa-route me-2"></i>${routeData.name} (${routeData.from_name} → ${routeData.to_name})`;

        // Calcular estatísticas
        const delayMinutes = ((routeData.avg_time - routeData.historic_time) / 60).toFixed(1);
        const lengthKM = (routeData.length / 1000).toFixed(2);
        const timeIncrease = routeData.historic_time > 0 ?
            ((routeData.avg_time - routeData.historic_time) / routeData.historic_time * 100).toFixed(1) : 0;
        const speedReduction = routeData.historic_speed > 0 ?
            ((routeData.historic_speed - routeData.avg_speed) / routeData.historic_speed * 100).toFixed(1) : 0;
        
        // Atualizar insights
        const insightsContainer = document.getElementById('insightsContainer');
        insightsContainer.innerHTML = `
            <div class="col-6">
                <div class="insight-card ${delayMinutes > 5 ? 'danger' : delayMinutes > 1 ? 'warning' : 'success'}">
                    <div class="insight-card-value">${delayMinutes}</div>
                    <div class="insight-card-label">Atraso Atual</div>
                    <small class="text-muted">minutos</small>
                </div>
            </div>
            <div class="col-6">
                <div class="insight-card ${speedReduction > 30 ? 'danger' : speedReduction > 10 ? 'warning' : 'success'}">
                    <div class="insight-card-value">${routeData.avg_speed.toFixed(1)}</div>
                    <div class="insight-card-label">Velocidade Média</div>
                    <small class="text-muted">km/h</small>
                </div>
            </div>
            <div class="col-6">
                <div class="insight-card info">
                    <div class="insight-card-value">${lengthKM}</div>
                    <div class="insight-card-label">Distância</div>
                    <small class="text-muted">quilômetros</small>
                </div>
            </div>
            <div class="col-6">
                <div class="insight-card ${timeIncrease > 30 ? 'warning' : timeIncrease > 10 ? 'info' : 'success'}">
                    <div class="insight-card-value">${timeIncrease}%</div>
                    <div class="insight-card-label">Aumento no Tempo</div>
                    <small class="text-muted">vs. histórico</small>
                </div>
            </div>
        `;
        
        // Inicializar gráficos
        initCharts(routeData);
    }

    // Função para inicializar o mapa Leaflet
    function initMap(routeData) {
        const mapContainer = document.getElementById('mapContainer');
        
        // Se já existe um mapa, remover (Garantia)
        if (routeMap) {
            routeMap.remove();
            routeMap = null;
        }
        
        // Criar novo mapa centralizado no ponto de partida
        routeMap = L.map('mapContainer').setView([routeData.from_lat, routeData.from_lon], 13);
        
        // Adicionar tile layer
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors',
            maxZoom: 19
        }).addTo(routeMap);

        // Gerar pontos intermediários para criar uma rota visual (simulação)
        const points = generateRoutePoints(
            [routeData.from_lat, routeData.from_lon],
            [routeData.to_lat, routeData.to_lon],
            10 // Número de pontos intermediários
        );

        // Criar a rota como uma linha
        const routeLine = L.polyline(points, {
            color: '#4e73df',
            weight: 5,
            opacity: 0.8,
            lineJoin: 'round',
            lineCap: 'round'
        }).addTo(routeMap);

        // Adicionar marcador de início e fim
        L.marker([routeData.from_lat, routeData.from_lon], {
            icon: L.divIcon({
                html: '<div style="background: #28a745; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">S</div>',
                className: 'custom-marker',
                iconSize: [24, 24]
            })
        }).addTo(routeMap)
        .bindPopup(`<b>${routeData.from_name}</b><br>Ponto de partida da rota`);

        L.marker([routeData.to_lat, routeData.to_lon], {
            icon: L.divIcon({
                html: '<div style="background: #dc3545; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">F</div>',
                className: 'custom-marker',
                iconSize: [24, 24]
            })
        }).addTo(routeMap)
        .bindPopup(`<b>${routeData.to_name}</b><br>Ponto de destino da rota`);

        // Ajustar o mapa para mostrar toda a rota
        const bounds = routeLine.getBounds();
        routeMap.fitBounds(bounds, { padding: [50, 50] });

        // Adicionar informações da rota como popup
        const routeInfo = `
            <div style="padding: 10px; min-width: 200px;">
                <h6 style="margin-top: 0; color: #4e73df;">${routeData.name}</h6>
                <p><strong>Distância:</strong> ${(routeData.length / 1000).toFixed(2)} km</p>
                <p><strong>Tempo normal:</strong> ${(routeData.historic_time / 60).toFixed(1)} min</p>
                <p><strong>Tempo atual:</strong> ${(routeData.avg_time / 60).toFixed(1)} min</p>
                <p><strong>Atraso:</strong> <span style="color: ${((routeData.avg_time - routeData.historic_time) / 60) > 5 ? '#dc3545' : ((routeData.avg_time - routeData.historic_time) / 60) > 1 ? '#ffc107' : '#28a745'}">
                    ${((routeData.avg_time - routeData.historic_time) / 60).toFixed(1)} min
                </span></p>
            </div>
        `;
        const middlePoint = points[Math.floor(points.length / 2)];
        L.popup()
            .setLatLng(middlePoint)
            .setContent(routeInfo)
            .openOn(routeMap);
        
        L.control.zoom({
            position: 'topright'
        }).addTo(routeMap);

        // ESSENCIAL: Invalida o tamanho do mapa após a criação
        // Isso força o Leaflet a recalcular suas dimensões, corrigindo o "bug do modal"
        setTimeout(() => {
            routeMap.invalidateSize();
        }, 100);
    }
    
    // Função auxiliar para gerar pontos de rota (simulação)
    function generateRoutePoints(start, end, numPoints) {
        const points = [start];
        const latDiff = end[0] - start[0];
        const lonDiff = end[1] - start[1];
        for (let i = 1; i < numPoints; i++) {
            const factor = i / numPoints;
            const curveFactor = Math.sin(factor * Math.PI) * 0.01;
            points.push([
                start[0] + (latDiff * factor) + (Math.random() * curveFactor - curveFactor/2),
                start[1] + (lonDiff * factor) + (Math.random() * curveFactor - curveFactor/2)
            ]);
        }
        points.push(end);
        return points;
    }

    function initCharts(routeData) {
        // Dados para o gráfico de linha (velocidade ao longo do tempo)
        const hours = ['00:00', '04:00', '08:00', '12:00', '16:00', '20:00'];
        const currentSpeeds = hours.map(() => {
            const variation = (Math.random() * 0.4) - 0.2;
            return routeData.avg_speed * (1 + variation);
        });
        const historicSpeeds = hours.map(() => {
            const variation = (Math.random() * 0.2) - 0.1;
            return routeData.historic_speed * (1 + variation);
        });
        
        // Gráfico de linha (velocidade ao longo do dia)
        Highcharts.chart('lineChartContainer', {
            title: {
                text: 'Velocidade da Rota (últimas 24h)',
                style: {
                    color: getComputedStyle(document.documentElement).getPropertyValue('--text-primary'),
                    fontSize: '14px',
                    fontWeight: 'bold'
                }
            },
            chart: {
                backgroundColor: 'transparent',
                style: {
                    fontFamily: 'inherit'
                }
            },
            yAxis: {
                title: {
                    text: 'Velocidade (km/h)',
                    style: {
                        color: getComputedStyle(document.documentElement).getPropertyValue('--text-primary')
                    }
                },
                labels: {
                    style: {
                        color: getComputedStyle(document.documentElement).getPropertyValue('--text-primary')
                    }
                },
                gridLineColor: getComputedStyle(document.documentElement).getPropertyValue('--border-color')
            },
            xAxis: {
                categories: hours,
                labels: {
                    style: {
                        color: getComputedStyle(document.documentElement).getPropertyValue('--text-primary')
                    }
                }
            },
            series: [{
                name: 'Velocidade Atual',
                data: currentSpeeds.map(speed => parseFloat(speed.toFixed(1))),
                color: '#4e73df',
                lineWidth: 3,
                marker: {
                    enabled: true,
                    radius: 4
                }
            }, {
                name: 'Velocidade Histórica',
                data: historicSpeeds.map(speed => parseFloat(speed.toFixed(1))),
                color: '#1cc88a',
                lineWidth: 2,
                dashStyle: 'dash',
                marker: {
                    enabled: false
                }
            }],
            legend: {
                itemStyle: {
                    color: getComputedStyle(document.documentElement).getPropertyValue('--text-primary')
                }
            },
            tooltip: {
                shared: true,
                crosshairs: true
            },
            credits: {
                enabled: false
            }
        });

        // Heatmap (simulação de intensidade do tráfego por segmento)
        const segments = 5;
        const intensityLevels = 3;
        const heatmapData = [];
        
        for (let segment = 0; segment < segments; segment++) {
            for (let level = 0; level < intensityLevels; level++) {
                let value;
                if (segment === Math.floor(segments/2)) {
                    value = 7 + Math.random() * 3;
                } else if (segment === 0 || segment === segments-1) {
                    value = 2 + Math.random() * 3;
                } else {
                    value = 4 + Math.random() * 3;
                }
                heatmapData.push([segment, level, value]);
            }
        }
        
        Highcharts.chart('heatmapChart', {
            chart: {
                type: 'heatmap',
                backgroundColor: 'transparent',
                marginTop: 30
            },
            title: {
                text: 'Intensidade do Tráfego por Segmento',
                style: {
                    color: getComputedStyle(document.documentElement).getPropertyValue('--text-primary'),
                    fontSize: '14px',
                    fontWeight: 'bold'
                }
            },
            xAxis: {
                title: {
                    text: 'Segmento da Rota',
                    style: {
                        color: getComputedStyle(document.documentElement).getPropertyValue('--text-primary')
                    }
                },
                categories: ['Início', '25%', '50%', '75%', 'Fim'],
                labels: {
                    style: {
                        color: getComputedStyle(document.documentElement).getPropertyValue('--text-primary')
                    }
                }
            },
            yAxis: {
                title: {
                    text: 'Nível de Congestionamento',
                    style: {
                        color: getComputedStyle(document.documentElement).getPropertyValue('--text-primary')
                    }
                },
                categories: ['Baixo', 'Médio', 'Alto'],
                reversed: true,
                labels: {
                    style: {
                        color: getComputedStyle(document.documentElement).getPropertyValue('--text-primary')
                    }
                }
            },
            colorAxis: {
                stops: [
                    [0, '#1cc88a'],
                    [0.5, '#f6c23e'],
                    [1, '#e74a3b']
                ],
                min: 0,
                max: 10,
                labels: {
                    style: {
                        color: getComputedStyle(document.documentElement).getPropertyValue('--text-primary')
                    }
                }
            },
            series: [{
                name: 'Intensidade',
                borderWidth: 1,
                borderColor: getComputedStyle(document.documentElement).getPropertyValue('--border-color'),
                data: heatmapData,
                dataLabels: {
                    enabled: true,
                    color: '#000000',
                    style: {
                        textShadow: 'none',
                        fontWeight: 'bold'
                    }
                }
            }],
            tooltip: {
                formatter: function() {
                    const levels = ['Baixo', 'Médio', 'Alto'];
                    const segments = ['Início', '25%', '50%', '75%', 'Fim'];
                    return `<b>Segmento: ${segments[this.point.x]}</b><br>
                           Nível: ${levels[this.point.y]}<br>
                           Intensidade: ${this.point.value.toFixed(1)}/10`;
                }
            },
            credits: {
                enabled: false
            }
        });
    }

    // ESSENCIAL: Iniciar o mapa SOMENTE após o modal estar totalmente aberto
    // CORREÇÃO do bug de renderização do Leaflet em modais
    $('#mapModal').on('shown.bs.modal', function () {
        // Se os dados já foram carregados e o mapa ainda não foi criado
        if (currentRouteData && !routeMap) {
             initMap(currentRouteData);
        } 
        // Se o mapa já existe (e foi inicializado), apenas garante que o tamanho está correto
        else if (routeMap) {
            setTimeout(() => {
                routeMap.invalidateSize();
            }, 300);
        }
    });

    // Limpar mapa quando o modal é fechado
    $('#mapModal').on('hidden.bs.modal', function () {
        if (routeMap) {
            routeMap.remove();
            routeMap = null;
        }
        currentRouteData = null; // Limpa os dados para garantir que um novo ID será carregado no próximo clique
    });

    // Atualizar hora atual
    function updateCurrentTime() {
        const now = new Date();
        const timeString = now.toLocaleTimeString('pt-BR');
        const dateString = now.toLocaleDateString('pt-BR');
        
        const timeElement = document.getElementById('currentTime');
        if (timeElement) {
            timeElement.textContent = `${dateString} ${timeString}`;
        }
    }

    updateCurrentTime();
    setInterval(updateCurrentTime, 1000);

    console.log('Dashboard de Rotas inicializado com sucesso!');
});
</script>
{% endblock %}