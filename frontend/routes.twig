<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Lista de Rotas</title>
    <style>
        /* Estilos b√°sicos para visualiza√ß√£o (manter ou substituir) */
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
        th { background-color: #f2f2f2; }
        /* Estilo b√°sico para o modal */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0, 0, 0, 0.5); display: none; z-index: 999;
        }
        .modal-content {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); 
            background: white; padding: 30px; border-radius: 8px; z-index: 1000;
        }
    </style>
</head>
<body>
    <h1>Rotas do Parceiro ID: {{ id_parceiro }}</h1>

    {% if routes is empty %}
        <p>Nenhuma rota encontrada para o seu parceiro.</p>
    {% else %}
        <table>
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Nome</th>
                    <th>Origem</th>
                    <th>Destino</th>
                    <th>Vel. Hist√≥rica</th>
                    <th>Tempo Hist√≥rico</th>
                    <th>Vel. M√©dia</th>
                    <th>Tempo M√©dio</th>
                    <th>A√ß√µes</th>
                </tr>
            </thead>
            <tbody>
                {% for route in routes %}
                    <tr>
                        <td>{{ route.id }}</td>
                        <td>{{ route.name }}</td>
                        <td>{{ route.from_name }}</td>
                        <td>{{ route.to_name }}</td>
                        <td>{{ route.historic_speed }}</td>
                        <td>{{ route.historic_time }}</td>
                        <td>{{ route.avg_speed }}</td>
                        <td>{{ route.avg_time }}</td>
                        <td>
                            {# O ID da rota √© corretamente passado para a fun√ß√£o #}
                            <button 
                                class="btn-detalhes" 
                                onclick="fetchRouteDetails({{ route.id }})"
                            >
                                Detalhes
                            </button>
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    {% endif %}

    <hr>

    {# Estrutura do Modal #}
    <div id="route-modal-overlay" class="modal-overlay">
        <div id="route-modal" class="modal-content">
            <h2>Detalhes da Rota</h2>
            <p>ID: <span id="modal-route-id">...</span></p>
            <p>Nome: <span id="modal-route-name">...</span></p>
            <p>Origem: <span id="modal-from-name">...</span></p>
            <p>Destino: <span id="modal-to-name">...</span></p>
            <p>Velocidade Hist√≥rica: <span id="modal-historic-speed">...</span></p>
            <p>Tempo Hist√≥rico: <span id="modal-historic-time">...</span></p>
            
            <button onclick="document.getElementById('route-modal-overlay').style.display='none'">Fechar</button>
        </div>
    </div>

    {# L√≥gica JavaScript para Carregar Dados do Modal via AJAX (Refor√ßada) #}
    <script>
        function fetchRouteDetails(routeId) {
            // üí° CORRE√á√ÉO APLICADA: Adicionando um timestamp (cache-busting)
            // Isso for√ßa o navegador a fazer uma nova requisi√ß√£o, garantindo dados frescos.
            const url = `/routes.php?action=details&id=${routeId}&_t=${new Date().getTime()}`;

            // Limpa o conte√∫do anterior enquanto carrega
            document.getElementById('modal-route-id').textContent = 'Carregando...';
            document.getElementById('modal-route-name').textContent = 'Carregando...';
            document.getElementById('modal-from-name').textContent = 'Carregando...';
            document.getElementById('modal-to-name').textContent = 'Carregando...';
            document.getElementById('modal-historic-speed').textContent = 'Carregando...';
            document.getElementById('modal-historic-time').textContent = 'Carregando...';
            document.getElementById('route-modal-overlay').style.display = 'block';

            fetch(url)
                .then(response => {
                    if (!response.ok) {
                        // Verifica status de erro HTTP (ex: 404 do PHP)
                        throw new Error(`Erro ao buscar dados: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    // Preenche o modal com os dados retornados (data)
                    document.getElementById('modal-route-id').textContent = data.id || 'N/A';
                    document.getElementById('modal-route-name').textContent = data.name || 'N/A';
                    document.getElementById('modal-from-name').textContent = data.from_name || 'N/A'; // Campo adicionado/verificado
                    document.getElementById('modal-to-name').textContent = data.to_name || 'N/A';
                    document.getElementById('modal-historic-speed').textContent = data.historic_speed || 'N/A';
                    document.getElementById('modal-historic-time').textContent = data.historic_time || 'N/A';
                    
                    // Garante que o modal esteja vis√≠vel ap√≥s o carregamento
                    document.getElementById('route-modal-overlay').style.display = 'block';
                })
                .catch(error => {
                    console.error('Erro ao carregar detalhes da rota:', error);
                    document.getElementById('modal-route-name').textContent = 'Erro ao carregar os dados.';
                    // Caso o erro seja na requisi√ß√£o, mantemos o modal aberto com a mensagem de erro.
                });
        }
    </script>
</body>
</html>