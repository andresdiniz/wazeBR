<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@1.0.1/dist/chartjs-plugin-zoom.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<div class="container mt-4">
    <h2 class="text-center mb-4">Selecionar Rota e Período</h2>
    <form method="GET" class="row g-3">
        <div class="col-md-4">
            <label for="route_id" class="form-label">Rota:</label>
            <select name="route_id" id="route_id" class="form-select" required>
                <option value="">Selecione uma rota</option>
                {% for route in routes %}
                    <option value="{{ route.id }}" {% if route.id == selected_route %}selected{% endif %}>
                        {{ route.name }}
                    </option>
                {% endfor %}
            </select>
        </div>

        <div class="col-md-3">
            <label for="start_date" class="form-label">Início:</label>
            <input type="date" name="start_date" id="start_date" value="{{ start_date }}" class="form-control" required>
        </div>

        <div class="col-md-3">
            <label for="end_date" class="form-label">Fim:</label>
            <input type="date" name="end_date" id="end_date" value="{{ end_date }}" class="form-control" required>
        </div>

        <div class="col-md-2 d-flex align-items-end">
            <button type="submit" class="btn btn-primary w-100">Buscar</button>
        </div>
    </form>

    {% if dados.historic_routes %}
        <div class="mt-4">
            <h3 class="text-center">Gráficos de Velocidade e Tempo</h3>
            <canvas id="chartVelocidade"></canvas>
            <canvas id="chartTempo" class="mt-4"></canvas>
        </div>

        <div class="mt-4 d-flex justify-content-center gap-3">
            <button class="btn btn-success" onclick="exportTableToCSV()">Exportar CSV</button>
            <button class="btn btn-warning" onclick="exportTableToExcel()">Exportar Excel</button>
            <button class="btn btn-info" onclick="downloadChart('chartVelocidade')">Baixar Gráfico de Velocidade</button>
            <button class="btn btn-info" onclick="downloadChart('chartTempo')">Baixar Gráfico de Tempo</button>
        </div>

        <h3 class="mt-4 text-center">Tabela de Dados</h3>
        <table class="table table-bordered table-striped text-center mt-3" id="dataTable">
            <thead class="table-dark">
                <tr>
                    <th>Data</th>
                    <th>Velocidade (km/h)</th>
                    <th>Tempo (s)</th>
                </tr>
            </thead>
            <tbody>
                {% for item in dados.historic_routes %}
                    <tr>
                        <td>{{ item.data }}</td>
                        <td>{{ item.velocidade }}</td>
                        <td>{{ item.tempo }}</td>
                    </tr>
                {% else %}
                    <tr>
                        <td colspan="3">Nenhum dado encontrado.</td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>

        <div class="mt-4 text-center" id="sentimentMessage">
            <!-- Frase de sentimento será exibida aqui -->
        </div>
    {% endif %}
</div>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        // Verificando se existem dados antes de criar os gráficos
        {% if dados.historic_routes %}
            const labels = [
                {% for item in dados.historic_routes %}
                    "{{ item.data }}",
                {% endfor %}
            ];

            const velocidades = [
                {% for item in dados.historic_routes %}
                    {{ item.velocidade }},
                {% endfor %}
            ];

            const tempos = [
                {% for item in dados.historic_routes %}
                    {{ item.tempo }},
                {% endfor %}
            ];

            // Gráfico de Velocidade
            new Chart(document.getElementById("chartVelocidade"), {
                type: "line",
                data: {
                    labels: labels,
                    datasets: [{
                        label: "Velocidade (km/h)",
                        data: velocidades,
                        borderColor: "blue",
                        fill: false,
                        tension: 0.3,
                        borderWidth: 2,
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(tooltipItem) {
                                    return tooltipItem.dataset.label + ": " + tooltipItem.raw + " km/h";
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 10,
                            }
                        }
                    },
                    plugins: {
                        zoom: {
                            pan: {
                                enabled: true,
                                mode: 'xy',
                                speed: 10,
                                threshold: 10
                            },
                            zoom: {
                                enabled: true,
                                mode: 'xy',
                                speed: 0.1
                            }
                        }
                    }
                }
            });

            // Gráfico de Tempo
            new Chart(document.getElementById("chartTempo"), {
                type: "line",
                data: {
                    labels: labels,
                    datasets: [{
                        label: "Tempo (s)",
                        data: tempos,
                        borderColor: "red",
                        fill: false,
                        tension: 0.3,
                        borderWidth: 2,
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(tooltipItem) {
                                    return tooltipItem.dataset.label + ": " + tooltipItem.raw + " s";
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 10,
                            }
                        }
                    },
                    plugins: {
                        zoom: {
                            pan: {
                                enabled: true,
                                mode: 'xy',
                                speed: 10,
                                threshold: 10
                            },
                            zoom: {
                                enabled: true,
                                mode: 'xy',
                                speed: 0.1
                            }
                        }
                    }
                }
            });

            // Sentimento baseado na média de velocidade
            const averageSpeed = velocidades.reduce((a, b) => a + b, 0) / velocidades.length;
            const sentimentMessage = document.getElementById("sentimentMessage");

            if (averageSpeed > 80) {
                sentimentMessage.innerHTML = "<p><strong>Excelente!</strong> A velocidade média está ótima!</p>";
            } else if (averageSpeed < 40) {
                sentimentMessage.innerHTML = "<p><strong>Atenção!</strong> A velocidade média está abaixo do esperado. Verifique a rota.</p>";
            } else {
                sentimentMessage.innerHTML = "<p>A velocidade está dentro do esperado. Continue monitorando.</p>";
            }
        {% endif %}
    });

    // Função para exportar tabela para CSV
    function exportTableToCSV() {
        let csv = "Data,Velocidade (km/h),Tempo (s)\n";
        document.querySelectorAll("#dataTable tbody tr").forEach(row => {
            csv += Array.from(row.children).map(td => td.innerText).join(",") + "\n";
        });
        const blob = new Blob([csv], { type: "text/csv" });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "dados_historicos.csv";
        link.click();
    }

    // Função para exportar tabela para Excel
    function exportTableToExcel() {
        let wb = XLSX.utils.book_new();
        let ws = XLSX.utils.table_to_sheet(document.getElementById("dataTable"));
        XLSX.utils.book_append_sheet(wb, ws, "Dados");
        XLSX.writeFile(wb, "dados_historicos.xlsx");
    }

    // Função para baixar o gráfico como imagem PNG
    function downloadChart(chartId) {
        const canvas = document.getElementById(chartId);
        const link = document.createElement("a");
        link.href = canvas.toDataURL("image/png");
        link.download = chartId + ".png"; // Nome do arquivo com o id do gráfico
        link.click();
    }
</script>
