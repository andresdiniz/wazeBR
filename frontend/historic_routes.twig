<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@1.0.1/dist/chartjs-plugin-zoom.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.0.1/dist/chartjs-plugin-annotation.min.js"></script>

<style>
    @media (max-width: 767px) {
        #chartVelocidade, #chartTempo { display: none !important; }
        .mt-4.d-flex { margin-top: 1rem !important; }
    }
    .progress-bar { transition: width 0.5s ease; }
    .card-status { min-height: 200px; }
</style>

<div class="container mt-4">
    <h2 class="text-center mb-4">Selecionar Rota e Período</h2>
    <form method="GET" class="row g-3">
        <div class="col-md-4">
            <label for="route_id" class="form-label">Rota:</label>
            <select name="route_id" id="route_id" class="form-select" required>
                <option value="">Selecione uma rota</option>
                {% for route in routes %}
                    <option value="{{ route.id }}" {% if route.id == selected_route %}selected{% endif %}>
                        {{ route.name }}
                    </option>
                {% endfor %}
            </select>
        </div>

        <div class="col-md-3">
            <label for="start_date" class="form-label">Início:</label>
            <input type="date" name="start_date" id="start_date" value="{{ start_date }}" class="form-control" required>
        </div>

        <div class="col-md-3">
            <label for="end_date" class="form-label">Fim:</label>
            <input type="date" name="end_date" id="end_date" value="{{ end_date }}" class="form-control" required>
        </div>

        <div class="col-md-2 d-flex align-items-end">
            <button type="submit" class="btn btn-primary w-100">Buscar</button>
        </div>
    </form>

    {% if dados.historic_routes %}
        <div class="mt-4" id="sentimentMessage"></div>
        
        <div class="mt-4">
            <h3 class="text-center">Análise de Desempenho com Gráficos</h3>
            <canvas id="chartVelocidade"></canvas>
            <canvas id="chartTempo" class="mt-4"></canvas>
        </div>

        <div class="mt-4 d-flex justify-content-center gap-3 flex-wrap">
            <button class="btn btn-success" onclick="exportTableToCSV()">Exportar CSV</button>
            <button class="btn btn-warning" onclick="exportTableToExcel()">Exportar Excel</button>
            <button class="btn btn-info" onclick="downloadChart('chartVelocidade')">Baixar Gráfico de Velocidade</button>
            <button class="btn btn-info" onclick="downloadChart('chartTempo')">Baixar Gráfico de Tempo</button>
        </div>

        <h3 class="mt-4 text-center">Tabela de Dados</h3>
        <table class="table table-bordered table-striped text-center mt-3" id="dataTable" style="width:100%">
            <thead class="table-dark">
                <tr>
                    <th>Data/Hora</th>
                    <th>Velocidade (km/h)</th>
                    <th>Tempo (s)</th>
                </tr>
            </thead>
            <tbody>
                {% for item in dados.historic_routes %}
                    <tr>
                        <td>{{ item.data }}</td>
                        <td>{{ item.velocidade }}</td>
                        <td>{{ item.tempo }}</td>
                    </tr>
                {% else %}
                    <tr>
                        <td colspan="3">Nenhum dado encontrado.</td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    {% endif %}
</div>

<script>
    const jq = jQuery.noConflict(true);

    document.addEventListener("DOMContentLoaded", function() {
        {% if dados.historic_routes %}
            // Inicialização do DataTables
            jq('#dataTable').DataTable({
                language: {
                    url: '//cdn.datatables.net/plug-ins/1.13.7/i18n/pt-BR.json'
                },
                dom: 'Bfrtip',
                buttons: [],
                pageLength: 10,
                lengthMenu: [5, 10, 25, 50],
                order: [[0, 'desc']]
            });

            // Obter dados
            const routeName = document.getElementById('route_id').selectedOptions[0].text;
            const labels = [{% for item in dados.historic_routes %}"{{ item.data }}",{% endfor %}];
            const velocidades = [{% for item in dados.historic_routes %}{{ item.velocidade }},{% endfor %}];
            const tempos = [{% for item in dados.historic_routes %}{{ item.tempo }},{% endfor %}];

            // Configuração comum dos gráficos
            const chartOptions = {
                responsive: true,
                plugins: {
                    legend: { position: 'top' },
                    tooltip: {
                        callbacks: {
                            label: function(tooltipItem) {
                                return `${tooltipItem.dataset.label}: ${tooltipItem.raw} ${tooltipItem.dataset.label.includes('Velocidade') ? 'km/h' : 's'}`;
                            }
                        }
                    },
                    zoom: {
                        wheel: { enabled: true, speed: 0.1 },
                        pinch: { enabled: true },
                        drag: { enabled: true, mode: 'xy' }
                    },
                    annotation: {
                        annotations: {}
                    }
                },
                scales: { y: { beginAtZero: true, ticks: { stepSize: 10 } } }
            };

            // Funções auxiliares
            const getMinMaxIndices = arr => ({
                maxIndex: arr.indexOf(Math.max(...arr)),
                minIndex: arr.indexOf(Math.min(...arr))
            });

            // Configurar gráfico de velocidade
            const velAnnotations = getMinMaxIndices(velocidades);
            new Chart(document.getElementById("chartVelocidade"), {
                type: "line",
                data: {
                    labels: labels,
                    datasets: [{
                        label: `Velocidade na Rota: ${routeName}`,
                        data: velocidades,
                        borderColor: "rgba(0, 123, 255, 0.8)",
                        fill: false,
                        tension: 0.3,
                        borderWidth: 2,
                        pointBackgroundColor: velocidades.map((v, i) => 
                            i === velAnnotations.maxIndex ? 'rgba(255,0,0,0.8)' :
                            i === velAnnotations.minIndex ? 'rgba(0,0,255,0.8)' : 'rgba(0,0,0,0.2)'
                        ),
                        pointRadius: velocidades.map((v, i) => 
                            (i === velAnnotations.maxIndex || i === velAnnotations.minIndex) ? 6 : 3
                        )
                    }]
                },
                options: chartOptions
            });

            // Configurar gráfico de tempo
            const tempoAnnotations = getMinMaxIndices(tempos);
            new Chart(document.getElementById("chartTempo"), {
                type: "line",
                data: {
                    labels: labels,
                    datasets: [{
                        label: `Tempo na Rota: ${routeName}`,
                        data: tempos,
                        borderColor: "rgba(220, 53, 69, 0.8)",
                        fill: false,
                        tension: 0.3,
                        borderWidth: 2,
                        pointBackgroundColor: tempos.map((t, i) => 
                            i === tempoAnnotations.maxIndex ? 'rgba(255,0,0,0.8)' :
                            i === tempoAnnotations.minIndex ? 'rgba(0,0,255,0.8)' : 'rgba(0,0,0,0.2)'
                        ),
                        pointRadius: tempos.map((t, i) => 
                            (i === tempoAnnotations.maxIndex || i === tempoAnnotations.minIndex) ? 6 : 3
                        )
                    }]
                },
                options: chartOptions
            });

            // Análise de desempenho
            const timeAnalysis = {
                madrugada1: { key: 'madrugada1', start: 0, end: 3, speeds: [], label: 'Madrugada (00:00 - 03:00)' },
                madrugada2: { key: 'madrugada2', start: 3, end: 6, speeds: [], label: 'Madrugada (03:00 - 06:00)' },
                manha1: { key: 'manha1', start: 6, end: 9, speeds: [], label: 'Manhã (06:00 - 09:00)' },
                manha2: { key: 'manha2', start: 9, end: 12, speeds: [], label: 'Manhã (09:00 - 12:00)' },
                tarde1: { key: 'tarde1', start: 12, end: 15, speeds: [], label: 'Tarde (12:00 - 15:00)' },
                tarde2: { key: 'tarde2', start: 15, end: 18, speeds: [], label: 'Tarde (15:00 - 18:00)' },
                noite1: { key: 'noite1', start: 18, end: 21, speeds: [], label: 'Noite (18:00 - 21:00)' },
                noite2: { key: 'noite2', start: 21, end: 24, speeds: [], label: 'Noite (21:00 - 00:00)' }
            };

            // Classificar dados por período
            labels.forEach((label, index) => {
                const hour = parseInt(label.split(' ')[1].split(':')[0], 10);
                for (const period of Object.values(timeAnalysis)) {
                    if (hour >= period.start && hour < period.end) {
                        period.speeds.push(velocidades[index]);
                        break;
                    }
                }
            });

            // Calcular médias históricas
            const calcularMediaHistorica = (start, end) => {
                const dados = [];
                labels.forEach((label, i) => {
                    const hora = parseInt(label.split(' ')[1].split(':')[0], 10);
                    if(hora >= start && hora < end) dados.push(velocidades[i]);
                });
                return dados.length ? dados.reduce((a,b) => a + b, 0) / dados.length : 0;
            };

            const referenceAverages = Object.fromEntries(
                Object.values(timeAnalysis).map(p => [
                    p.key, 
                    calcularMediaHistorica(p.start, p.end)
                ])
            );

            // Gerar cards de análise
            const gerarCardsAnalise = () => {
                let html = '<div class="row mt-4">';
                
                Object.values(timeAnalysis).forEach(period => {
                    if(period.speeds.length === 0) return;
                    
                    const avg = period.speeds.reduce((a,b) => a + b, 0) / period.speeds.length;
                    const ref = referenceAverages[period.key];
                    const deviation = ref ? ((avg - ref)/ref * 100).toFixed(1) : 'N/A';

                    let status = 'secondary', statusText = 'Sem dados', icon = 'bi-question-circle';
                    if(ref > 0) {
                        if(avg >= ref * 1.2) {
                            status = 'success'; statusText = 'Excelente'; icon = 'bi-rocket';
                        } else if(avg >= ref * 1.1) {
                            status = 'info'; statusText = 'Bom'; icon = 'bi-arrow-up';
                        } else if(avg >= ref * 0.95) {
                            status = 'primary'; statusText = 'Normal'; icon = 'bi-dash';
                        } else if(avg >= ref * 0.85) {
                            status = 'warning'; statusText = 'Atenção'; icon = 'bi-exclamation';
                        } else {
                            status = 'danger'; statusText = 'Crítico'; icon = 'bi-arrow-down';
                        }
                    }

                    html += `
                        <div class="col-md-3 mb-3">
                            <div class="card h-100 border-${status}">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <h5 class="card-title mb-0">${period.label}</h5>
                                        <i class="bi ${icon} text-${status} fs-4"></i>
                                    </div>
                                    <hr>
                                    <div class="text-center my-3">
                                        <span class="display-4 text-${status}">${statusText}</span>
                                    </div>
                                    <dl class="row small">
                                        <dt class="col-6">Média Atual</dt>
                                        <dd class="col-6 text-end">${avg.toFixed(1)} km/h</dd>
                                        
                                        <dt class="col-6">Média Histórica</dt>
                                        <dd class="col-6 text-end">${ref.toFixed(1)} km/h</dd>
                                        
                                        <dt class="col-6">Desvio</dt>
                                        <dd class="col-6 text-end">
                                            <span class="badge bg-${status}">${deviation}%</span>
                                        </dd>
                                    </dl>
                                </div>
                            </div>
                        </div>`;
                });
                
                return html + '</div>';
            };

            // Montar interface
            document.getElementById("sentimentMessage").innerHTML = `
                <div class="alert alert-info mt-4">
                    <h4 class="text-center">Análise Consolidada</h4>
                    <div class="row">
                        <div class="col-md-6">Média Geral: ${(velocidades.reduce((a,b) => a + b, 0)/velocidades.length).toFixed(1)} km/h</div>
                        <div class="col-md-6">Total de Registros: ${velocidades.length}</div>
                    </div>
                </div>
                ${gerarCardsAnalise()}`;

        {% endif %}
    });

    // Funções de exportação
    function exportTableToCSV() {
        const data = jq('#dataTable').DataTable().rows().data().toArray();
        let csv = "Data/Hora,Velocidade (km/h),Tempo (s)\n";
        data.forEach(row => csv += `"${row[0]}",${row[1]},${row[2]}\n`);
        const blob = new Blob(["\uFEFF" + csv], { type: "text/csv;charset=utf-8;" });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = `dados_rota_${new Date().toISOString().slice(0,10)}.csv`;
        link.click();
    }

    function exportTableToExcel() {
        const data = jq('#dataTable').DataTable().rows().data().toArray();
        const wsData = [
            ["Data/Hora", "Velocidade (km/h)", "Tempo (s)"],
            ...data
        ];
        const ws = XLSX.utils.aoa_to_sheet(wsData);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Dados");
        XLSX.writeFile(wb, `dados_rota_${new Date().toISOString().slice(0,10)}.xlsx`);
    }

    function downloadChart(chartId) {
        const canvas = document.getElementById(chartId);
        const link = document.createElement("a");
        link.href = canvas.toDataURL("image/png");
        link.download = `${chartId}_${document.getElementById('route_id').value}.png`;
        link.click();
    }
</script>