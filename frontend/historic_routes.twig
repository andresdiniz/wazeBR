<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@1.0.1/dist/chartjs-plugin-zoom.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>

<div class="container mt-4">
    <h2 class="text-center mb-4">Selecionar Rota e Período</h2>
    <form method="GET" class="row g-3">
        <div class="col-md-4">
            <label for="route_id" class="form-label">Rota:</label>
            <select name="route_id" id="route_id" class="form-select" required>
                <option value="">Selecione uma rota</option>
                {% for route in routes %}
                    <option value="{{ route.id }}" {% if route.id == selected_route %}selected{% endif %}>
                        {{ route.name }}
                    </option>
                {% endfor %}
            </select>
        </div>

        <div class="col-md-3">
            <label for="start_date" class="form-label">Início:</label>
            <input type="date" name="start_date" id="start_date" value="{{ start_date }}" class="form-control" required>
        </div>

        <div class="col-md-3">
            <label for="end_date" class="form-label">Fim:</label>
            <input type="date" name="end_date" id="end_date" value="{{ end_date }}" class="form-control" required>
        </div>

        <div class="col-md-2 d-flex align-items-end">
            <button type="submit" class="btn btn-primary w-100">Buscar</button>
        </div>
    </form>

    {% if dados.historic_routes %}
        <div class="mt-4" id="sentimentMessage">
            <!-- Análise por período será exibida aqui -->
        </div>
        <div class="mt-4">
            <h3 class="text-center">Análise de Desempenho com Gráficos</h3>
            <canvas id="chartVelocidade"></canvas>
            <canvas id="chartTempo" class="mt-4"></canvas>
        </div>

        <div class="mt-4 d-flex justify-content-center gap-3">
            <button class="btn btn-success" onclick="exportTableToCSV()">Exportar CSV</button>
            <button class="btn btn-warning" onclick="exportTableToExcel()">Exportar Excel</button>
            <button class="btn btn-info" onclick="downloadChart('chartVelocidade')">Baixar Gráfico de Velocidade</button>
            <button class="btn btn-info" onclick="downloadChart('chartTempo')">Baixar Gráfico de Tempo</button>
        </div>

        <h3 class="mt-4 text-center">Tabela de Dados</h3>
        <table class="table table-bordered table-striped text-center mt-3" id="dataTable" style="width:100%">
            <thead class="table-dark">
                <tr>
                    <th>Data/Hora</th>
                    <th>Velocidade (km/h)</th>
                    <th>Tempo (s)</th>
                </tr>
            </thead>
            <tbody>
                {% for item in dados.historic_routes %}
                    <tr>
                        <td>{{ item.data }}</td>
                        <td>{{ item.velocidade }}</td>
                        <td>{{ item.tempo }}</td>
                    </tr>
                {% else %}
                    <tr>
                        <td colspan="3">Nenhum dado encontrado.</td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>

    {% endif %}
</div>

<script>
    // Definir alias jq para jQuery com noConflict
    var jq = jQuery.noConflict(true);

    document.addEventListener("DOMContentLoaded", function() {
        {% if dados.historic_routes %}
            // Inicialização do DataTables com jq
            jq('#dataTable').DataTable({
                language: {
                    url: '//cdn.datatables.net/plug-ins/1.13.7/i18n/pt-BR.json'
                },
                dom: 'Bfrtip',
                buttons: [],
                pageLength: 10,
                lengthMenu: [5, 10, 25, 50],
                order: [[0, 'desc']]
            });

            const routeName = document.getElementById('route_id').selectedOptions[0].text;
            const labels = [
                {% for item in dados.historic_routes %}
                    "{{ item.data }}",
                {% endfor %}
            ];

            const velocidades = [
                {% for item in dados.historic_routes %}
                    {{ item.velocidade }},
                {% endfor %}
            ];

            const tempos = [
                {% for item in dados.historic_routes %}
                    {{ item.tempo }},
                {% endfor %}
            ];

            // Configuração comum para os gráficos
            const chartOptions = {
                responsive: true,
                plugins: {
                    legend: { position: 'top' },
                    tooltip: {
                        callbacks: {
                            label: function(tooltipItem) {
                                return `${tooltipItem.dataset.label}: ${tooltipItem.raw} ${tooltipItem.dataset.label.includes('Velocidade') ? 'km/h' : 's'}`;
                            }
                        }
                    },
                    zoom: {
                        wheel: { enabled: true, speed: 0.1 },
                        pinch: { enabled: true },
                        drag: { enabled: true, mode: 'xy' }
                    }
                },
                scales: { y: { beginAtZero: true, ticks: { stepSize: 10 } } }
            };

            // Gráfico de Velocidade
            new Chart(document.getElementById("chartVelocidade"), {
                type: "line",
                data: {
                    labels: labels,
                    datasets: [{
                        label: `Velocidade na Rota: ${routeName}`,
                        data: velocidades,
                        borderColor: "blue",
                        fill: false,
                        tension: 0.3,
                        borderWidth: 2,
                    }]
                },
                options: {
                    ...chartOptions,
                    plugins: {
                        ...chartOptions.plugins,
                        title: {
                            display: true,
                            text: `Velocidade na Rota: ${routeName}`,
                            font: { size: 18 }
                        }
                    }
                }
            });

            // Gráfico de Tempo
            new Chart(document.getElementById("chartTempo"), {
                type: "line",
                data: {
                    labels: labels,
                    datasets: [{
                        label: `Tempo na Rota: ${routeName}`,
                        data: tempos,
                        borderColor: "red",
                        fill: false,
                        tension: 0.3,
                        borderWidth: 2,
                    }]
                },
                options: {
                    ...chartOptions,
                    plugins: {
                        ...chartOptions.plugins,
                        title: {
                            display: true,
                            text: `Tempo de Percurso na Rota: ${routeName}`,
                            font: { size: 18 }
                        }
                    }
                }
            });

// Cálculo da média geral
function calcularMediaGeral(velocidades) {
    return velocidades.reduce((a, b) => a + b, 0) / velocidades.length;
}

// Configuração dos períodos de análise
function criarPeriodosAnalise() {
    return {
        manha: { start: 6, end: 12, speeds: [], label: 'Manhã (06:00 - 12:00)' },
        tarde: { start: 12, end: 18, speeds: [], label: 'Tarde (12:00 - 18:00)' },
        noite: { start: 18, end: 24, speeds: [], label: 'Noite (18:00 - 00:00)' },
        madrugada: { start: 0, end: 6, speeds: [], label: 'Madrugada (00:00 - 06:00)' }
    };
}

// Classificação de status com base no desempenho
function classificarDesempenho(mediaPeriodo, mediaGeral) {
    const percentual = (mediaPeriodo / mediaGeral) * 100;
    
    if (percentual >= 110) return { status: 'success', texto: 'Ótimo', descricao: 'Acima da média' };
    if (percentual >= 90) return { status: 'warning', texto: 'Atenção', descricao: 'Próximo da média' };
    return { status: 'danger', texto: 'Crítico', descricao: 'Abaixo da média' };
}

// Processamento dos dados por período
function processarDadosPorPeriodo(labels, velocidades, periodos) {
    labels.forEach((label, index) => {
        const hora = parseInt(label.split(' ')[1].split(':')[0], 10);
        const periodo = Object.values(periodos).find(p => hora >= p.start && hora < p.end);
        if (periodo) periodo.speeds.push(velocidades[index]);
    });
    return periodos;
}

// Geração do HTML de análise
function gerarHTMLAnalise(mediaGeral, periodos) {
    let html = `
        <h4 class="mt-4 text-center">Análise de Desempenho por Período</h4>
        <div class="alert alert-info">
            Média geral: <strong>${mediaGeral.toFixed(1)} km/h</strong>
        </div>
        <div class="row mt-3">`;

    Object.values(periodos).forEach(periodo => {
        if (periodo.speeds.length === 0) return;
        
        const media = calcularMediaGeral(periodo.speeds);
        const classificacao = classificarDesempenho(media, mediaGeral);
        const desvio = ((media - mediaGeral) / mediaGeral * 100).toFixed(1);

        html += `
            <div class="col-md-3 mb-3">
                <div class="card border-${classificacao.status} h-100">
                    <div class="card-body text-center">
                        <h5>${periodo.label}</h5>
                        <div class="display-4 text-${classificacao.status}">${classificacao.texto}</div>
                        <p class="mt-2">
                            Média: <strong>${media.toFixed(1)} km/h</strong><br>
                            Desvio: ${desvio}%<br>
                            Registros: ${periodo.speeds.length}<br>
                            <small>${classificacao.descricao}</small>
                        </p>
                    </div>
                </div>
            </div>`;
    });

    return html + '</div>';
}

// Execução principal
if (typeof velocidades !== 'undefined' && velocidades.length > 0) {
    const mediaGeral = calcularMediaGeral(velocidades);
    const periodos = criarPeriodosAnalise();
    processarDadosPorPeriodo(labels, velocidades, periodos);
    document.getElementById("sentimentMessage").innerHTML = gerarHTMLAnalise(mediaGeral, periodos);
}
        {% endif %}

    function exportTableToCSV() {
        let csv = "Data/Hora,Velocidade (km/h),Tempo (s)\n";
        document.querySelectorAll("#dataTable tbody tr").forEach(row => {
            csv += Array.from(row.children).map(td => td.innerText).join(",") + "\n";
        });
        const blob = new Blob([csv], { type: "text/csv" });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "dados_rota.csv";
        link.click();
    }

    function exportTableToExcel() {
        let wb = XLSX.utils.book_new();
        let ws = XLSX.utils.table_to_sheet(document.getElementById("dataTable"));
        XLSX.utils.book_append_sheet(wb, ws, "Dados Rota");
        XLSX.writeFile(wb, "dados_rota.xlsx");
    }

    function downloadChart(chartId) {
        const canvas = document.getElementById(chartId);
        const link = document.createElement("a");
        link.href = canvas.toDataURL("image/png");
        link.download = `${chartId}_${document.getElementById('route_id').value}.png`;
        link.click();
    }
</script>