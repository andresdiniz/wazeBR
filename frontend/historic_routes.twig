<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@1.0.1/dist/chartjs-plugin-zoom.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.0.1/dist/chartjs-plugin-annotation.min.js"></script>

<style>
    /* Esconder gráficos em mobile */
    @media (max-width: 767px) {
        #chartVelocidade, 
        #chartTempo {
            display: none !important;
        }
        
        /* Opcional: Ajustar margens */
        .mt-4.d-flex {
            margin-top: 1rem !important;
        }
    }
</style>

<div class="container mt-4">
    <h2 class="text-center mb-4">Selecionar Rota e Período</h2>
    <form method="GET" class="row g-3">
        <div class="col-md-4">
            <label for="route_id" class="form-label">Rota:</label>
            <select name="route_id" id="route_id" class="form-select" required>
                <option value="">Selecione uma rota</option>
                {% for route in routes %}
                    <option value="{{ route.id }}" {% if route.id == selected_route %}selected{% endif %}>
                        {{ route.name }}
                    </option>
                {% endfor %}
            </select>
        </div>

        <div class="col-md-3">
            <label for="start_date" class="form-label">Início:</label>
            <input type="date" name="start_date" id="start_date" value="{{ start_date }}" class="form-control" required>
        </div>

        <div class="col-md-3">
            <label for="end_date" class="form-label">Fim:</label>
            <input type="date" name="end_date" id="end_date" value="{{ end_date }}" class="form-control" required>
        </div>

        <div class="col-md-2 d-flex align-items-end">
            <button type="submit" class="btn btn-primary w-100">Buscar</button>
        </div>
    </form>

    {% if dados.historic_routes %}
        <div class="mt-4" id="sentimentMessage">
            <!-- Análise por período será exibida aqui -->
        </div>
        <div class="mt-4">
            <h3 class="text-center">Análise de Desempenho com Gráficos</h3>
            <canvas id="chartVelocidade"></canvas>
            <canvas id="chartTempo" class="mt-4"></canvas>
        </div>

        <div class="mt-4 d-flex justify-content-center gap-3">
            <button class="btn btn-success" onclick="exportTableToCSV()">Exportar CSV</button>
            <button class="btn btn-warning" onclick="exportTableToExcel()">Exportar Excel</button>
            <button class="btn btn-info" onclick="downloadChart('chartVelocidade')">Baixar Gráfico de Velocidade</button>
            <button class="btn btn-info" onclick="downloadChart('chartTempo')">Baixar Gráfico de Tempo</button>
        </div>

        <h3 class="mt-4 text-center">Tabela de Dados</h3>
        <table class="table table-bordered table-striped text-center mt-3" id="dataTable" style="width:100%">
            <thead class="table-dark">
                <tr>
                    <th>Data/Hora</th>
                    <th>Velocidade (km/h)</th>
                    <th>Tempo (s)</th>
                </tr>
            </thead>
            <tbody>
                {% for item in dados.historic_routes %}
                    <tr>
                        <td>{{ item.data }}</td>
                        <td>{{ item.velocidade }}</td>
                        <td>{{ item.tempo }}</td>
                    </tr>
                {% else %}
                    <tr>
                        <td colspan="3">Nenhum dado encontrado.</td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>

    {% endif %}
</div>

<script>
    // Definir alias jq para jQuery com noConflict
    var jq = jQuery.noConflict(true);

    document.addEventListener("DOMContentLoaded", function() {
        {% if dados.historic_routes %}
            // Inicialização do DataTables com configuração completa
            const dataTable = jq('#dataTable').DataTable({
                language: {
                    url: '//cdn.datatables.net/plug-ins/1.13.7/i18n/pt-BR.json'
                },
                dom: 'Bfrtip',
                buttons: [
                    {
                        extend: 'csv',
                        text: 'Exportar CSV',
                        className: 'btn btn-sm btn-primary',
                        title: 'dados_rota',
                        exportOptions: { columns: [0, 1, 2] }
                    },
                    {
                        extend: 'excel',
                        text: 'Exportar Excel',
                        className: 'btn btn-sm btn-success',
                        title: 'dados_rota',
                        exportOptions: { columns: [0, 1, 2] }
                    }
                ],
                pageLength: 10,
                lengthMenu: [5, 10, 25, 50],
                order: [[0, 'desc']],
                columnDefs: [
                    { targets: 0, type: 'date' },
                    { targets: 1, render: DataTable.render.number('.', ',', 2, '') },
                    { targets: 2, render: DataTable.render.number('.', ',', 2, '') }
                ]
            });

            // Dados dos gráficos
            const routeName = document.getElementById('route_id').selectedOptions[0].text;
            const labels = [{% for item in dados.historic_routes %}"{{ item.data }}",{% endfor %}];
            const velocidades = [{% for item in dados.historic_routes %}{{ item.velocidade }},{% endfor %}];
            const tempos = [{% for item in dados.historic_routes %}{{ item.tempo }},{% endfor %}];

            // Funções auxiliares
            const getMinMaxIndices = (arr) => ({
                maxIndex: arr.indexOf(Math.max(...arr)),
                minIndex: arr.indexOf(Math.min(...arr))
            });

            const getCurrentStatus = (speed, avg) => {
                if (speed >= avg * 1.20) return ['success', 'Excelente'];
                if (speed >= avg * 1.10) return ['info', 'Bom'];
                if (speed >= avg * 0.95) return ['primary', 'Normal'];
                if (speed >= avg * 0.85) return ['warning', 'Atenção'];
                return ['danger', 'Crítico'];
            };

            // Configuração comum dos gráficos
            const chartOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'top' },
                    tooltip: {
                        callbacks: {
                            label: (tooltipItem) => 
                                `${tooltipItem.dataset.label}: ${tooltipItem.raw.toFixed(2)} ${tooltipItem.dataset.label.includes('Velocidade') ? 'km/h' : 's'}`
                        }
                    },
                    zoom: {
                        wheel: { enabled: true, speed: 0.1 },
                        pinch: { enabled: true },
                        drag: { enabled: true, mode: 'xy' }
                    },
                    annotation: {
                        annotations: {}
                    }
                },
                scales: { 
                    y: { 
                        beginAtZero: true, 
                        ticks: { 
                            stepSize: 10,
                            callback: function(value) {
                                return this.getLabelForValue(value) + (this.scale.axis === 'y' ? ' km/h' : ' s');
                            }
                        }
                    }
                }
            };

            // Gráfico de Velocidade
            const velAnnotations = getMinMaxIndices(velocidades);
            new Chart(document.getElementById("chartVelocidade"), {
                type: "line",
                data: {
                    labels: labels,
                    datasets: [{
                        label: `Velocidade na Rota: ${routeName}`,
                        data: velocidades,
                        borderColor: "rgba(54, 162, 235, 1)",
                        backgroundColor: "rgba(54, 162, 235, 0.2)",
                        fill: true,
                        tension: 0.3,
                        borderWidth: 2,
                        pointBackgroundColor: velocidades.map((v, i) => 
                            i === velAnnotations.maxIndex ? 'rgba(255,0,0,0.8)' :
                            i === velAnnotations.minIndex ? 'rgba(0,0,255,0.8)' : 'rgba(54, 162, 235, 0.6)'
                        ),
                        pointRadius: velocidades.map((v, i) => 
                            (i === velAnnotations.maxIndex || i === velAnnotations.minIndex) ? 6 : 3
                        )
                    }]
                },
                options: {
                    ...chartOptions,
                    plugins: {
                        ...chartOptions.plugins,
                        title: {
                            display: true,
                            text: `Velocidade na Rota: ${routeName}`,
                            font: { size: 18 }
                        },
                        annotation: {
                            annotations: {
                                maxLine: {
                                    type: 'line',
                                    yMin: velocidades[velAnnotations.maxIndex],
                                    yMax: velocidades[velAnnotations.maxIndex],
                                    borderColor: 'red',
                                    borderWidth: 2,
                                    label: {
                                        content: `Máximo: ${velocidades[velAnnotations.maxIndex].toFixed(1)} km/h`,
                                        position: 'end'
                                    }
                                },
                                minLine: {
                                    type: 'line',
                                    yMin: velocidades[velAnnotations.minIndex],
                                    yMax: velocidades[velAnnotations.minIndex],
                                    borderColor: 'blue',
                                    borderWidth: 2,
                                    label: {
                                        content: `Mínimo: ${velocidades[velAnnotations.minIndex].toFixed(1)} km/h`,
                                        position: 'end'
                                    }
                                }
                            }
                        }
                    }
                }
            });

            // Gráfico de Tempo
            const tempoAnnotations = getMinMaxIndices(tempos);
            new Chart(document.getElementById("chartTempo"), {
                type: "line",
                data: {
                    labels: labels,
                    datasets: [{
                        label: `Tempo na Rota: ${routeName}`,
                        data: tempos,
                        borderColor: "rgba(255, 99, 132, 1)",
                        backgroundColor: "rgba(255, 99, 132, 0.2)",
                        fill: true,
                        tension: 0.3,
                        borderWidth: 2,
                        pointBackgroundColor: tempos.map((t, i) => 
                            i === tempoAnnotations.maxIndex ? 'rgba(255,0,0,0.8)' :
                            i === tempoAnnotations.minIndex ? 'rgba(0,0,255,0.8)' : 'rgba(255, 99, 132, 0.6)'
                        ),
                        pointRadius: tempos.map((t, i) => 
                            (i === tempoAnnotations.maxIndex || i === velAnnotations.minIndex) ? 6 : 3
                        )
                    }]
                },
                options: {
                    ...chartOptions,
                    plugins: {
                        ...chartOptions.plugins,
                        title: {
                            display: true,
                            text: `Tempo de Percurso na Rota: ${routeName}`,
                            font: { size: 18 }
                        },
                        annotation: {
                            annotations: {
                                maxLine: {
                                    type: 'line',
                                    yMin: tempos[tempoAnnotations.maxIndex],
                                    yMax: tempos[tempoAnnotations.maxIndex],
                                    borderColor: 'red',
                                    borderWidth: 2,
                                    label: {
                                        content: `Máximo: ${tempos[tempoAnnotations.maxIndex].toFixed(1)} s`,
                                        position: 'end'
                                    }
                                },
                                minLine: {
                                    type: 'line',
                                    yMin: tempos[tempoAnnotations.minIndex],
                                    yMax: tempos[tempoAnnotations.minIndex],
                                    borderColor: 'blue',
                                    borderWidth: 2,
                                    label: {
                                        content: `Mínimo: ${tempos[tempoAnnotations.minIndex].toFixed(1)} s`,
                                        position: 'end'
                                    }
                                }
                            }
                        }
                    }
                }
            });

            // Cálculo de estatísticas
            const overallAvg = velocidades.reduce((a, b) => a + b, 0) / velocidades.length;
            const currentSpeed = velocidades[velocidades.length - 1];
            const [currentStatus] = getCurrentStatus(currentSpeed, overallAvg);

            // Restante do código de análise (mantido igual)
            // ... (código de statusHTML e analysisHTML permanece igual)
            
        {% endif %}
    });

    // Funções de exportação otimizadas
    function exportTableToCSV() {
        const dt = jq('#dataTable').DataTable();
        const data = dt.rows().data().toArray().sort((a, b) => new Date(a[0]) - new Date(b[0]));
        
        const csvContent = data.map(row => 
            `"${row[0]}",${parseFloat(row[1]).toFixed(2)},${parseFloat(row[2]).toFixed(2)}`
        ).join('\n');
        
        const blob = new Blob(["\uFEFFData/Hora,Velocidade (km/h),Tempo (s)\n" + csvContent], 
            { type: "text/csv;charset=utf-8;" });
        
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = `dados_rota_${new Date().toISOString().slice(0, 10)}.csv`;
        link.click();
    }

    function exportTableToExcel() {
        const dt = jq('#dataTable').DataTable();
        const data = dt.rows().data().toArray().sort((a, b) => new Date(a[0]) - new Date(b[0]));
        
        const wsData = [
            ["Data/Hora", "Velocidade (km/h)", "Tempo (s)"],
            ...data.map(row => [
                row[0],
                parseFloat(row[1]).toFixed(2),
                parseFloat(row[2]).toFixed(2)
            ])
        ];
        
        const ws = XLSX.utils.aoa_to_sheet(wsData);
        ws['!cols'] = [{wch: 20}, {wch: 15}, {wch: 10}];
        
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Dados da Rota");
        XLSX.writeFile(wb, `dados_rota_${new Date().toISOString().slice(0, 10)}.xlsx`);
    }

    // Função de download de gráfico
    function downloadChart(chartId) {
        const canvas = document.getElementById(chartId);
        const link = document.createElement("a");
        link.href = canvas.toDataURL("image/png");
        link.download = `${chartId}_${new Date().toISOString().slice(0, 10)}.png`;
        link.click();
    }
</script>