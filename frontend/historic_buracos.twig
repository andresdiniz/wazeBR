<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Buracos</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.datatables.net/2.0.3/css/dataTables.bootstrap5.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/buttons/3.0.1/css/buttons.bootstrap5.css">

    <link rel="stylesheet" href="https://cdn.datatables.net/rowgroup/1.4.0/css/rowGroup.dataTables.min.css">
    <script src="https://cdn.datatables.net/rowgroup/1.4.0/js/dataTables.rowGroup.min.js"></script>

    <style>
        /* Custom styles for badges based on confidence level */
        .badge.bg-success {
            background-color: #28a745 !important;
        }

        .badge.bg-warning {
            background-color: #ffc107 !important;
            color: #333 !important;
        }

        /* Added color for warning readability */
        .badge.bg-danger {
            background-color: #dc3545 !important;
        }

        /* Smaller font for labels in filter card */
        .form-label.small {
            font-size: 0.85em;
        }

        /* Adjust button group for DataTables export buttons to stack on small screens */
        div.dt-buttons {
            display: flex;
            flex-wrap: wrap;
            /* Allow buttons to wrap to next line */
            gap: 5px;
            /* Space between buttons */
            /* Ensure the button container itself is aligned correctly */
            align-items: center;
        }

        /* Ensure filter input has a consistent look */
        .dataTables_filter input {
            min-width: 150px;
            /* Ensure search bar is not too narrow */
        }

        /* Ensure the table itself uses table-layout: fixed for better column distribution */
        /* This forces the table to use 100% of available width */
        #buracos-table {
            table-layout: fixed;
            width: 100% !important;
            /* Force 100% width, important for fixed layout */
        }

        /* Make sure table cells don't wrap unless necessary, to prevent fixed layout issues */
        #buracos-table tbody td {
            white-space: normal;
            /* Allow text to wrap naturally within cells */
            word-wrap: break-word;
            /* Break long words */
        }
    </style>
</head>

<body>

    <div class="container mt-4">
        <div class="card shadow-sm mb-4">
            <div class="card-body">
                <h5 class="card-title mb-3 text-muted">Filtrar Registros</h5>
                <form method="GET" action="" class="row g-3 align-items-end">
                    <div class="col-md-4 col-lg-3">
                        <label for="filter-date" class="form-label small text-muted mb-1">Data Específica</label>
                        <input type="date" id="filter-date" name="date" class="form-control form-control-sm"
                            value="{{ filters.date ?? '' }}">
                    </div>
                    <div class="col-md-4 col-lg-3">
                        <label for="filter-period" class="form-label small text-muted mb-1">Período</label>
                        <select id="filter-period" name="period" class="form-select form-select-sm">
                            <option value="">Todos</option>
                            <option value="7" {{ filters.period=='7' ? 'selected' : '' }}>Última semana</option>
                            <option value="15" {{ filters.period=='15' ? 'selected' : '' }}>Últimos 15 dias</option>
                            <option value="30" {{ filters.period=='30' ? 'selected' : '' }}>Último mês</option>
                        </select>
                    </div>
                    <div class="col-md-4 col-lg-2 d-grid">
                        <button type="submit" class="btn btn-primary btn-sm">
                            <i class="bi bi-funnel me-1"></i>Filtrar
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <div class="row mb-4">
            <div class="row mb-4">
                <div class="row mb-4">
                    {# Primeira linha: 3 cartões (Total, Filtrados, Confirmados) #}
                    <div class="col-md-4 col-sm-6 mb-3"> {# col-sm-6 para 2 por linha em telas pequenas, mb-3 para
                        espaçamento #}
                        <div class="card border-success border-2 shadow-sm h-100">
                            <div class="card-body py-2">
                                <span class="small text-muted">Total de Registros</span>
                                <h3 class="mb-0 text-success" id="count-total">{{counts.total}}</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 col-sm-6 mb-3"> {# col-sm-6 para 2 por linha em telas pequenas, mb-3 para
                        espaçamento #}
                        <div class="card border-info border-2 shadow-sm h-100">
                            <div class="card-body py-2">
                                <span class="small text-muted">Registros Filtrados</span>
                                <h3 class="mb-0 text-info" id="count-filtered">{{counts.filtered}}</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 col-sm-6 mb-3"> {# col-sm-6 para 2 por linha em telas pequenas, mb-3 para
                        espaçamento #}
                        <div class="card border-primary border-2 shadow-sm h-100">
                            <div class="card-body py-2">
                                <span class="small text-muted">Registros Confirmados</span>
                                <h3 class="mb-0 text-primary" id="count-confirmed">{{counts.confirmed}}</h3>
                            </div>
                        </div>
                    </div>

                    {# Segunda linha: 2 cartões (Não resolvidos, Ocultos) #}
                    {# Usamos col-md-6 para que ocupem metade da linha em telas médias+ #}
                    <div class="col-md-6 col-sm-6 mb-3"> {# col-sm-6 para 2 por linha em telas pequenas, mb-3 para
                        espaçamento #}
                        <div class="card border-warning border-2 shadow-sm h-100">
                            <div class="card-body py-2">
                                <span class="small text-muted">Registros Não resolvidos</span>
                                <h3 class="mb-0 text-warning" id="count-not-resolved">0</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 col-sm-6 mb-3"> {# col-sm-6 para 2 por linha em telas pequenas, mb-3 para
                        espaçamento #}
                        <div class="card border-danger border-2 shadow-sm h-100">
                            <div class="card-body py-2">
                                <span class="small text-muted">Registros Ocultos (inativos/removidos)</span>
                                <h3 class="mb-0 text-danger" id="count-hidden">0</h3>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card shadow-sm">
            <div class="card-body">
                <h5 class="card-title mb-3 text-muted">Relatório de Buracos</h5>
                <div class="table-responsive"> {# Added this wrapper div for responsiveness #}
                    <table id="buracos-table" class="table table-hover table-striped table-bordered table-sm"
                        style="width:100%; height: 100%;">
                        <thead class="table-light">
                            <tr>
                                <th class="text-center">#</th>
                                <th>Cidade</th>
                                <th>Rua</th>
                                <th class="text-center">Confiança</th>
                                <th>Data</th>
                                <th>Coordenadas</th>
                                <th class="text-center no-export">Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for buraco in buracos %}
                            <tr data-uuid="{{ buraco.uuid }}">
                                <td>{{ loop.index }}</td>
                                <td>{{ buraco.city }}</td>
                                <td>{{ buraco.street }}</td>
                                <td>
                                    {# The actual badge styling will be applied by DataTables JS render function #}
                                    {{ buraco.confidence }}
                                </td>
                                <td data-order="{{ buraco.pubMillis }}">
                                    {{ (buraco.pubMillis / 1000)|date('d/m/Y H:i') }}
                                </td>
                                <td>
                                    <a href="https://www.waze.com/ul?ll={{ buraco.location_y }},{{ buraco.location_x }}"
                                        target="_blank" class="btn btn-link btn-sm py-0" title="Ver no Mapa">
                                        <i class="bi bi-geo-alt"></i> Ver mapa
                                    </a>
                                </td>
                                <td class="text-center">
                                    <button class="btn btn-outline-secondary btn-sm open-edit-modal"
                                        title="Atualizar Status" data-uuid="{{ buraco.uuid }}">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                </td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="7" class="text-center text-muted py-4">Nenhum registro encontrado para os
                                    filtros aplicados.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div> {# Close .table-responsive wrapper #}
            </div>
        </div>

        <div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content"> {# Removed p-3 here #}
                    <div class="modal-header bg-light">
                        <h5 class="modal-title" id="editModalLabel">Atualizar Status do Buraco</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <form id="updateForm"> {# Removed action and method attributes here #}
                        <div class="modal-body">
                            <input type="hidden" name="uuid" id="modal-uuid">
                            <input type="hidden" name="status" id="modal-status"> {# Added name="status" #}

                            <p class="text-muted small">Selecione uma ação para este registro:</p>
                            <div class="d-grid gap-3">
                                <button type="button" data-status="resolvido"
                                    class="btn btn-success btn-lg submit-status">
                                    <i class="bi bi-check-circle me-2"></i>Marcar como Resolvido
                                </button>
                                <button type="button" data-status="nao_existe"
                                    class="btn btn-danger btn-lg submit-status">
                                    <i class="bi bi-x-circle me-2"></i>Não Existe / Falso Positivo
                                </button>
                                <button type="button" data-status="nao_resolvido"
                                    class="btn btn-warning btn-lg submit-status">
                                    <i class="bi bi-exclamation-triangle me-2"></i>Não Resolvido / Aguardando
                                </button>
                            </div>
                        </div>
                        <div class="modal-footer justify-content-start mt-3"> {# Added mt-3 for spacing #}
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script src="https://cdn.datatables.net/2.0.3/js/dataTables.js"></script>
    <script src="https://cdn.datatables.net/2.0.3/js/dataTables.bootstrap5.js"></script>

    <script src="https://cdn.datatables.net/buttons/3.0.1/js/dataTables.buttons.js"></script>
    <script src="https://cdn.datatables.net/buttons/3.0.1/js/buttons.bootstrap5.js"></script>
    <script src="https://cdn.datatables.net/buttons/3.0.1/js/buttons.html5.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Helper function para formatar a confiança
            const formatConfidence = (value) => {
                let numValue = parseFloat(value);
                if (isNaN(numValue)) numValue = 0;
                const percentage = (numValue * 20).toFixed(0) + '%';
                let color = numValue >= 4 ? 'success' : numValue >= 2 ? 'warning' : 'danger';
                return `<span class="badge bg-${color}">${numValue} (${percentage})</span>`;
            };

            // Configuração inicial da DataTable
            let table = new DataTable('#buracos-table', {
                dom: '<"row mb-3"<"col-md-4"l><"col-md-4"B><"col-md-4"g>><"row"<"col-md-12"f>><"row mt-2"<"col-12"rt>><"row"<"col-md-5"i><"col-md-7"p>>',
                buttons: [
                    {
                        extend: 'copy',
                        text: '<i class="bi bi-clipboard"></i> Copiar',
                        className: 'btn btn-outline-secondary btn-sm',
                        exportOptions: { columns: ':not(.no-export)' }
                    },
                    {
                        extend: 'excelHtml5',
                        text: '<i class="bi bi-file-earmark-excel"></i> Excel',
                        className: 'btn btn-outline-success btn-sm',
                        exportOptions: { columns: ':not(.no-export)' }
                    },
                    {
                        extend: 'pdfHtml5',
                        text: '<i class="bi bi-file-earmark-pdf"></i> PDF',
                        className: 'btn btn-outline-danger btn-sm',
                        exportOptions: { columns: ':not(.no-export)' }
                    }
                ],
                order: [[2, 'asc'], [4, 'desc']],
                language: { url: '//cdn.datatables.net/plug-ins/2.0.3/i18n/pt-BR.json' },
                rowGroup: {
                    dataSrc: 2,
                    className: 'group-row',
                    enable: true
                },
                columnDefs: [
                    { targets: 0, width: '30px', className: 'text-center' },
                    { targets: 2, visible: false }, // Oculta a coluna de Rua
                    { targets: 3, width: '100px', className: 'text-center', render: formatConfidence },
                    { targets: 4, width: '150px' },
                    { targets: 6, width: '80px', orderable: false, className: 'no-export text-center' }
                ],
                paging: true,
                pageLength: 10,
                lengthMenu: [[10, 25, 50, -1], [10, 25, 50, 'Todos']],
                initComplete: function () {
                    // Aplica estilos aos controles
                    const elements = [
                        ['.dt-buttons', 'btn-group', 'flex-wrap gap-2'],
                        ['.dataTables_filter input', 'form-control form-control-sm', 'Pesquisar...'],
                        ['.dataTables_length select', 'form-select form-select-sm']
                    ];

                    elements.forEach(([selector, classes, placeholder]) => {
                        const el = document.querySelector(selector);
                        if (el) {
                            if (classes) el.className += ` ${classes}`;
                            if (placeholder) el.placeholder = placeholder;
                        }
                    });
                }
            });

            // Adiciona seletor de agrupamento
            const groupSelector = document.createElement('select');
            groupSelector.className = 'form-select form-select-sm w-auto mb-2';
            groupSelector.innerHTML = `
        <option value="2">Agrupar por Rua</option>
        <option value="1">Agrupar por Cidade</option>
        <option value="-1">Sem Agrupamento</option>
    `;

            document.querySelector('#buracos-table_wrapper').prepend(groupSelector);

            // Função para atualizar o agrupamento
            function updateGrouping(columnIndex) {
                const column = table.column(columnIndex);

                if (columnIndex === -1) {
                    table.rowGroup().dataSrc(null).draw();
                    table.column(2).visible(true);
                    table.column(1).visible(true);
                } else {
                    table.rowGroup().dataSrc(columnIndex).draw();
                    table.column(columnIndex).visible(false);
                    if (columnIndex === 2) table.column(1).visible(true);
                }
            }

            // Evento de mudança no seletor
            groupSelector.addEventListener('change', function () {
                updateGrouping(parseInt(this.value));
            });

            // Estilos para grupos
            const style = document.createElement('style');
            style.innerHTML = `
        tr.group-row td {
            background-color: #e9ecef;
            font-weight: bold;
            border-top: 2px solid #dee2e6;
            border-bottom: 2px solid #dee2e6;
            transition: background-color 0.3s;
        }
        tr.group-row:hover td {
            background-color: #dae0e5 !important;
        }
        tr.group-row td:first-child {
            border-radius: 4px 0 0 4px;
        }
        tr.group-row td:last-child {
            border-radius: 0 4px 4px 0;
        }
    `;
            document.head.appendChild(style);

            // Atualizador de contadores
            const updateCounters = () => {
                const totalRecords = table.data().count();
                const filteredRecords = table.rows({ search: 'applied' }).count();

                document.getElementById('count-total').textContent = totalRecords;
                document.getElementById('count-filtered').textContent = filteredRecords;
                document.getElementById('count-hidden').textContent = totalRecords - filteredRecords;
            };

            table.on('draw', updateCounters);
            updateCounters();

            // Controle do Modal
            const editModal = new bootstrap.Modal('#editModal');

            document.querySelector('#buracos-table tbody').addEventListener('click', (e) => {
                const button = e.target.closest('button.open-edit-modal');
                if (!button) return;

                const uuid = button.dataset.uuid;
                if (!uuid) return;

                document.getElementById('modal-uuid').value = uuid;
                editModal.show();
            });

            // Envio do formulário
            document.querySelectorAll('.submit-status').forEach(button => {
                button.addEventListener('click', async () => {
                    const status = button.dataset.status;
                    const uuid = document.getElementById('modal-uuid').value;

                    try {
                        const response = await fetch('/api.php?action=atualizaburaco', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ uuid, status })
                        });

                        const result = await response.json();

                        if (response.ok && result.success) {
                            editModal.hide();
                            location.reload(); // Atualiza os dados
                        } else {
                            alert(result.error || 'Erro na atualização');
                        }
                    } catch (error) {
                        console.error('Erro:', error);
                        alert('Falha na comunicação com o servidor');
                    }
                });
            });
        });
    </script>
</body>

</html>