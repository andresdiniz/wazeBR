<!-- Tabela de Buracos Corrigida -->
<div class="card shadow">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th>Localização</th>
                        <th>Confiança</th>
                        <th>Data</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody>
                    {% for buraco in buracos %}
                    <tr data-uuid="{{ buraco.uuid }}">
                        <td>
                            {% if buraco.street %}
                                {{ buraco.city }}, {{ buraco.street }}
                            {% else %}
                                {{ buraco.city }} (Sem endereço)
                            {% endif %}
                        </td>
                        <td>
                            <div class="progress" style="height: 20px;">
                                <div class="progress-bar 
                                    {% if buraco.confidence >= 50 %}bg-success
                                    {% elseif buraco.confidence >= 20 %}bg-warning
                                    {% else %}bg-danger{% endif %}" 
                                     style="width: {{ buraco.confidence }}%">
                                    {{ buraco.confidence }}%
                                </div>
                            </div>
                        </td>
                        <td>{{ (buraco.pubMillis / 1000)|date("d/m/Y H:i") }}</td>
                        <td>
                            <button class="btn btn-sm btn-info btn-edit" 
                                    data-bs-toggle="modal" 
                                    data-bs-target="#editModal"
                                    disabled title="Funcionalidade em desenvolvimento">
                                <i class="fas fa-edit"></i>
                            </button>
                        </td>
                    </tr>
                    {% else %}
                        <tr>
                            <td colspan="4" class="text-center text-muted py-4">
                                Nenhum registro encontrado
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Modal de Edição -->
<div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">Editar Alerta</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="map" style="height: 400px; width: 100%;"></div>
                <div class="mt-3">
                    <button id="btnWaze" class="btn btn-primary" target="_blank">
                        <i class="fab fa-waze"></i> Criar Rota no Waze
                    </button>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-success btn-confirm">
                    <i class="fas fa-check-circle"></i> Confirmar Existência
                </button>
                <button type="button" class="btn btn-danger btn-resolve">
                    <i class="fas fa-flag-checkered"></i> Marcar como Concluído
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Leaflet CSS/JS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    let map, marker;
    let currentUUID = null;

    // Inicializar Modal
    $('#editModal').on('show.bs.modal', function(e) {
        const button = e.relatedTarget;
        const row = button.closest('tr');
        const lat = parseFloat(row.dataset.lat);
        const lon = parseFloat(row.dataset.lon);
        currentUUID = row.dataset.uuid;

        // Inicializar Mapa
        if(map) map.remove();
        map = L.map('map').setView([lat, lon], 18);
        
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        
        if(marker) marker.remove();
        marker = L.marker([lat, lon]).addTo(map);

        // Configurar Botão Waze
        document.getElementById('btnWaze').href = 
            `https://www.waze.com/ul?ll=${lat},${lon}&navigate=yes`;
    });

    // Ações dos Botões
    document.querySelector('.btn-confirm').addEventListener('click', function() {
        console.log('Confirmar existência:', currentUUID);
        // AJAX para confirmar existência
    });

    document.querySelector('.btn-resolve').addEventListener('click', function() {
        console.log('Marcar como resolvido:', currentUUID);
        // AJAX para marcar como resolvido
    });

    // Redimensionar mapa quando o modal é aberto
    $('#editModal').on('shown.bs.modal', function() {
        map.invalidateSize();
    });
});
</script>