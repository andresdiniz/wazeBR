<div class="container mt-4 mb-4">
    <div class="row">
        <div class="col-lg-6 mb-3">
            <h3 class="text-primary">Criar Alerta</h3>
        </div>
    </div>
    <div class="row">
        <div class="col-lg-8">
            <div class="card shadow-sm p-4">
                <form action="api.php?action=cadastrar_evento" method="post" id="eventoForm">

                    <!-- Nome e descrição do evento -->
                    <div class="mb-3">
                        <label for="nome" class="form-label">Descrição do Evento</label>
                        <input type="text" class="form-control" id="nome" name="nome" required
                            placeholder="Escreva uma descrição breve do Evento" maxlength="50">
                    </div>

                    <!-- Tipo e Subtipo -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="tipo" class="form-label">Tipo</label>
                            <select class="form-select" id="tipo" name="tipo" required>
                                <option value="">Selecione um Tipo</option>
                                {% for tipo in tipos %}
                                <option value="{{ tipo.id }}">{{ tipo.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="subtipo" class="form-label">Subtipo</label>
                            <select class="form-select" id="subtipo" name="subtipo" required>
                                <option value="">Selecione um Subtipo</option>
                            </select>
                        </div>
                    </div>

                    <!-- Início e Fim do Evento -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="starttime" class="form-label">Início do Evento</label>
                            <input type="datetime-local" class="form-control" id="starttime" name="starttime" required>
                        </div>
                        <div class="col-md-6">
                            <label for="endtime" class="form-label">Fim do Evento</label>
                            <input type="datetime-local" class="form-control" id="endtime" name="endtime" required>
                        </div>
                    </div>

                    <!-- Dias da Semana -->
                    <div class="mb-3">
                        <label for="dias_semana" class="form-label">Dias da Semana</label>
                        <select multiple class="form-select" id="dias_semana" name="dias_semana[]">
                            <option value="sunday">Domingo</option>
                            <option value="monday">Segunda-feira</option>
                            <option value="tuesday">Terça-feira</option>
                            <option value="wednesday">Quarta-feira</option>
                            <option value="thursday">Quinta-feira</option>
                            <option value="friday">Sexta-feira</option>
                            <option value="saturday">Sábado</option>
                        </select>
                    </div>

                    <!-- Horários -->
                    <div id="horarios_dia" class="mb-3">
                        <!-- Espaço para adicionar campos de horário para cada dia da semana -->
                    </div>

                    <!-- Coordenadas -->
                    <div class="mb-3">
                        <label for="coordenadas" class="form-label">Coordenadas do Evento (lat, lon)</label>
                        <input type="text" class="form-control" id="coordenadas" name="coordenadas" required
                            placeholder="Clique no mapa para definir as coordenadas" readonly>
                    </div>

                    <!-- Rua -->
                    <div class="mb-3">
                        <label for="rua" class="form-label">Selecione a Rua</label>
                        <select class="form-select" id="ruaSelect" name="rua" required>
                            <option value="">Selecione uma rua</option>
                            <!-- Opções de rua preenchidas dinamicamente -->
                        </select>
                    </div>

                    <!-- Sentido e Botão de Envio -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="directionSelect" class="form-label">Escolha o Sentido</label>
                            <select id="directionSelect" class="form-select" name="directionSelect"></select>
                        </div>
                        <div class="col-md-6 d-flex justify-content-end align-items-center mt-6">
                            <button type="submit" class="btn btn-primary w-100">Criar Evento</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Mapa -->
        <div class="col-lg-4 mt-4 mt-lg-0">
            <div id="map" class="card shadow-sm" style="height: 500px;"></div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@turf/turf/turf.min.js"></script>
<script>
    // === Funções do Mapa ===
    function initializeMap() {
        const map = L.map('map').setView([-23.55052, -46.633308], 15); // São Paulo como exemplo
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);
        return map;
    }

    function locateUser(map) {
        map.locate({ setView: true, maxZoom: 16 });

        map.on('locationerror', function(e) {
            alert('Não foi possível localizar a sua posição.');
        });

    }

    function handleLocationFound(e, map) {
        const radius = e.accuracy / 2;
        L.marker(e.latlng).addTo(map).bindPopup('Você está aqui!').openPopup();
        L.circle(e.latlng, radius).addTo(map);

        consultarRuaWaze(e.latlng.lat, e.latlng.lng).then(nomeRuaWaze => {
            if (nomeRuaWaze) {
                const ruaSelect = document.getElementById('ruaSelect');
                const optionWaze = document.createElement('option');
                optionWaze.value = nomeRuaWaze;
                optionWaze.textContent = nomeRuaWaze;
                ruaSelect.appendChild(optionWaze);
                ruaSelect.value = nomeRuaWaze;
            }
        });
    }

    function consultarRuaWaze(lat, lon) {
        const url = `api.php?action=get_street&lat_inicio=${lat}&lon_inicio=${lon}`;
        return fetch(url)
            .then(response => response.json())
            .then(data => {
                if (data && data.result && data.result.length > 0) {
                    data.result.sort((a, b) => a.distance - b.distance);
                    return data.result[0].names[0]; // Nome da rua mais próxima
                } else {
                    return null;
                }
            })
            .catch(() => null);
    }

    function drawSegment(map, segmentNodes, direction = 'both', previousSegmentLayer) {
        if (previousSegmentLayer) {
            map.removeLayer(previousSegmentLayer);
        }

        const segment = {
            type: 'Feature',
            properties: {},
            geometry: {
                type: 'LineString',
                coordinates: segmentNodes
            }
        };

        const segmentLayer = L.geoJSON(segment).addTo(map);

        // Configuração das setas
        const arrowColor = direction === 'single' ? '#FF0000' : '#0000FF';
        const arrowLayer = L.polylineDecorator(segmentLayer, {
            patterns: [
                {
                    offset: 25,
                    repeat: 50,
                    symbol: L.Symbol.arrowHead({
                        pixelSize: 15,
                        polygon: false,
                        pathOptions: {
                            stroke: true,
                            color: arrowColor,
                            weight: 2
                        }
                    })
                }
            ]
        });

        return L.layerGroup([segmentLayer, arrowLayer]).addTo(map);
    }

    async function getStreetSegment(map, lat, lon, drawSegmentCallback) {
        const query = `
            [out:json];
            (
                node(around:50, ${lat}, ${lon});
                way(bn)["highway"];
                >;
            );
            out geom;
        `;
        const url = `https://overpass-api.de/api/interpreter?data=${encodeURIComponent(query)}`;

        try {
            const response = await fetch(url);
            const data = await response.json();

            if (data.elements.length > 0) {
                const nodes = {};
                const ways = [];

                data.elements.forEach(el => {
                    if (el.type === 'node') {
                        nodes[el.id] = [el.lon, el.lat];
                    } else if (el.type === 'way') {
                        ways.push(el);
                    }
                });

                let closestWay = null;
                let minDistance = Infinity;

                ways.forEach(way => {
                    const wayNodes = way.nodes.map(id => nodes[id]);
                    const distance = turf.pointToLineDistance(turf.point([lon, lat]), turf.lineString(wayNodes), { units: 'meters' });

                    if (distance < minDistance) {
                        minDistance = distance;
                        closestWay = way;
                    }
                });

                if (closestWay) {
                    const wayNodes = closestWay.nodes.map(id => nodes[id]);
                    const intersections = closestWay.nodes.filter(nodeId =>
                        data.elements.some(el => el.type === 'way' && el.id !== closestWay.id && el.nodes.includes(nodeId))
                    );

                    if (intersections.length >= 2) {
                        const startNodeIndex = closestWay.nodes.indexOf(intersections[0]);
                        const endNodeIndex = closestWay.nodes.indexOf(intersections[1]);
                        const segmentNodes = wayNodes.slice(startNodeIndex, endNodeIndex + 1);

                        drawSegmentCallback(segmentNodes);
                    }
                }
            }
        } catch (error) {
            console.error('Erro ao buscar segmento:', error);
        }
    }

    function invertSegmentCoordinates(segmentNodes, drawSegmentCallback) {
        segmentNodes.reverse();
        drawSegmentCallback(segmentNodes, 'single');
    }

    // === Funções de Agendamento ===
    function calcularDiasSemana() {
        const startDate = document.getElementById('starttime').value;
        const endDate = document.getElementById('endtime').value;

        if (!startDate || !endDate) return;

        const start = new Date(startDate);
        const end = new Date(endDate);
        const diasSemana = [];
        const dias = ['domingo', 'segunda', 'terca', 'quarta', 'quinta', 'sexta', 'sabado'];

        while (start <= end) {
            const dayOfWeek = start.getDay();
            if (!diasSemana.includes(dias[dayOfWeek])) {
                diasSemana.push(dias[dayOfWeek]);
            }
            start.setDate(start.getDate() + 1);
        }

        atualizarHorarios(diasSemana);
    }

    function atualizarHorarios(diasSelecionados) {
        const horariosDiv = document.getElementById('horarios_dia');
        horariosDiv.innerHTML = '';

        diasSelecionados.forEach(dia => {
            const dayDiv = document.createElement('div');
            dayDiv.classList.add('mb-3');
            dayDiv.setAttribute('data-dia', dia);

            const label = document.createElement('label');
            label.classList.add('form-label');
            label.innerText = `Horários para ${dia.charAt(0).toUpperCase() + dia.slice(1)}`;

            const inputHora = document.createElement('input');
            inputHora.type = 'time';
            inputHora.name = `${dia}_inicio`;
            inputHora.classList.add('form-control');

            const inputHoraFim = document.createElement('input');
            inputHoraFim.type = 'time';
            inputHoraFim.name = `${dia}_fim`;
            inputHoraFim.classList.add('form-control');

            dayDiv.appendChild(label);
            dayDiv.appendChild(inputHora);
            dayDiv.appendChild(inputHoraFim);

            horariosDiv.appendChild(dayDiv);
        });
    }

    // === Funções de Tipos e Subtipos ===
    function carregarSubtiposPorTipo(tipoSelect, subtipoSelect, subtiposPorTipo) {
        subtipoSelect.innerHTML = '<option value="">Selecione um Subtipo</option>';

        const selectedTipoId = tipoSelect.value;
        if (selectedTipoId && subtiposPorTipo[selectedTipoId]) {
            subtipoSelect.disabled = false;
            subtiposPorTipo[selectedTipoId].forEach(subtipo => {
                const option = document.createElement('option');
                option.value = subtipo.subtype_value;
                option.textContent = subtipo.name;
                subtipoSelect.appendChild(option);
            });
        } else {
            subtipoSelect.disabled = true;
        }
    }

    // === Funções de Inicialização e Eventos ===
    document.addEventListener('DOMContentLoaded', function() {
        const map = initializeMap();

        map.on('locationfound', (e) => handleLocationFound(e, map));
        locateUser(map);

        const tipoSelect = document.getElementById('tipo');
        const subtipoSelect = document.getElementById('subtipo');
        const subtiposPorTipo = {{ subtiposPorTipo | json_encode | raw }};
        
        tipoSelect.addEventListener('change', () => carregarSubtiposPorTipo(tipoSelect, subtipoSelect, subtiposPorTipo));

        document.getElementById('starttime').addEventListener('change', calcularDiasSemana);
        document.getElementById('endtime').addEventListener('change', calcularDiasSemana);
    });
</script>
