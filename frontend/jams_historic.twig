<!-- CSS -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.3.6/css/buttons.dataTables.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.min.css">

<!-- Scripts (nova ordem correta) -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.3.6/js/dataTables.buttons.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.html5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.print.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>

<!-- NoConflict após carregar todos os plugins -->
<script>
    var jq = $.noConflict(true);
</script>

<div class="container my-5">
    <h1 class="text-center">Painel de Congestionamentos</h1>

    <form id="filterForm" class="my-4">
        <div class="row g-3">
            <div class="col-md-3">
                <label for="start_date" class="form-label">Data Inicial:</label>
                <input type="date" class="form-control" id="start_date" name="start_date" value="{{ start_date }}">
            </div>
            <div class="col-md-3">
                <label for="end_date" class="form-label">Data Final:</label>
                <input type="date" class="form-control" id="end_date" name="end_date" value="{{ end_date }}">
            </div>
            <div class="col-md-3">
                <label for="group_by" class="form-label">Agrupar Por:</label>
                <select id="group_by" class="form-select">
                    <option value="date">Data</option>
                    <option value="street">Rua</option>
                    <option value="hour">Hora</option>
                    <option value="city">Cidade</option>
                </select>
            </div>
            <div class="col-md-3 d-flex align-items-end">
                <button type="submit" class="btn btn-primary w-100">Aplicar</button>
            </div>
        </div>
    </form>

    <div class="chart-container my-5">
        <canvas id="alertsChart"></canvas>
    </div>

    <div id="alertsTable">
        <table id="jamsTable" class="table table-bordered table-striped">
            <thead>
                <tr>
                    <th>Cidade</th>
                    <th>Rua</th>
                    <th>Confiança</th>
                    <th>Data Recebida</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
                {% for jam in jams %}
                <tr>
                    <td>{{ jam.city }}</td>
                    <td>{{ jam.street }}</td>
                    <td>{{ jam.confidence }}</td>
                    <td>{{ jam.date_received }}</td>
                    <td>{{ jam.status == 1 ? 'Ativo' : 'Inativo' }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        // Dados do gráfico
        const labels = {{ labels|raw }};
        const dataCounts = {{ data_counts|raw }};
        
        // Configuração do gráfico
        const ctx = document.getElementById('alertsChart').getContext('2d');
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Congestionamentos por Período',
                    data: dataCounts,
                    backgroundColor: '#4e73df',
                    borderColor: '#2e59d9',
                    borderWidth: 2,
                    borderRadius: 5,
                    hoverBackgroundColor: '#2e59d9'
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    title: {
                        display: true,
                        text: 'Distribuição de Congestionamentos',
                        font: { size: 18 }
                    },
                    legend: {
                        display: false
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Quantidade'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Período'
                        }
                    }
                },
                animation: {
                    duration: 1500,
                    easing: 'easeInOutQuart'
                }
            }
        });
    
        // DataTable
        const table = jq('#jamsTable').DataTable({
            paging: true,
            pageLength: 15,
            lengthMenu: [10, 15, 25, 50],
            dom: '<"top"Blf>rt<"bottom"ip>',
            buttons: [
                {
                    extend: 'collection',
                    text: 'Exportar',
                    buttons: ['copy', 'csv', 'excel', 'pdf', 'print']
                }
            ],
            language: {
                url: '//cdn.datatables.net/plug-ins/1.13.6/i18n/pt-BR.json'
            },
            columnDefs: [
                { targets: 0, width: '20%' },
                { targets: 1, width: '30%' },
                { targets: 2, width: '15%' },
                { targets: 3, width: '20%' },
                { targets: 4, width: '15%' }
            ]
        });
    
        // Filtro pelo gráfico
        document.getElementById('alertsChart').onclick = function(evt) {
            const points = this.chart.getElementsAtEventForMode(evt, 'nearest', { intersect: true }, true);
            if (points.length) {
                const clickedLabel = this.chart.data.labels[points[0].index];
                table.search(clickedLabel).draw();
            }
        };
    });
    </script>