<div class="container my-5">
    <h1 class="text-center">Painel de Congestionamentos</h1>

    <form id="filterForm" class="my-4">
        <div class="row g-3">
            <div class="col-md-3">
                <label for="start_date" class="form-label">Data Inicial:</label>
                <input type="date" class="form-control" id="start_date" name="start_date" value="{{ start_date }}">
            </div>
            <div class="col-md-3">
                <label for="end_date" class="form-label">Data Final:</label>
                <input type="date" class="form-control" id="end_date" name="end_date" value="{{ end_date }}">
            </div>
            <div class="col-md-2">
                <label for="city" class="form-label">Cidade:</label>
                <select id="city" class="form-select">
                    <option value="">Todas</option>
                    {% for city in cities %}
                        <option value="{{ city }}">{{ city }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <label for="street" class="form-label">Rua:</label>
                <select id="street" class="form-select">
                    <option value="">Todas</option>
                    {% for street in streets %}
                        <option value="{{ street }}">{{ street }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2 d-flex align-items-end">
                <button type="submit" class="btn btn-primary w-100">Filtrar</button>
            </div>
        </div>
    </form>

    <div class="chart-container my-5">
        <canvas id="alertsChart"></canvas>
    </div>

    <div id="alertsTable">
        <table id="jamsTable" class="table table-bordered table-striped">
            <thead>
                <tr>
                    <th>Cidade</th>
                    <th>Rua</th>
                    <th>Confiança</th>
                    <th>Data Recebida</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
                {% for jam in jams %}
                    <tr>
                        <td>{{ jam.city }}</td>
                        <td>{{ jam.street }}</td>
                        <td>{{ jam.confidence }}</td>
                        <td>{{ jam.date_received }}</td>
                        <td>{{ jam.status == 1 ? 'Ativo' : 'Inativo' }}</td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        var labels = {{ labels|raw }};
        var dataCounts = {{ data_counts|raw }};
        var totalJams = dataCounts.reduce((sum, value) => sum + value, 0);

        const ctx = document.getElementById('alertsChart').getContext('2d');
        var myChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Número de Congestionamentos',
                    data: dataCounts,
                    backgroundColor: 'rgba(75, 192, 192, 0.6)',
                    borderColor: 'rgba(75, 192, 192, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    datalabels: {
                        anchor: 'end',
                        align: 'top',
                        formatter: (value) => {
                            return `${value} (${((value / totalJams) * 100).toFixed(1)}%)`;
                        }
                    }
                },
                scales: {
                    y: { beginAtZero: true }
                }
            }
        });

        document.getElementById('alertsChart').onclick = function (e) {
            const points = myChart.getElementsAtEventForMode(e, 'nearest', { intersect: true }, true);
            if (points.length) {
                const clickedLabel = myChart.data.labels[points[0].index];
                filterTable(clickedLabel);
            }
        };

        function filterTable(label) {
            var table = $('#jamsTable').DataTable();
            table.search(label).draw();
        }

        $('#jamsTable').DataTable({
            paging: true,
            searching: true,
            ordering: true,
            responsive: true,
            dom: 'Bfrtip',
            buttons: [
                { extend: 'copy', text: 'Copiar' },
                { extend: 'csv', text: 'Exportar CSV' },
                { extend: 'excel', text: 'Exportar Excel' },
                { extend: 'pdf', text: 'Exportar PDF' },
                { extend: 'print', text: 'Imprimir' }
            ]
        });
    });
</script>
