<div class="container-fluid">
    <!-- Page Heading -->
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h2 class="h3 mb-0 text-gray-800">ADMINISTRAR USÚARIOS</h2>
    </div>

    <!-- Content Row -->
    <div class="row">
        <div class="container">
            <div class="row">
                {% if session.type == 1 or session.type == 2 %}<!-- Card 1 -->
                    <div class="col-md-3 col-sm-6 mb-4">
                        <div class="card shadow-sm">
                            <img src="https://via.placeholder.com/150" class="card-img-top" alt="Card image cap">
                            <div class="card-body">
                                <h5 class="card-title">Cadastrar</h5>
                                <p class="card-text">Cadastrar Usuarios</p>
                                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalCadastrar">Cadastrar</button>
                            </div>
                        </div>
                    </div>

                    <!-- Card 2 -->
                    <div class="col-md-3 col-sm-6 mb-4">
                        <div class="card shadow-sm">
                            <img src="https://via.placeholder.com/150" class="card-img-top" alt="Card image cap">
                            <div class="card-body">
                                <h5 class="card-title">Alterar Usuarios</h5>
                                <p class="card-text">Alterar propriedades</p>
                                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalAlterar">Alterar</button>
                            </div>
                        </div>
                    </div>
                {% endif %}

                <!-- Card 3 -->
                <div class="col-md-3 col-sm-6 mb-4">
                    <div class="card shadow-sm">
                        <img src="https://via.placeholder.com/150" class="card-img-top" alt="Card image cap">
                        <div class="card-body">
                            <h5 class="card-title">Reset de Senha</h5>
                            <p class="card-text">Realizar o reset de senha</p>
                            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalResetSenha">Reset Senha</button>
                        </div>
                    </div>
                </div>
                {% if session.type == 1 or session.type == 2 %}
                    <!-- Card 4 -->
                    <div class="col-md-3 col-sm-6 mb-4">
                        <div class="card shadow-sm">
                            <img src="https://via.placeholder.com/150" class="card-img-top" alt="Card image cap">
                            <div class="card-body">
                                <h5 class="card-title">Apagar Usuario</h5>
                                <p class="card-text">Apagar Usuario</p>
                                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalApagar">Apagar</button>
                            </div>
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Modals -->
<!-- Modais para cada funcionalidade -->
<!-- Modal Cadastrar -->
<div class="modal fade" id="modalCadastrar" tabindex="-1" aria-labelledby="modalCadastrarLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="formCadastrar">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalCadastrarLabel">Cadastrar Usuário</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="nomeUsuario" class="form-label">Nome</label>
                        <input type="text" class="form-control" id="nomeUsuario" name="nome" required>
                    </div>
                    <div class="mb-3">
                        <label for="nomeDeUsuario" class="form-label">Nome de Usuário</label>
                        <input type="text" class="form-control" id="nomeDeUsuario" name="usuario" required>
                    </div>
                    <div class="mb-3">
                        <label for="emailUsuario" class="form-label">Email do Usuário</label>
                        <input type="email" class="form-control" id="emailUsuario" name="email" required>
                    </div>
                    <div class="mb-3">
                        <label for="senhaUsuario" class="form-label">Senha</label>
                        <input type="password" class="form-control" id="senhaUsuario" name="senha" required>
                    </div>
                    <div class="mb-3">
                        <label for="typeSelect" class="form-label">Nivel de Usuario</label>
                        <select id="typeSelect" name="type" class="form-control" required>
                            <option value="" selected>Selecione o tipo</option>
                            {% if session.type == 1 %}
                                <option value="1" selected>Super User / Dev</option>
                            {% endif %}
                            <option value="2" selected>Administrador Conta</option>
                            <option value="3" selected>Usuário de Teste / Treinamento</option>
                            <option value="4" selected>Usuário Geral</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="parceirosSelect" class="form-label">Parceiro</label>
                        <select id="parceirosSelect" name="id_parceiro" class="form-control" required>
                            <option value="">Carregando...</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" id="salvarUsuario" class="btn btn-primary">Salvar</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Alterar -->
<div class="modal fade" id="modalAlterar" tabindex="-1" aria-labelledby="modalAlterarLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalAlterarLabel">Alterar Usuário</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <input type="text" id="searchAlterar" class="form-control" placeholder="Buscar por nome ou email">
                <ul id="resultAlterar" class="list-group"></ul>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                <button type="button" class="btn btn-primary">Salvar Alterações</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Reset de Senha -->
<div class="modal fade" id="modalResetSenha" tabindex="-1" aria-labelledby="modalResetSenhaLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalResetSenhaLabel">Reset de Senha</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <input type="text" id="searchResetSenha" class="form-control" placeholder="Buscar por nome ou email">
                <ul id="resultResetSenha" class="list-group mt-2"></ul>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                <button type="button" class="btn btn-primary">Resetar Senha</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Apagar -->
<div class="modal fade" id="modalApagar" tabindex="-1" aria-labelledby="modalApagarLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalApagarLabel">Apagar Usuário</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <input type="text" id="searchApagar" class="form-control" placeholder="Buscar por nome ou email">
                <ul id="resultApagar" class="list-group mt-2"></ul>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger">Apagar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de edição -->
<div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editModalLabel">Editar Usuário</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editForm">
                    <input type="hidden" id="editUserId">
                    <div class="mb-3">
                        <label for="editUsername" class="form-label">Username</label>
                        <input type="text" class="form-control" id="editUsername" required>
                    </div>
                    <div class="mb-3">
                        <label for="editEmail" class="form-label">Email</label>
                        <input type="email" class="form-control" id="editEmail" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="saveChanges()">Salvar Alterações</button>
            </div>
        </div>
    </div>
</div>


<!-- Script para busca AJAX -->
<script>
const sessionType = {{ session.type | json_encode | raw }};
    console.log(sessionType);
    let isInputEventBound = false; // Controle de inicialização

    // Função genérica para busca
    function performSearch(inputId, resultId, functionName) {
    const inputField = document.getElementById(inputId);
    const resultList = document.getElementById(resultId);

    inputField.addEventListener('input', () => {
        const query = inputField.value;

        if (query.length >= 3) {
            fetch(`api.php?action=${functionName}&query=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(data => {
                    // Limpar resultados anteriores
                    resultList.innerHTML = '';

                    if (data.success) {
                        // Adicionar resultados
                        data.users.forEach(item => {
                            const li = document.createElement('li');
                            li.className = 'list-group-item d-flex justify-content-between align-items-center';
                            li.textContent = `${item.username} (${item.email})`;

                            // Criar ícone de editar
                            const editIcon = document.createElement('i');
                            editIcon.className = 'fas fa-edit text-primary';
                            editIcon.style.cursor = 'pointer';
                            editIcon.addEventListener('click', () => openEditModal(item));

                            li.appendChild(editIcon);
                            resultList.appendChild(li);
                        });
                    } else {
                        resultList.innerHTML = '<li class="list-group-item text-danger">Nenhum usuário encontrado.</li>';
                    }
                })
                .catch(error => {
                    console.error('Erro ao buscar:', error);
                    resultList.innerHTML = '<li class="list-group-item text-danger">Erro ao buscar resultados.</li>';
                });
        } else {
            resultList.innerHTML = ''; // Limpar resultados se o texto for muito curto
        }
    });
}

// Função para abrir o modal de edição
function openEditModal(user) {
    const modalElement = document.getElementById('editModal');
    const modal = new bootstrap.Modal(modalElement);
    document.getElementById('editUsername').value = user.username;
    document.getElementById('editEmail').value = user.email;
    document.getElementById('editUserId').value = user.id;
    modal.show();
}
// Função para salvar as alterações
function saveChanges() {
    const userId = document.getElementById('editUserId').value;
    const username = document.getElementById('editUsername').value;
    const email = document.getElementById('editEmail').value;

    // Verifica se os campos não estão vazios
    if (!username || !email) {
        alert('Por favor, preencha todos os campos!');
        return;
    }

    // Faz a requisição para salvar os dados
    fetch('api.php?action=update_user', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ id: userId, username: username, email: email }),
    })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Usuário atualizado com sucesso!');
                const modal = bootstrap.Modal.getInstance(document.getElementById('editModal'));
                modal.hide();
                // Aqui você pode atualizar a lista de resultados ou recarregar a página
            } else {
                alert('Erro ao atualizar usuário: ' + (data.message || 'Erro desconhecido.'));
            }
        })
        .catch(error => {
            console.error('Erro ao atualizar usuário:', error);
            alert('Erro ao salvar as alterações.');
        });
}

// Adiciona o listener de clique no botão de salvar
document.getElementById('salvarUsuario').addEventListener('click', saveChanges);


    // Função para carregar os parceiros no select
    function carregarParceiros(sessionType) {
        const parceirosSelect = document.getElementById('parceirosSelect');

        fetch(`api.php?action=get_parceiros&sessionType=${encodeURIComponent(sessionType)}`, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
            },
        })
            .then((response) => {
                if (!response.ok) {
                    throw new Error('Erro na requisição: ' + response.status);
                }
                return response.json();
            })
            .then((data) => {
                if (data.success) {
                    parceirosSelect.innerHTML =
                        sessionType == 1
                            ? "<option value='99'>Todos Parceiros</option>"
                            : "<option value=''>Selecione um parceiro</option>";

                    data.nomes.forEach((item) => {
                        const option = document.createElement('option');
                        option.value = item.id;
                        option.textContent = item.Nome;
                        parceirosSelect.appendChild(option);
                    });
                } else {
                    console.error('Erro: ' + data.message);
                }
            })
            .catch((error) => {
                console.error('Erro ao carregar os parceiros:', error);
                alert('Erro ao carregar os parceiros. Por favor, tente novamente mais tarde.');
            });
    }

    // Inicializar buscas e carregar parceiros
    document.addEventListener('DOMContentLoaded', () => {
        performSearch('searchAlterar', 'resultAlterar', 'alterar');
        performSearch('searchResetSenha', 'resultResetSenha', 'reset_senha');
        performSearch('searchApagar', 'resultApagar', 'apagar');

        const modalCadastrar = document.getElementById('modalCadastrar');
        modalCadastrar.addEventListener('show.bs.modal', () => carregarParceiros(sessionType));

        carregarParceiros(sessionType);

        document.getElementById('salvarUsuario').addEventListener('click', () => {
            const form = document.getElementById('formCadastrar');
            const formData = new FormData(form);

            fetch('api.php?action=cadastrar_usuario', {
                method: 'POST',
                body: formData,
            })
                .then((response) => response.json())
                .then((data) => {
                    if (data.success) {
                        alert('Usuário cadastrado com sucesso!');
                        form.reset();
                        const modalElement = document.getElementById('modalCadastrar');
                        const modalInstance = bootstrap.Modal.getInstance(modalElement);
                        if (modalInstance) {
                            modalInstance.hide();
                        }
                    } else {
                        alert('Erro ao cadastrar usuário: ' + (data.message || 'Erro desconhecido.'));
                    }
                })
                .catch((error) => console.error('Erro ao cadastrar usuário:', error));
        });
    });
</script>
