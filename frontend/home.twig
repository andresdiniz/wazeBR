<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<link rel="stylesheet" href="https://cdn.datatables.net/1.10.25/css/dataTables.bootstrap5.min.css">
<script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>

<style>
    :root {
        --card-shadow: 0 2px 8px rgba(0,0,0,0.08);
        --card-hover-shadow: 0 4px 16px rgba(0,0,0,0.12);
        --border-radius: 12px;
        --transition: all 0.3s ease;
    }

    /* Cards melhorados */
    .card {
        border: none;
        border-radius: var(--border-radius);
        box-shadow: var(--card-shadow);
        transition: var(--transition);
        overflow: hidden;
    }

    .card:hover {
        box-shadow: var(--card-hover-shadow);
        transform: translateY(-2px);
    }

    .card-header {
        border: none;
        padding: 1rem 1.25rem;
        font-weight: 600;
        font-size: 1.1rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .card-header i {
        margin-right: 0.5rem;
        font-size: 1.2rem;
    }

    .card-body {
        padding: 1.25rem;
    }

    /* Badge modernizado */
    .badge {
        padding: 0.4rem 0.7rem;
        border-radius: 20px;
        font-weight: 600;
        font-size: 0.85rem;
    }

    /* Mapa de congestionamento */
    #congestionMap {
        height: 550px;
        width: 100%;
        border-radius: var(--border-radius);
        overflow: hidden;
    }

    /* Tabelas otimizadas */
    .table {
        margin-bottom: 0;
        font-size: 0.9rem;
    }

    .table thead th {
        background-color: #f8f9fa;
        border-bottom: 2px solid #dee2e6;
        font-weight: 600;
        font-size: 0.85rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        padding: 0.75rem 0.5rem;
        white-space: nowrap;
    }

    .table tbody td {
        padding: 0.75rem 0.5rem;
        vertical-align: middle;
    }

    .table-hover tbody tr:hover {
        background-color: #f8f9fa;
        cursor: pointer;
    }

    /* Botões melhorados */
    .btn-sm {
        padding: 0.35rem 0.7rem;
        font-size: 0.85rem;
        border-radius: 6px;
        transition: var(--transition);
    }

    .btn-group .btn {
        margin: 0 2px;
    }

    .btn-outline-primary:hover {
        transform: scale(1.05);
    }

    /* Card de estatísticas (motoristas) */
    .stat-card {
        text-align: center;
        padding: 2rem;
    }

    .stat-card h2 {
        font-size: 3.5rem;
        font-weight: 700;
        color: #0dcaf0;
        margin: 0;
        line-height: 1;
    }

    .stat-card p {
        font-size: 1rem;
        color: #6c757d;
        margin-top: 0.5rem;
    }

    /* Estados vazios melhorados */
    .empty-state {
        text-align: center;
        padding: 3rem 1rem;
    }

    .empty-state i {
        opacity: 0.3;
        margin-bottom: 1rem;
    }

    .empty-state p {
        color: #6c757d;
        font-size: 1rem;
    }

    /* Responsividade aprimorada */
    @media (max-width: 768px) {
        .card-header {
            font-size: 1rem;
            padding: 0.875rem 1rem;
        }

        .table {
            font-size: 0.85rem;
        }

        .table thead th,
        .table tbody td {
            padding: 0.5rem 0.35rem;
        }

        .col-mobile-hide {
            display: none;
        }

        .btn-sm {
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
        }

        .stat-card h2 {
            font-size: 2.5rem;
        }

        #congestionMap {
            height: 400px;
        }

        .badge {
            font-size: 0.75rem;
            padding: 0.3rem 0.5rem;
        }
    }

    @media (min-width: 769px) {
        .col-mobile-hide {
            display: table-cell;
        }
    }

    @media (min-width: 1400px) {
        .container-fluid {
            max-width: 1600px;
            margin: 0 auto;
        }
    }

    /* DataTables customização */
    .dataTables_wrapper .dataTables_length select,
    .dataTables_wrapper .dataTables_filter input {
        border-radius: 6px;
        border: 1px solid #dee2e6;
        padding: 0.375rem 0.75rem;
    }

    .dataTables_wrapper .dataTables_paginate .paginate_button {
        border-radius: 6px;
        margin: 0 2px;
    }

    /* Badges de confiança */
    .confidence-badge {
        min-width: 50px;
        font-weight: 600;
    }

    /* Animações sutis */
    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .card {
        animation: fadeIn 0.5s ease;
    }

    /* Melhorias de acessibilidade */
    .btn:focus,
    .form-control:focus {
        box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
    }

    /* Tooltip customizado */
    [title] {
        cursor: help;
    }

    /* Modal map */
    .modal-map {
        height: 300px;
        width: 100%;
        border-radius: 8px;
    }
</style>

<div class="container-fluid py-4">
    <div class="row g-4">
        <!-- Card de Acidentes -->
        <div class="col-xl-6 col-lg-12">
            <div class="card h-100">
                <div class="card-header bg-danger text-white">
                    <span>
                        <i class="fas fa-car-crash"></i>
                        Acidentes
                    </span>
                    {% if accidentAlerts is not empty %}
                    <span class="badge bg-light text-dark">{{ accidentAlerts|length }}</span>
                    {% endif %}
                </div>
                <div class="card-body p-0">
                    {% if accidentAlerts is not empty %}
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0" id="accidentsTable">
                            <thead>
                                <tr>
                                    <th>Local</th>
                                    <th class="col-mobile-hide">Rua</th>
                                    <th class="col-mobile-hide">Localização</th>
                                    <th>Data/Hora</th>
                                    <th class="text-center">Conf.</th>
                                    <th class="text-center">Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for alert in accidentAlerts %}
                                <tr>
                                    <td>
                                        <strong class="text-dark">{{ alert.city }}</strong>
                                        <div class="d-md-none">
                                            <small class="text-muted">{{ alert.street }}</small>
                                        </div>
                                    </td>
                                    <td class="col-mobile-hide">{{ alert.street }}</td>
                                    <td class="col-mobile-hide text-center">
                                        <a href="https://www.waze.com/ul?ll={{ alert.location_y }},{{ alert.location_x }}"
                                            target="_blank" class="btn btn-outline-primary btn-sm">
                                            <i class="fab fa-waze"></i>
                                        </a>
                                    </td>
                                    <td>
                                        <div class="fw-semibold">{{ (alert.pubMillis / 1000)|date("d/m/Y") }}</div>
                                        <small class="text-muted">{{ (alert.pubMillis / 1000)|date("H:i") }}</small>
                                    </td>
                                    <td class="text-center">
                                        <span class="badge bg-{{ alert.confidence > 80 ? 'success' : (alert.confidence > 50 ? 'warning text-dark' : 'danger') }} confidence-badge">
                                            {{ alert.confidence }}
                                        </span>
                                    </td>
                                    <td class="text-center">
                                        <div class="btn-group" role="group">
                                            <button class="btn btn-info btn-sm open-modal" 
                                                data-bs-toggle="modal"
                                                data-bs-target="#alertModal{{ alert.uuid }}"
                                                data-lat="{{ alert.location_y }}" 
                                                data-lon="{{ alert.location_x }}"
                                                title="Detalhes">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            <a href="https://www.waze.com/ul?ll={{ alert.location_y }},{{ alert.location_x }}"
                                                target="_blank" class="btn btn-primary btn-sm d-md-none" title="Waze">
                                                <i class="fab fa-waze"></i>
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                                {% include 'modal.twig' with {'alert': alert} %}
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="empty-state">
                        <i class="fas fa-car-crash fa-3x"></i>
                        <p class="mb-0">Não há eventos de acidentes registrados no momento.</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Card de Congestionamentos -->
        <div class="col-xl-6 col-lg-12">
            <div class="card h-100">
                <div class="card-header bg-warning text-dark">
                    <span>
                        <i class="fas fa-traffic-light"></i>
                        Congestionamentos
                    </span>
                    {% if jamAlerts is not empty %}
                    <span class="badge bg-dark">{{ jamAlerts|length }}</span>
                    {% endif %}
                </div>
                <div class="card-body p-0">
                    {% if jamAlerts is not empty %}
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0" id="trafficTable">
                            <thead>
                                <tr>
                                    <th>Local</th>
                                    <th class="col-mobile-hide">Rua</th>
                                    <th class="col-mobile-hide">Localização</th>
                                    <th>Data/Hora</th>
                                    <th class="text-center">Conf.</th>
                                    <th class="text-center">Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for alert in jamAlerts %}
                                <tr>
                                    <td>
                                        <strong class="text-dark">{{ alert.city }}</strong>
                                        <div class="d-md-none">
                                            <small class="text-muted">{{ alert.street }}</small>
                                        </div>
                                    </td>
                                    <td class="col-mobile-hide">{{ alert.street }}</td>
                                    <td class="col-mobile-hide text-center">
                                        <a href="https://www.waze.com/ul?ll={{ alert.location_y }},{{ alert.location_x }}"
                                            target="_blank" class="btn btn-outline-primary btn-sm">
                                            <i class="fab fa-waze"></i>
                                        </a>
                                    </td>
                                    <td>
                                        <div class="fw-semibold">{{ (alert.pubMillis / 1000)|date("d/m/Y") }}</div>
                                        <small class="text-muted">{{ (alert.pubMillis / 1000)|date("H:i") }}</small>
                                    </td>
                                    <td class="text-center">
                                        <span class="badge bg-{{ alert.confidence > 80 ? 'success' : (alert.confidence > 50 ? 'warning text-dark' : 'danger') }} confidence-badge">
                                            {{ alert.confidence }}
                                        </span>
                                    </td>
                                    <td class="text-center">
                                        <div class="btn-group" role="group">
                                            <button class="btn btn-info btn-sm open-modal" 
                                                data-bs-toggle="modal"
                                                data-bs-target="#alertModal{{ alert.uuid }}"
                                                data-lat="{{ alert.location_y }}" 
                                                data-lon="{{ alert.location_x }}"
                                                title="Detalhes">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            <a href="https://www.waze.com/ul?ll={{ alert.location_y }},{{ alert.location_x }}"
                                                target="_blank" class="btn btn-primary btn-sm d-md-none" title="Waze">
                                                <i class="fab fa-waze"></i>
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                                {% include 'modal.twig' with {'alert': alert} %}
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="empty-state">
                        <i class="fas fa-traffic-light fa-3x"></i>
                        <p class="mb-0">Não há congestionamentos registrados no momento.</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Card de Motoristas Impactados -->
        {% if activeDrivers is not empty %}
        <div class="col-xl-6 col-lg-12">
            <div class="card h-100">
                <div class="card-header bg-info text-white">
                    <span>
                        <i class="fas fa-users"></i>
                        Motoristas em Congestionamentos
                    </span>
                    <span class="badge bg-light text-dark">{{ activeDrivers[0].total_wazers_impactados }}</span>
                </div>
                <div class="card-body stat-card">
                    <h2>{{ activeDrivers[0].total_wazers_impactados|number_format(0, ',', '.') }}</h2>
                    <p class="mb-0">motoristas impactados no momento</p>
                    <small class="text-muted">
                        <i class="fas fa-clock"></i>
                        Última atualização: {{ activeDrivers[0].ultima_coleta_dados|date("d/m/Y H:i") }}
                    </small>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Mapa de Congestionamento -->
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-dark text-white">
                    <span>
                        <i class="fas fa-map-marked-alt"></i>
                        Mapa de Congestionamentos em Tempo Real
                    </span>
                    {% if jamLive is not empty %}
                    <span class="badge bg-light text-dark">{{ jamLive|length }} congestionamentos ativos</span>
                    {% endif %}
                </div>
                <div class="card-body p-3">
                    <div id="congestionMap"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
    // Configuração do DataTable para Bootstrap 5
    const dataTableConfig = {
        language: {
            url: '//cdn.datatables.net/plug-ins/1.10.25/i18n/Portuguese-Brasil.json'
        },
        responsive: true,
        pageLength: 10,
        lengthMenu: [[10, 25, 50, -1], [10, 25, 50, "Todos"]],
        order: [[3, 'desc']], // Ordenar por data
        columnDefs: [
            { orderable: false, targets: [-1] }, // Desabilitar ordenação na coluna de ações
            { className: "text-center", targets: [4, 5] }
        ],
        dom: '<"row mb-3"<"col-sm-12 col-md-6"l><"col-sm-12 col-md-6"f>>' +
             '<"row"<"col-sm-12"tr>>' +
             '<"row mt-3"<"col-sm-12 col-md-5"i><"col-sm-12 col-md-7"p>>'
    };

    // Inicializar DataTables
    if ($('#accidentsTable').length) {
        $('#accidentsTable').DataTable(dataTableConfig);
    }

    if ($('#trafficTable').length) {
        $('#trafficTable').DataTable(dataTableConfig);
    }

    // Manipulação de modais com mapas (Bootstrap 5)
    const modalMaps = {};
    
    $('.open-modal').on('click', function() {
        const lat = $(this).data('lat');
        const lon = $(this).data('lon');
        const modalId = $(this).attr('data-bs-target');
        const mapId = modalId.replace('#alertModal', 'map-');

        // Remover eventos anteriores para evitar múltiplas chamadas
        $(modalId).off('shown.bs.modal');
        
        // Usar evento do Bootstrap 5
        $(modalId).one('shown.bs.modal', function() {
            const mapElement = document.getElementById(mapId);
            
            // Verificar se o mapa já existe
            if (mapElement) {
                // Se o mapa já foi criado, apenas reajustar tamanho
                if (modalMaps[mapId]) {
                    setTimeout(function() {
                        modalMaps[mapId].invalidateSize();
                        modalMaps[mapId].setView([lat, lon], 15);
                    }, 200);
                } else {
                    // Criar novo mapa
                    try {
                        const map = L.map(mapId, {
                            center: [lat, lon],
                            zoom: 15,
                            scrollWheelZoom: false
                        });

                        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                            attribution: '&copy; OpenStreetMap contributors',
                            maxZoom: 19
                        }).addTo(map);

                        L.marker([lat, lon]).addTo(map)
                            .bindPopup('Localização do Alerta')
                            .openPopup();

                        // Armazenar referência do mapa
                        modalMaps[mapId] = map;

                        setTimeout(function() {
                            map.invalidateSize();
                        }, 200);
                    } catch (error) {
                        console.error('Erro ao criar mapa:', error);
                    }
                }
            }
        });
    });

    // Inicialização do mapa principal
    const congestionMap = L.map('congestionMap').setView([-20.66, -43.79], 13);
    
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors',
        maxZoom: 19
    }).addTo(congestionMap);

    // Dados de congestionamento vindos do PHP
    const jamsData = {{ jamLive|json_encode|raw }};

    // Função para determinar cor baseada no nível
    function getColorForLevel(level) {
        const colors = {
            5: '#dc3545',  // Vermelho - Parado
            4: '#fd7e14',  // Laranja - Muito lento
            3: '#ffc107',  // Amarelo - Lento
            2: '#28a745',  // Verde - Moderado
            1: '#17a2b8',  // Azul - Leve
        };
        return colors[level] || '#6c757d';
    }

    // Função para obter texto do nível
    function getLevelText(level) {
        const texts = {
            5: 'Trânsito Parado',
            4: 'Muito Lento',
            3: 'Lento',
            2: 'Moderado',
            1: 'Leve'
        };
        return texts[level] || 'Desconhecido';
    }

    // Renderizar congestionamentos no mapa
    if (Array.isArray(jamsData) && jamsData.length > 0) {
        jamsData.forEach(jam => {
            if (jam.lines && Array.isArray(jam.lines) && jam.lines.length > 0) {
                const latlngs = jam.lines.map(line => [line.latitude, line.longitude]);
                const color = getColorForLevel(jam.level);
                const levelText = getLevelText(jam.level);
                
                L.polyline(latlngs, {
                    color: color,
                    weight: 6,
                    opacity: 0.8,
                    lineJoin: 'round',
                    lineCap: 'round'
                }).addTo(congestionMap)
                  .bindPopup(`
                    <div style="min-width: 200px;">
                        <strong>${jam.street || 'Rua não identificada'}</strong><br>
                        <strong>Cidade:</strong> ${jam.city || 'N/A'}<br>
                        <strong>Nível:</strong> ${jam.level}/5 - ${levelText}<br>
                        <strong>Comprimento:</strong> ${jam.length || 0} metros<br>
                        <strong>Velocidade:</strong> ${jam.speed || 0} km/h<br>
                        <strong>Atraso:</strong> ${jam.delay || 0} segundos
                    </div>
                  `);
            }
        });

        // Ajustar o zoom para mostrar todos os congestionamentos
        if (jamsData.length > 0) {
            const bounds = [];
            jamsData.forEach(jam => {
                if (jam.lines && jam.lines.length > 0) {
                    jam.lines.forEach(line => {
                        bounds.push([line.latitude, line.longitude]);
                    });
                }
            });
            if (bounds.length > 0) {
                congestionMap.fitBounds(bounds, { padding: [50, 50] });
            }
        }
    } else {
        console.log('Nenhum dado de congestionamento disponível');
    }

    // Ajustar mapa após carregamento completo
    setTimeout(() => {
        congestionMap.invalidateSize();
    }, 300);

    // Inicializar tooltips do Bootstrap 5
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
});
</script>

<script src="https://cdn.datatables.net/1.10.25/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.10.25/js/dataTables.bootstrap5.min.js"></script>