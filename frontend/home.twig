<!-- Content Row -->
<div class="container">
    <div class="row">
        <!-- Acidentes -->
        <div class="col-xl-6 col-lg-6">
            <div class="card">
                <div class="card-header bg-primary text-white">Acidentes</div>
                <!-- Card Body -->
                <div class="card-body">
                    {% if accidentAlerts is not empty %}
                    <div class="table-responsive">
                        <table class="table table-striped table-bordered" id="accidentsTable">
                            <thead>
                                <tr>
                                    <th>Cidade</th>
                                    <th>Rua</th>
                                    <th>Localização</th>
                                    <th>Data Evento</th>
                                    <th>Nota</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for alert in accidentAlerts %}
                                <tr data-uuid="{{ alert.uuid }}">
                                    <td data-toggle="tooltip" title="{{ alert.city }}">{{ alert.city }}</td>
                                    <td data-toggle="tooltip" title="{{ alert.street }}">{{ alert.street }}</td>
                                    <td data-toggle="tooltip" title="Lat: {{ alert.location_x }}, Lon: {{ alert.location_y }}">
                                        <a href="https://www.waze.com/ul?ll={{ alert.location_y }},{{ alert.location_x }}" 
                                           class="btn btn-link" target="_blank">
                                            Ver no Waze
                                        </a>
                                    </td>
                                    <td class="alert-date" data-pubmillis="{{ alert.pubMillis }}" 
                                        data-toggle="tooltip" title="{{ (alert.pubMillis / 1000) | date('d/m/Y H:i:s') }}">
                                        {{ (alert.pubMillis / 1000) | date("d/m/Y H:i:s") }}
                                    </td>
                                    <td>
                                        <span class="badge badge-{{ alert.confidence > 80 ? 'success' : (alert.confidence > 50 ? 'warning' : 'danger') }}">
                                            {{ alert.confidence }}
                                        </span>
                                    </td>
                                    <td>
                                        <button class="btn btn-info btn-sm" data-toggle="modal" data-target="#alertModal" 
                                                data-alert='{{ alert|json_encode }}'>
                                            Ver Mais
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <p class="text-center">Não há eventos de acidentes registrados no momento.</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Congestionamentos -->
        <div class="col-xl-6 col-lg-6">
            <div class="card">
                <div class="card-header bg-warning text-white">Congestionamentos</div>
                <!-- Card Body -->
                <div class="card-body">
                    {% if jamAlerts is not empty %}
                    <div class="table-responsive">
                        <table class="table table-striped table-bordered" id="trafficTable">
                            <thead>
                                <tr>
                                    <th>Cidade</th>
                                    <th>Rua</th>
                                    <th>Localização</th>
                                    <th>Data Evento</th>
                                    <th>Intensidade</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for alerts in jamAlerts %}
                                <tr data-uuid="{{ alert.uuid }}">
                                    <td data-toggle="tooltip" title="{{ alert.city }}">{{ alert.city }}</td>
                                    <td data-toggle="tooltip" title="{{ alert.street }}">{{ alert.street }}</td>
                                    <td data-toggle="tooltip" title="Lat: {{ alert.location_x }}, Lon: {{ alert.location_y }}">
                                        <a href="https://www.waze.com/ul?ll={{ alert.location_y }},{{ alert.location_x }}" 
                                           class="btn btn-link" target="_blank">
                                            Ver no Waze
                                        </a>
                                    </td>
                                    <td class="alert-date" data-pubmillis="{{ alert.pubMillis }}" 
                                        data-toggle="tooltip" title="{{ (alert.pubMillis / 1000) | date('d/m/Y H:i:s') }}">
                                        {{ (alert.pubMillis / 1000) | date("d/m/Y H:i:s") }}
                                    </td>
                                    <td>
                                        <span class="badge badge-{{ alert.severity > 80 ? 'danger' : (alert.severity > 50 ? 'warning' : 'success') }}">
                                            {{ alert.severity }}
                                        </span>
                                    </td>
                                    <td>
                                        <button class="btn btn-info btn-sm" data-toggle="modal" data-target="#alertModal" 
                                                data-alert='{{ alert|json_encode }}'>
                                            Ver Mais
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <p class="text-center">Não há eventos de congestionamentos registrados no momento.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal -->
<div class="modal fade" id="alertModal" tabindex="-1" aria-labelledby="alertModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="alertModalLabel">Detalhes do Alerta</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p id="alertDetails"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>

<script>
    $(document).ready(function() {
        // Inicializar o DataTable para acidentes e congestionamentos
        $('#accidentsTable').DataTable({
            "responsive": true,
            "autoWidth": false
        });

        $('#trafficTable').DataTable({
            "responsive": true,
            "autoWidth": false
        });

        // Modificar o conteúdo do modal ao clicar no botão
        $('#alertModal').on('show.bs.modal', function (event) {
            var button = $(event.relatedTarget);
            var alertData = button.data('alert');
            var modal = $(this);
            modal.find('#alertDetails').text(JSON.stringify(alertData, null, 2)); // Exibe os detalhes
        });
    });
</script>

<!-- Inicializando os tooltips e DataTables do Bootstrap -->
<script>
    $(document).ready(function () {
        // Inicializa tooltips
        $('[data-toggle="tooltip"]').tooltip();
        jQuery.noConflict();

        // Inicializa DataTables para a tabela de acidentes
        $('#accidentsTable').DataTable({
            paging: true,
            searching: true,
            info: true,
            language: {
                search: "Buscar:",
                paginate: {
                    next: "Próximo",
                    previous: "Anterior",
                },
            },
        });

        // Inicializa DataTables para a tabela de congestionamentos
        $('#jamsTable').DataTable({
            paging: true,
            searching: true,
            info: true,
            language: {
                search: "Buscar:",
                paginate: {
                    next: "Próximo",
                    previous: "Anterior",
                },
            },
        });

        // Exibir os detalhes do alerta e consultar o DENIT ao abrir o modal
        $('#alertModal').on('show.bs.modal', function (event) {
            console.log("Modal aberto: evento disparado.");
        
            var button = $(event.relatedTarget); // Obtém o botão que acionou a modal
            if (!button.length) {
                console.log("Erro: Não foi possível encontrar o botão que acionou o modal.");
                return;
            }
        
            var uuid = button.closest('tr').data('uuid'); // Obtém o UUID do alerta
            var locationX = button.closest('tr').find('td[data-toggle="tooltip"]').data('lat'); // Latitude
            var locationY = button.closest('tr').find('td[data-toggle="tooltip"]').data('lon'); // Longitude
        
            console.log("UUID capturado:", uuid);
            console.log("Coordenadas capturadas: Lat =", locationX, ", Lon =", locationY);
        
            if (!locationX || !locationY) {
                console.log("Erro: Coordenadas não encontradas.");
                return;
            }
        
            // URL do DENIT
            var denitUrl = `https://servicos.dnit.gov.br/sgplan/apigeo/rotas/localizarkm?lng=${locationX}&lat=${locationY}&r=250&data=${new Date().toISOString().split('T')[0]}`;
            console.log("URL de consulta ao DENIT:", denitUrl);
        
            // Faz a requisição ao DENIT
            $.ajax({
                url: denitUrl,
                type: 'GET',
                success: function (response) {
                    console.log("Resposta da API DENIT:", response);
                    if (response && response.length > 0) {
                        const result = response[0]; // Obtendo o primeiro resultado
                        $('#modal-uuid').text(uuid || 'N/A');
                        $('#modal-city').text(result.uf || 'N/A');
                        $('#modal-street').text(result.br || 'N/A');
                        $('#modal-type').text('DENIT Response');
                        $('#modal-subtype').text('N/A');
                        $('#modal-status').text('Ativo');
                        $('#modal-date-received').text(new Date().toLocaleString());
                        $('#modal-confidence').text('N/A');
                        $('#modal-location').text(
                            `Lat: ${result.lat || 'N/A'}, Lon: ${result.lng || 'N/A'}`
                        );
                    } else {
                        alert('Nenhum dado encontrado para as coordenadas fornecidas.');
                    }
                },
                error: function (xhr, status, error) {
                    console.error("Erro na requisição ao DENIT:", status, error);
                    alert('Erro ao consultar os dados do DENIT. Tente novamente.');
                },
            });
        });        

        // Função para confirmar o alerta no banco de dados
        function confirmarAlerta(uuid) {
            $.ajax({
                url: '/confirmar_alerta', // URL da sua API ou rota para confirmar o alerta
                type: 'POST',
                data: {
                    uuid: uuid,
                    status: 1, // Aqui você pode definir o status como "Ativo" ao confirmar
                },
                success: function (response) {
                    alert('Alerta confirmado com sucesso!');
                    $('#alertModal').modal('hide');
                },
                error: function (xhr, status, error) {
                    alert('Erro ao confirmar o alerta. Tente novamente.');
                },
            });
        }

        // Adicionar evento para confirmar o alerta
        $('#confirm-alert').on('click', function () {
            var uuid = $('#modal-uuid').text(); // Obtém o UUID do alerta da modal
            confirmarAlerta(uuid);
        });
    });
</script>
