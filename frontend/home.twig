<!-- Content Row -->
<div class="container">
    <div class="row">
        <!-- Acidentes -->
        <div class="col-xl-6 col-lg-6">
            <div class="card">
                <div class="card-header bg-primary text-white">Acidentes</div>
                <!-- Card Body -->
                <div class="card-body">
                    {% if accidentAlerts is not empty %}
                    <div class="table-responsive">
                        <table class="table table-striped table-bordered" id="accidentsTable">
                            <thead>
                                <tr>
                                    <th>Cidade</th>
                                    <th>Rua</th>
                                    <th>Localização</th>
                                    <th>Data Evento</th>
                                    <th>Nota</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for alert in accidentAlerts %}
                                <tr data-uuid="{{ alert.uuid }}">
                                    <td data-toggle="tooltip" title="{{ alert.city }}">{{ alert.city }}</td>
                                    <td data-toggle="tooltip" title="{{ alert.street }}">{{ alert.street }}</td>
                                    <td data-toggle="tooltip" title="Lat: {{ alert.location_x }}, Lon: {{ alert.location_y }}">
                                        <a href="https://www.waze.com/ul?ll={{ alert.location_y }},{{ alert.location_x }}" 
                                           class="btn btn-link" target="_blank">
                                            Ver no Waze
                                        </a>
                                    </td>
                                    <td class="alert-date" data-pubmillis="{{ alert.pubMillis }}" 
                                        data-toggle="tooltip" title="{{ (alert.pubMillis / 1000) | date('d/m/Y H:i:s') }}">
                                        {{ (alert.pubMillis / 1000) | date("d/m/Y H:i:s") }}
                                    </td>
                                    <td>
                                        <span class="badge badge-{{ alert.confidence > 80 ? 'success' : (alert.confidence > 50 ? 'warning' : 'danger') }}">
                                            {{ alert.confidence }}
                                        </span>
                                    </td>
                                    <td>
                                        <button class="btn btn-info btn-sm" data-toggle="modal" data-target="#alertModal" 
                                                data-alert='{{ alert|json_encode }}'>
                                            Ver Mais
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <p class="text-center">Não há eventos de acidentes registrados no momento.</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Congestionamentos -->
        <div class="col-xl-6 col-lg-6 pt-2">
            <div class="card">
                <div class="card-header bg-warning text-white">Congestionamentos</div>
                <!-- Card Body -->
                <div class="card-body">
                    {% if jamAlerts is not empty %}
                    <div class="table-responsive">
                        <table class="table table-striped table-bordered" id="trafficTable">
                            <thead>
                                <tr>
                                    <th>Cidade</th>
                                    <th>Rua</th>
                                    <th>Localização</th>
                                    <th>Data Evento</th>
                                    <th>Intensidade</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for alerts in jamAlerts %}
                                <tr data-uuid="{{ alert.uuid }}">
                                    <td data-toggle="tooltip" title="{{ alerts.city }}">{{ alerts.city }}</td>
                                    <td data-toggle="tooltip" title="{{ alerts.street }}">{{ alerts.street }}</td>
                                    <td data-toggle="tooltip" title="Lat: {{ alerts.location_x }}, Lon: {{ alerts.location_y }}">
                                        <a href="https://www.waze.com/ul?ll={{ alerts.location_y }},{{ alerts.location_x }}" 
                                           class="btn btn-link" target="_blank">
                                            Ver no Waze
                                        </a>
                                    </td>
                                    <td class="alert-date" data-pubmillis="{{ alerts.pubMillis }}" 
                                        data-toggle="tooltip" title="{{ (alerts.pubMillis / 1000) | date('d/m/Y H:i:s') }}">
                                        {{ (alerts.pubMillis / 1000) | date("d/m/Y H:i:s") }}
                                    </td>
                                    <td>
                                        <span class="badge badge-{{ alerts.severity > 80 ? 'danger' : (alerts.severity > 50 ? 'warning' : 'success') }}">
                                            {{ alerts.severity }}
                                        </span>
                                    </td>
                                    <td>
                                        <button class="btn btn-info btn-sm" data-toggle="modal" data-target="#alertModal" 
                                                data-alert='{{ alerts|json_encode }}'>
                                            Ver Mais
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <p class="text-center">Não há eventos de congestionamentos registrados no momento.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal -->
<div class="modal fade" id="alertModal" tabindex="-1" aria-labelledby="alertModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="alertModalLabel">Detalhes do Alerta</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p><strong>UUID:</strong> <span id="modal-uuid">N/A</span></p>
                <p><strong>Cidade:</strong> <span id="modal-city">N/A</span></p>
                <p><strong>Via:</strong> <span id="modal-street">N/A</span></p>
                <p><strong>KM:</strong> <span id="modal-via-KM">N/A</span></p>
                <p><strong>Localização:</strong> <span id="modal-location">N/A</span></p>
                <p><strong>Data Recebido:</strong> <span id="modal-date-received">N/A</span></p>
                <p><strong>Confiança:</strong> <span id="modal-confidence">N/A</span></p>
                <p><strong>Tipo:</strong> <span id="modal-type">N/A</span></p>
                <p><strong>Subtipo:</strong> <span id="modal-subtype">N/A</span></p>
                <p><strong>Status:</strong> <span id="modal-status">N/A</span></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Fechar</button>
                <button type="button" class="btn btn-primary" id="confirm-alert">Confirmar Alerta</button>
            </div>
        </div>
    </div>
</div>

<script>
$(document).ready(function() {
    // Inicializar DataTables apenas se ainda não estiverem inicializados
    if (!$.fn.DataTable.isDataTable('#accidentsTable')) {
        $('#accidentsTable').DataTable({
            responsive: true,
            autoWidth: false,
            paging: true,
            searching: true,
            info: true,
            language: {
                search: "Buscar:",
                paginate: {
                    next: "Próximo",
                    previous: "Anterior",
                },
            },
        });
    }

    if (!$.fn.DataTable.isDataTable('#trafficTable')) {
        $('#trafficTable').DataTable({
            responsive: true,
            autoWidth: false
        });
    }

    if (!$.fn.DataTable.isDataTable('#jamsTable')) {
        $('#jamsTable').DataTable({
            responsive: true,
            autoWidth: false,
            paging: true,
            searching: true,
            info: true,
            language: {
                search: "Buscar:",
                paginate: {
                    next: "Próximo",
                    previous: "Anterior",
                },
            },
        });
    }

    // Inicializa tooltips
    $('[data-toggle="tooltip"]').tooltip();
    jQuery.noConflict();

    // Evento para abrir o modal e carregar os dados do alerta
    $('#alertModal').on('show.bs.modal', function(event) {
        var button = $(event.relatedTarget);
        var alertData = button.data('alert');

        if (!alertData) {
            console.error("Erro: Não foi possível obter os dados do alerta.");
            return;
        }

        var modal = $(this);
        modal.find('#modal-uuid').text(alertData.uuid || 'N/A');
        modal.find('#modal-city').text(alertData.city || 'N/A');
        modal.find('#modal-street').text(alertData.street || 'N/A');
        modal.find('#modal-location').text(`Lat: ${alertData.location_x || 'N/A'}, Lon: ${alertData.location_y || 'N/A'}`);
        modal.find('#modal-date-received').text(new Date(alertData.pubMillis).toLocaleString() || 'N/A');
        modal.find('#modal-confidence').text(alertData.confidence || 'N/A');
        modal.find('#modal-type').text('Alerta');
        modal.find('#modal-subtype').text('N/A');

        // Define o status do alerta
        var status = alertData.status === 1 ? 'Ativo' : (alertData.status === 0 ? 'Inativo' : 'N/A');
        modal.find('#modal-status').text(status);

        // Consulta ao DNIT para obter o KM
        var locationX = alertData.location_x;
        var locationY = alertData.location_y;

        if (locationX && locationY) {
            var denitUrl = `https://servicos.dnit.gov.br/sgplan/apigeo/rotas/localizarkm?lng=${locationX}&lat=${locationY}&r=250&data=${new Date().toISOString().split('T')[0]}`;
            console.log("Consultando o DNIT com a URL:", denitUrl);

            $.ajax({
                url: denitUrl,
                type: 'GET',
                success: function(response, textStatus, xhr) {
                    console.log("Status da resposta:", xhr.status);  // Verifica se o status é 200
                    console.log("Resposta do DNIT:", response);
            
                    if (xhr.status === 200) {  // Confirma que a resposta foi bem-sucedida
                        try {
                            // Se a resposta for uma string, converter para JSON
                            if (typeof response === "string") {
                                response = JSON.parse(response);
                                console.log("Resposta convertida para JSON:", response);
                            }
            
                            // Caso a resposta seja um objeto válido
                            if (response && typeof response === 'object') {
                                console.log("Estrutura do JSON DNIT:", response);
            
                                // Procura o campo 'km' dentro do JSON (verifique se está aninhado)
                                var km = response.km || (response.data ? response.data.km : null);
            
                                if (km !== null) {
                                    km = parseFloat(km);
                                    if (!isNaN(km)) {
                                        console.log("KM convertido:", km.toFixed(2));
                                        $('#modal-via-KM').text(km.toFixed(2)); // Atualiza o modal
                                    } else {
                                        console.warn("O valor de KM não é um número válido:", km);
                                        $('#modal-via-KM').text('N/A');
                                    }
                                } else {
                                    console.warn("Campo 'km' não encontrado na resposta.");
                                    $('#modal-via-KM').text('N/A');
                                }
                            } else {
                                console.error("Resposta inválida do DNIT.", response);
                                $('#modal-via-KM').text('N/A');
                            }
                        } catch (e) {
                            console.error("Erro ao processar a resposta JSON:", e);
                            $('#modal-via-KM').text('N/A');
                        }
                    } else {
                        console.warn("Resposta não foi 200 OK:", xhr.status);
                        $('#modal-via-KM').text('N/A');
                    }
                },
                error: function(xhr, status, error) {
                    console.error("Erro na requisição ao DNIT:", status, error);
                    alert('Erro ao consultar os dados do DNIT. Tente novamente.');
                }
            });        
        } else {
            console.log("Sem coordenadas válidas para consulta ao DNIT.");
            modal.find('#modal-via-KM').text('N/A');
        }

        console.log("Dados do alerta:", alertData);
    });

    // Função para confirmar alerta
    function confirmarAlerta(uuid) {
        $.ajax({
            url: '/api.php?action=confirm_alert',
            type: 'POST',
            data: { uuid: uuid, status: 1 },
            success: function(response) {
                alert('Alerta confirmado com sucesso!');
                $('#alertModal').modal('hide');
            },
            error: function(xhr, status, error) {
                alert('Erro ao confirmar o alerta. Tente novamente.');
            },
        });
    }

    // Evento para confirmar alerta
    $('#confirm-alert').on('click', function() {
        var uuid = $('#modal-uuid').text();
        confirmarAlerta(uuid);
    });
});
</script>