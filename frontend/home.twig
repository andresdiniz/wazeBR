<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/1.10.25/css/dataTables.bootstrap4.min.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>


<style>
    #congestionMap {
        height: 500px;
        width: 100%;
    }

    /* Melhorias mínimas para responsividade */
    @media (max-width: 767.98px) {
        .table-responsive {
            font-size: 0.85rem;
        }

        .table th,
        .table td {
            padding: 0.5rem 0.25rem;
            vertical-align: middle;
        }

        .btn-sm {
            padding: 0.2rem 0.4rem;
            font-size: 0.75rem;
        }

        .badge {
            font-size: 0.7rem;
            padding: 0.2rem 0.4rem;
        }

        /* Ocultar colunas menos importantes em mobile */
        .d-none-mobile {
            display: none !important;
        }

        .card-header {
            padding: 0.75rem 1rem;
            font-size: 0.95rem;
        }
    }

    @media (min-width: 768px) {
        .d-none-mobile {
            display: table-cell !important;
        }
    }

    /* Melhor aproveitamento da área */
    .container {
        max-width: 100%;
        padding-left: 15px;
        padding-right: 15px;
    }

    @media (min-width: 1200px) {
        .container {
            max-width: 1400px;
        }
    }

    /* Tabelas mais compactas */
    .table-sm th,
    .table-sm td {
        padding: 0.5rem;
    }

    .card-body {
        padding: 1rem;
    }

    /* Melhorar legibilidade dos badges */
    .badge {
        min-width: 45px;
        padding: 0.375rem 0.5rem;
    }

    /* Botões de ação mais compactos */
    .btn-group-sm>.btn,
    .btn-sm {
        padding: 0.25rem 0.5rem;
        font-size: 0.8rem;
    }
</style>

<div class="container-fluid mt-3">
    <div class="row">
        <div class="col-xl-6 col-lg-12 mb-4">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-primary text-white d-flex align-items-center justify-content-between">
                    <span><i class="fas fa-car-crash mr-2"></i>Acidentes</span>
                    {% if accidentAlerts is not empty %}
                    <span class="badge badge-light">{{ accidentAlerts|length }}</span>
                    {% endif %}
                </div>
                <div class="card-body p-2">
                    {% if accidentAlerts is not empty %}
                    <div class="table-responsive">
                        <table class="table table-striped table-sm mb-0" id="accidentsTable">
                            <thead class="thead-light">
                                <tr>
                                    <th>Local</th>
                                    <th class="d-none-mobile">Rua</th>
                                    <th class="d-none d-md-table-cell">Localização</th>
                                    <th>Data</th>
                                    <th class="text-center">Conf.</th>
                                    <th class="text-center">Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for alert in accidentAlerts %}
                                <tr>
                                    <td>
                                        <strong>{{ alert.city }}</strong>
                                        <div class="d-md-none">
                                            <small class="text-muted">{{ alert.street }}</small>
                                        </div>
                                    </td>
                                    <td class="d-none-mobile">{{ alert.street }}</td>
                                    <td class="d-none d-md-table-cell">
                                        <a href="https://www.waze.com/ul?ll={{ alert.location_y }},{{ alert.location_x }}"
                                            target="_blank" class="btn btn-outline-primary btn-sm">
                                            <i class="fab fa-waze"></i>
                                        </a>
                                    </td>
                                    <td>
                                        <div>{{ (alert.pubMillis / 1000) | date("d/m/Y") }}</div>
                                        <small class="text-muted">{{ (alert.pubMillis / 1000) | date("H:i") }}</small>
                                    </td>
                                    <td class="text-center">
                                        <span
                                            class="badge badge-{{ alert.confidence > 80 ? 'success' : (alert.confidence > 50 ? 'warning' : 'danger') }}">
                                            {{ alert.confidence }}
                                        </span>
                                    </td>
                                    <td class="text-center">
                                        <div class="btn-group" role="group">
                                            <button class="btn btn-info btn-sm open-modal" data-toggle="modal"
                                                data-target="#alertModal{{ alert.uuid }}"
                                                data-lat="{{ alert.location_y }}" data-lon="{{ alert.location_x }}"
                                                title="Detalhes">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            <a href="https://www.waze.com/ul?ll={{ alert.location_y }},{{ alert.location_x }}"
                                                target="_blank" class="btn btn-primary btn-sm d-md-none" title="Waze">
                                                <i class="fab fa-waze"></i>
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                                {% include 'modal.twig' with {'alert': alert} %}
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-car-crash fa-3x text-muted mb-3"></i>
                        <p class="text-muted mb-0">Não há eventos de acidentes registrados no momento.</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="col-xl-6 col-lg-12 mb-4">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-warning text-dark d-flex align-items-center justify-content-between">
                    <span><i class="fas fa-traffic-light mr-2"></i>Congestionamentos</span>
                    {% if jamAlerts is not empty %}
                    <span class="badge badge-dark">{{ jamAlerts|length }}</span>
                    {% endif %}
                </div>
                <div class="card-body p-2">
                    {% if jamAlerts is not empty %}
                    <div class="table-responsive">
                        <table class="table table-striped table-sm mb-0" id="trafficTable">
                            <thead class="thead-light">
                                <tr>
                                    <th>Local</th>
                                    <th class="d-none-mobile">Rua</th>
                                    <th class="d-none d-md-table-cell">Localização</th>
                                    <th>Data</th>
                                    <th class="text-center">Conf.</th>
                                    <th class="text-center">Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for alert in jamAlerts %}
                                <tr>
                                    <td>
                                        <strong>{{ alert.city }}</strong>
                                        <div class="d-md-none">
                                            <small class="text-muted">{{ alert.street }}</small>
                                        </div>
                                    </td>
                                    <td class="d-none-mobile">{{ alert.street }}</td>
                                    <td class="d-none d-md-table-cell">
                                        <a href="https://www.waze.com/ul?ll={{ alert.location_y }},{{ alert.location_x }}"
                                            target="_blank" class="btn btn-outline-primary btn-sm">
                                            <i class="fab fa-waze"></i>
                                        </a>
                                    </td>
                                    <td>
                                        <div>{{ (alert.pubMillis / 1000) | date("d/m/Y") }}</div>
                                        <small class="text-muted">{{ (alert.pubMillis / 1000) | date("H:i") }}</small>
                                    </td>
                                    <td class="text-center">
                                        <span
                                            class="badge badge-{{ alert.confidence > 80 ? 'success' : (alert.confidence > 50 ? 'warning' : 'danger') }}">
                                            {{ alert.confidence }}
                                        </span>
                                    </td>
                                    <td class="text-center">
                                        <div class="btn-group" role="group">
                                            <button class="btn btn-info btn-sm open-modal" data-toggle="modal"
                                                data-target="#alertModal{{ alert.uuid }}"
                                                data-lat="{{ alert.location_y }}" data-lon="{{ alert.location_x }}"
                                                title="Detalhes">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            <a href="https://www.waze.com/ul?ll={{ alert.location_y }},{{ alert.location_x }}"
                                                target="_blank" class="btn btn-primary btn-sm d-md-none" title="Waze">
                                                <i class="fab fa-waze"></i>
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                                {% include 'modal.twig' with {'alert': alert} %}
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-traffic-light fa-3x text-muted mb-3"></i>
                        <p class="text-muted mb-0">Não há congestionamentos registrados no momento.</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="col-xl-6 col-lg-12 mb-4">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-info text-white d-flex align-items-center justify-content-between">
                    <span><i class="fas fa-users mr-2"></i>Motoristas Em Congestionamentos</span>
                    {% if activeDrivers is defined %}
                    <span class="badge badge-light">{{ activeDrivers }}</span>
                    {% endif %}
                </div>
                <div class="card-body d-flex align-items-center justify-content-center">
                    {% if activeDrivers is defined %}
                    <h2 class="font-weight-bold">{{ activeDrivers }}</h2>
                    {% else %}
                    <p class="text-muted mb-0">Dados de motoristas não disponíveis.</p>
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-body p-2">
                    <div id="congestionMap"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        $(".open-modal").on("click", function () {
            let lat = $(this).data("lat");
            let lon = $(this).data("lon");
            let modalId = $(this).attr("data-target");
            let mapId = modalId.replace("#alertModal", "map-");

            $(modalId).on('shown.bs.modal', function () {
                // Verificação melhorada para evitar erro
                let mapElement = document.getElementById(mapId);
                if (mapElement && !mapElement._leaflet_id) {
                    let map = L.map(mapId).setView([lat, lon], 15);

                    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
                        attribution: "&copy; OpenStreetMap contributors"
                    }).addTo(map);

                    L.marker([lat, lon]).addTo(map)
                        .bindPopup("Localização do Alerta")
                        .openPopup();

                    setTimeout(function () {
                        map.invalidateSize();
                    }, 100);
                }
            });
        });

        // Configuração otimizada do DataTable para responsividade
        const dataTableConfig = {
            language: {
                url: '//cdn.datatables.net/plug-ins/1.10.25/i18n/Portuguese-Brasil.json'
            },
            scrollX: true,
            responsive: true,
            pageLength: 25, // Mais itens por página para aproveitar melhor a tela
            lengthMenu: [[10, 25, 50, -1], [10, 25, 50, "Todos"]],
            order: [[3, 'desc']], // Ordenar por data
            columnDefs: [
                { orderable: false, targets: [5] }, // Desabilitar ordenação na coluna de ações
                { width: "15%", targets: [0] }, // Largura da coluna cidade
                { width: "8%", targets: [4] }, // Largura da coluna confiança
                { width: "10%", targets: [5] } // Largura da coluna ações
            ],
            dom: '<"row"<"col-sm-12 col-md-6"l><"col-sm-12 col-md-6"f>>' +
                '<"row"<"col-sm-12"tr>>' +
                '<"row"<"col-sm-12 col-md-5"i><"col-sm-12 col-md-7"p>>'
        };

        if ($('#accidentsTable').length) {
            $('#accidentsTable').DataTable(dataTableConfig);
        }

        if ($('#trafficTable').length) {
            $('#trafficTable').DataTable(dataTableConfig);
        }
    });

    async function buscarKmDnit(latitude, longitude, raio) {
        console.log("Buscando KM para:", latitude, longitude, raio);
        await new Promise(resolve => setTimeout(resolve, 500));
        return "KM Desconhecido";
    }
    // Inicialização do mapa de congestionamento
    const congestionMap = L.map('congestionMap').setView([-20.66, -43.79], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
    }).addTo(congestionMap);

    const jamsData = {{ jamLive| json_encode | raw }};

    function getColorForLevel(level) {
        switch (level) {
            case 5: return 'red';    // Tráfego parado
            case 4: return 'orange'; // Tráfego muito lento
            case 3: return 'yellow'; // Tráfego lento
            case 2: return 'lime';   // Tráfego moderado
            case 1: return 'blue';   // Tráfego leve
            default: return 'gray';
        }
    }

    if (Array.isArray(jamsData)) {
        jamsData.forEach(jam => {
            if (jam.lines && Array.isArray(jam.lines) && jam.lines.length > 0) {
                const latlngs = jam.lines.map(line => [line.latitude, line.longitude]);
                const color = getColorForLevel(jam.level);
                L.polyline(latlngs, {
                    color: color,
                    weight: 5,
                    opacity: 0.7
                }).addTo(congestionMap).bindPopup(`Congestionamento: Nível ${jam.level}, Rua: ${jam.street}`);
            }
        });
    } else {
        console.error("Os dados de congestionamento não são um array:", jamsData);
    }
</script>

<link rel="stylesheet" href="https://cdn.datatables.net/1.10.25/css/dataTables.bootstrap4.min.css">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.3/dist/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
<script src="https://cdn.datatables.net/1.10.25/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.10.25/js/dataTables.bootstrap4.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">