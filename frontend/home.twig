<!-- Content Row -->
<div class="container">
<div class="row">
    <!-- Area Chart -->
    <div class="col-xl-6 col-lg-6">
        <div class="card-header bg-primary text-white">Acidentes</div>
            <!-- Card Body -->
            <div class="card-body">
                {% if accidentAlerts is not empty %}
                <div class="table-responsive">
                    <table class="table" id="accidentsTable">
                        <thead>
                            <tr>
                                <th>Cidade</th>
                                <th>Rua</th>
                                <th>Localização</th>
                                <th>Data Evento</th>
                                <th>Nota</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for alert in accidentAlerts %}
                            <tr data-uuid="{{ alert.uuid }}">
                                <td data-toggle="tooltip" title="{{ alert.city }}">{{ alert.city }}</td>
                                <td data-toggle="tooltip" title="{{ alert.street }}">{{ alert.street }}</td>
                                <td data-toggle="tooltip" title="Lat: {{ alert.location_x }}, Lon: {{ alert.location_y }}">
                                    <a href="https://www.waze.com/ul?ll={{ alert.location_y }},{{ alert.location_x }}" target="_blank">
                                        Ver no Waze
                                    </a>
                                </td>
                                <td class="alert-date" data-pubmillis="{{ alert.pubMillis }}" data-toggle="tooltip" 
                                    title="{{ (alert.pubMillis / 1000) | date('d/m/Y H:i:s') }}">
                                    {{ (alert.pubMillis / 1000) | date("d/m/Y H:i:s") }}
                                </td>
                                <td>
                                    <span class="badge badge-{{ alert.confidence > 80 ? 'success' : (alert.confidence > 50 ? 'warning' : 'danger') }}">
                                        {{ alert.confidence }}
                                    </span>
                                </td>
                                <td>
                                    <button class="btn btn-info btn-sm" 
                                            data-toggle="modal" 
                                            data-target="#alertModal" 
                                            data-alert='{{ alert|json_encode }}'>
                                        VER +
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p>Não há eventos de acidentes registrados no momento.</p>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Content Column (Congestionamentos) -->
    <div class="col-lg-6 mb-4">
        <div class="card shadow mb-4">
            <div class="card-header bg-danger text-white">Acidentes</div>
            <div class="card-body">
                {% if jamAlerts is not empty %}
                <div class="table-responsive">
                    <table class="table" id="jamsTable">
                        <thead>
                            <tr>
                                <th>Cidade</th>
                                <th>Rua</th>
                                <th>Localização</th>
                                <th>Data do Evento</th>
                                <th>Nota</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for alert in jamAlerts %}
                            <tr>
                                <td data-toggle="tooltip" title="{{ alert.city }}">{{ alert.city }}</td>
                                <td data-toggle="tooltip" title="{{ alert.street }}">{{ alert.street }}</td>
                                <td data-toggle="tooltip" title="Lat: {{ alert.location_x }}, Lon: {{ alert.location_y }}">
                                    <a href="https://www.waze.com/ul?ll={{ alert.location_y }},{{ alert.location_x }}" target="_blank">
                                        Ver no Waze
                                    </a>
                                </td>
                                <td class="alert-date" data-pubmillis="{{ alert.pubMillis }}" data-toggle="tooltip" 
                                    title="{{ (alert.pubMillis / 1000) | date('d/m/Y H:i:s') }}">
                                    {{ (alert.pubMillis / 1000) | date("d/m/Y H:i:s") }}
                                </td>
                                <td>
                                    <span class="badge badge-{{ alert.confidence > 80 ? 'success' : (alert.confidence > 50 ? 'warning' : 'danger') }}">
                                        {{ alert.confidence }}
                                    </span>
                                </td>
                                <td>
                                    <button class="btn btn-info btn-sm" 
                                            data-toggle="modal" 
                                            data-target="#alertModal" 
                                            data-alert='{{ alert|json_encode }}'>
                                        VER +
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p>Não há alertas de congestionamento registrados no momento.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Modal Atualizado -->
<div class="modal fade" id="alertModal" tabindex="-1" aria-labelledby="alertModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="alertModalLabel">
                    Detalhes do Alerta: <span id="modal-type-title"></span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button> <!-- Atualizado para Bootstrap 5 -->
            </div>
            <div class="modal-body">
                <p><strong>UUID:</strong> <span id="modal-uuid"></span></p>
                <p><strong>Cidade:</strong> <span id="modal-city"></span></p>
                <p><strong>Rua:</strong> <span id="modal-street"></span></p>
                <p><strong>Tipo:</strong> <span id="modal-type"></span></p>
                <p><strong>Subtipo:</strong> <span id='modal-subtype'></span></p>
                <p><strong>Status:</strong> <span id="modal-status"></span></p>
                <p><strong>Localização:</strong> 
                    <span id="modal-location" data-lat="" data-lon=""></span>
                </p>
                <p id="modal-km-p"><strong>Km:</strong> <span id="modal-km"></span></p> <!-- Novo campo para exibir km -->
                <p><strong>Data Recebida:</strong> <span id="modal-date-received"></span></p>
                <p><strong>Confiança:</strong> <span id="modal-confidence"></span></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button> <!-- Atualizado para Bootstrap 5 -->
                <button type="button" class="btn btn-success" id="confirm-alert">Confirmar Alerta</button>
            </div>
        </div>
    </div>
</div>

<!-- Inicializando os tooltips e DataTables do Bootstrap -->
<script>
    $(document).ready(function () {
        // Inicializa tooltips
        $('[data-toggle="tooltip"]').tooltip();
        jQuery.noConflict();

        // Inicializa DataTables para a tabela de acidentes
        $('#accidentsTable').DataTable({
            paging: true,
            searching: true,
            info: true,
            language: {
                search: "Buscar:",
                paginate: {
                    next: "Próximo",
                    previous: "Anterior",
                },
            },
        });

        // Inicializa DataTables para a tabela de congestionamentos
        $('#jamsTable').DataTable({
            paging: true,
            searching: true,
            info: true,
            language: {
                search: "Buscar:",
                paginate: {
                    next: "Próximo",
                    previous: "Anterior",
                },
            },
        });

        // Exibir os detalhes do alerta e consultar o DENIT ao abrir o modal
        $('#alertModal').on('show.bs.modal', function (event) {
            console.log("Modal aberto: evento disparado.");
        
            var button = $(event.relatedTarget); // Obtém o botão que acionou a modal
            if (!button.length) {
                console.log("Erro: Não foi possível encontrar o botão que acionou o modal.");
                return;
            }
        
            var uuid = button.closest('tr').data('uuid'); // Obtém o UUID do alerta
            var locationX = button.closest('tr').find('td[data-toggle="tooltip"]').data('lat'); // Latitude
            var locationY = button.closest('tr').find('td[data-toggle="tooltip"]').data('lon'); // Longitude
        
            console.log("UUID capturado:", uuid);
            console.log("Coordenadas capturadas: Lat =", locationX, ", Lon =", locationY);
        
            if (!locationX || !locationY) {
                console.log("Erro: Coordenadas não encontradas.");
                return;
            }
        
            // URL do DENIT
            var denitUrl = `https://servicos.dnit.gov.br/sgplan/apigeo/rotas/localizarkm?lng=${locationX}&lat=${locationY}&r=250&data=${new Date().toISOString().split('T')[0]}`;
            console.log("URL de consulta ao DENIT:", denitUrl);
        
            // Faz a requisição ao DENIT
            $.ajax({
                url: denitUrl,
                type: 'GET',
                success: function (response) {
                    console.log("Resposta da API DENIT:", response);
                    if (response && response.length > 0) {
                        const result = response[0]; // Obtendo o primeiro resultado
                        $('#modal-uuid').text(uuid || 'N/A');
                        $('#modal-city').text(result.uf || 'N/A');
                        $('#modal-street').text(result.br || 'N/A');
                        $('#modal-type').text('DENIT Response');
                        $('#modal-subtype').text('N/A');
                        $('#modal-status').text('Ativo');
                        $('#modal-date-received').text(new Date().toLocaleString());
                        $('#modal-confidence').text('N/A');
                        $('#modal-location').text(
                            `Lat: ${result.lat || 'N/A'}, Lon: ${result.lng || 'N/A'}`
                        );
                    } else {
                        alert('Nenhum dado encontrado para as coordenadas fornecidas.');
                    }
                },
                error: function (xhr, status, error) {
                    console.error("Erro na requisição ao DENIT:", status, error);
                    alert('Erro ao consultar os dados do DENIT. Tente novamente.');
                },
            });
        });        

        // Função para confirmar o alerta no banco de dados
        function confirmarAlerta(uuid) {
            $.ajax({
                url: '/confirmar_alerta', // URL da sua API ou rota para confirmar o alerta
                type: 'POST',
                data: {
                    uuid: uuid,
                    status: 1, // Aqui você pode definir o status como "Ativo" ao confirmar
                },
                success: function (response) {
                    alert('Alerta confirmado com sucesso!');
                    $('#alertModal').modal('hide');
                },
                error: function (xhr, status, error) {
                    alert('Erro ao confirmar o alerta. Tente novamente.');
                },
            });
        }

        // Adicionar evento para confirmar o alerta
        $('#confirm-alert').on('click', function () {
            var uuid = $('#modal-uuid').text(); // Obtém o UUID do alerta da modal
            confirmarAlerta(uuid);
        });
    });
</script>
